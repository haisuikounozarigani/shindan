<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CBTおみくじ — あなたの運勢を占います</title>
<meta name="description" content="CBTおみくじ。今日の運勢とあわせて、役立つCBTワザをワンポイントでご提案。">
<meta name="theme-color" content="#fff9fe">
<style>
  :root{
    --bg1:#fff9fe; --bg2:#f5f7ff; --paper:#fff; --ink:#1a1623; --muted:#6c6a77;
    --line:#eee6f4; --accent:#7b5cff; --accent2:#ff88c9; --warn:#c9366f;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    font-family:"Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic UI","YuGothic",Meiryo,sans-serif;
    background:linear-gradient(160deg,var(--bg1),var(--bg2));
    line-height:1.85; letter-spacing:.01em;
  }
  header{position:sticky;top:0;z-index:5;background:rgba(255,255,255,.9);backdrop-filter:saturate(1.08) blur(8px);border-bottom:1px solid var(--line)}
  header .in{max-width:960px;margin:auto;padding:12px 16px;display:flex;gap:12px;align-items:center}
  h1{font-size:18px;margin:0;font-weight:800}
  .crumb{margin-left:auto;color:var(--muted);font-size:12px}

  main{max-width:960px;margin:0 auto;padding:18px 16px 120px}
  .panel{background:var(--paper);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 10px 28px rgba(0,0,0,.05)}
  .lead{color:var(--muted);margin-top:4px}
  .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  .btn{appearance:none;border:1px solid var(--line);background:linear-gradient(180deg,#fff,#faf7ff);padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:700}
  .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;border-color:transparent}
  .btn[disabled]{opacity:.5;cursor:not-allowed}

  /* Result card */
  #result{display:none;margin-top:14px}
  .omk-head{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .rank{font-size:36px;font-weight:900;letter-spacing:.02em}
  .tag{display:inline-block;margin-left:6px;padding:4px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;font-weight:700}
  .omk-hero{margin:12px 0;border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#f7f8fb}
  .omk-hero img{display:block;width:100%;height:auto}
  .msg{font-size:16px}
  .cbt{border:1px dashed #e9e1f7;background:#fff;border-radius:12px;padding:10px;margin-top:10px}
  .cbt .ttl{font-weight:800}
  .cbt ol{margin:8px 0 0 18px; padding:0}
  .share{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}

  /* Disclaimer */
  .warn{margin-top:14px;border:2px solid var(--warn);background:#fff4f7;border-radius:14px;padding:10px}
  .warn strong{color:var(--warn)}

  /* Footer bar */
  .footerbar{position:fixed;left:0;right:0;bottom:0;background:rgba(255,255,255,.88);backdrop-filter:blur(6px) saturate(1.05);border-top:1px solid var(--line);padding:10px}
  .footerbar .in{max-width:960px;margin:auto;display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
  .footerbar a,.footerbar button{padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#fff;color:#1c1a22;text-decoration:none;cursor:pointer}

  @media (max-width:420px){ .rank{font-size:32px} }
  /* ===== おみくじの見栄え強化（非破壊） ===== */
.omikuji-card{
  position:relative;
  background:#fff;
  border:1px solid #ece8f2;
  border-radius:16px;
  box-shadow:0 8px 28px rgba(34,34,52,.08);
  padding:16px 16px 18px;
  margin:12px 0;
  animation:oki-fade .35s ease;
}
@keyframes oki-fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

.omikuji-card p{margin:.45em 0 0; line-height:1.9}
.omikuji-card .lead{font-size:1.05rem; line-height:1.95}

.fortune-badge{
  position:absolute; inset: -12px auto auto -12px;
  background:linear-gradient(135deg,#6b6bd9,#b96ad6);
  color:#fff; padding:8px 12px; border-radius:12px;
  font-weight:800; letter-spacing:.06em; box-shadow:0 8px 20px rgba(107,107,217,.25);
}
.fortune-sub{display:block; font-weight:600; font-size:.85rem; opacity:.9}

.omikuji-card[data-fortune="daikichi"] .fortune-badge{background:linear-gradient(135deg,#ff7b5a,#ffbd5a)}
.omikuji-card[data-fortune="chukichi"] .fortune-badge{background:linear-gradient(135deg,#5aa9ff,#6bd9cf)}
.omikuji-card[data-fortune="shokichi"] .fortune-badge{background:linear-gradient(135deg,#6b6bd9,#b96ad6)}
.omikuji-card[data-fortune="suekichi"] .fortune-badge{background:linear-gradient(135deg,#8c7bd9,#ca86d6)}
.omikuji-card[data-fortune="kichi"]     .fortune-badge{background:linear-gradient(135deg,#5abf7a,#8bd95a)}
.omikuji-card[data-fortune="kyo"]       .fortune-badge{background:linear-gradient(135deg,#ff6b6b,#ff956b)}
.omikuji-card[data-fortune="daikyo"]    .fortune-badge{background:linear-gradient(135deg,#d94e6b,#a83952)}

.omikuji-card .sep{height:1px;background:#eee; margin:12px 0}
.omikuji-card .tips{display:grid; gap:8px; margin-top:8px}
.omikuji-card .tips li{padding-left:.4em}
/* おみくじ結果画像（正方形・角丸） */
.omikuji-hero{margin:10px 0 12px;border:1px solid #ece8f2;border-radius:14px;overflow:hidden;background:#fafbff}
.omikuji-hero img{display:block;width:100%;max-width:460px;aspect-ratio:1/1;object-fit:cover;margin-inline:auto}
</style>
</head>
<body data-id="cbt-omikuji">
<header><div class="in">
  <h1>CBTおみくじ</h1>
  <span class="crumb">あなたの運勢を占います</span>
</div></header>

<main>
  <section class="panel">
    <div class="ttl"><strong>今日の運勢</strong> をひいて、<strong>CBTのワザ</strong>を1つだけ実行してみましょう。</div>
    <div class="actions">
      <button id="btnDraw" class="btn primary">おみくじを引く</button>
      <button id="btnAgain" class="btn" style="display:none">もう一度ひく</button>
    </div>

    <article id="result" class="panel">
    	<section id="legal-note-omikuji" style="margin:8px 0 14px;background:#fff;border:1px solid #e7d9d9;border-radius:10px;padding:10px 12px">

      <div class="omk-head">
        <div class="rank" id="rankText">—</div>
        <span class="tag" id="tagText"></span>
      </div>

      <figure class="omk-hero" aria-hidden="true"><img id="rankImg" src="" alt=""></figure>

      <p class="msg" id="msgText"></p>

      <div class="cbt">
        <div class="ttl">CBTワザ｜<span id="cbtName">—</span></div>
        <ol id="cbtSteps"></ol>
      </div>

      <div class="share">
        <button id="btnCopy" class="btn">内容をコピー</button>
        <button id="btnShare" class="btn">共有</button>
      </div>
   	<section id="legal-note-omikuji" style="margin:8px 0 14px;background:#fff;border:1px solid #e7d9d9;border-radius:10px;padding:10px 12px">
  <h2 style="margin:4px 0 6px;font-size:1rem;color:#533">ご利用にあたって</h2>
  <ul style="margin:6px 0 0 1.2em;line-height:1.8;color:#666">
    <li><strong>非提携・非公式：</strong>本コンテンツは心理学／CBT（認知行動療法）の一般的知見に<span style="white-space:nowrap">ヒントを得た</span><strong>独自制作</strong>です。学会・医療機関・資格認定団体等の承認・提携・推奨を意味しません。</li>
    <li><strong>医療用途ではありません：</strong>娯楽＋セルフヘルプのヒント提供を目的とする一般情報で、医療・心理・法的助言や診断／治療の代替にはなりません。体調や心の不調が続く場合は専門家にご相談ください（緊急時は119/110）。</li>
    <li><strong>プライバシー：</strong>回答は端末内で処理・保存され、回答内容や個人を特定できる情報はサーバーに送信されません。結果表示時に匿名の件数カウントのみ送信する場合があります。</li>
    <li><strong>用語について：</strong>「CBT」は一般概念への言及であり、手法の有効性や個々の適用可否を保証するものではありません。実践はご自身の状況に照らして安全な範囲で判断してください。</li>
    <li><strong>免責：</strong>法令で認められる範囲で、本コンテンツの利用により生じたいかなる損失・損害についても、当サイトは責任を負いません。</li>
  </ul>
</section>
      <aside class="warn" role="note">
        <p>⚠️ <strong>注意</strong>：本ページはエンタメ＋セルフヘルプのヒント提供を目的とした<strong>占いコンテンツ</strong>です。<br>
        医療・診断・治療・緊急対応の目的では<strong>ありません</strong>。実践はご自身の判断・<strong>自己責任</strong>で行ってください。体調・心身の不調が続く場合は、医療機関や専門家へご相談ください。</p>
      </aside>
    </article>
  </section>
</main>

<!-- 戻り導線 -->
<nav class="footerbar">
  <div class="in">
    <a href="/shindan/">診断一覧に戻る</a>
  </div>
</nav>

<script>
(()=>{
  // ===== 画像の置き場所（必要なら変更） =====
  const IMG_BASE = '/shindan/assets/results/cbt-omikuji/'; // 01.png〜07.png を配置

  // ===== 画像ファイル番号（運勢→画像） =====
  const RANK_IMG = { '大吉':'01', '吉':'02', '中吉':'03', '小吉':'04', '末吉':'05', '半吉':'06', '凶':'07' };

  // ===== おみくじ本文（占い風・性格記述なし） =====
  const DATA = [
    {rank:'大吉', tag:'追い風の日',
     msg:'風向きは順。朝のひと押しが一日を軽くします。細かな不安は流しましょう。ラッキータイム：午前中。',
     cbt:'3分だけ着手（行動活性）',
     steps:'やることを1つ選ぶ → タイマー3分 → 鳴ったら続きは「やる／やらない」を自分で決める。'},

    {rank:'吉', tag:'静かな自信',
     msg:'静かな運気。距離感が保てる日。予定は短いメッセージで整えると吉。ラッキーカラー：薄青。',
     cbt:'事実と解釈の仕分け（認知の再評価）',
     steps:'紙に「事実｜解釈」と2列を書き、頭の中の“解釈”を事実から切り離す。'},

    {rank:'中吉', tag:'雲間の光',
     msg:'もやが晴れて光が差す日。最初の一歩が鍵。ラッキーアクション：扉や窓を開ける。',
     cbt:'5-4-3-2-1グラウンディング',
     steps:'見える5・触れる4・聞こえる3・嗅ぐ2・味1を順に言語化→今ここへ戻す。'},

    {rank:'小吉', tag:'整える日',
     msg:'“最初の一手”が効く日。机やデスクトップをひと拭きすると流れが生まれる。',
     cbt:'最初の小石（課題分割）',
     steps:'タスクを“最初の30秒行動”に分解（例：ファイルを開く／ペンを持つ）。'},

    {rank:'大吉', tag:'自然体の集中',
     msg:'追い波到来。短く始めるほど長く乗れる暗示。ご褒美は小さく素早く。',
     cbt:'ポモドーロ1セット（時間制限）',
     steps:'25分集中＋5分休憩を1回。終わったらご褒美を小さく。'},

    {rank:'吉', tag:'やさしさの矢印',
     msg:'やわらかな巡り。あたたかい飲み物が心身を整えてくれる。ラッキーアイテム：マグカップ。',
     cbt:'ベストフレンド視点（セルフコンパッション）',
     steps:'“親友が同じ状況なら何と言う？”を自分に向けて一行で書く。'},

    {rank:'末吉', tag:'風待ち',
     msg:'向かい風。完璧狙いは重くなる日。“ほどよく”で先へ。キーワード：60点で出す。',
     cbt:'行動実験ミニ',
     steps:'“予測：笑われる(80%)”→小さく提出→“実測：どうだった？”を書いて見直す。'},

    {rank:'半吉', tag:'軽やかな回避',
     msg:'賢い切り替えが光る日。短い休憩→再開のリズムで滞りを回避。',
     cbt:'心配の予約（刺激コントロール）',
     steps:'心配はメモに入れて“19:00–19:15だけ考える”。今は箱に戻す。'},

    {rank:'中吉', tag:'視点の切替',
     msg:'ズーム切替で視界クリア。やることを絞るほど運気は整う。ラッキーアクション：一画面にまとめる。',
     cbt:'一画面ToDo（選択と集中）',
     steps:'今日やる3つだけ書く（それ以外は明日箱へ）。'},

    {rank:'小吉', tag:'落ち着きの呼吸',
     msg:'呼吸を整えると波が静まる。静かな集中が戻る暗示。ラッキータイム：夕方前。',
     cbt:'呼吸4-6（呼吸法）',
     steps:'4秒吸って6秒吐く×8呼吸。肩・顎・舌をゆるめる。'},

    {rank:'吉', tag:'意味の糸',
     msg:'ひと言の“なぜ”が背中を押す日。目的を添えるほど道がまっすぐになる。',
     cbt:'価値カード3語（価値づけ）',
     steps:'大切にしたい言葉を3つ（例：誠実・学び・安心）→今日の行動に1語ひもづけ。'},

    {rank:'中吉', tag:'ゆるい筋トレ',
     msg:'薄く積むほど効いてくる日。小さな回数で地力アップ。ラッキーアイテム：チェックリスト。',
     cbt:'行動活性の最小化',
     steps:'運動なら1分・勉強なら1ページ・片づけなら1か所だけ。'},

    {rank:'末吉', tag:'ちいさな修理',
     msg:'大工事は不向き。直せるところを直せば十分。結果は後からついてくる。',
     cbt:'問題解決5手',
     steps:'①問題を1行 ②目的 ③選択肢3つ ④一番軽い案 ⑤実行→結果メモ。'},

    {rank:'小吉', tag:'音量の調整',
     msg:'内なるナレーションは一段小さく。景色がクリアになり、判断が軽くなる。',
     cbt:'思考ラベリング',
     steps:'浮かんだ考えに“考えだと気づく”ラベル（例：いま「不安の予言」をしてる）。'},

    {rank:'吉', tag:'受け取り上手',
     msg:'お願いごとが通りやすい流れ。短く素直に頼むと吉。ラッキー方角：東。',
     cbt:'ヘルプリクエスト（対人スキル）',
     steps:'誰に／何を／いつを1行で決め、短く送る。'},

    {rank:'中吉', tag:'余白の力',
     msg:'空白が幸運を呼ぶ。15分の“何もしない”が最大効率。通知は静かに。',
     cbt:'刺激コントロール',
     steps:'通知OFF・机の上は1テーマだけ・タイマー15分で余白を守る。'},

    {rank:'小吉', tag:'ゆる許可',
     msg:'自分にゆるく“OK”を出すほど流れは軽く。キーワード：許可・減点しない。',
     cbt:'セルフコンパッション一言',
     steps:'「今は十分やってる。次は小さくでいい」を声に出す。'},

    {rank:'吉', tag:'再開の合図',
     msg:'再開のスイッチが見つかる日。音・姿勢・場所いずれかを“合図”に。',
     cbt:'環境トリガー',
     steps:'再開したい行動と“合図”をセット（音楽・椅子・アプリ）。合図→即30秒だけ動く。'},

    {rank:'中吉', tag:'夜空のメモ',
     msg:'夜に増える考えは紙に預けるのが吉。眠りの質が上向く兆し。',
     cbt:'ブレインダンプ5分',
     steps:'頭の中を箇条書き→明日やる／後で検討／捨てる に3分で仕分け。'},

    {rank:'大吉', tag:'着地名人',
     msg:'切り替えが冴える日。戻るコツを言葉にすれば明日も使えるチャームに。',
     cbt:'着地手順を3行に（対処計画）',
     steps:'①水を飲む ②姿勢＋呼吸 ③人に一言送る——紙に書いて持ち歩く。'},

    {rank:'凶', tag:'雲の下で一休み',
     msg:'空は低め。無理に進まず“点で終わらせる”がコツ。切り替えたら今日は勝ち。',
     cbt:'1分リセット（行動活性）',
     steps:'①水を飲む ②窓を開けるor肩回し10回 ③30秒だけ片づけ。小さく動いて流れを変える。'}
  ];

  // ===== DOM =====
  const $ = (q,root=document)=>root.querySelector(q);
  const rankText = $('#rankText');
  const tagText  = $('#tagText');
  const msgText  = $('#msgText');
  const cbtName  = $('#cbtName');
  const cbtSteps = $('#cbtSteps');
  const rankImg  = $('#rankImg');
  const resBox   = $('#result');
  const btnDraw  = $('#btnDraw');
  const btnAgain = $('#btnAgain');
  const btnCopy  = $('#btnCopy');
  const btnShare = $('#btnShare');

  // ===== helpers =====
  const pick = arr => arr[Math.floor(Math.random()*arr.length)];
  function render(item){
    rankText.textContent = item.rank;
    tagText.textContent  = item.tag;
    msgText.textContent  = item.msg;
    cbtName.textContent  = item.cbt;
    cbtSteps.innerHTML   = ''; // reset
    // ステップは「。」「→」「／」で分割して整える（1文のものもOK）
    const parts = (item.steps.includes('→') ? item.steps.split('→') : item.steps.split('。').filter(Boolean));
    parts.forEach(p=>{
      const li=document.createElement('li');
      li.textContent = p.replace(/^・/,'').trim();
      cbtSteps.appendChild(li);
    });

    const num = RANK_IMG[item.rank] || '03';
    rankImg.src = IMG_BASE + num + '.png';
    rankImg.alt = item.rank + 'のイメージ';

    resBox.style.display = 'block';
    btnAgain.style.display = 'inline-block';
    try{ localStorage.setItem('cbt-omikuji:last', JSON.stringify({rank:item.rank,tag:item.tag,at:Date.now()})); }catch{}
  }

  // ===== events =====
  btnDraw.addEventListener('click', ()=> render(pick(DATA)));
  btnAgain.addEventListener('click', ()=> render(pick(DATA)));

  btnCopy.addEventListener('click', async ()=>{
    const text = [
      `【CBTおみくじ】${rankText.textContent}「${tagText.textContent}」`,
      msgText.textContent,
      `CBTワザ：${cbtName.textContent}`,
      ...[...cbtSteps.querySelectorAll('li')].map((li,i)=>`(${i+1}) ${li.textContent}`),
      location.href.split('#')[0]
    ].join('\n');
    try{
      await navigator.clipboard.writeText(text);
      alert('内容をコピーしました');
    }catch{}
  });

  btnShare.addEventListener('click', async ()=>{
    const shareData = {
      title: document.title,
      text: `CBTおみくじ｜${rankText.textContent}「${tagText.textContent}」`,
      url: location.href.split('#')[0]
    };
    try{
      if(navigator.share){ await navigator.share(shareData); }
      else{
        await navigator.clipboard.writeText(`${shareData.text}\n${shareData.url}`);
        alert('結果テキストをコピーしました');
      }
    }catch(e){}
  });

  // 初回 自動で一回引く（任意）
  // render(pick(DATA));
})();
</script>
<script>
/* ============================================================
   診断ページ共通スニペット（コピペ用）
   1) 回答の自動保存・自動復元（入力中も逐次保存）
   2) 結果表示タイミングで「済」＋ あなたのLv +1
   3) みんなのこころLv（CountAPI）に +1（失敗は無視）
   ------------------------------------------------------------
   ★置き場所：各診断HTMLの </body> の直前
   ★ページID：<body data-id="xxxxx"> を推奨（未設定でも動作）
============================================================ */
(function(){
  'use strict';

  // ===== 固定キー：index.html と合わせてあります =====
  var DONE_KEY   = 'specimens:open:byid';   // 診断ごとの「済」マップ
  var TOTAL_KEY  = 'specimens:open:total';  // あなたのこころLv（合計）
  var GLOBAL_LAST= 'specimens:open:global:last'; // みんなのLvの前回表示キャッシュ

  // ===== このページのID =====
  var MY_ID = (document.body && document.body.getAttribute('data-id')) || 'unknown';

  // ===== 回答保存ストレージ（この診断だけの箱） =====
  var ANSWER_KEY = 'specimens:answers:' + MY_ID;

  // ===== みんなのLv（CountAPI設定） =====
  var COUNTAPI_NS  = 'haisuikounozarigani_shindan';
  var COUNTAPI_KEY = 'specimens_open_total';
  function countapiHit(){
    var url = 'https://api.countapi.xyz/hit/'+COUNTAPI_NS+'/'+COUNTAPI_KEY;
    if(navigator.sendBeacon){
      try{ navigator.sendBeacon(url); }catch(_){}
    }else{
      fetch(url, {mode:'cors', cache:'no-store', keepalive:true}).catch(function(){});
    }
  }

  // ---------- 回答の保存/復元 ----------
  function loadState(){
    try{ return JSON.parse(localStorage.getItem(ANSWER_KEY) || '{}'); }catch(_){ return {}; }
  }
  function saveState(obj){
    try{ localStorage.setItem(ANSWER_KEY, JSON.stringify(obj)); }catch(_){}
  }
  function saveField(el){
    if(!el || !el.name) return;
    var st = loadState();
    var nm = el.name;

    if(el.type === 'radio'){
      // ラジオは選ばれた value を保存
      var chosen = (el.form || document).querySelector('input[type="radio"][name="'+nm+'"]:checked');
      st[nm] = chosen ? {t:'r', v: chosen.value} : {t:'r', v:null};
    }else if(el.type === 'checkbox'){
      // チェックボックスは同名グループのチェック済み value 配列
      var all = (el.form || document).querySelectorAll('input[type="checkbox"][name="'+nm+'"]');
      var vals = [];
      all.forEach(function(c){ if(c.checked) vals.push(c.value || 'on'); });
      st[nm] = {t:'c', v: vals};
    }else if(el.tagName==='SELECT'){
      if(el.multiple){
        var arr=[]; [].slice.call(el.options).forEach(function(o){ if(o.selected) arr.push(o.value); });
        st[nm] = {t:'m', v: arr};
      }else{
        st[nm] = {t:'s', v: el.value};
      }
    }else{
      // text / number / textarea など
      st[nm] = {t:'t', v: el.value};
    }
    saveState(st);
  }
  function restoreOnce(){
    var st = loadState();
    var names = Object.keys(st);
    if(!names.length) return false;

    names.forEach(function(nm){
      var info = st[nm]; if(!info) return;

      if(info.t==='r'){
        var r = document.querySelector('input[type="radio"][name="'+nm+'"][value="'+CSS.escape(String(info.v))+'"]');
        if(r){ r.checked = true; r.dispatchEvent(new Event('change',{bubbles:true})); }
      }else if(info.t==='c'){
        var all = document.querySelectorAll('input[type="checkbox"][name="'+nm+'"]');
        var set = new Set(info.v||[]);
        all.forEach(function(c){ c.checked = set.has(c.value || 'on'); });
      }else if(info.t==='m'){
        var sel = document.querySelector('select[name="'+nm+'"]');
        if(sel){
          var setm = new Set(info.v||[]);
          [].slice.call(sel.options).forEach(function(o){ o.selected = setm.has(o.value); });
        }
      }else if(info.t==='s'){
        var s = document.querySelector('select[name="'+nm+'"]');
        if(s){ s.value = info.v; }
      }else{
        var t = document.querySelector('[name="'+nm+'"]');
        if(t){ t.value = info.v==null? '' : String(info.v); }
      }
    });
    // プログレス等を更新したいUIのため、軽く change を投げる
    try{
      document.dispatchEvent(new Event('change', {bubbles:true}));
    }catch(_){}
    return true;
  }
  // 入力監視（保存）
  document.addEventListener('change', function(e){
    var el = e.target;
    if(!(el instanceof HTMLElement)) return;
    if(el.matches('input[name], select[name], textarea[name]')) saveField(el);
  }, true);
  document.addEventListener('input', function(e){
    var el = e.target;
    if(!(el instanceof HTMLElement)) return;
    if(el.matches('input[type="text"][name], input:not([type])[name], textarea[name]')) saveField(el);
  }, true);

  // 復元は「入力が描画されてから」一度だけ試みる（動的生成にも対応）
  (function restoreWhenReady(){
    var TRY_MAX=12, tries=0;
    function tick(){
      tries++;
      // 入力が一つでも見つかってから復元
      var hasAny = document.querySelector('input[name], select[name], textarea[name]');
      if(hasAny){
        restoreOnce(); return;
      }
      if(tries<TRY_MAX){ setTimeout(tick, 300); }
    }
    if(document.readyState==='complete' || document.readyState==='interactive'){ tick(); }
    else document.addEventListener('DOMContentLoaded', tick);
  })();

  // リセット系ボタンがあれば保存も削除（#btnReset / data-role="reset" を想定）
  function clearAnswers(){
    try{ localStorage.removeItem(ANSWER_KEY); }catch(_){}
  }
  document.addEventListener('click', function(e){
    var t = e.target;
    if(!(t instanceof HTMLElement)) return;
    if(t.id==='btnReset' || t.matches('[data-role="reset"]')) clearAnswers();
  }, true);

  // ---------- 結果確定で「済」＋Lv加算 ----------
  var marked = false;
  function markOnce(){
    if(marked) return; marked = true;
    try{
      // 1) あなたのこころLv 合計 +1
      var total = (+localStorage.getItem(TOTAL_KEY) || 0) + 1;
      localStorage.setItem(TOTAL_KEY, String(total));

      // 2) この診断の「済」を +1（他タブ即時反映用にタイムスタンプ混ぜる）
      var map={}; try{ map = JSON.parse(localStorage.getItem(DONE_KEY) || '{}'); }catch(_){}
      map[MY_ID] = (map[MY_ID] || 0) + 1;
      localStorage.setItem(DONE_KEY, JSON.stringify(Object.assign({}, map, {_ts: Date.now()})));

      // 3) みんなのこころLv +1（表示は index 側で取得／ここでは送るだけ）
      countapiHit();
      // ついでに前回キャッシュも+1（index初期表示の見栄え改善）
      try{
        var last = (+localStorage.getItem(GLOBAL_LAST) || 0) + 1;
        localStorage.setItem(GLOBAL_LAST, String(last));
      }catch(_){}
    }catch(_){}
  }

  // A) 結果が描画された合図（推奨：各ページの集計完了時に dispatch してください）
  //   例）document.dispatchEvent(new Event('result:ready'));
  document.addEventListener('result:ready', markOnce);

  // B) フォールバック：結果UIが見えてから2秒後に一度だけ実行（戻る無しでも確実に「済」）
  setTimeout(markOnce, 2000);
})();
</script>
<!-- みんなのこころLv（result:ready で匿名件数のみカウント） -->
<script>
(function(){
  'use strict';
  var DONE_KEY='specimens:open:byid', TOTAL_KEY='specimens:open:total', GLOBAL_LAST='specimens:open:global:last';
  var MY_ID=(document.body&&document.body.getAttribute('data-id'))||'unknown';
  var COUNTAPI_NS='haisuikounozarigani_shindan', COUNTAPI_KEY='specimens_open_total';

  function hitEveryone(){
    var u='https://api.countapi.xyz/hit/'+COUNTAPI_NS+'/'+COUNTAPI_KEY;
    if(navigator.sendBeacon){ try{ navigator.sendBeacon(u); }catch(_){} }
    else{ fetch(u,{mode:'cors',cache:'no-store',keepalive:true}).catch(function(){}); }
  }

  var marked=false;
  function markOnce(){
    if(marked) return; marked=true;
    try{
      // 端末内カウント（総数とID別）※回答保存とは別
      localStorage.setItem(TOTAL_KEY, String((+localStorage.getItem(TOTAL_KEY)||0)+1));
      var map={}; try{ map=JSON.parse(localStorage.getItem(DONE_KEY)||'{}'); }catch(_){}
      map[MY_ID]=(map[MY_ID]||0)+1;
      localStorage.setItem(DONE_KEY, JSON.stringify(Object.assign({},map,{_ts:Date.now()})));
      // 全体件数（匿名）を1件だけ送信
      hitEveryone();
      try{ localStorage.setItem(GLOBAL_LAST, String((+localStorage.getItem(GLOBAL_LAST)||0)+1)); }catch(_){}
    }catch(_){}
  }

  // 結果が出た合図で一度だけ加算
  document.addEventListener('result:ready', markOnce);
  // 念のためのフォールバック（取りこぼし対策）
  setTimeout(markOnce, 2000);
})();
</script>
<script>
(function(){
  'use strict';
  var fired = false;
  function fire(){
    if(fired) return; fired = true;
    try{
      document.dispatchEvent(new Event('result:ready'));
      // 一覧に戻ったときの「つづきから」にも使える last 記録
      localStorage.setItem('specimens:last', JSON.stringify({
        id: 'cbt-omikuji',
        title: 'CBTおみくじ',
        href: location.pathname
      }));
    }catch(_){}
  }

  // もしページ内で使っているカスタムイベントがあれば拾う（無ければ無視される）
  ['render:result','result:show','omikuji:done'].forEach(ev=>{
    document.addEventListener(ev, fire, { once:true });
  });

  // DOMの変化で“結果らしさ”を検出（オミクジ語彙）
  var obs = new MutationObserver(function(muts){
    if(fired){ obs.disconnect(); return; }
    for(var k=0;k<muts.length;k++){
      var m = muts[k];
      for(var j=0;j<m.addedNodes.length;j++){
        var node = m.addedNodes[j];
        if(!(node instanceof Element)) continue;
        var txt = (node.textContent||'').slice(0,200);
        if(/[大中小末]?吉|大凶|凶|おみくじ|結果|今日の処方箋/.test(txt)){
          fire(); obs.disconnect(); return;
        }
      }
    }
  });
  obs.observe(document.body, { childList:true, subtree:true });

  // 念のための保険（4秒後に一度だけ）
  setTimeout(fire, 4000);
})();
</script>
<!-- みんなのこころLv（result:ready で匿名件数のみカウント） -->
<script>
(function(){
  'use strict';
  var DONE_KEY='specimens:open:byid', TOTAL_KEY='specimens:open:total', GLOBAL_LAST='specimens:open:global:last';
  var MY_ID=(document.body&&document.body.getAttribute('data-id'))||'cbt-omikuji';
  var COUNTAPI_NS='haisuikounozarigani_shindan', COUNTAPI_KEY='specimens_open_total';

  function hitEveryone(){
    var u='https://api.countapi.xyz/hit/'+COUNTAPI_NS+'/'+COUNTAPI_KEY;
    if(navigator.sendBeacon){ try{ navigator.sendBeacon(u); }catch(_){ } }
    else{ fetch(u,{mode:'cors',cache:'no-store',keepalive:true}).catch(function(){}); }
  }

  var marked=false;
  function markOnce(){
    if(marked) return; marked=true;
    try{
      // 端末内カウント（総数＋ID別）※回答そのものは送信しません
      localStorage.setItem(TOTAL_KEY, String((+localStorage.getItem(TOTAL_KEY)||0)+1));
      var map={}; try{ map=JSON.parse(localStorage.getItem(DONE_KEY)||'{}'); }catch(_){}
      map[MY_ID]=(map[MY_ID]||0)+1;
      localStorage.setItem(DONE_KEY, JSON.stringify(Object.assign({},map,{_ts:Date.now()})));
      // 全体件数（匿名）も1件だけ送信
      hitEveryone();
      try{ localStorage.setItem(GLOBAL_LAST, String((+localStorage.getItem(GLOBAL_LAST)||0)+1)); }catch(_){}
    }catch(_){}
  }

  document.addEventListener('result:ready', markOnce);
  // フォールバック（取りこぼし対策）
  setTimeout(markOnce, 2000);
})();
</script>
<script>
(function(){
  'use strict';
  // 結果ブロックを推測してカード化＆札バッジを付与（文言は変更しない）
  function prettifyOmikuji(){
    // 候補から最初に見つかった要素を結果ブロックとみなす
    var node = document.querySelector('#omikujiResult, .omikuji-result, .result, .result-area, #result, [data-role="result"], [data-result]') 
            || document.querySelector('main .card, main section, body');
    if(!node) return;
    if(!node.classList.contains('omikuji-card')) node.classList.add('omikuji-card');

    // おみくじ語（大吉/中吉/...）を本文から抽出
    var txt = node.textContent || '';
    var hit = (txt.match(/大吉|中吉|小吉|末吉|吉|大凶|凶/)||[])[0] || '';
    var key = ({
      '大吉':'daikichi','中吉':'chukichi','小吉':'shokichi','末吉':'suekichi','吉':'kichi','凶':'kyo','大凶':'daikyo'
    })[hit] || '';

    if(key){ node.setAttribute('data-fortune', key); }

    // 既にバッジが無ければ作る（文言はそのまま抽出した hit を使用）
    if(!node.querySelector('.fortune-badge') && hit){
      var badge = document.createElement('div');
      badge.className = 'fortune-badge';
      badge.innerHTML = hit + '<span class="fortune-sub">omikuji</span>';
      node.prepend(badge);
    }

    // 先頭の説明段落に .lead を付ける（視認性だけ上げる）
    var p = node.querySelector('p');
    if(p && !p.classList.contains('lead')) p.classList.add('lead');
  }

  // 結果が出た合図で整形（あなたのページには既に result:ready が入っている前提）
  document.addEventListener('result:ready', function(){
    setTimeout(prettifyOmikuji, 60); // レイアウト更新後に軽く待つ
  });

  // 万一イベントが無い・取りこぼした場合の保険（4秒後に一度実行）
  setTimeout(prettifyOmikuji, 4000);
})();
</script>
<script>
(function(){
  'use strict';
  // 画像ベースパス & 変換表（必要な枚数だけフォルダに置いてね）
  var IMG_BASE = '/shindan/assets/results/cbt-omikuji/';
  var OMI2FILE = {
    daikichi:'t01.webp',
    chukichi:'t02.webp',
    shokichi:'t03.webp',
    suekichi:'t04.webp',
    kichi:'t05.webp',
    kyo:'t06.webp',
    daikyo:'t07.webp' // 使わないなら置かなくてOK
  };

  // 既存の結果DOMから「大吉/中吉…」を拾って key を返す
  function detectFortuneKey(root){
    var txt = (root && root.textContent) ? root.textContent : document.body.textContent || '';
    var hit = (txt.match(/大吉|中吉|小吉|末吉|吉|大凶|凶/)||[])[0] || '';
    return {
      '大吉':'daikichi','中吉':'chukichi','小吉':'shokichi','末吉':'suekichi',
      '吉':'kichi','凶':'kyo','大凶':'daikyo'
    }[hit] || '';
  }

  // 結果ブロック（推測）を取得
  function pickResultNode(){
    return document.querySelector('#omikujiResult, .omikuji-result, .result, .result-area, #result, [data-role="result"], [data-result]')
        || document.querySelector('main .card, main section, body');
  }

  // 画像を差し込む（無ければ作る／あれば差し替え）
  function ensureHeroImage(root, src, alt){
    var host = root.querySelector('.omikuji-hero');
    if(!host){
      host = document.createElement('div');
      host.className = 'omikuji-hero';
      // 先頭か見出し直後に置く
      var h = root.querySelector('h2,h3') || root.firstElementChild;
      if(h && h.nextSibling){ root.insertBefore(host, h.nextSibling); }
      else { root.prepend(host); }
    }
    var img = host.querySelector('img#omikujiHero');
    if(!img){
      img = document.createElement('img');
      img.id = 'omikujiHero';
      host.appendChild(img);
    }
    img.alt = alt || 'omikuji result';
    img.src = src;
  }

  // 結果合図（result:ready）で適用
  function applyOmikujiImage(){
    var root = pickResultNode();
    var key  = detectFortuneKey(root);
    var file = OMI2FILE[key] || OMI2FILE.kichi || 't01.webp'; // 予備
    ensureHeroImage(root, IMG_BASE + file, key||'omikuji');
  }

  document.addEventListener('result:ready', function(){
    // レイアウト更新を少し待ってから
    setTimeout(applyOmikujiImage, 60);
  });

  // 念のための保険（数秒後に一度だけ適用）
  setTimeout(applyOmikujiImage, 4000);
})();
</script>
</body>
</html>