<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>時の天秤診断 – あなたは時間派？お金派？</title>
<meta name="description" content="時間とお金、あなたの天秤はどちらに傾きやすい？5軸×15問で“時間フォーカス指数”を可視化。">
<meta name="theme-color" content="#f0f6ff">
<meta property="og:type" content="website">
<meta property="og:title" content="時の天秤診断 – あなたは時間派？お金派？">
<meta property="og:description" content="5軸×15問で“時間フォーカス指数”を可視化。各軸の傾向バーも表示。">
<meta property="og:url" content="https://haisuikounozarigani.github.io/shindan/time-money.html">



<style>
.small ul{ margin:8px 0 0 18px; padding:0; }
.small li{ margin:4px 0; }
:root{
  --bg1:#f6fbff; --bg2:#eef4ff; --card:#fff; --line:#dbe8ff; --fg:#1f2a3a; --muted:#5b6a75;
  --accent:#4aa8ff; --accent2:#a48bff;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;color:var(--fg);font-family:"Noto Sans JP",system-ui,sans-serif;background:linear-gradient(160deg,var(--bg1),var(--bg2))}
a{color:inherit}
.wrap{max-width:1040px;margin:18px auto 24px;padding:0 14px}
.header{display:grid;grid-template-columns:64px 1fr;gap:12px;align-items:center;margin:14px 0 6px}
.logo{width:64px;height:64px;border-radius:16px;background:linear-gradient(135deg,#d9efff,#e7dbff);display:grid;place-items:center;font-size:34px}
h1{margin:0;font-size:clamp(22px,4.5vw,34px)}
.sub{margin:2px 0 0;color:var(--muted);font-size:.95em}
.card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px;box-shadow:0 6px 18px rgba(74,168,255,.10)}
.section{margin:16px 0}
.qrow{padding:12px;border:1px solid var(--line);border-radius:12px;margin:12px 0;background:#fff}
.qrow .ttl{font-weight:700}
.scale{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-top:8px}
.scale label{display:block;border:1px solid #e6ebff;border-radius:10px;background:#fff;cursor:pointer;padding:10px;text-align:center}
.scale input{position:absolute;opacity:0;pointer-events:none}
.scale input:checked+label{outline:2px solid var(--accent);border-color:transparent;outline-offset:2px}
.scale .hint{grid-column:1/-1;display:flex;justify-content:space-between;color:#7a8694;font-size:.88em;margin-top:6px}
.badge{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;font-weight:700}
/* 📊 sticky progress（rail/NOH準拠） */
.sticky{position:sticky;top:0;z-index:30;margin:-6px -14px 10px;padding:8px 14px;
  background:rgba(255,255,255,.86);backdrop-filter:blur(6px) saturate(1.05);
  border-bottom:1px solid #e8eefc;display:flex;align-items:center;gap:10px}
.progress{height:8px;background:#e8eefc;border-radius:999px;flex:1;overflow:hidden}
.progress>span{display:block;height:100%;width:0;background:linear-gradient(90deg,#bfe3ff,#a48bff);transition:width .25s ease}
.btn{padding:10px 14px;border:1px solid var(--line);border-radius:12px;background:#fff;cursor:pointer}
.btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));border-color:transparent;color:#fff;font-weight:700}
.small{color:var(--muted);font-size:.92em}
.hidden{display:none!important}

/* 結果 */
.res-head{display:grid;grid-template-columns:1fr;gap:10px;align-items:center}

/* ── NOH風：正方形ヒーロー ───────────────── */
.hero-square{display:grid;place-items:center;border:1px solid #dfe7ff;border-radius:16px;background:#fff;overflow:hidden}
.hero-square figure{margin:0;width:min(560px,100%);max-width:100%;aspect-ratio:1/1;border-bottom:1px solid #eef2ff;background:#f7f9ff}
.hero-square img{width:100%;height:100%;object-fit:cover;display:block}
.hero-square figcaption{padding:14px 12px;width:100%;line-height:1.7}
.title-row{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.badge-size{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;background:#fff;border:1px solid #e6ebff;font-size:.85em;margin-left:6px}

/* ── NOH風：因子バー（％） ───────────────── */
.factors{display:grid;gap:12px}
.meter{display:grid;gap:8px}
.meter .row{display:flex;align-items:center;justify-content:space-between;gap:8px}
.meter .row .name{font-weight:700}
.mbar{height:10px;border:1px solid #e5e9f3;border-radius:999px;overflow:hidden;background:#f7f8fc}
.mbar>span{display:block;height:100%;width:0;background:linear-gradient(90deg,#bfe3ff,#a48bff)}
.pct{font-variant-numeric:tabular-nums;color:#4e4e6a}
#factorBox{max-width:720px;margin-inline:auto}
.ttl-big{font-weight:800;font-size:clamp(20px,3.4vw,28px)}
.pills{display:flex;gap:8px;flex-wrap:wrap;color:#54607a}
.pill{padding:6px 10px;border:1px solid #e6ebff;border-radius:999px;background:#fff}
.grid2{display:grid;grid-template-columns:1fr;gap:12px}
.chartbox{padding:10px;border:1px dashed #dfe7ff;border-radius:12px}
.chartbox canvas{max-width:100%;height:140px!important}

/* Footer note */
.footer{color:var(--muted);font-size:.92em;margin-top:14px}
.backline{display:flex;justify-content:center;margin-top:12px}
.warn{background:#fff;border:1px dashed #d7d7e6;border-radius:12px;padding:12px;color:#503a46;font-size:13px}
.hl{box-shadow:0 0 0 3px rgba(127,164,255,.25)}

@media (max-width:720px){
  .scale{grid-template-columns:1fr 1fr;grid-auto-rows:auto}
}
</style>
</head>
<body data-id="time-money">
<main class="wrap" id="app">
  <header class="header">
    <div class="logo">⏳</div>
    <div>
      <h1>時の天秤診断 – あなたは時間派？お金派？</h1>
      <p class="sub">5軸×15問・5件法。総合TFI（時間フォーカス指数）と各軸のバーで表示。</p>
    </div>
  </header>

  <div class="sticky card" aria-live="polite">
    <span>🧭</span>
    <div class="progress" aria-label="回答進捗"><span id="prog"></span></div>
    <span class="small" id="progText">0/15</span>
    <button class="btn primary" id="btn-score">結果を見る</button>
  </div>

  <section class="card section">
    <h2>説明</h2>
    <p>直感で選んでください（全問必須・0〜4）。</p>
    
  </section>

  <section id="formArea" class="card section" aria-label="設問エリア">
    <h2>設問（全15問／各5択）</h2>
    <div id="qContainer"></div>
    <div class="section" style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" id="btn-clear">回答をクリア</button>
      <button class="btn primary" id="btn-score2">結果を見る</button>
      <a class="btn" href="/shindan/" id="btnBack" role="button">診断一覧に戻る</a>
    </div>
    <div class="warn">
      <strong>ご利用にあたって</strong><br>
      このコンテンツは<strong>エンタメ目的</strong>の自己理解ツールです。医療・診断・治療・助言には使えません。<br>
      <strong>最終判断はご自身で</strong>お願いします。重要な意思決定の唯一の根拠にはしないでください。<br>
      <strong>プライバシー</strong>：回答は端末内で処理・保存され、回答内容や個人を特定できる情報はサーバーに送信されません。結果表示時に匿名の件数カウントのみ送信する場合があります。
      
    </div>
  </section>

  <section id="result" class="card section" aria-live="polite">
    <div id="resEmpty">
      <div class="badge">まだ結果はありません</div>
      <p class="small">上の設問にすべて回答すると、こちらに結果が表示されます。</p>
    </div>

    <div id="resArea" class="hidden">
      <div class="res-head">
        <div class="ttl-big" id="titleText">—</div>
        <div class="pills">
          <span class="pill" id="pillTFI">TFI: —</span>
          <span class="pill" id="pillType">タイプ: —</span>
        </div>
      </div>

      

      <!-- 正方形ヒーロー（tNN.webp） -->
<div class="section">
  <div class="hero-square" role="region" aria-label="結果イメージ">
    <figure>
      <img id="heroImg" src="" alt="結果イメージ" loading="lazy" width="600" height="600">
    </figure>
    <figcaption>
      <div class="title-row">
        <div id="heroTitle" style="font-weight:800">—</div>
        <span class="badge-size" id="rangeBadge">—</span>
      </div>
      <div class="small" id="heroTag" style="margin-top:4px">—</div>
    </figcaption>
  </div>
  <!-- 結果コメント（画像の下に表示） -->
<div class="section" id="oneLine"></div>
</div>

<!-- 因子バー（NOH風） -->
<div class="section">
  <div class="small">各軸（0–100）</div>
  <div class="factors" id="factorBox" aria-label="各軸スコア（％）"></div>
</div>

      <div class="footer">
        <p class="small">※TFIは5軸（TA/DG/EX/MV/FT）の平均です。逆転項目は自動で反転採点しています。</p>
      </div>

      <div class="backline">
        <a class="btn" id="back2" href="/shindan/" aria-label="診断一覧に戻る">診断一覧に戻る</a>
      </div>
    </div>
  </section>
</main>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const STORAGE_KEY = "specimens:answers:time-money";

  // 軸ラベル
  const IMG_BASE = "/shindan/assets/results/time-money/"; // t01.webp..t05.webp
  const AXIS = {
    TA:{name:"余白感"},
    DG:{name:"手放し力"},
    EX:{name:"体験志向"},
    MV:{name:"移動効率"},
    FT:{name:"未来時間投資"}
  };

  // 質問定義（各3問・r:逆転）
  const Q = [
    // TA
    {axis:"TA", t:"やることが多い日でも、心に少しは余裕がある。", r:false},
    {axis:"TA", t:"週に一度は『予定を入れない時間』を意識的につくっている。", r:false},
    {axis:"TA", t:"自由に使える時間が少ないと感じる日が多い。", r:true},

    // DG
    {axis:"DG", t:"面倒な家事や事務は、必要ならお金を払って外注してもよい。", r:false},
    {axis:"DG", t:"配送料や手数料で、時間を買えるなら払う選択をすることがある。", r:false},
    {axis:"DG", t:"自分でできることは、お金を払ってまで他人に頼まない。", r:true},

    // EX
    {axis:"EX", t:"モノよりも、体験や学びにお金を使うことが多い。", r:false},
    {axis:"EX", t:"思い出になることを優先して予定を組むことがある。", r:false},
    {axis:"EX", t:"セールで安く買えるなら、時間がかかっても構わない。", r:true},

    // MV
    {axis:"MV", t:"早くて快適な移動手段に、追加料金を払うことがある。", r:false},
    {axis:"MV", t:"待ち時間が長い店は避けるか、事前に予約しておく。", r:false},
    {axis:"MV", t:"渋滞していても、無料の道を選びがちだ。", r:true},

    // FT（※3つ目が逆転）
    {axis:"FT", t:"今は手間でも、今後の時短になるなら取り組む。", r:false},
    {axis:"FT", t:"時短家電や自動化ツールにお金をかける価値があると思う。", r:false},
    {axis:"FT", t:"将来の時短のために今の時間を割くのは後回しにしがちだ。", r:true}
  ];
const LABELS = ["0 まったくない","1 あまりない","2 どちらとも","3 だいたい","4 とてもある"];

const TYPES = [
  {name:"時間最優先", range:[80,100], file:"t05.webp", alt:"時間最優先", tag:"自由時間と心の余裕を第一に置くタイプ。",
   one:`<div class="small">自由時間と心の余裕を第一に置く傾向。外注や予約で「待つ」を減らし、体験に投資しやすい。</div>
   <ul class="small"><li>月1で「フルオフ日」を確保</li><li>移動は最短＋事前予約</li><li>サブスクの棚卸しを四半期に1回</li></ul>`},
  {name:"やや時間", range:[65,79], file:"t04.webp", alt:"やや時間", tag:"基本は時間重視、節約も織り交ぜる。",
   one:`<div class="small">基本は時間重視。必要な場面では節約も織り交ぜ、外注・自動化をバランス良く使う。</div>
   <ul class="small"><li>待ち30分超は代替案を用意</li><li>配送料の上限を自分ルール化</li><li>家事は面倒トップ3だけ外注候補</li></ul>`},
  {name:"バランス", range:[45,64], file:"t03.webp", alt:"バランス", tag:"状況で切り替える現実派。",
   one:`<div class="small">忙しい時期は時間を買い、余裕がある時期は自分で手を動かす。</div>
   <ul class="small"><li>繁忙/閑散の切替基準を事前定義</li><li>並ぶ店はモバイルオーダー有無で選ぶ</li><li>モノは「使用時間」で判断</li></ul>`},
  {name:"やや金銭", range:[30,44], file:"t02.webp", alt:"やや金銭", tag:"費用対効果に敏感。",
   one:`<div class="small">配送料や手数料は控えめで、モノ購買の優先がやや強い。</div>
   <ul class="small"><li>時給換算で上限額を一度設定</li><li>無料ルートでも渋滞30分超は再検討</li><li>クーポン待ちは締切を決める</li></ul>`},
  {name:"金銭最優先", range:[0,29], file:"t01.webp", alt:"金銭最優先", tag:"貯蓄・収入を最重視。",
   one:`<div class="small">長時間の自己対応や並びも許容しやすい一方、ゆとりは後回しになりがち。</div>
   <ul class="small"><li>週1の「余白30分」を先に確保</li><li>時短家電は中古/レンタルで試す</li><li>待ち時間は学び/運動に置換</li></ul>`}
];

  // DOM
  const qContainer = document.getElementById("qContainer");
  const prog = document.getElementById("prog");
  const progText = document.getElementById("progText");
  const resEmpty = document.getElementById("resEmpty");
  const resArea = document.getElementById("resArea");
  const titleText = document.getElementById("titleText");
  const pillTFI = document.getElementById("pillTFI");
  const pillType = document.getElementById("pillType");
  const oneLine = document.getElementById("oneLine");

  // 質問UI生成（5件法）
  function buildQuestions(){
    let html = "";
    Q.forEach((q,i)=>{
      const n = i+1;
      html += `
        <div class="qrow">
          <div class="ttl">Q${n}. ${q.t}${q.r?' <span class="small" title="逆転項目（自動で採点反転）">（R）</span>':''}</div>
       <div class="scale" role="radiogroup" aria-label="${q.t}">
  ${[0,1,2,3,4].map(v=>`
    <div style="position:relative">
      <input id="q${n}-${v}" type="radio" name="Q${n}" value="${v}">
      <label for="q${n}-${v}">${LABELS[v]}</label>
    </div>`).join("")}
</div>
          </div>
        </div>`;
    });
    qContainer.innerHTML = html;
    document.querySelectorAll('#qContainer input[type="radio"]').forEach(el=>{
      el.addEventListener('change', updateProgress, {passive:true});
    });
    updateProgress();
  }

  function updateProgress(){
  const total = Q.length;
  let answered = 0;
  for(let i=1;i<=total;i++){
    if(document.querySelector(`input[name="Q${i}"]:checked`)) answered++;
  }
  const pct = Math.round(100*answered/total);
  const bar = document.getElementById('prog');
  const txt = document.getElementById('progText');
  if(bar) bar.style.width = pct + "%";
  if(txt) txt.textContent = `${answered}/${total}`;

  // ARIA（ここでだけ設定する）
  const shell = document.querySelector('.progress');
  if(shell){
    shell.setAttribute('role','progressbar');
    shell.setAttribute('aria-valuemin','0');
    shell.setAttribute('aria-valuemax', String(total));
    shell.setAttribute('aria-valuenow', String(answered));
    shell.setAttribute('aria-label', `回答進捗：${answered} / ${total}`);
  }
}


  function readAnswers(){
    const missing = [];
    const values = [];
    for(let i=1;i<=Q.length;i++){
      const el = document.querySelector(`input[name="Q${i}"]:checked`);
      if(!el) missing.push(i);
      else values.push(parseInt(el.value,10));
    }
    return {missing, values};
  }

  function toPct(arr){
    const m = arr.reduce((a,b)=>a+b,0)/arr.length; // 0..4
    return Math.round((m / 4) * 100); // 0..100
}

  function score(values){
    const byAxis = {TA:[],DG:[],EX:[],MV:[],FT:[]};
    values.forEach((v,i)=>{
      const def = Q[i];
      const vv = def.r ? (4 - v) : v;
      byAxis[def.axis].push(vv);
    });
    const axisPct = Object.fromEntries(Object.keys(byAxis).map(k=>[k, toPct(byAxis[k])]));
    const TFI = Math.round((axisPct.TA + axisPct.DG + axisPct.EX + axisPct.MV + axisPct.FT)/5);
    return {axisPct, TFI};
  }

  function pickType(tfi){
    return TYPES.find(t=> tfi>=t.range[0] && tfi<=t.range[1]) || TYPES[2];
  }

 
  // NOH風：因子バーを描画
function renderFactors(axisPct){
  const rows = [
    ["余白感 (TA)","TA"],
    ["手放し力 (DG)","DG"],
    ["体験志向 (EX)","EX"],
    ["移動効率 (MV)","MV"],
    ["未来時間投資 (FT)","FT"],
  ];
  const html = rows.map(([label,key])=>{
    const v = Math.max(0, Math.min(100, axisPct[key]||0));
    return `
      <div class="meter">
        <div class="row"><div class="name">${label}</div><div class="pct">${v}%</div></div>
        <div class="mbar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="${v}">
          <span style="width:${v}%"></span>
        </div>
      </div>`;
  }).join("");
  const box = document.getElementById("factorBox");
  if(box) box.innerHTML = html;
}

  function compute(){
    const {missing, values} = readAnswers();
    if(missing.length){
      alert(`未回答があります（${missing.slice(0,6).map(n=>"Q"+n).join(", ")}${missing.length>6?" ほか":""}）。すべての15問に回答してください。`);
      const first = missing[0];
      const node = document.querySelector(`[name="Q${first}"]`)?.closest(".qrow");
      if(node){ node.scrollIntoView({behavior:"smooth", block:"center"}); node.classList.add("hl"); setTimeout(()=>node.classList.remove("hl"),1600); }
      return;
    }
    try{
      localStorage.setItem(STORAGE_KEY, JSON.stringify(values));
      localStorage.setItem('specimens:last', JSON.stringify({ id: 'time-money', title: '時の天秤診断', href: location.pathname }));
    }catch{}

   const r = score(values);
const typ = pickType(r.TFI);

// 表示
resEmpty.classList.add("hidden");
resArea.classList.remove("hidden");
titleText.textContent = `あなたの天秤は「${typ.name}」寄り`;
pillTFI.textContent = `TFI: ${r.TFI}`;
pillType.textContent = `タイプ: ${typ.name}`;
oneLine.innerHTML = typ.one;

// 画像とキャプション
const hero = document.getElementById('heroImg');
if(hero){
  hero.src = IMG_BASE + typ.file;
  hero.alt = typ.alt || '結果イメージ';
}
const ht = document.getElementById('heroTitle'); if(ht) ht.textContent = typ.name;
const rb = document.getElementById('rangeBadge'); if(rb) rb.textContent = `TFI ${r.TFI}`;
const tag= document.getElementById('heroTag'); if(tag) tag.textContent = typ.tag;

// 因子バー（NOH風）
renderFactors(r.axisPct);

try{
  document.dispatchEvent(new Event('result:ready'));
  localStorage.setItem('specimens:last', JSON.stringify({ id: 'time-money', title: '時の天秤診断', href: location.pathname }));
}catch(_){}
document.getElementById("result").scrollIntoView({behavior:"smooth", block:"start"});
}

  function restore(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return;
      const saved = JSON.parse(raw);
    (saved||[]).forEach((v,i)=>{
  const vv = (v>4) ? (v-1) : v; // 旧1..5 → 新0..4へ移行
  const el = document.querySelector(`input[name="Q${i+1}"][value="${vv}"]`);
  if(el){ el.checked = true; }
});
      updateProgress();
    }catch{}
  }

  // 初期化
  buildQuestions();
  restore();
  document.getElementById("btn-score").addEventListener("click", compute);
  document.getElementById("btn-score2").addEventListener("click", compute);
  document.getElementById("btn-clear").addEventListener("click", ()=>{
    if(!confirm("すべての回答をクリアしますか？")) return;
    document.querySelectorAll('#qContainer input[type="radio"]').forEach(el=>el.checked=false);
    try{ localStorage.removeItem(STORAGE_KEY); }catch{}
    updateProgress();
    resEmpty.classList.remove("hidden");
    resArea.classList.add("hidden");
    document.getElementById("app").scrollIntoView({behavior:"smooth", block:"start"});
  });
  document.getElementById('btnBack').addEventListener('click', saveLast);
  document.getElementById('back2').addEventListener('click', saveLast);
  function saveLast(){
    try{
      const payload = { id: 'time-money', title: '時の天秤診断', href: location.pathname };
      localStorage.setItem('specimens:last', JSON.stringify(payload));
    }catch(_e){}
  }
});
</script>
<script>
/* ============================================================
   診断ページ共通スニペット（コピペ用）
   1) 回答の自動保存・自動復元（入力中も逐次保存）
   2) 結果表示タイミングで「済」＋ あなたのLv +1
   3) みんなのこころLv（CountAPI）に +1（失敗は無視）
   ------------------------------------------------------------
   ★置き場所：各診断HTMLの </body> の直前
   ★ページID：<body data-id="xxxxx"> を推奨（未設定でも動作）
============================================================ */
(function(){
  'use strict';

  // ===== 固定キー：index.html と合わせてあります =====
  var DONE_KEY   = 'specimens:open:byid';   // 診断ごとの「済」マップ
  var TOTAL_KEY  = 'specimens:open:total';  // あなたのこころLv（合計）
  var GLOBAL_LAST= 'specimens:open:global:last'; // みんなのLvの前回表示キャッシュ

  // ===== このページのID =====
  var MY_ID = (document.body && document.body.getAttribute('data-id')) || 'unknown';

  // ===== 回答保存ストレージ（この診断だけの箱） =====
  var ANSWER_KEY = 'specimens:answers:' + MY_ID;

  // ===== みんなのLv（CountAPI設定） =====
  var COUNTAPI_NS  = 'haisuikounozarigani_shindan';
  var COUNTAPI_KEY = 'specimens_open_total';
  function countapiHit(){
    var url = 'https://api.countapi.xyz/hit/'+COUNTAPI_NS+'/'+COUNTAPI_KEY;
    if(navigator.sendBeacon){
      try{ navigator.sendBeacon(url); }catch(_){}
    }else{
      fetch(url, {mode:'cors', cache:'no-store', keepalive:true}).catch(function(){});
    }
  }

  // ---------- 回答の保存/復元 ----------
  function loadState(){
    try{ return JSON.parse(localStorage.getItem(ANSWER_KEY) || '{}'); }catch(_){ return {}; }
  }
  function saveState(obj){
    try{ localStorage.setItem(ANSWER_KEY, JSON.stringify(obj)); }catch(_){}
  }
  function saveField(el){
    if(!el || !el.name) return;
    var st = loadState();
    var nm = el.name;

    if(el.type === 'radio'){
      // ラジオは選ばれた value を保存
      var chosen = (el.form || document).querySelector('input[type="radio"][name="'+nm+'"]:checked');
      st[nm] = chosen ? {t:'r', v: chosen.value} : {t:'r', v:null};
    }else if(el.type === 'checkbox'){
      // チェックボックスは同名グループのチェック済み value 配列
      var all = (el.form || document).querySelectorAll('input[type="checkbox"][name="'+nm+'"]');
      var vals = [];
      all.forEach(function(c){ if(c.checked) vals.push(c.value || 'on'); });
      st[nm] = {t:'c', v: vals};
    }else if(el.tagName==='SELECT'){
      if(el.multiple){
        var arr=[]; [].slice.call(el.options).forEach(function(o){ if(o.selected) arr.push(o.value); });
        st[nm] = {t:'m', v: arr};
      }else{
        st[nm] = {t:'s', v: el.value};
      }
    }else{
      // text / number / textarea など
      st[nm] = {t:'t', v: el.value};
    }
    saveState(st);
  }
  function restoreOnce(){
    var st = loadState();
    var names = Object.keys(st);
    if(!names.length) return false;

    names.forEach(function(nm){
      var info = st[nm]; if(!info) return;

      if(info.t==='r'){
        var r = document.querySelector('input[type="radio"][name="'+nm+'"][value="'+CSS.escape(String(info.v))+'"]');
        if(r){ r.checked = true; r.dispatchEvent(new Event('change',{bubbles:true})); }
      }else if(info.t==='c'){
        var all = document.querySelectorAll('input[type="checkbox"][name="'+nm+'"]');
        var set = new Set(info.v||[]);
        all.forEach(function(c){ c.checked = set.has(c.value || 'on'); });
      }else if(info.t==='m'){
        var sel = document.querySelector('select[name="'+nm+'"]');
        if(sel){
          var setm = new Set(info.v||[]);
          [].slice.call(sel.options).forEach(function(o){ o.selected = setm.has(o.value); });
        }
      }else if(info.t==='s'){
        var s = document.querySelector('select[name="'+nm+'"]');
        if(s){ s.value = info.v; }
      }else{
        var t = document.querySelector('[name="'+nm+'"]');
        if(t){ t.value = info.v==null? '' : String(info.v); }
      }
    });
    // プログレス等を更新したいUIのため、軽く change を投げる
    try{
      document.dispatchEvent(new Event('change', {bubbles:true}));
    }catch(_){}
    return true;
  }
  // 入力監視（保存）
  document.addEventListener('change', function(e){
    var el = e.target;
    if(!(el instanceof HTMLElement)) return;
    if(el.matches('input[name], select[name], textarea[name]')) saveField(el);
  }, true);
  document.addEventListener('input', function(e){
    var el = e.target;
    if(!(el instanceof HTMLElement)) return;
    if(el.matches('input[type="text"][name], input:not([type])[name], textarea[name]')) saveField(el);
  }, true);

  // 復元は「入力が描画されてから」一度だけ試みる（動的生成にも対応）
  (function restoreWhenReady(){
    var TRY_MAX=12, tries=0;
    function tick(){
      tries++;
      // 入力が一つでも見つかってから復元
      var hasAny = document.querySelector('input[name], select[name], textarea[name]');
      if(hasAny){
        restoreOnce(); return;
      }
      if(tries<TRY_MAX){ setTimeout(tick, 300); }
    }
    if(document.readyState==='complete' || document.readyState==='interactive'){ tick(); }
    else document.addEventListener('DOMContentLoaded', tick);
  })();

  // リセット系ボタンがあれば保存も削除（#btnReset / data-role="reset" を想定）
  function clearAnswers(){
    try{ localStorage.removeItem(ANSWER_KEY); }catch(_){}
  }
  document.addEventListener('click', function(e){
    var t = e.target;
    if(!(t instanceof HTMLElement)) return;
    if(t.id==='btnReset' || t.matches('[data-role="reset"]')) clearAnswers();
  }, true);

  // ---------- 結果確定で「済」＋Lv加算 ----------
  var marked = false;
  function markOnce(){
    if(marked) return; marked = true;
    try{
      // 1) あなたのこころLv 合計 +1
      var total = (+localStorage.getItem(TOTAL_KEY) || 0) + 1;
      localStorage.setItem(TOTAL_KEY, String(total));

      // 2) この診断の「済」を +1（他タブ即時反映用にタイムスタンプ混ぜる）
      var map={}; try{ map = JSON.parse(localStorage.getItem(DONE_KEY) || '{}'); }catch(_){}
      map[MY_ID] = (map[MY_ID] || 0) + 1;
      localStorage.setItem(DONE_KEY, JSON.stringify(Object.assign({}, map, {_ts: Date.now()})));

      // 3) みんなのこころLv +1（表示は index 側で取得／ここでは送るだけ）
      countapiHit();
      // ついでに前回キャッシュも+1（index初期表示の見栄え改善）
      try{
        var last = (+localStorage.getItem(GLOBAL_LAST) || 0) + 1;
        localStorage.setItem(GLOBAL_LAST, String(last));
      }catch(_){}
    }catch(_){}
  }

  // A) 結果が描画された合図（推奨：各ページの集計完了時に dispatch してください）
  //   例）document.dispatchEvent(new Event('result:ready'));
  document.addEventListener('result:ready', markOnce);

  // B) フォールバック：結果UIが見えてから2秒後に一度だけ実行（戻る無しでも確実に「済」）
  setTimeout(markOnce, 2000);
})();
</script>
</body>
</html>