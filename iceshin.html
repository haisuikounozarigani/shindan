<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>冷酷アイスクリーム診断（Mach-IV準拠・20問）</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{ --brand:#b86b77; --chip:#f4f1ef; --bg:#fffaf6; }
    body{font-family:sans-serif;background:var(--bg);color:#333;padding:20px}
    h1{text-align:center;color:var(--brand);margin:0 0 14px}
    .legend{max-width:860px;margin:0 auto 16px;font-size:.95em;color:#555}
    .progress-wrap{max-width:860px;margin:0 auto 18px}
    .progress{height:10px;background:#eee;border-radius:999px;overflow:hidden}
    .bar{height:100%;width:0;background:var(--brand);transition:width .2s}
    .count{margin-top:6px;color:#666;font-size:.9em;text-align:right}

    form{max-width:860px;margin:auto;background:#fff;padding:18px;border-radius:12px;box-shadow:0 0 12px #e5d4cf}
    .question{margin:20px 0}
    .qhead{display:flex;justify-content:space-between;gap:8px;align-items:center;margin:0 0 8px;font-weight:600}
    .qstatus{font-weight:600;font-size:.85em;color:#888}
    .qstatus.done{color:var(--brand)}
    .scale{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
    .chip{display:block;position:relative;border-radius:10px;background:var(--chip);text-align:center;padding:12px 8px;cursor:pointer;border:2px solid #e9e1de;user-select:none}
    .chip input{position:absolute;inset:0;opacity:0}
    .chip span{display:block}
    .chip input:checked + span{
      background:var(--brand);color:#fff;border-radius:8px;padding:8px 6px;
      box-shadow:0 0 0 2px var(--brand) inset, 0 4px 10px rgba(184,107,119,.25);
      transform:scale(1.02);
    }
    .chip:hover{border-color:#d7c6c2}
    .chip input:focus-visible + span{outline:3px solid #ffd9e1;outline-offset:2px;border-radius:8px}
    .btn{display:block;margin:22px auto 0;padding:12px 22px;font-size:1.1em;background:var(--brand);color:#fff;border:none;border-radius:10px;cursor:pointer}

    #result{max-width:860px;margin:22px auto 0;background:#fff;border:1px solid #eadad6;padding:18px;border-radius:10px}
    #result h2{margin:0 0 8px;color:#b16370}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .tag{display:inline-block;background:#f6eef0;border:1px solid #e0cfd0;border-radius:999px;padding:6px 12px;font-size:.9em;color:#7b4d57}
    .lead{margin:8px 0 10px;color:#555}
    .img{width:100%;height:auto;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,.08);margin:8px 0}
    .actions{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
    .a-btn{flex:1;text-align:center;text-decoration:none;background:#f7f2f1;border:1px solid #e3d2cd;padding:10px;border-radius:10px;color:#7b4d57;font-weight:700}
    .a-btn:hover{background:#f1e7e5}
  </style>
</head>
<body>
  <h1>🍦 冷酷アイスクリーム診断（Mach-IV準拠）</h1>
  <div class="legend">5件法：1 まったく当てはまらない ／ 2 あまり当てはまらない ／ 3 どちらともいえない ／ 4 やや当てはまる ／ 5 とても当てはまる</div>

  <div class="progress-wrap">
    <div class="progress"><div id="bar" class="bar"></div></div>
    <div id="count" class="count">0 / 20 回答</div>
  </div>

  <form id="quizForm" aria-live="polite"></form>
  <button class="btn" type="button" onclick="calculate()">診断する</button>

  <div id="result" style="display:none;"></div>

  <script>
    // Mach-IV 20項目（rev:true は逆転）
    const items = [
      { text: "目的のためなら本音を隠すことも必要だと思う", rev: false },
      { text: "道徳的に正しいと確信できないなら、行動すべきではない", rev: true },
      { text: "出世する人の多くは、正直で潔白だと思う", rev: true },
      { text: "重要人物にはお世辞を使うのが賢いやり方だ", rev: false },
      { text: "たとえ不利でも、他人にうそをつくべきではない", rev: true },
      { text: "人を動かすには、相手が聞きたいことを言うのが一番だ", rev: false },
      { text: "誰かを完全に信頼するのは危険だと思う", rev: false },
      { text: "近道を使わず努力すれば、必ず報われるものだ", rev: true },
      { text: "人は基本的に善良で、公正に振る舞うと思う", rev: true },
      { text: "成功には、時にルールを曲げることが欠かせない", rev: false },
      { text: "チャンスがあっても、不公平な利得は絶対に得ない", rev: true },
      { text: "うまく立ち回るには、多少の“操作”は必要だ", rev: false },
      { text: "人前では、本心を見せない方が安全だと思う", rev: false },
      { text: "たとえ損でも、正直さを最優先するべきだ", rev: true },
      { text: "多くの人は、見返りがなければ協力しないと思う", rev: false },
      { text: "人間関係では、誠意さえあれば十分うまくいく", rev: true },
      { text: "交渉では“規範”より“結果”を重視するべきだ", rev: false },
      { text: "人を利用するくらいなら、機会を逃してもよい", rev: true },
      { text: "重要な情報は、有利になるまで伏せておくべきだ", rev: false },
      { text: "約束は状況が変わっても、必ず守るべきだ", rev: true }
    ];

    const scaleLabels = [
      "1（まったく当てはまらない）","2（あまり当てはまらない）","3（どちらともいえない）","4（やや当てはまる）","5（とても当てはまる）"
    ];

    const TAGLINE = {
      "ソフトクリーム":"駆け引きゼロ、直球すぎて逆に最強",
      "バニラアイス":"基本は正攻法、ときどき小ワザ",
      "ジェラート":"甘さと冷静さのスイッチャー",
      "ソルベ":"氷点下の冷静、勝ち筋直行",
      "クリスタルアイス":"氷の策士、最適解を取りにいく"
    };

    // タイプ → 画像フォルダのスラッグ
    const TYPE_TO_SLUG = {
      "ソフトクリーム":"softcream",
      "バニラアイス":"vanilla",
      "ジェラート":"gelato",
      "ソルベ":"sorbet",
      "クリスタルアイス":"crystalice"
    };

    const form   = document.getElementById("quizForm");
    const bar    = document.getElementById("bar");
    const count  = document.getElementById("count");
    const result = document.getElementById("result");

    // 質問生成
    items.forEach((it, i) => {
      const div = document.createElement("div");
      div.className = "question";
      const qid = `q${i}`;
      let options = "";
      for (let n = 0; n < 5; n++) {
        const id = `${qid}_${n+1}`;
        options += `
          <label class="chip" for="${id}">
            <input id="${id}" type="radio" name="${qid}" value="${n+1}" />
            <span>${scaleLabels[n]}</span>
          </label>`;
      }
      div.innerHTML = `
        <p class="qhead"><span>Q${i+1}. ${it.text}</span><span id="${qid}_status" class="qstatus">未選択</span></p>
        <div class="scale">${options}</div>`;
      form.appendChild(div);
    });

    // 進捗表示
    document.addEventListener("change", (e) => {
      if (!e.target.name?.startsWith("q")) return;
      const qid = e.target.name;
      const st = document.getElementById(`${qid}_status`);
      if (st){ st.textContent = "選択済"; st.classList.add("done"); }
      updateProgress();
    });
    function updateProgress(){
      const checked = Array.from(document.querySelectorAll('input[type="radio"]:checked'));
      const answeredQs = new Set(checked.map(i=>i.name)).size;
      const totalQ = items.length;
      const pct = Math.round(answeredQs/totalQ*100);
      bar.style.width = pct + "%";
      count.textContent = `${answeredQs} / ${totalQ} 回答`;
    }

    // 画像セット（01のみ）。PNG→だめならWebPにフォールバック
    function setImage(imgEl, slug){
      const base = `/shindan/assets/results/ice/${slug}/01`;
      imgEl.onerror = null;
      imgEl.src = `${base}.png`;
      imgEl.onerror = () => { if (imgEl.src.endsWith('.png')) imgEl.src = `${base}.webp`; };
    }

    function calculate() {
      // 未回答チェック
      for (let i = 0; i < items.length; i++) {
        if (!document.querySelector(`input[name="q${i}"]:checked`)) {
          alert(`未回答の設問があります（Q${i+1}）`);
          return;
        }
      }
      // 採点（逆転項目は 6 - 値）
      let sum = 0;
      for (let i = 0; i < items.length; i++) {
        let v = parseInt(document.querySelector(`input[name="q${i}"]:checked`).value,10);
        if (items[i].rev) v = 6 - v;
        sum += v;
      }
      // 20〜100点 → 0〜100% に線形変換
      const machPct = Math.round((sum - 20) / 80 * 100);

      // タイプ判定
      let type="";
      if (machPct <= 20) type="ソフトクリーム";
      else if (machPct <= 40) type="バニラアイス";
      else if (machPct <= 60) type="ジェラート";
      else if (machPct <= 80) type="ソルベ";
      else type="クリスタルアイス";

      const tagline = TAGLINE[type] || "";
      const slug = TYPE_TO_SLUG[type];

      // 結果描画（サイト内画像1枚）
      result.style.display = "block";
      result.innerHTML = `
        <h2>結果</h2>
        <div class="row">
          <span class="tag">冷酷度：${machPct}%</span>
          <span class="tag">${type}</span>
        </div>
        <p class="lead">一言まとめ：${tagline}</p>
        <img id="ice-img" class="img" alt="${type} の結果画像" decoding="async">
        <div class="actions">
          <a class="a-btn" href="/shindan/">🔙 診断一覧へ戻る</a>
          <a class="a-btn" href="#" onclick="window.scrollTo({top:0,behavior:'smooth'});return false;">🔁 もう一度やる</a>
        </div>
      `;

      // 01画像を表示
      const img = document.getElementById('ice-img');
      setImage(img, slug);

      window.scrollTo(0, document.body.scrollHeight);
    }
  </script>
</body>
</html>
