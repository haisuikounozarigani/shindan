<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>認知プロファイル・チャレンジ（CHC簡易版）</title>
<style>
  :root{ --brand:#8e5a5a; --bg:#fffdf8; --card:#ffffff; --muted:#666; --ok:#1a7f37; --ng:#b3261e; }
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,"Noto Sans JP",sans-serif;background:linear-gradient(var(--bg),#f4f0e9);margin:0;color:#333}
  .wrap{max-width:1024px;margin:28px auto;padding:0 16px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
  h1{margin:0;color:var(--brand);font-size:clamp(20px,3.4vw,28px)}
  a.back{font-size:.9em;color:#835f5f;text-decoration:none;border:1px solid #e4d9d9;padding:6px 10px;border-radius:10px;background:#fff}
  .card{background:var(--card);border:1px solid #eee;border-radius:14px;padding:16px 18px;margin:14px 0;box-shadow:0 1px 0 rgba(0,0,0,.03)}
  .card.tall{padding-bottom:36px}
  .row{margin:12px 0}
  .muted{color:var(--muted);font-size:.95em}
  button{padding:10px 16px;border-radius:10px;border:1px solid #cfcfcf;background:#fff;cursor:pointer}
  button.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
  button:disabled{opacity:.5;cursor:not-allowed}
  input[type="number"],input[type="text"],select{padding:10px;font-size:16px;border:1px solid #ddd;border-radius:10px}
  .tabs{display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap}
  .tab{padding:8px 12px;border-radius:999px;border:1px solid #e5dede;background:#fff;color:#624c4c;cursor:pointer}
  .tab.active{background:var(--brand);color:#fff;border-color:var(--brand)}
  .kpis{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .kpi{padding:10px;border:1px solid #eee;border-radius:12px;background:#fff}
  .ok{color:var(--ok)} .ng{color:var(--ng)}
  #digitBox,#digitBox2{font-size:44px;text-align:center;min-height:56px;letter-spacing:.2em}
  .grid{display:grid;grid-template-columns:repeat(3,72px);gap:10px;justify-content:center;margin:12px 0}
  .cell{width:72px;height:72px;border-radius:12px;border:1px solid #ddd;background:#faf9f7;cursor:pointer;transition:transform .06s}
  .cell.flash{background:#d8c0c0}
  .cell.sel{outline:3px solid #8e5a5a55}
  .center{display:flex;justify-content:center;align-items:center;min-height:60px;font-size:42px;letter-spacing:.04em}
  canvas{max-width:100%;height:auto}
  .small{font-size:.9em}
  .choices{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
  .choice{padding:10px;border:1px solid #ddd;border-radius:10px;background:#fff;cursor:pointer}
  .choice.selected{border-color: var(--brand); box-shadow:0 0 0 2px rgba(142,90,90,.15) inset}
  .choice.correct{border-color:#1a7f37}
  .choice.wrong{border-color:#b3261e}
  .pair{display:flex;gap:10px;justify-content:center;align-items:center;font-size:24px}
  .pill{display:inline-block;padding:2px 8px;border:1px solid #e4d9d9;border-radius:999px;background:#fff;font-size:.86em;margin-left:6px}

  /* 下側に“押しやすい余白”を確保したボタン行 */
  .controls-row{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:16px}
  .btnbar{display:grid;grid-template-columns:repeat(2,minmax(130px,1fr));gap:12px;max-width:560px;margin:20px auto 8px}
  .btnbar .wide{grid-column:1 / -1}
  .bigbtn{padding:14px 16px;font-size:18px;border-radius:12px}
  .soft{background:#fff;border-color:#e5dede}

  /* Gv/Gsの表示域を“下側広め”に（端っこすぎない） */
  .gv-area{min-height:400px;display:flex;flex-direction:column;align-items:center;justify-content:center;margin-bottom:12px}
  .gs-area{min-height:280px;display:flex;flex-direction:column;align-items:center;justify-content:center;margin-bottom:12px}

  /* 準備オーバーレイ */
  .prep{position:fixed;inset:0;background:rgba(255,253,248,.92);display:none;align-items:center;justify-content:center;z-index:999}
  .prep .box{background:#fff;border:1px solid #eee;padding:16px 22px;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.08);color:#624c4c}
  .prep .title{font-weight:700;margin-bottom:4px}
  .prep .dots::after{content:"";display:inline-block;width:1ch;animation:dots 1.1s infinite steps(4,end)}
  @keyframes dots{0%{content:""}25%{content:"."}50%{content:".."}75%{content:"..."}100%{content:""}}

  /* Gf 見やすいグリッド */
  .qwrap{margin:8px 0}
  .rowgrid{display:grid;gap:6px;margin:4px 0}
  .cellg{height:36px;min-width:42px;display:flex;align-items:center;justify-content:center;border:1px solid #e0d7d7;border-radius:8px;background:#fbfaf8;font-weight:600}

  /* モバイル最適化 */
  @media (max-width:560px){
    .grid{grid-template-columns:repeat(3,56px);gap:8px}
    .cell{width:56px;height:56px;border-radius:10px}
    #digitBox,#digitBox2{font-size:36px}
    .pair{font-size:20px}
    .choices{grid-template-columns:repeat(2,1fr)}
    h1{font-size:20px}
    .wrap{margin:18px auto}
    canvas#gv_left, canvas#gv_right{width:150px !important;height:150px !important}
    canvas#radar{width:100% !important;height:auto !important}
    .btnbar{grid-template-columns:1fr 1fr}
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>認知プロファイル・チャレンジ（CHC簡易版）<span class="pill">練習なし・一発計測</span></h1>
    <a class="back" href="https://haisuikounozarigani.github.io/shindan/">診断一覧に戻る</a>
  </header>

  <div class="card">
    <p class="muted">CHC理論の広範能力（Gf/Gc/Gv/Gs/Gwm）を簡易測定。ヒントは出しません（解き方は非表示）。</p>
    <div class="kpis">
      <div class="kpi"><b>総合（CCI）</b><br><div id="overall">未実施</div></div>
      <div class="kpi"><b>詳細</b><br><div class="muted" id="detail">各タスク→能力別z→CCI。％位と「上位◯％」を表示。</div></div>
    </div>
  </div>

  <div class="tabs">
    <button class="tab active" data-tab="gwm">Gwm（作動記憶）</button>
    <button class="tab" data-tab="gf">Gf（流動性推理）</button>
    <button class="tab" data-tab="gc">Gc（結晶性）</button>
    <button class="tab" data-tab="gv">Gv（視覚）</button>
    <button class="tab" data-tab="gs">Gs（処理速度）</button>
    <button class="tab" data-tab="result">結果</button>
  </div>

  <!-- 準備オーバーレイ -->
  <div class="prep" id="prep">
    <div class="box">
      <div class="title">準備してください</div>
      <div class="muted dots">まもなく提示します</div>
    </div>
  </div>

  <!-- GWM -->
  <section class="card" id="gwm">
    <h2>Gwm（作動記憶）</h2>
    <div class="muted small">停止規則：各レベル最大2試行。1回成功で次レベル、2回失敗で終了。採点後<span id="delayInfo">2.5秒</span>待ってから次へ。</div>

    <h3>数字スパン（順向）</h3>
    <div class="row">
      <label>開始桁数：<input id="t1_start" type="number" min="3" max="9" value="4"></label>
      <label style="margin-left:12px">表示速度（ms/桁）：<input id="t1_ms" type="number" min="200" max="1500" value="600"></label>
    </div>
    <div class="row" id="digitBox" aria-live="off"></div>
    <div class="row"><input id="t1_answer" type="text" placeholder="数字列（例: 4192）" disabled></div>
    <div class="controls-row">
      <button id="t1_startBtn" class="primary">開始</button>
      <button id="t1_check" disabled>採点</button>
      <button id="t1_abortBtn">中断</button>
    </div>
    <div class="row" id="t1_feedback"></div>
    <div class="row muted small" id="t1_state">未開始</div>
    <hr>

    <h3>数字スパン（逆向）</h3>
    <div class="row">
      <label>開始桁数：<input id="t2_startN" type="number" min="3" max="8" value="3"></label>
      <label style="margin-left:12px">表示速度（ms/桁）：<input id="t2_ms" type="number" min="200" max="1500" value="650"></label>
    </div>
    <div class="row" id="digitBox2" aria-live="off"></div>
    <div class="row"><input id="t2_answer" type="text" placeholder="逆順で（例: 2914）" disabled></div>
    <div class="controls-row">
      <button id="t2_startBtn" class="primary">開始</button>
      <button id="t2_check" disabled>採点</button>
      <button id="t2_abortBtn">中断</button>
    </div>
    <div class="row" id="t2_feedback"></div>
    <div class="row muted small" id="t2_state">未開始</div>
    <hr>

    <h3>視空間パターン（3×3）</h3>
    <div class="row small muted">必要数だけ選択できます（<span id="t3_sel_info">0/—</span>）。必要数に達すると以降のクリックは無視します。<span class="pill" id="t3_badge" style="display:none">満点</span></div>
    <div class="row">
      <label>開始長：<input id="t3_start" type="number" min="3" max="7" value="3"></label>
      <label style="margin-left:12px">表示速度（ms/マス）：<input id="t3_ms" type="number" min="250" max="1500" value="600"></label>
    </div>
    <div class="grid" id="grid" aria-live="off"></div>
    <div class="controls-row">
      <button id="t3_startBtn" class="primary">開始</button>
      <button id="t3_check" disabled>採点</button>
      <button id="t3_abortBtn">中断</button>
    </div>
    <div class="row" id="t3_feedback"></div>
    <div class="row muted small" id="t3_state">未開始</div>
    <hr>

    <h3>2-back（更新）</h3>
    <details class="small muted" style="margin-bottom:8px">
      <summary>2-backの説明（タップで展開）</summary>
      画面中央に1文字ずつ表示されます。<b>2つ前と同じ文字が出た時だけ</b>、スペースキーまたは「反応」ボタンを押してください。<br>
      例）A → B → <b>A</b> → C … の太字Aは2つ前のAと同じなので反応。<br>
      押し間違いは減点、押し忘れも減点です。
    </details>
    <div class="row">
      <label>表示時間（ms/刺激）：<input id="t4_ms" type="number" min="600" max="2000" value="1000"></label>
      <label style="margin-left:12px">インターバル（ms）：<input id="t4_gap" type="number" min="100" max="1000" value="180"></label>
    </div>
    <div class="center" id="t4_stim" aria-live="off">—</div>
    <div class="controls-row">
      <button id="t4_startBtn" class="primary">開始</button>
      <button id="t4_hitBtn" disabled>反応（スペース）</button>
      <button id="t4_abortBtn">中断</button>
    </div>
    <div class="row" id="t4_feedback"></div>
    <div class="row muted small" id="t4_state">未開始</div>
  </section>

  <!-- GF -->
  <section class="card" id="gf" style="display:none">
    <h2>Gf（流動性推理）— 行列推理</h2>
    <div class="muted small">12問・制限時間なし（簡易版）。選択後は<b>提出</b>で採点。</div>
    <div id="gf_body"></div>
    <div class="controls-row"><button id="gf_submit" class="primary">提出して採点</button></div>
    <div class="row" id="gf_feedback"></div>
  </section>

  <!-- GC -->
  <section class="card" id="gc" style="display:none">
    <h2>Gc（結晶性）— 類義語選択</h2>
    <div class="muted small">12問・制限時間なし（簡易版）。選択後は<b>提出</b>で採点。</div>
    <div id="gc_body"></div>
    <div class="controls-row"><button id="gc_submit" class="primary">提出して採点</button></div>
    <div class="row" id="gc_feedback"></div>
  </section>

  <!-- GV：時間内に何問正解できるか（試行無制限） -->
  <section class="card tall" id="gv" style="display:none">
    <h2>Gv（視覚）— 回転同一判断（時間制：できるだけ解く）</h2>
    <div class="muted small">左のパターンを回転したものが右と<b>同一</b>か判断（鏡映は「違う」）。<b>持ち時間内</b>にできるだけ回答。正答数で評価します。</div>
    <div class="row small muted">
      <label>持ち時間（秒）：<input id="gv_secs" type="number" min="30" max="120" value="60"></label>
      <span class="pill" id="gv_status" style="margin-left:8px">待機中</span>
    </div>
    <div class="gv-area">
      <div class="row">
        <canvas id="gv_left" width="220" height="220"></canvas>
        <canvas id="gv_right" width="220" height="220"></canvas>
      </div>
    </div>
    <div class="row" id="gv_feedback"></div>
    <div class="btnbar">
      <button id="gv_start" class="primary bigbtn wide">開始</button>
      <button id="gv_same"  class="bigbtn soft" disabled>同じ (F)</button>
      <button id="gv_diff"  class="bigbtn soft" disabled>違う (J)</button>
      <button id="gv_finish" class="bigbtn wide" disabled>終了</button>
    </div>
  </section>

  <!-- GS：下側広め＋ボタン少し上 -->
  <section class="card tall" id="gs" style="display:none">
    <h2>Gs（処理速度）— 記号比較（30秒・ペース固定）</h2>
    <div class="muted small">左右の記号列（3文字）が<b>同じ</b>なら「同じ(F)」、違えば「違う(J)」。<b>各ペアは一度だけ回答可</b>（連打は無効）。</div>
    <div class="gs-area">
      <div class="pair" id="gs_pair">—</div>
      <div class="row small muted" id="gs_meta">—</div>
    </div>
    <div class="btnbar">
      <button id="gs_start" class="primary bigbtn">開始</button>
      <button id="gs_same" class="bigbtn soft" disabled>同じ (F)</button>
      <button id="gs_diff" class="bigbtn soft" disabled>違う (J)</button>
      <span class="pill" id="gs_timer" style="place-self:center">00:30</span>
    </div>
    <div class="row" id="gs_feedback"></div>
  </section>

  <!-- RESULT -->
  <section class="card" id="result" style="display:none">
    <h2>結果</h2>
    <div class="row"><canvas id="radar" width="760" height="540"></canvas></div>
    <div class="row" style="display:flex;gap:8px;flex-wrap:wrap">
      <button id="btnSaveCard">画像保存</button>
    </div>
    <div class="row" id="result_body">未実施</div>
    <div class="row" id="result_comment" class="small muted"></div>
    <div class="muted small">
      <hr>
      <p><b>標準化の近似</b>（簡易版・参考域）<br>
      Gwm：順向(μ7,σ2)／逆向(μ5,σ1.5)／視空間(μ5,σ1.5)／2-back正答(μ0.70,σ0.15)<br>
      Gf：行列推理 正答数(μ7,σ2.5)　Gc：語彙 正答数(μ8,σ2.0)<br>
      <u>Gv：回転同一 60秒正答数(μ10,σ5)</u>　Gs：30秒正答数(μ25,σ7)<br>
      能力別zを平均→CCI。CCI％位＝Φ(z)×100。上位＝(100−％位)％。</p>
    </div>
  </section>
</div>

<script>
(()=>{
// ===== Utils =====
const $ = (q)=>document.querySelector(q);
const el = (id)=>document.getElementById(id);
const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const randInt = (n)=>Math.floor(Math.random()*n);
const shuffle = (arr)=>arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]);
function erf(x){const a1=0.254829592,a2=-0.284496736,a3=1.421413741,a4=-1.453152027,a5=1.061405429,p=0.3275911;const s=x<0?-1:1; x=Math.abs(x); const t=1/(1+p*x); const y=1-(((((a5*t+a4)*t)+a3)*t+a2)*t+a1)*t*Math.exp(-x*x); return s*y;}
function normCdf(z){return 0.5*(1+erf(z/Math.SQRT2));}
async function showPrep(ms=900, text='準備してください'){ const o=el('prep'); o.querySelector('.title').textContent=text; o.style.display='flex'; await sleep(ms); o.style.display='none'; }

// 全角→半角 数字
const toHalfNumStr = (s)=> s.replace(/[０-９]/g, ch=>String.fromCharCode(ch.charCodeAt(0)-0xFEE0));
function getNum(id, def, min, max){
  const raw = (el(id).value??''); const hv = toHalfNumStr(raw); const n = parseInt(hv,10);
  return clamp(Number.isFinite(n)?n:def, min, max);
}
function sanitizeNums(s){ const hv = toHalfNumStr(s||''); return hv.replace(/[^\d]/g,'').split('').map(d=>parseInt(d,10)); }
// 入力強制半角
document.addEventListener('input', (e)=>{
  const t=e.target; if (t.tagName==='INPUT'&&(t.type==='number'||t.type==='text')){ const v=t.value, hv=toHalfNumStr(v); if(v!==hv) t.value=hv; }
});

// ===== Tabs =====
const FEEDBACK_DELAY_MS = 2500;
el('delayInfo').textContent = (FEEDBACK_DELAY_MS/1000).toFixed(1)+'秒';
const tabs = document.querySelectorAll('.tab');
const secs = { gwm: $('#gwm'), gf: $('#gf'), gc: $('#gc'), gv: $('#gv'), gs: $('#gs'), result: $('#result') };
tabs.forEach(b=>b.addEventListener('click', ()=>{
  tabs.forEach(x=>x.classList.remove('active')); b.classList.add('active');
  Object.values(secs).forEach(s=>s.style.display='none');
  secs[b.dataset.tab].style.display='';
}));

// ===== Scores =====
const score = { t1:null, t2:null, t3:null, t3Perfect:false, t4_acc:null, gf_correct:null, gc_correct:null, gv_count:null, gs_count:null };
let lastSummary = null;

// ===== Gwm: T1 =====
const t1 = { L:4, trial:0, success:false, seq:[], showing:false, done:false };
function t1Reset(){ t1.L=getNum('t1_start',4,3,9); t1.trial=0;t1.success=false;t1.seq=[];t1.showing=false;t1.done=false;
  el('digitBox').textContent=''; el('t1_answer').value=''; el('t1_answer').disabled=true; el('t1_check').disabled=true;
  el('t1_feedback').textContent=''; el('t1_state').textContent='未開始';
}
function t1Digits(n){ return Array.from({length:n},()=>randInt(10)); }
async function t1Show(){
  t1.success=false; await showPrep(900,'準備してください');
  t1.showing=true; t1.seq=t1Digits(t1.L);
  const ms=getNum('t1_ms',600,200,1500);
  el('t1_state').textContent=`提示中（${t1.L}桁）`; el('digitBox').textContent='';
  for(let i=0;i<t1.seq.length;i++){ el('digitBox').textContent=t1.seq[i]; await sleep(ms); el('digitBox').textContent=''; await sleep(180); }
  t1.showing=false; el('t1_answer').disabled=false; el('t1_check').disabled=false; el('t1_answer').focus();
  el('t1_state').textContent=`入力待ち（試行 ${t1.trial+1}/2）`;
}
function t1Start(){ t1Reset(); el('t1_startBtn').disabled=true; t1Step(); }
async function t1Step(){
  if (t1.done) return;
  if (t1.trial>=2){
    if (t1.success){ score.t1=t1.L; el('t1_feedback').innerHTML=`<span class="ok">レベル達成！</span> 到達最大桁 <b>${score.t1}</b>`; }
    else{ score.t1=t1.L-1; el('t1_feedback').innerHTML=`<span class="ng">終了。</span> 到達最大桁 <b>${score.t1}</b><br>正解：${t1.seq.join('')}`; }
    t1.done=true; el('t1_startBtn').disabled=false; updateOverall(); return;
  }
  await t1Show();
}
async function t1Check(){
  if (t1.showing) return;
  const g = sanitizeNums(el('t1_answer').value); el('t1_answer').value='';
  const ok = (g.length===t1.seq.length) && g.every((d,i)=>d===t1.seq[i]); t1.trial++;
  if (ok){ el('t1_feedback').innerHTML=`<span class="ok">正解！</span> 次は ${t1.L+1} 桁（正解：${t1.seq.join('')})`;
    t1.success=true; t1.L++; t1.trial=0; updateOverall(); await sleep(FEEDBACK_DELAY_MS); t1Step();
  }else{ el('t1_feedback').innerHTML=`<span class="ng">不正解。</span> 同レベル再試行（${t1.trial}/2）／正解：${t1.seq.join('')}`;
    await sleep(FEEDBACK_DELAY_MS); t1Step();
  }
}
el('t1_startBtn').addEventListener('click', t1Start);
el('t1_abortBtn').addEventListener('click', ()=>{ t1.done=true; el('t1_state').textContent='中断'; el('t1_startBtn').disabled=false; });
el('t1_check').addEventListener('click', t1Check);
el('t1_answer').addEventListener('keydown', e=>{ if(e.key==='Enter'&&!el('t1_check').disabled) t1Check(); });
t1Reset();

// ===== Gwm: T2 =====
const t2 = { L:3, trial:0, success:false, seq:[], showing:false, done:false };
function t2Reset(){ t2.L=getNum('t2_startN',3,3,8); t2.trial=0;t2.success=false;t2.seq=[];t2.showing=false;t2.done=false;
  el('digitBox2').textContent=''; el('t2_answer').value=''; el('t2_answer').disabled=true; el('t2_check').disabled=true; el('t2_feedback').textContent=''; el('t2_state').textContent='未開始';
}
async function t2Show(){ t2.success=false; await showPrep(900,'準備してください'); t2.showing=true; t2.seq=Array.from({length:t2.L},()=>randInt(10));
  const ms=getNum('t2_ms',650,200,1500);
  el('t2_state').textContent=`提示中（${t2.L}桁）`; el('digitBox2').textContent='';
  for(let i=0;i<t2.seq.length;i++){ el('digitBox2').textContent=t2.seq[i]; await sleep(ms); el('digitBox2').textContent=''; await sleep(180); }
  t2.showing=false; el('t2_answer').disabled=false; el('t2_check').disabled=false; el('t2_answer').focus();
  el('t2_state').textContent=`入力待ち（試行 ${t2.trial+1}/2）`;
}
function t2Start(){ t2Reset(); el('t2_startBtn').disabled=true; t2Step(); }
async function t2Step(){
  if (t2.done) return;
  if (t2.trial>=2){
    if (t2.success){ score.t2=t2.L; el('t2_feedback').innerHTML=`<span class="ok">レベル達成！</span> 到達最大桁 <b>${score.t2}</b>`; }
    else{ score.t2=t2.L-1; el('t2_feedback').innerHTML=`<span class="ng">終了。</span> 到達最大桁 <b>${score.t2}</b><br>正解：${[...t2.seq].reverse().join('')}`; }
    t2.done=true; el('t2_startBtn').disabled=false; updateOverall(); return;
  }
  await t2Show();
}
async function t2Check(){
  if (t2.showing) return;
  const g = sanitizeNums(el('t2_answer').value); el('t2_answer').value='';
  const rev=[...t2.seq].reverse(); const ok=(g.length===rev.length)&&g.every((d,i)=>d===rev[i]); t2.trial++;
  if (ok){ el('t2_feedback').innerHTML=`<span class="ok">正解！</span> 次は ${t2.L+1} 桁（正解：${rev.join('')})`;
    t2.success=true; t2.L++; t2.trial=0; updateOverall(); await sleep(FEEDBACK_DELAY_MS); t2Step();
  }else{ el('t2_feedback').innerHTML=`<span class="ng">不正解。</span> 同レベル再試行（${t2.trial}/2）／正解：${rev.join('')}`;
    await sleep(FEEDBACK_DELAY_MS); t2Step();
  }
}
el('t2_startBtn').addEventListener('click', t2Start);
el('t2_abortBtn').addEventListener('click', ()=>{ t2.done=true; el('t2_state').textContent='中断'; el('t2_startBtn').disabled=false; });
el('t2_check').addEventListener('click', t2Check);
el('t2_answer').addEventListener('keydown', e=>{ if(e.key==='Enter'&&!el('t2_check').disabled) t2Check(); });
t2Reset();

// ===== Gwm: T3（3×3） =====
const grid = el('grid'); const cells=[];
for(let i=0;i<9;i++){ const d=document.createElement('div'); d.className='cell'; d.dataset.idx=i; grid.appendChild(d); cells.push(d);   .choices{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
  .choice{padding:10px;border:1px solid #ddd;border-radius:10px;background:#fff;cursor:pointer}
  .choice.selected{border-color: var(--brand); box-shadow:0 0 0 2px rgba(142,90,90,.15) inset}
  .choice.correct{border-color:#1a7f37}
  .choice.wrong{border-color:#b3261e}
  .pair{display:flex;gap:10px;justify-content:center;align-items:center;font-size:24px}
  .pill{display:inline-block;padding:2px 8px;border:1px solid #e4d9d9;border-radius:999px;background:#fff;font-size:.86em;margin-left:6px}

  /* ボタン行（下寄せ気味） */
  .controls-row{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-top:16px}
  .btnbar{display:grid;grid-template-columns:repeat(2, minmax(120px,1fr));gap:10px;max-width:520px;margin:18px auto 4px}
  .btnbar .wide{grid-column:1 / -1}
  .bigbtn{padding:14px 16px;font-size:18px;border-radius:12px}
  .soft{background:#fff;border-color:#e5dede}

  /* Gv/Gsの表示域を“下側広め”に確保 */
  .gv-area{min-height:320px;display:flex;flex-direction:column;align-items:center;justify-content:center}
  .gs-area{min-height:220px;display:flex;flex-direction:column;align-items:center;justify-content:center}

  /* 準備オーバーレイ */
  .prep{position:fixed;inset:0;background:rgba(255,253,248,.92);display:none;align-items:center;justify-content:center;z-index:999}
  .prep .box{background:#fff;border:1px solid #eee;padding:16px 22px;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.08);color:#624c4c}
  .prep .title{font-weight:700;margin-bottom:4px}
  .prep .dots::after{content:"";display:inline-block;width:1ch;animation:dots 1.1s infinite steps(4,end)}
  @keyframes dots{0%{content:""}25%{content:"."}50%{content:".."}75%{content:"..."}100%{content:""}}

  /* Gf 見やすいグリッド */
  .qwrap{margin:8px 0}
  .rowgrid{display:grid;gap:6px;margin:4px 0}
  .cellg{height:36px;min-width:42px;display:flex;align-items:center;justify-content:center;border:1px solid #e0d7d7;border-radius:8px;background:#fbfaf8;font-weight:600}

  /* モバイル最適化 */
  @media (max-width:560px){
    .grid{grid-template-columns:repeat(3,56px);gap:8px}
    .cell{width:56px;height:56px;border-radius:10px}
    #digitBox,#digitBox2{font-size:36px}
    .pair{font-size:20px}
    .choices{grid-template-columns:repeat(2,1fr)}
    h1{font-size:20px}
    .wrap{margin:18px auto}
    canvas#gv_left, canvas#gv_right{width:140px !important;height:140px !important}
    canvas#radar{width:100% !important;height:auto !important}
    .btnbar{grid-template-columns:1fr 1fr}
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>認知プロファイル・チャレンジ（CHC簡易版）<span class="pill">練習なし・一発計測</span></h1>
    <a class="back" href="https://haisuikounozarigani.github.io/shindan/">診断一覧に戻る</a>
  </header>

  <div class="card">
    <p class="muted">CHC理論の広範能力（Gf/Gc/Gv/Gs/Gwm）を簡易測定。ヒントは出しません（解き方は非表示）。</p>
    <div class="kpis">
      <div class="kpi"><b>総合（CCI）</b><br><div id="overall">未実施</div></div>
      <div class="kpi"><b>詳細</b><br><div class="muted" id="detail">各タスク→能力別z→CCI。％位と「上位◯％」を表示。</div></div>
    </div>
  </div>

  <div class="tabs">
    <button class="tab active" data-tab="gwm">Gwm（作動記憶）</button>
    <button class="tab" data-tab="gf">Gf（流動性推理）</button>
    <button class="tab" data-tab="gc">Gc（結晶性）</button>
    <button class="tab" data-tab="gv">Gv（視覚）</button>
    <button class="tab" data-tab="gs">Gs（処理速度）</button>
    <button class="tab" data-tab="result">結果</button>
  </div>

  <!-- 準備オーバーレイ -->
  <div class="prep" id="prep">
    <div class="box">
      <div class="title">準備してください</div>
      <div class="muted dots">まもなく提示します</div>
    </div>
  </div>

  <!-- GWM -->
  <section class="card" id="gwm">
    <h2>Gwm（作動記憶）</h2>
    <div class="muted small">停止規則：各レベル最大2試行。1回成功で次レベル、2回失敗で終了。採点後<span id="delayInfo">2.5秒</span>待ってから次へ。</div>

    <h3>数字スパン（順向）</h3>
    <div class="row">
      <label>開始桁数：<input id="t1_start" type="number" min="3" max="9" value="4"></label>
      <label style="margin-left:12px">表示速度（ms/桁）：<input id="t1_ms" type="number" min="200" max="1500" value="600"></label>
    </div>
    <div class="row" id="digitBox" aria-live="off"></div>
    <div class="row"><input id="t1_answer" type="text" placeholder="数字列（例: 4192）" disabled></div>
    <div class="controls-row">
      <button id="t1_startBtn" class="primary">開始</button>
      <button id="t1_check" disabled>採点</button>
      <button id="t1_abortBtn">中断</button>
    </div>
    <div class="row" id="t1_feedback"></div>
    <div class="row muted small" id="t1_state">未開始</div>
    <hr>

    <h3>数字スパン（逆向）</h3>
    <div class="row">
      <label>開始桁数：<input id="t2_startN" type="number" min="3" max="8" value="3"></label>
      <label style="margin-left:12px">表示速度（ms/桁）：<input id="t2_ms" type="number" min="200" max="1500" value="650"></label>
    </div>
    <div class="row" id="digitBox2" aria-live="off"></div>
    <div class="row"><input id="t2_answer" type="text" placeholder="逆順で（例: 2914）" disabled></div>
    <div class="controls-row">
      <button id="t2_startBtn" class="primary">開始</button>
      <button id="t2_check" disabled>採点</button>
      <button id="t2_abortBtn">中断</button>
    </div>
    <div class="row" id="t2_feedback"></div>
    <div class="row muted small" id="t2_state">未開始</div>
    <hr>

    <h3>視空間パターン（3×3）</h3>
    <div class="row small muted">必要数だけ選択できます（<span id="t3_sel_info">0/—</span>）。必要数に達すると以降のクリックは無視します。<span class="pill" id="t3_badge" style="display:none">満点</span></div>
    <div class="row">
      <label>開始長：<input id="t3_start" type="number" min="3" max="7" value="3"></label>
      <label style="margin-left:12px">表示速度（ms/マス）：<input id="t3_ms" type="number" min="250" max="1500" value="600"></label>
    </div>
    <div class="grid" id="grid" aria-live="off"></div>
    <div class="controls-row">
      <button id="t3_startBtn" class="primary">開始</button>
      <button id="t3_check" disabled>採点</button>
      <button id="t3_abortBtn">中断</button>
    </div>
    <div class="row" id="t3_feedback"></div>
    <div class="row muted small" id="t3_state">未開始</div>
    <hr>

    <h3>2-back（更新）</h3>
    <details class="small muted" style="margin-bottom:8px">
      <summary>2-backの説明（タップで展開）</summary>
      画面中央に1文字ずつ表示されます。<b>2つ前と同じ文字が出た時だけ</b>、スペースキーまたは「反応」ボタンを押してください。<br>
      例）A → B → <b>A</b> → C … の太字Aは2つ前のAと同じなので反応。<br>
      押し間違いは減点、押し忘れも減点です。
    </details>
    <div class="row">
      <label>表示時間（ms/刺激）：<input id="t4_ms" type="number" min="600" max="2000" value="1000"></label>
      <label style="margin-left:12px">インターバル（ms）：<input id="t4_gap" type="number" min="100" max="1000" value="180"></label>
    </div>
    <div class="center" id="t4_stim" aria-live="off">—</div>
    <div class="controls-row">
      <button id="t4_startBtn" class="primary">開始</button>
      <button id="t4_hitBtn" disabled>反応（スペース）</button>
      <button id="t4_abortBtn">中断</button>
    </div>
    <div class="row" id="t4_feedback"></div>
    <div class="row muted small" id="t4_state">未開始</div>
  </section>

  <!-- GF -->
  <section class="card" id="gf" style="display:none">
    <h2>Gf（流動性推理）— 行列推理</h2>
    <div class="muted small">12問・制限時間なし（簡易版）。選択後は<b>提出</b>で採点。</div>
    <div id="gf_body"></div>
    <div class="controls-row"><button id="gf_submit" class="primary">提出して採点</button></div>
    <div class="row" id="gf_feedback"></div>
  </section>

  <!-- GC -->
  <section class="card" id="gc" style="display:none">
    <h2>Gc（結晶性）— 類義語選択</h2>
    <div class="muted small">12問・制限時間なし（簡易版）。選択後は<b>提出</b>で採点。</div>
    <div id="gc_body"></div>
    <div class="controls-row"><button id="gc_submit" class="primary">提出して採点</button></div>
    <div class="row" id="gc_feedback"></div>
  </section>

  <!-- GV（時間制：60秒で何問正解できるか） -->
  <section class="card tall" id="gv" style="display:none">
    <h2>Gv（視覚）— 回転同一判断（時間内にどれだけ解けるか）</h2>
    <div class="muted small">左のパターンを回転したものが右と<b>同一</b>か判断（鏡映は「違う」）。時間内にできるだけ解答してください。正答数で評価します。</div>
    <div class="row small muted">
      <label>持ち時間（秒）：<input id="gv_secs" type="number" min="30" max="120" value="60"></label>
      <span class="pill" id="gv_status" style="margin-left:8px">待機中</span>
    </div>
    <div class="gv-area">
      <div class="row">
        <canvas id="gv_left" width="220" height="220"></canvas>
        <canvas id="gv_right" width="220" height="220"></canvas>
      </div>
    </div>
    <div class="row" id="gv_feedback"></div>
    <div class="btnbar">
      <button id="gv_start" class="primary bigbtn wide">開始</button>
      <button id="gv_same"  class="bigbtn soft" disabled>同じ (F)</button>
      <button id="gv_diff"  class="bigbtn soft" disabled>違う (J)</button>
      <button id="gv_finish" class="bigbtn wide" disabled>終了</button>
    </div>
  </section>

  <!-- GS -->
  <section class="card tall" id="gs" style="display:none">
    <h2>Gs（処理速度）— 記号比較（30秒・ペース固定）</h2>
    <div class="muted small">左右の記号列（3文字）が<b>同じ</b>なら「同じ(F)」、違えば「違う(J)」。<b>各ペアは一度だけ回答可</b>（連打は無効）。</div>
    <div class="gs-area">
      <div class="pair" id="gs_pair">—</div>
      <div class="row small muted" id="gs_meta">—</div>
    </div>
    <div class="btnbar">
      <button id="gs_start" class="primary bigbtn">開始</button>
      <button id="gs_same" class="bigbtn soft" disabled>同じ (F)</button>
      <button id="gs_diff" class="bigbtn soft" disabled>違う (J)</button>
      <span class="pill" id="gs_timer" style="place-self:center">00:30</span>
    </div>
    <div class="row" id="gs_feedback"></div>
  </section>

  <!-- RESULT -->
  <section class="card" id="result" style="display:none">
    <h2>結果</h2>
    <div class="row"><canvas id="radar" width="760" height="540"></canvas></div>
    <div class="row" style="display:flex;gap:8px;flex-wrap:wrap">
      <button id="btnSaveCard">画像保存</button>
    </div>
    <div class="row" id="result_body">未実施</div>
    <div class="row" id="result_comment" class="small muted"></div>
    <div class="muted small">
      <hr>
      <p><b>標準化の近似</b>（簡易版・参考域）<br>
      Gwm：順向(μ7,σ2)／逆向(μ5,σ1.5)／視空間(μ5,σ1.5)／2-back正答(μ0.70,σ0.15)<br>
      Gf：行列推理 正答数(μ7,σ2.5)　Gc：語彙 正答数(μ8,σ2.0)<br>
      Gv：回転同一 <u>60秒正答数</u>(μ12,σ4)　Gs：30秒正答数(μ25,σ7)<br>
      能力別zを平均→CCI。CCI％位＝Φ(z)×100。上位＝(100−％位)％。</p>
    </div>
  </section>
</div>

<script>
(()=>{
// ===== Utils =====
const $ = (q)=>document.querySelector(q);
const el = (id)=>document.getElementById(id);
const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const randInt = (n)=>Math.floor(Math.random()*n);
const shuffle = (arr)=>arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]);
function erf(x){const a1=0.254829592,a2=-0.284496736,a3=1.421413741,a4=-1.453152027,a5=1.061405429,p=0.3275911;const s=x<0?-1:1; x=Math.abs(x); const t=1/(1+p*x); const y=1-(((((a5*t+a4)*t)+a3)*t+a2)*t+a1)*t*Math.exp(-x*x); return s*y;}
function normCdf(z){return 0.5*(1+erf(z/Math.SQRT2));}
async function showPrep(ms=900, text='準備してください'){ const o=el('prep'); o.querySelector('.title').textContent=text; o.style.display='flex'; await sleep(ms); o.style.display='none'; }

// 全角→半角 数字
const toHalfNumStr = (s)=> s.replace(/[０-９]/g, ch=>String.fromCharCode(ch.charCodeAt(0)-0xFEE0));
// 数値取得（全角対応＋clamp）
function getNum(id, def, min, max){
  const raw = (el(id).value??'');
  const hv = toHalfNumStr(raw);
  const n = parseInt(hv,10);
  return clamp(Number.isFinite(n)?n:def, min, max);
}
// 回答の数字配列（全角対応）
function sanitizeNums(s){
  const hv = toHalfNumStr(s||'');
  return hv.replace(/[^\d]/g,'').split('').map(d=>parseInt(d,10));
}
document.addEventListener('input', (e)=>{
  const t = e.target;
  if (t.tagName==='INPUT' && (t.type==='number' || t.type==='text')){
    const v = t.value; const hv = toHalfNumStr(v);
    if (v!==hv) t.value = hv;
  }
});

// ===== Tabs =====
const FEEDBACK_DELAY_MS = 2500;
el('delayInfo').textContent = (FEEDBACK_DELAY_MS/1000).toFixed(1)+'秒';
const tabs = document.querySelectorAll('.tab');
const secs = { gwm: $('#gwm'), gf: $('#gf'), gc: $('#gc'), gv: $('#gv'), gs: $('#gs'), result: $('#result') };
tabs.forEach(b=>b.addEventListener('click', ()=>{
  tabs.forEach(x=>x.classList.remove('active')); b.classList.add('active');
  Object.values(secs).forEach(s=>s.style.display='none');
  secs[b.dataset.tab].style.display='';
}));

// ===== Scores =====
const score = { t1:null, t2:null, t3:null, t3Perfect:false, t4_acc:null, gf_correct:null, gc_correct:null, gv_count:null, gs_count:null };
let lastSummary = null; // ← 重複宣言をここだけに統一

// ===== Gwm: T1 =====
const t1 = { L:4, trial:0, success:false, seq:[], showing:false, done:false };
function t1Reset(){
  t1.L = getNum('t1_start',4,3,9);
  t1.trial=0; t1.success=false; t1.seq=[]; t1.showing=false; t1.done=false;
  el('digitBox').textContent=''; el('t1_answer').value=''; el('t1_answer').disabled=true;
  el('t1_check').disabled=true; el('t1_feedback').textContent=''; el('t1_state').textContent='未開始';
}
function t1Digits(n){ return Array.from({length:n},()=>randInt(10)); }
async function t1Show(){
  t1.success=false; await showPrep(900,'準備してください');
  t1.showing=true; t1.seq=t1Digits(t1.L);
  const ms=getNum('t1_ms',600,200,1500);
  el('t1_state').textContent=`提示中（${t1.L}桁）`; el('digitBox').textContent='';
  for(let i=0;i<t1.seq.length;i++){ el('digitBox').textContent=t1.seq[i]; await sleep(ms); el('digitBox').textContent=''; await sleep(180); }
  t1.showing=false; el('t1_answer').disabled=false; el('t1_check').disabled=false; el('t1_answer').focus();
  el('t1_state').textContent=`入力待ち（試行 ${t1.trial+1}/2）`;
}
function t1Start(){ t1Reset(); el('t1_startBtn').disabled=true; t1Step(); }
async function t1Step(){
  if (t1.done) return;
  if (t1.trial>=2){
    if (t1.success){ score.t1=t1.L; el('t1_feedback').innerHTML=`<span class="ok">レベル達成！</span> 到達最大桁 <b>${score.t1}</b>`; }
    else{ score.t1=(t1.L-1); el('t1_feedback').innerHTML=`<span class="ng">終了。</span> 到達最大桁 <b>${score.t1}</b><br>正解：${t1.seq.join('')}`; }
    t1.done=true; el('t1_startBtn').disabled=false; updateOverall(); return;
  }
  await t1Show();
}
async function t1Check(){
  if (t1.showing) return;
  const g = sanitizeNums(el('t1_answer').value);
  el('t1_answer').value='';
  const ok = (g.length===t1.seq.length) && g.every((d,i)=>d===t1.seq[i]);
  t1.trial++;
  if (ok){
    el('t1_feedback').innerHTML=`<span class="ok">正解！</span> 次は ${t1.L+1} 桁（正解：${t1.seq.join('')})`;
    t1.success=true; t1.L++; t1.trial=0; updateOverall(); await sleep(FEEDBACK_DELAY_MS); t1Step();
  }else{
    el('t1_feedback').innerHTML=`<span class="ng">不正解。</span> 同レベル再試行（${t1.trial}/2）／正解：${t1.seq.join('')}`;
    await sleep(FEEDBACK_DELAY_MS); t1Step();
  }
}
el('t1_startBtn').addEventListener('click', t1Start);
el('t1_abortBtn').addEventListener('click', ()=>{ t1.done=true; el('t1_state').textContent='中断'; el('t1_startBtn').disabled=false; });
el('t1_check').addEventListener('click', t1Check);
el('t1_answer').addEventListener('keydown', e=>{ if(e.key==='Enter'&&!el('t1_check').disabled) t1Check(); });
t1Reset();

// ===== Gwm: T2 =====
const t2 = { L:3, trial:0, success:false, seq:[], showing:false, done:false };
function t2Reset(){
  t2.L = getNum('t2_startN',3,3,8);
  t2.trial=0;t2.success=false;t2.seq=[];t2.showing=false;t2.done=false;
  el('digitBox2').textContent=''; el('t2_answer').value=''; el('t2_answer').disabled=true; el('t2_check').disabled=true;
  el('t2_feedback').textContent=''; el('t2_state').textContent='未開始';
}
async function t2Show(){
  t2.success=false; await showPrep(900,'準備してください');
  t2.showing=true; t2.seq=Array.from({length:t2.L},()=>randInt(10));
  const ms=getNum('t2_ms',650,200,1500);
  el('t2_state').textContent=`提示中（${t2.L}桁）`; el('digitBox2').textContent='';
  for(let i=0;i<t2.seq.length;i++){ el('digitBox2').textContent=t2.seq[i]; await sleep(ms); el('digitBox2').textContent=''; await sleep(180); }
  t2.showing=false; el('t2_answer').disabled=false; el('t2_check').disabled=false; el('t2_answer').focus();
  el('t2_state').textContent=`入力待ち（試行 ${t2.trial+1}/2）`;
}
function t2Start(){ t2Reset(); el('t2_startBtn').disabled=true; t2Step(); }
async function t2Step(){
  if (t2.done) return;
  if (t2.trial>=2){
    if (t2.success){ score.t2=t2.L; el('t2_feedback').innerHTML=`<span class="ok">レベル達成！</span> 到達最大桁 <b>${score.t2}</b>`; }
    else{ score.t2=(t2.L-1); el('t2_feedback').innerHTML=`<span class="ng">終了。</span> 到達最大桁 <b>${score.t2}</b><br>正解：${[...t2.seq].reverse().join('')}`; }
    t2.done=true; el('t2_startBtn').disabled=false; updateOverall(); return;
  }
  await t2Show();
}
async function t2Check(){
  if (t2.showing) return;
  const g = sanitizeNums(el('t2_answer').value);
  el('t2_answer').value='';
  const rev = [...t2.seq].reverse();
  const ok = (g.length===rev.length) && g.every((d,i)=>d===rev[i]);
  t2.trial++;
  if (ok){
    el('t2_feedback').innerHTML=`<span class="ok">正解！</span> 次は ${t2.L+1} 桁（正解：${rev.join('')})`;
    t2.success=true; t2.L++; t2.trial=0; updateOverall(); await sleep(FEEDBACK_DELAY_MS); t2Step();
  }else{
    el('t2_feedback').innerHTML=`<span class="ng">不正解。</span> 同レベル再試行（${t2.trial}/2）／正解：${rev.join('')}`;
    await sleep(FEEDBACK_DELAY_MS); t2Step();
  }
}
el('t2_startBtn').addEventListener('click', t2Start);
el('t2_abortBtn').addEventListener('click', ()=>{ t2.done=true; el('t2_state').textContent='中断'; el('t2_startBtn').disabled=false; });
el('t2_check').addEventListener('click', t2Check);
el('t2_answer').addEventListener('keydown', e=>{ if(e.key==='Enter'&&!el('t2_check').disabled) t2Check(); });
t2Reset();

// ===== Gwm: T3（3×3） =====
const grid = el('grid'); const cells=[];
for(let i=0;i<9;i++){ const d=document.createElement('div'); d
