<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>関係の切れやすさ・セルフチェック（独自再構成）</title>
<meta name="description" content="20問で“切れやすさ”の傾向を可視化。四騎士・ファビング・拒絶/愛着・TAS-20/DERSなどの研究知見にヒントを得た独自再構成のセルフチェック（エンタメ＋自己理解向け／公式の心理検査ではありません）。">
<meta property="og:title" content="関係の切れやすさ・セルフチェック（独自再構成）">
<meta property="og:description" content="20問で“切れやすさ”の傾向を可視化。結果は「鎖→糸」の5段階。恋人・友人どちらにも。※独自再構成／非医療・非公式">
<meta name="theme-color" content="#faf7ff">
<link rel="preload" as="image" href="/shindan/assets/results/kizuna-rope/t01.webp">
<style>
  :root{
    --bg:#f7f8ff;--ink:#1b2030;--muted:#677088;--panel:#fff;--line:#e5e8f2;--accent:#6b4cff;
    --accent2:#8f7bff;
  }
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#fbfcff,#f2f4fb);color:var(--ink);font-family:"Noto Sans JP",system-ui,sans-serif}

body{ padding-top:56px; } /* 固定バーの高さぶん余白を足す */

  /* sticky progress（noh/rail準拠） */
/* sticky progress (上部固定版) */
.sticky{
  position: fixed; top:0; left:0; right:0; z-index:1000;
  margin:0; padding:10px 14px;
  background:rgba(255,255,255,.9);
  backdrop-filter:blur(6px) saturate(1.05);
  border-bottom:1px solid #e9edf7;
  display:flex; align-items:center; gap:10px
}
.progress{height:8px; background:#edf2fb; border-radius:999px; flex:1; overflow:hidden}
.progress>span{display:block; height:100%; width:0;
  background:linear-gradient(90deg,var(--accent),var(--accent2)); transition:width .25s ease}
  .progress{height:8px;background:#edf2fb;border-radius:999px;flex:1;overflow:hidden}
  .progress>span{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width .25s ease}
  .btn{appearance:none;border:1px solid var(--line);background:#fff;padding:10px 14px;border-radius:12px;cursor:pointer}
  .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;border-color:transparent;font-weight:700}

  header .in{max-width:960px;margin:auto;padding:12px 16px}
  h1{margin:0 0 4px;font-size:clamp(18px,3.6vw,24px)}
  .lead{color:var(--muted);margin:4px 0 0}
  .note{color:var(--muted);font-size:.92em;margin:0}
  main{max-width:960px;margin:0 auto;padding:14px 16px 120px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;box-shadow:0 8px 26px rgba(0,0,0,.06);padding:16px;margin:14px 0}

  .qs{list-style:none;margin:0;padding:0;display:grid;gap:12px}
  .q{border:1px dashed #e9ecf5;border-radius:12px;padding:12px}
  .q .t{margin:0 0 8px}
  .scale{display:flex;gap:8px;flex-wrap:wrap}
  .scale input{position:absolute;opacity:0}
  .scale label{border:1px solid var(--line);border-radius:999px;padding:6px 10px;background:#fff;cursor:pointer}
  .scale input:checked+span{outline:2px solid var(--accent);outline-offset:1px}

  .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:16px}
  .result{margin-top:18px}
  .muted{color:var(--muted)}
  #r-text{white-space:pre-line}

  /* 正方形ヒーロー */
  .hero{display:grid;place-items:center;border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#f7f8ff}
  .hero figure{margin:0;width:min(560px,100%);aspect-ratio:1/1;border-bottom:1px solid var(--line)}
  .hero img{width:100%;height:100%;object-fit:cover;display:block}
  .hero figcaption{padding:12px}

  /* 因子バー */
  .factors{display:grid;gap:12px;max-width:720px;margin-inline:auto}
  .meter{display:grid;gap:6px}
  .meter .row{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .meter .name{font-weight:700}
  .mbar{height:10px;border:1px solid #e5e9f3;border-radius:999px;overflow:hidden;background:#f7f8fc}
  .mbar>span{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent2))}
  .pct{font-variant-numeric:tabular-nums;color:#4e4e6a}

  /* 診断一覧へ戻る（固定フッター） */
  .backbar{position:fixed;left:0;right:0;bottom:0;background:rgba(255,255,255,.9);backdrop-filter:saturate(1.1) blur(8px);
    border-top:1px solid var(--line);padding:10px 16px;z-index:30}
  .backbar .in{max-width:960px;margin:0 auto;display:flex;justify-content:flex-end}
  .to-index{font-weight:600;text-decoration:none}
</style>
</head>
<body data-id="kizuna-rope">
  <!-- 📊 sticky progress -->
  <div class="sticky" aria-live="polite">
    <span aria-hidden="true">📊</span>
    <div class="progress" aria-label="回答進捗"><span id="prog"></span></div>
    <button class="btn primary" id="btn-calc-top">判定する</button>
  </div>

<header><div class="in">
  <h1>関係の切れやすさ診断</h1>
  <p class="lead">対象：最近よく関わる「特定の相手」を一人思い浮かべてお答えください。（恋人／友人どちらでもOK）</p>
  <p class="note">※ この診断は参考情報です。断定やラベリングは行いません。</p>
</div></header>

<main>
  <!-- 質問カード -->
  <section class="card" id="qcard">
    <h2 style="margin:0 0 10px">質問（20問・5段階）</h2>
    <ul id="qs" class="qs">
      <!-- 1〜20（※ data-rev="1" は保護的項目：集計時は反転） -->
      <li class="q"><p class="t">1) 話している最中に、どちらかがついスマホや画面を見てしまう。</p><div class="scale" data-i="1">
        <label><input type="radio" name="q1" value="1"><span>ほとんどない</span></label>
        <label><input type="radio" name="q1" value="2"><span>たまにある</span></label>
        <label><input type="radio" name="q1" value="3"><span>ときどきある</span></label>
        <label><input type="radio" name="q1" value="4"><span>よくある</span></label>
        <label><input type="radio" name="q1" value="5"><span>ほぼいつも</span></label>
      </div></li>

      <li class="q"><p class="t">2) 食事中や集まりの場でも、片方が画面に気を取られて会話が切れがち。</p><div class="scale" data-i="2">
        <label><input type="radio" name="q2" value="1"><span>ほとんどない</span></label>
        <label><input type="radio" name="q2" value="2"><span>たまにある</span></label>
        <label><input type="radio" name="q2" value="3"><span>ときどきある</span></label>
        <label><input type="radio" name="q2" value="4"><span>よくある</span></label>
        <label><input type="radio" name="q2" value="5"><span>ほぼいつも</span></label>
      </div></li>

      <li class="q"><p class="t">3) けんかのとき、相手の性格そのものを責める言い方になりやすい。</p><div class="scale" data-i="3">
        <label><input type="radio" name="q3" value="1"><span>ほとんどない</span></label>
        <label><input type="radio" name="q3" value="2"><span>たまにある</span></label>
        <label><input type="radio" name="q3" value="3"><span>ときどきある</span></label>
        <label><input type="radio" name="q3" value="4"><span>よくある</span></label>
        <label><input type="radio" name="q3" value="5"><span>ほぼいつも</span></label>
      </div></li>

      <li class="q"><p class="t">4) 皮肉・見下し・ため息など、相手を下げるサインが出ることがある。</p><div class="scale" data-i="4">
        <label><input type="radio" name="q4" value="1"><span>ほとんどない</span></label>
        <label><input type="radio" name="q4" value="2"><span>たまにある</span></label>
        <label><input type="radio" name="q4" value="3"><span>ときどきある</span></label>
        <label><input type="radio" name="q4" value="4"><span>よくある</span></label>
        <label><input type="radio" name="q4" value="5"><span>ほぼいつも</span></label>
      </div></li>

      <li class="q"><p class="t">5) ぶつかったとき、片方が黙り込んで話を終わらせてしまうことが多い。</p><div class="scale" data-i="5">
        <label><input type="radio" name="q5" value="1"><span>ほとんどない</span></label>
        <label><input type="radio" name="q5" value="2"><span>たまにある</span></label>
        <label><input type="radio" name="q5" value="3"><span>ときどきある</span></label>
        <label><input type="radio" name="q5" value="4"><span>よくある</span></label>
        <label><input type="radio" name="q5" value="5"><span>ほぼいつも</span></label>
      </div></li>

      <li class="q"><p class="t">6) ひとつの話題を、十分ほど落ち着いて最後まで話しきれる。</p><div class="scale" data-i="6" data-rev="1">
        <label><input type="radio" name="q6" value="1"><span>ほとんどない</span></label>
        <label><input type="radio" name="q6" value="2"><span>たまにある</span></label>
        <label><input type="radio" name="q6" value="3"><span>ときどきある</span></label>
        <label><input type="radio" name="q6" value="4"><span>よくある</span></label>
        <label><input type="radio" name="q6" value="5"><span>ほぼいつも</span></label>
      </div></li>

      <li class="q"><p class="t">7) 感情が高ぶったら、一度間を置いてから話し直す「合図」がある。</p><div class="scale" data-i="7" data-rev="1">
        <label><input type="radio" name="q7" value="1"><span>ほとんどない</span></label>
        <label><input type="radio" name="q7" value="2"><span>たまにある</span></label>
        <label><input type="radio" name="q7" value="3"><span>ときどきある</span></label>
        <label><input type="radio" name="q7" value="4"><span>よくある</span></label>
        <label><input type="radio" name="q7" value="5"><span>ほぼいつも</span></label>
      </div></li>

      <li class="q"><p class="t">8) 「助かった」「ありがとう」などの感謝を、はっきり言葉にして伝えている。</p><div class="scale" data-i="8" data-rev="1">
        <label><input type="radio" name="q8" value="1"><span>ほとんどない</span></label>
        <label><input type="radio" name="q8" value="2"><span>たまにある</span></label>
        <label><input type="radio" name="q8" value="3"><span>ときどきある</span></label>
        <label><input type="radio" name="q8" value="4"><span>よくある</span></label>
        <label><input type="radio" name="q8" value="5"><span>ほぼいつも</span></label>
      </div></li>

      <li class="q"><p class="t">9) 忙しくても、短い近況のやりとり（対面やメッセ）を続けられている。</p><div class="scale" data-i="9" data-rev="1">
        <label><input type="radio" name="q9" value="1"><span>ほとんどない</span></label>
        <label><input type="radio" name="q9" value="2"><span>たまにある</span></label>
        <label><input type="radio" name="q9" value="3"><span>ときどきある</span></label>
        <label><input type="radio" name="q9" value="4"><span>よくある</span></label>
        <label><input type="radio" name="q9" value="5"><span>ほぼいつも</span></label>
      </div></li>

      <li class="q"><p class="t">10) 役割や費用・時間の負担で、不公平だと感じることが多い。</p><div class="scale" data-i="10">
        <label><input type="radio" name="q10" value="1"><span>ほとんどない</span></label>
        <label><input type="radio" name="q10" value="2"><span>たまにある</span></label>
        <label><input type="radio" name="q10" value="3"><span>ときどきある</span></label>
        <label><input type="radio" name="q10" value="4"><span>よくある</span></label>
        <label><input type="radio" name="q10" value="5"><span>ほぼいつも</span></label>
      </div></li>

      <li class="q"><p class="t">11) 意見が割れたときの決め方（折り合い・持ち越しなど）がはっきりしている。</p><div class="scale" data-i="11" data-rev="1">
        <label><input type="radio" name="q11" value="1"><span>ほとんどない</span></label>
        <label><input type="radio" name="q11" value="2"><span>たまにある</span></label>
        <label><input type="radio" name="q11" value="3"><span>ときどきある</span></label>
        <label><input type="radio" name="q11" value="4"><span>よくある</span></label>
        <label><input type="radio" name="q11" value="5"><span>ほぼいつも</span></label>
      </div></li>

      <li class="q"><p class="t">12) SNSやメッセの非公開・既読などを過度に疑ってしまう。</p><div class="scale" data-i="12">
        <label><input type="radio" name="q12" value="1"><span>ほとんどない</span></label>
        <label><input type="radio" name="q12" value="2"><span>たまにある</span></label>
        <label><input type="radio" name="q12" value="3"><span>ときどきある</span></label>
        <label><input type="radio" name="q12" value="4"><span>よくある</span></label>
        <label><input type="radio" name="q12" value="5"><span>ほぼいつも</span></label>
      </div></li>

      <li class="q"><p class="t">13) 連絡のしかたや誘いの線引きなど、共通の「決まり」がある。</p><div class="scale" data-i="13" data-rev="1">
        <label><input type="radio" name="q13" value="1"><span>ほとんどない</span></label>
        <label><input type="radio" name="q13" value="2"><span>たまにある</span></label>
        <label><input type="radio" name="q13" value="3"><span>ときどきある</span></label>
        <label><input type="radio" name="q13" value="4"><span>よくある</span></label>
        <label><input type="radio" name="q13" value="5"><span>ほぼいつも</span></label>
      </div></li>

      <li class="q"><p class="t">14) 距離感や誘うタイミングをめぐって、気まずさや我慢がたまりやすい。</p><div class="scale" data-i="14">
        <label><input type="radio" name="q14" value="1"><span>ほとんどない</span></label>
        <label><input type="radio" name="q14" value="2"><span>たまにある</span></label>
        <label><input type="radio" name="q14" value="3"><span>ときどきある</span></label>
        <label><input type="radio" name="q14" value="4"><span>よくある</span></label>
        <label><input type="radio" name="q14" value="5"><span>ほぼいつも</span></label>
      </div></li>

      <li class="q"><p class="t">15) 予定の断りや変更を、悪者にせず伝える・代案を出すことができる。</p><div class="scale" data-i="15" data-rev="1">
        <label><input type="radio" name="q15" value="1"><span>ほとんどない</span></label>
        <label><input type="radio" name="q15" value="2"><span>たまにある</span></label>
        <label><input type="radio" name="q15" value="3"><span>ときどきある</span></label>
        <label><input type="radio" name="q15" value="4"><span>よくある</span></label>
        <label><input type="radio" name="q15" value="5"><span>ほぼいつも</span></label>
      </div></li>

      <li class="q"><p class="t">16) 片方が追い、片方が逃げる（近づくほど離れる）流れになりがちだ。</p><div class="scale" data-i="16">
        <label><input type="radio" name="q16" value="1"><span>ほとんどない</span></label>
        <label><input type="radio" name="q16" value="2"><span>たまにある</span></label>
        <label><input type="radio" name="q16" value="3"><span>ときどきある</span></label>
        <label><input type="radio" name="q16" value="4"><span>よくある</span></label>
        <label><input type="radio" name="q16" value="5"><span>ほぼいつも</span></label>
      </div></li>

      <li class="q"><p class="t">17) 不満を伝える頻度より、ねぎらいや労いの言葉のほうが多い。</p><div class="scale" data-i="17" data-rev="1">
        <label><input type="radio" name="q17" value="1"><span>ほとんどない</span></label>
        <label><input type="radio" name="q17" value="2"><span>たまにある</span></label>
        <label><input type="radio" name="q17" value="3"><span>ときどきある</span></label>
        <label><input type="radio" name="q17" value="4"><span>よくある</span></label>
        <label><input type="radio" name="q17" value="5"><span>ほぼいつも</span></label>
      </div></li>

      <li class="q"><p class="t">18) 「事実 → その時の気持ち → こうしてほしい」の順で伝えられている。</p><div class="scale" data-i="18" data-rev="1">
        <label><input type="radio" name="q18" value="1"><span>ほとんどない</span></label>
        <label><input type="radio" name="q18" value="2"><span>たまにある</span></label>
        <label><input type="radio" name="q18" value="3"><span>ときどきある</span></label>
        <label><input type="radio" name="q18" value="4"><span>よくある</span></label>
        <label><input type="radio" name="q18" value="5"><span>ほぼいつも</span></label>
      </div></li>

      <li class="q"><p class="t">19) 大声・物に当たる・怖がらせる等の「安全でない言い合い」は起きていない。</p><div class="scale" data-i="19" data-rev="1">
        <label><input type="radio" name="q19" value="1"><span>ほとんどない</span></label>
        <label><input type="radio" name="q19" value="2"><span>たまにある</span></label>
        <label><input type="radio" name="q19" value="3"><span>ときどきある</span></label>
        <label><input type="radio" name="q19" value="4"><span>よくある</span></label>
        <label><input type="radio" name="q19" value="5"><span>ほぼいつも</span></label>
      </div></li>

      <li class="q"><p class="t">20) 先の予定（遊び/旅行/イベントや共同のこと）を一緒に決める時間がある。</p><div class="scale" data-i="20" data-rev="1">
        <label><input type="radio" name="q20" value="1"><span>ほとんどない</span></label>
        <label><input type="radio" name="q20" value="2"><span>たまにある</span></label>
        <label><input type="radio" name="q20" value="3"><span>ときどきある</span></label>
        <label><input type="radio" name="q20" value="4"><span>よくある</span></label>
        <label><input type="radio" name="q20" value="5"><span>ほぼいつも</span></label>
      </div></li>
    </ul>

    <div class="actions">
      <button id="btn-calc" class="btn primary">判定する</button>
      <button id="btn-clear" class="btn">未回答をリセット</button>
    </div>

    <section class="card" id="legal-note" style="margin:14px 0">
      <h2 style="margin:6px 0;font-size:1rem">ご利用にあたって</h2>
      <ul style="margin:6px 0 0 1.2em;line-height:1.8;color:#677088">
        <li><strong>非提携・非公式：</strong>本コンテンツは「四騎士」「ファビング」「愛着」「TAS-20」「DERS」等の研究知見に<span style="white-space:nowrap">ヒントを得た</span><strong>独自再構成</strong>です。各種公式質問票・項目・採点方法は使用しておらず、権利者による承認・提携・推奨を意味しません。</li>
        <li><strong>医療・カウンセリングの代替ではありません：</strong>娯楽＋自己理解のためのセルフチェックであり、医療的・心理的な診断/治療/助言を目的としません。つらさや不調が続く場合は、医療機関や専門家へご相談ください。</li>
        <li><strong>法的助言ではありません：</strong>安全確保や距離の取り方などの記述は一般的情報であり、法的助言ではありません。緊急時は地域の緊急通報窓口へ。</li>
        <li><strong>プライバシー：</strong>回答は端末内で処理・保存され、回答内容や個人を特定できる情報はサーバーに送信されません。結果表示時に匿名の件数カウントのみ送信する場合があります。</li>
        <li><strong>免責：</strong>法令で認められる範囲で、本コンテンツの利用に関連して生じたいかなる損失・損害についても、当サイトは責任を負いません。</li>
      </ul>
    </section>

    <div id="result" class="result card" style="display:none">
      <div class="hero" role="region" aria-label="イメージ">
        <figure>
          <img id="r-img" alt="結果画像" loading="lazy" width="600" height="600">
        </figure>
        <figcaption>
          <p class="r-ttl" id="r-ttl" style="font-weight:800;margin:6px 0">—</p>
          <p class="muted" id="r-avgline" style="margin:6px 0 0">—</p>
<p id="r-summary" style="margin:6px 0 0; font-weight:600">—</p>
        </figcaption>
      </div>

      <!-- 因子バー（％） -->
      <div class="factors" id="factorBox" aria-label="因子スコア（％）" style="margin:10px 0 6px"></div>

      <div id="r-text" class="muted" style="margin-top:8px">—</div>
    </div>
  </section>
</main>

<!-- ▼ 診断一覧へ戻る（固定フッター） -->
<nav class="backbar" aria-label="ページ下部の操作">
  <div class="in">
    <a id="to-index" class="btn to-index" href="/shindan/">診断一覧へ戻る</a>
  </div>
</nav>

<script>
(function(){
  // 画像（tNN.webp）
  const IMG = {
    1: '/shindan/assets/results/kizuna-rope/t01.webp',
    2: '/shindan/assets/results/kizuna-rope/t02.webp',
    3: '/shindan/assets/results/kizuna-rope/t03.webp',
    4: '/shindan/assets/results/kizuna-rope/t04.webp',
    5: '/shindan/assets/results/kizuna-rope/t05.webp'
  };

  const R_TITLE = {
    1:'鎖：とても強い・安定',
    2:'登山用ロープ：強いが負荷大',
    3:'麻縄：ほつれ始め',
    4:'荷造り紐：切れやすい',
    5:'糸：切れかけ'
  };

  const R_TEXT = {
    1:'【今日の一手】①感謝2：不満1で伝える ②寝る前に「今日よかった」を1つ交換 ③中断→再開の合図を紙で共有',
    2:'【今日の一手】①役割を1つ入れ替える ②スマホは画面伏せ ③ねぎらいを名前付きで言う（先回りありがとう等）',
    3:'【今日の一手】①非難語を出来事語に置換 ②追う↔逃げるは“再開時刻”で調整 ③不満は相談箱に入れて週1で話す',
    4:'【今日の一手】①荒れたら即停止→翌日再開 ②合図カードを決める ③食卓・寝室にスマホを持ち込まない',
    5:'【今日の一手】①安全最優先で距離を確保 ②連絡は短文・記録に残す ③期限を区切って見直す（3週間）'
  };

  const R_SUMMARY = {
    1:'ベースは安定。良い習慣をキープしつつ、油断の積み重ねにだけ注意。',
    2:'概ね良好。忙しさで雑になる瞬間を整えると、もっとラクになる。',
    3:'ゆるい凸凹あり。噛み合う日と噛み合わない日が混在、合図作りが鍵。',
    4:'摩擦がたまりやすい局面。ルール・言い方・休憩の仕組み化で脱出を。',
    5:'まず安全と距離。感情が落ち着く場を確保し、短文・記録ベースで再構築を。'
  };

  // しきい値（avg<=1.8→1, <=2.6→2, <=3.4→3, <=4.2→4, それ以外→5）
  const TH = [1.8, 2.6, 3.4, 4.2];

  const $  = (q,root=document)=>root.querySelector(q);
  const $$ = (q,root=document)=>[...root.querySelectorAll(q)];

  /* ---- 進捗バー ---- */
  const TOTAL = 20;
  const prog  = $('#prog');
  function answeredCount(){ return document.querySelectorAll('input[type="radio"]:checked').length; }
  function updateProgress(){
    const a = answeredCount();
    if(prog) prog.style.width = Math.round(100*a/TOTAL) + '%';
    const shell = document.querySelector('.progress');
    if(shell){
      shell.setAttribute('role','progressbar');
      shell.setAttribute('aria-valuemin','0');
      shell.setAttribute('aria-valuemax', String(TOTAL));
      shell.setAttribute('aria-valuenow', String(a));
      shell.setAttribute('aria-label', '回答進捗：'+a+' / '+TOTAL);
    }
  }
  document.addEventListener('change', e=>{
    if(e.target && e.target.matches('input[type="radio"]')) updateProgress();
  }, true);
  document.addEventListener('DOMContentLoaded', updateProgress);

  /* ---- 平均（リスク側） ---- */
  function calcAvg(){
    const vals=[];
    for(let i=1;i<=TOTAL;i++){
      const chk = document.querySelector(`input[name="q${i}"]:checked`);
      if(!chk) continue;
      const raw = parseInt(chk.value,10);         // 1..5
      const rev = document.querySelector(`.scale[data-i="${i}"]`)?.dataset.rev==='1';
      vals.push(rev ? (6 - raw) : raw);
    }
    if(!vals.length) return null;
    return vals.reduce((a,b)=>a+b,0)/vals.length; // 1..5
  }
  function avgToRank(avg){
    if(avg<=TH[0]) return 1;
    if(avg<=TH[1]) return 2;
    if(avg<=TH[2]) return 3;
    if(avg<=TH[3]) return 4;
    return 5;
  }

  /* ---- 因子（保護％：高いほど良い） ---- */
  const EXTRA_REV = new Set([10]); // 10はネガ項目だが保護%では反転して扱う
  const FACTORS = [
    {name:'対話の整流', desc:'落ち着いて話し切る・合図・決め方', items:[6,7,11,18]},
    {name:'感謝と日常', desc:'感謝の言語化・短い近況・ねぎらい', items:[8,9,17]},
    {name:'公平と安心', desc:'負担の公平・安全な言い合い', items:[10,19]},
    {name:'ルールと見通し', desc:'連絡や誘いの線引き・先の予定', items:[13,20]}
  ];
  function calcProtectivePct(){
    const out=[];
    for(const f of FACTORS){
      let got=0, n=f.items.length;
      for(const i of f.items){
        const chk = document.querySelector(`input[name="q${i}"]:checked`);
        const raw = chk ? parseInt(chk.value,10) : 0; // 1..5 or 0
        let v = raw ? (raw-1) : 0;                     // 0..4
        const rev = document.querySelector(`.scale[data-i="${i}"]`)?.dataset.rev==='1';
        if(rev || EXTRA_REV.has(i)) v = 4 - v;         // 反転
        got += v;
      }
      const pct = Math.round((got / (n*4)) * 100);
      out.push({name:f.name, desc:f.desc, pct});
    }
    return out;
  }
  function renderFactors(){
    const list = calcProtectivePct();
    const box = document.getElementById('factorBox');
    if(!box) return;
    box.innerHTML = list.map((e, i) => `
      <div class="meter" role="group" aria-label="${e.name}">
        <div class="row">
          <div class="name">${e.name}</div>
          <div class="pct" id="mbar-${i}-pct">${e.pct}%</div>
        </div>
        <div class="mbar" aria-hidden="true"><span id="mbar-${i}" style="width:0"></span></div>
        ${e.desc ? `<div class="muted" style="font-size:.92em">${e.desc}</div>` : ``}
      </div>
    `).join('');
    requestAnimationFrame(() => {
      list.forEach((e,i) => {
        const bar = document.getElementById('mbar-'+i);
        if(bar) bar.style.width = e.pct + '%';
        const pct = document.getElementById(`mbar-${i}-pct`);
        if(pct) pct.textContent = e.pct + '%';
      });
    });
  }
  // 回答を変えたら、結果表示中は因子バーを再計算
  document.addEventListener('change', (e) => {
    if(e.target && e.target.matches('input[type="radio"]')){
      const r = document.getElementById('result');
      if(r && r.style.display !== 'none') renderFactors();
    }
  }, true);

  /* ---- 結果描画 ---- */
  function onCalc(){
    const avg=calcAvg();
    if(avg===null){ alert('未回答があります。できる範囲で選んでください。'); return; }
    const rank=avgToRank(avg);
    $('#result').style.display='';
    $('#r-ttl').textContent = R_TITLE[rank];
    $('#r-img').src = IMG[rank];
    $('#r-img').alt = R_TITLE[rank];
    $('#r-avgline').textContent = `平均スコア：${avg.toFixed(2)}（1=鎖に近い／5=糸に近い）`;
    $('#r-summary').textContent = R_SUMMARY[rank] || '';
    $('#r-text').textContent = R_TEXT[rank];
    renderFactors();

    try{
      document.dispatchEvent(new Event('result:ready')); // みんなのこころLv用
      localStorage.setItem('specimens:last', JSON.stringify({ id:'kizuna-rope', title:document.title, href: location.pathname }));
    }catch(_){}
    window.scrollTo({top: $('#result').offsetTop-10, behavior:'smooth'});
  }

  // ボタン
  $('#btn-calc')    ?.addEventListener('click', onCalc);
  $('#btn-calc-top')?.addEventListener('click', onCalc);

  // クリア
  $('#btn-clear')?.addEventListener('click', ()=>{
    $$('input[type="radio"]:checked').forEach(el=>el.checked=false);
    $('#result').style.display='none';
    updateProgress();
  });

  // 一覧戻る保存
  $('#to-index')?.addEventListener('click', ()=>{
    try{ localStorage.setItem('specimens:last', JSON.stringify({ id:'kizuna-rope', title:document.title, href: location.pathname })); }catch(_){}
  });
})();
</script>

<!-- ▼ 共通スニペット（回答の保存/復元＋みんなのこころLv） -->
<script>
/* ============================================================
   診断ページ共通スニペット
   1) 回答の自動保存・自動復元（入力中も逐次保存）
   2) 結果表示タイミングで「済」＋ あなたのLv +1
   3) みんなのこころLv（CountAPI）に +1（失敗は無視）
   ※ <body data-id="kizuna-rope"> 必須
============================================================ */
(function(){
  'use strict';
  var DONE_KEY='specimens:open:byid', TOTAL_KEY='specimens:open:total', GLOBAL_LAST='specimens:open:global:last';
  var MY_ID=(document.body&&document.body.getAttribute('data-id'))||'unknown';
  var ANSWER_KEY='specimens:answers:'+MY_ID;

  var COUNTAPI_NS='haisuikounozarigani_shindan', COUNTAPI_KEY='specimens_open_total';
  function countapiHit(){
    var url='https://api.countapi.xyz/hit/'+COUNTAPI_NS+'/'+COUNTAPI_KEY;
    if(navigator.sendBeacon){ try{ navigator.sendBeacon(url); }catch(_){ } }
    else{ fetch(url,{mode:'cors',cache:'no-store',keepalive:true}).catch(function(){}); }
  }

  function loadState(){ try{ return JSON.parse(localStorage.getItem(ANSWER_KEY)||'{}'); }catch(_){ return {}; } }
  function saveState(obj){ try{ localStorage.setItem(ANSWER_KEY, JSON.stringify(obj)); }catch(_){ } }
  function saveField(el){
    if(!el || !el.name) return;
    var st=loadState(), nm=el.name;
    if(el.type==='radio'){
      var chosen=(el.form||document).querySelector('input[type="radio"][name="'+nm+'"]:checked');
      st[nm]={t:'r',v: chosen? chosen.value : null};
    }else{ st[nm]={t:'t',v: el.value}; }
    saveState(st);
  }
  function restoreOnce(){
    var st=loadState(), names=Object.keys(st); if(!names.length) return false;
    names.forEach(function(nm){
      var info=st[nm]; if(!info) return;
      if(info.t==='r'){
        var r=document.querySelector('input[type="radio"][name="'+nm+'"][value="'+CSS.escape(String(info.v))+'"]');
        if(r){ r.checked=true; r.dispatchEvent(new Event('change',{bubbles:true})); }
      }else{
        var t=document.querySelector('[name="'+nm+'"]');
        if(t){ t.value=info.v==null? '' : String(info.v); }
      }
    });
    try{ document.dispatchEvent(new Event('change',{bubbles:true})); }catch(_){}
    return true;
  }
  document.addEventListener('change',function(e){
    var el=e.target; if(!(el instanceof HTMLElement)) return;
    if(el.matches('input[name], select[name], textarea[name]')) saveField(el);
  },true);

  (function restoreWhenReady(){
    var tries=0; function tick(){
      tries++;
      var hasAny=document.querySelector('input[name], select[name], textarea[name]');
      if(hasAny){ restoreOnce(); return; }
      if(tries<12) setTimeout(tick,300);
    }
    if(document.readyState!=='loading') tick(); else document.addEventListener('DOMContentLoaded',tick);
  })();

  // 結果が出たら一度だけ加算
  var marked=false;
  function markOnce(){
    if(marked) return; marked=true;
    try{
      localStorage.setItem(TOTAL_KEY, String((+localStorage.getItem(TOTAL_KEY)||0)+1));
      var map={}; try{ map=JSON.parse(localStorage.getItem(DONE_KEY)||'{}'); }catch(_){}
      map[MY_ID]=(map[MY_ID]||0)+1;
      localStorage.setItem(DONE_KEY, JSON.stringify(Object.assign({},map,{_ts:Date.now()})));
      countapiHit();
      try{ localStorage.setItem(GLOBAL_LAST, String((+localStorage.getItem(GLOBAL_LAST)||0)+1)); }catch(_){}
    }catch(_){}
  }
  document.addEventListener('result:ready', markOnce);
  setTimeout(markOnce, 2000);
})();
</script>
</body>
</html>