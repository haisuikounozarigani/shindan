<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>æ¨ã—é¡”è¨ºæ–­ï¼ˆç”·æ€§ï¼å¥³æ€§ï¼‰</title>
<meta name="description" content="24å•ã§ã€Œæ˜ã‚‹ã•ãƒ»å¯¾æ¯”ãƒ»è³ªæ„Ÿãƒ»æƒ…å ±é‡ãƒ»ãã¡ã‚“ã¨æ„Ÿãƒ»æ‰€ä½œãƒ†ãƒ³ãƒã€ã‚’ï¼…åŒ–ã€‚ç”·å¥³åˆ‡æ›¿ã§18ã‚¿ã‚¤ãƒ—ï¼‹éš ã—ã‚¿ã‚¤ãƒ—ï¼ˆã‚¯ã‚ºãƒãƒ£ãƒ¼ãƒ ï¼‰ã‚’åˆ¤å®šã—ã¾ã™ã€‚">
<meta name="theme-color" content="#f7f9ff">
<!-- OGPï¼ˆå¿…è¦ãªã‚‰å·®ã—æ›¿ãˆï¼‰ -->
<meta property="og:type" content="website">
<meta property="og:title" content="æ¨ã—é¡”è¨ºæ–­ï¼ˆç”·æ€§ï¼å¥³æ€§ï¼‰">
<meta property="og:description" content="24å•ãƒ»6å› å­ï¼…ã§â€œæ¨ã—é¡”â€ã‚¿ã‚¤ãƒ—ã‚’åˆ¤å®šã€‚ç”·å¥³åˆ‡æ›¿ï¼†ç”»åƒwebpå¯¾å¿œã€‚">
<meta property="og:image" content="/shindan/assets/results/oshi-face/male/t01.webp">
<style>
:root{
  --accent:#ff7a6b; --accent2:#ffba7e;
  --ink:#1f2732; --muted:#667087; --paper:#fff;
  --bg1:#f7f9ff; --bg2:#fff6f3; --line:#e6ecf7;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--ink);
  background:linear-gradient(180deg,var(--bg1),var(--bg2));
  font-family:"Noto Sans JP",system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN",sans-serif;
}
a{color:inherit}
.wrap{max-width:980px;margin:18px auto;padding:0 14px}
header.hd{display:grid;grid-template-columns:56px 1fr;gap:12px;align-items:center;margin:8px 0}
.logo{width:56px;height:56px;border-radius:14px;background:linear-gradient(135deg,#ffe9e5,#fff3df);display:grid;place-items:center;font-size:28px}
h1{margin:0;font-size:clamp(22px,4.6vw,34px);letter-spacing:.02em}
.sub{margin:4px 0 0;color:var(--muted);font-size:.96em}
.card{background:var(--paper);border:1px solid var(--line);border-radius:16px;padding:14px}
.section{margin:14px 0}
.pill{display:inline-block;padding:4px 8px;border:1px solid var(--line);border-radius:999px;background:#fff;color:#6b6a77;font-size:.88em}
.meta{display:flex;gap:8px;flex-wrap:wrap}
.sticky{position:sticky;top:0;z-index:10;margin:-6px -14px 12px;padding:8px 14px;background:rgba(255,255,255,.8);backdrop-filter:blur(6px) saturate(1.05);border-bottom:1px solid #e9edf7;display:flex;align-items:center;gap:10px}
.progress{height:8px;background:#edf2fb;border-radius:999px;flex:1;overflow:hidden}
.progress>span{
  display:block;height:100%;width:0;
  background:linear-gradient(90deg,var(--accent),var(--accent2));
  transition:width .25s ease;
}
.btn{padding:10px 14px;border:1px solid var(--line);border-radius:12px;background:#fff;cursor:pointer}
.btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));border-color:transparent;color:#fff;font-weight:700}
fieldset.q{border:1px solid var(--line);border-radius:12px;padding:10px;margin:10px 0;background:#fff}
legend{font-weight:700}
.scale{display:grid;grid-template-columns:repeat(5,minmax(66px,1fr));gap:8px;margin-top:8px}
.scale input{position:absolute;opacity:0;pointer-events:none}
.scale label{display:grid;place-items:center;border:1px solid #e5e9f3;border-radius:10px;padding:8px;cursor:pointer;user-select:none;background:#fff}
.scale input:checked+label{outline:2px solid var(--accent);border-color:transparent}
mark.need{animation:need 1.6s ease}
@keyframes need{0%{box-shadow:0 0 0 0 rgba(255,122,107,.45)}100%{box-shadow:0 0 0 0 rgba(255,122,107,0)}}
.result-head{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;font-weight:700}
.total{font-size:22px;font-weight:800}
.small{color:var(--muted);font-size:.92em}

/* ãƒˆã‚°ãƒ«ï¼ˆç”·å¥³ï¼‰ */
.mode-tabs{display:inline-flex;border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#fff}
.mode-tabs button{padding:8px 12px;border:0;background:#fff;cursor:pointer}
.mode-tabs button.on{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;font-weight:700}

/* ãƒ’ãƒ¼ãƒ­ãƒ¼ï¼ˆç”»åƒâ†’ãƒ†ã‚­ã‚¹ãƒˆï¼‰ */
.hero-vert{display:grid;place-items:center;border:1px solid var(--line);border-radius:16px;background:#fff;overflow:hidden}
.hero-vert figure{margin:0;width:min(720px,100%);max-width:100%;aspect-ratio:3/4;border-bottom:1px solid var(--line);background:#f7f9ff}
.hero-vert img{width:100%;height:100%;object-fit:cover;display:block}
.hero-vert figcaption{padding:10px;width:100%}
.hero-vert .capline{font-weight:800;line-height:1.55;overflow-wrap:anywhere;word-break:break-word;white-space:normal}
.hero-vert .capmini{font-size:1em;line-height:1.85;color:var(--muted);overflow-wrap:anywhere;word-break:break-word;white-space:normal}

.grid2{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px}
.stat{border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff}
.stat .big{font-size:22px;font-weight:800}
.hr{height:1px;background:var(--line);margin:10px 0}
.factor-mini{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px}
.bar{border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff}
.bar .row{height:10px;background:#edf2fb;border-radius:999px;overflow:hidden;margin-top:6px}
.bar .row>span{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent2))}
.note{border:1px solid var(--line);border-radius:12px;background:#fff;padding:10px}
.note h4{margin:0 0 6px;font-size:16px}

/* å…±æœ‰ãƒœã‚¿ãƒ³ */
.share-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.btn.tw::before{content:"ğ•";margin-right:.25em}
.btn.line::before{content:"ğŸ’¬";margin-right:.25em}
.btn.ig::before{content:"ğŸ“¸";margin-right:.25em}
.btn.save::before{content:"â¬‡ï¸";margin-right:.25em}

@media (max-width: 560px){
  .wrap{padding:0 10px}
  .sticky{top:calc(env(safe-area-inset-top) + 0px); padding:8px 10px}
  .scale{grid-template-columns:repeat(2,1fr)}
  .scale label{padding:12px 8px;font-size:14px}
  .hero-vert figure{width:100%}
  .grid2{grid-template-columns:1fr}
  .card{padding:12px}
  .hero-vert .capline{font-size:clamp(16px,5.2vw,20px);line-height:1.65}
  .hero-vert .capmini{font-size:clamp(14px,4.6vw,16px);line-height:1.95}
  .note h4{font-size:15px}
}
#shareRow{display:flex !important; flex-wrap:wrap; gap:8px}
</style>
</head>
<body>
<main class="wrap" id="app">
  <header class="hd">
    <div class="logo">âœ¨</div>
    <div>
      <h1>æ¨ã—é¡”è¨ºæ–­ï¼ˆç”·æ€§ï¼å¥³æ€§ï¼‰</h1>
      <p class="sub">24å•ï¼ˆ0ã€œ4ã®5ä»¶æ³•ï¼‰ã€‚6å› å­ã®ï¼…ã¨ã‚¿ã‚¤ãƒ—ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚â€»ã‚¨ãƒ³ã‚¿ãƒ¡è‡ªå·±ç†è§£ï¼å› æœã¯æ–­å®šã—ã¾ã›ã‚“ã€‚</p>
    </div>
  </header>

  <div class="sticky" aria-live="polite">
    <div class="mode-tabs" role="tablist" aria-label="ç”»åƒã®æ€§åˆ¥åˆ‡æ›¿">
      <button id="modeMale"  class="on" role="tab" aria-selected="true">ç”·æ€§ç‰ˆ</button>
      <button id="modeFemale" role="tab" aria-selected="false">å¥³æ€§ç‰ˆ</button>
    </div>
    <div class="progress" aria-label="å›ç­”é€²æ—" role="progressbar" aria-valuemin="0" aria-valuemax="24">
      <span id="prog"></span>
    </div>
    <button class="btn primary" id="doScore">è¨ºæ–­ã™ã‚‹</button>
  </div>

  <section class="card section" id="desc">
    <h2 style="margin:4px 0 8px">èª¬æ˜</h2>
    <div class="meta" style="margin-bottom:8px">
      <span class="pill">è³ªå•æ•°ï¼š24</span>
      <span class="pill">å½¢å¼ï¼š0â€“4ï¼ˆ0=ãœã‚“ãœã‚“ / 4=ã¨ã¦ã‚‚ï¼‰</span>
      <span class="pill">å‡ºåŠ›ï¼š6å› å­ï¼…â†’ã‚¿ã‚¤ãƒ—åˆ¤å®šï¼ˆ18ï¼‹éš ã—ï¼‰</span>
    </div>
    <p class="small">ç”·å¥³åˆ‡æ›¿ã¯<b>ç”»åƒã¨ãƒ†ã‚­ã‚¹ãƒˆï¼ˆaltï¼‰</b>ã®ã¿å¤‰ã‚ã‚Šã¾ã™ã€‚åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã¯å…±é€šã§ã™ã€‚</p>
  </section>

  <!-- è¨­å• -->
  <section class="card section" id="questions">
    <h2 style="margin:4px 0 8px">è¨­å•ï¼ˆãœã‚“ãœã‚“ï¼ã‚ã¾ã‚Šï¼ã¨ãã©ãï¼ã‚ˆãï¼ã¨ã¦ã‚‚ï¼‰</h2>
    <div id="qWrap"></div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
      <button class="btn" id="clearAns">å›ç­”ã‚’ã‚¯ãƒªã‚¢</button>
      <button class="btn primary" id="doScore2">è¨ºæ–­ã™ã‚‹</button>
    </div>
  </section>

  <!-- çµæœ -->
  <section class="card section" id="result" aria-live="polite">
    <div id="resEmpty">
      <span class="badge">ã¾ã çµæœã¯ã‚ã‚Šã¾ã›ã‚“</span>
      <p class="small">å…¨24å•ã«å›ç­”ã—ã¦ã€Œè¨ºæ–­ã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>
    </div>

    <div id="resArea" style="display:none">
      <div class="result-head">
        <span class="badge">çµæœ</span>
        <div class="total" id="typeLine">â€”</div>
      </div>

      <!-- ãƒ’ãƒ¼ãƒ­ãƒ¼ï¼ˆã‚¿ã‚¤ãƒ—ç”»åƒï¼‹ãƒŸãƒ‹æƒ…å ±ï¼‰ -->
      <div class="hero-vert section" role="region" aria-label="ã‚¿ã‚¤ãƒ—ã‚¤ãƒ¡ãƒ¼ã‚¸">
        <figure>
          <img id="heroImg" src="/shindan/assets/results/oshi-face/male/t01.webp" alt="çµæœã‚¤ãƒ¡ãƒ¼ã‚¸" loading="lazy" width="960" height="1280">
        </figure>
        <figcaption>
          <div class="capline" id="heroTitle">â€”</div>
          <div class="capmini" id="heroCopy">â€”</div>
          <div class="capmini" id="heroTaste" style="margin-top:4px">â€”</div>
     <div class="share-row" id="shareRow" hidden>
  <button id="btnShot"  class="btn save" type="button">çµæœç”»åƒã‚’ä¿å­˜</button>
  <button id="shareTw"  class="btn tw"   type="button">Xã§å…±æœ‰</button>
  <button id="shareLn"  class="btn line" type="button">LINEã§é€ã‚‹</button>
  <button id="shareIg"  class="btn ig"   type="button" aria-label="Instagramï¼ˆWebï¼‰">Instagram</button>
  <button id="shareCp"  class="btn"      type="button">ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼</button>
</div>
<!-- ã¾ã¨ã‚ç”»åƒã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã®ã‚­ãƒ£ãƒ³ãƒã‚¹ï¼ˆéè¡¨ç¤ºï¼‰ -->
<canvas id="shotCanvas" width="1080" height="1350" style="display:none"></canvas>
        </figcaption>
      </div>

      <div class="grid2">
        <article class="stat" aria-label="ç·åˆã‚¹ã‚³ã‚¢">
          <div><strong>å› å­å¹³å‡ï¼ˆ0â€“4ï¼‰</strong></div>
          <div class="big"><span id="sumAvg">0.00</span> / 4.00 <span class="small" id="sumPct">= 0%</span></div>
          <div class="small" id="sumNote">â€”</div>
        </article>
      </div>

      <div class="hr"></div>
      <!-- å› å­ãƒãƒ¼ -->
      <div class="section">
        <h3 style="margin:8px 0">6å› å­ï¼ˆï¼…ï¼‰</h3>
        <div id="bars" class="factor-mini"></div>
      </div>

      <div class="hr"></div>
      <!-- ãƒ©ãƒ³ã‚¯/é•·æ–‡ï¼ˆä»»æ„ï¼‰ -->
      <div id="longCopy" class="small"></div>

      <div class="hr"></div>
      <!-- ç ”ç©¶ãƒ¡ãƒ¢ -->
      <details class="section" open>
        <summary><strong>ç ”ç©¶ãƒ¡ãƒ¢</strong></summary>
        <ul class="small" id="resMemo" style="margin:6px 0 0 18px;line-height:1.8"></ul>
        <p class="small" style="margin-top:6px">â€»ç›¸é–¢ä¸­å¿ƒã§å› æœã¯æ–­å®šã§ãã¾ã›ã‚“ã€‚å€‹äººå·®ãŒå¤§ãã„æ€§è³ªãŒã‚ã‚Šã¾ã™ã€‚åŒ»ç™‚ãƒ»æ¡ç”¨ãªã©ã®ç”¨é€”ã«ã¯ä½¿ãˆã¾ã›ã‚“ã€‚</p>
      </details>

      <div class="back-area" style="display:flex;justify-content:center;margin-top:12px">
        <a class="back" href="/shindan/" id="backLink" aria-label="è¨ºæ–­ä¸€è¦§ã«æˆ»ã‚‹">è¨ºæ–­ä¸€è¦§ã«æˆ»ã‚‹</a>
      </div>
    </div>
  </section>

  <section class="footer card">
    <h2 style="margin:4px 0 8px">ã”åˆ©ç”¨ã«ã‚ãŸã£ã¦</h2>
    <p class="small">ã“ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯<b>ã‚¨ãƒ³ã‚¿ãƒ¡ç”¨ã®è‡ªå·±ç†è§£</b>ã§ã™ã€‚ç¾å®Ÿã®åˆ¤æ–­ã‚„åŒ»ç™‚ãƒ»æ¡ç”¨ã«ã¯ä½¿ãˆã¾ã›ã‚“ã€‚å¿…è¦ãªå ´åˆã¯é–¢ä¿‚æ©Ÿé–¢ãƒ»å°‚é–€å®¶ã«ã”ç›¸è«‡ãã ã•ã„ã€‚<br>
    ãƒ‡ãƒ¼ã‚¿ã¯ç«¯æœ«å†…ã§å‡¦ç†ã•ã‚Œã€å€‹äººã‚’ç‰¹å®šã™ã‚‹æƒ…å ±ã®é€ä¿¡ãƒ»åé›†ã¯è¡Œã„ã¾ã›ã‚“ï¼ˆã”åˆ©ç”¨ç’°å¢ƒã«ã‚ˆã‚Šã‚¢ã‚¯ã‚»ã‚¹è§£æç­‰ãŒå‹•ä½œã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼‰ã€‚</p>
  </section>
</main>

<script>
(function(){
  // ====== ãƒšãƒ¼ã‚¸æƒ…å ± ======
  var SLUG = "oshi-face";
  var TITLE = "æ¨ã—é¡”è¨ºæ–­ï¼ˆç”·æ€§ï¼å¥³æ€§ï¼‰";
  var ANS_KEY = "specimens:"+SLUG+":answers";
  var GENDER_KEY = "specimens:"+SLUG+":gender";
  var IMG_BASE = "/shindan/assets/results/oshi-face/"; // {male|female}/t01.webp..t19.webp

  // ====== æ€§åˆ¥çŠ¶æ…‹ ======
  var CURRENT_GENDER = (localStorage.getItem(GENDER_KEY) || "male"); // "male" | "female"
  var modeMaleBtn = document.getElementById("modeMale");
  var modeFemaleBtn = document.getElementById("modeFemale");
  function setGender(g){
    CURRENT_GENDER = g;
    try{ localStorage.setItem(GENDER_KEY,g); }catch(e){}
    modeMaleBtn.classList.toggle("on", g==="male");
    modeFemaleBtn.classList.toggle("on", g==="female");
    modeMaleBtn.setAttribute("aria-selected", g==="male" ? "true":"false");
    modeFemaleBtn.setAttribute("aria-selected", g==="female" ? "true":"false");
    if(state.type){ renderType(); }
  }
  modeMaleBtn.addEventListener("click", function(){ setGender("male"); }, false);
  modeFemaleBtn.addEventListener("click", function(){ setGender("female"); }, false);

// ====== å› å­ãƒ»è¨­å• ======
// 6å› å­ï¼ˆLIGHT/CONTRAST/GLOSS/DENSITY/STRUCTURE/TEMPOï¼‰ã¯æ—¢å­˜ã®ã¾ã¾åˆ©ç”¨
var FACTORS = {
  LIGHT:     { name:"æ˜ã‚‹ã•ï¼ˆLIGHTï¼‰",               items:["Q01","Q02","Q20"] },
  CONTRAST:  { name:"å¯¾æ¯”ï¼ˆCONTRASTï¼‰",             items:["Q03","Q04","Q14","Q21"] },
  GLOSS:     { name:"è³ªæ„Ÿãƒ„ãƒ¤ï¼ˆGLOSSï¼‰",             items:["Q05","Q06","Q13","Q22","Q19"] },
  DENSITY:   { name:"æƒ…å ±é‡ï¼ˆDENSITYï¼‰",             items:["Q07","Q08","Q18","Q23","Q15"] },
  STRUCTURE: { name:"ãã¡ã‚“ã¨æ„Ÿï¼ˆSTRUCTUREï¼‰",       items:["Q09","Q10","Q16","Q24"] },
  TEMPO:     { name:"æ‰€ä½œãƒ†ãƒ³ãƒï¼ˆTEMPOï¼‰",           items:["Q11","Q12","Q17"] }
};
window.FACTORS = FACTORS;

// â–¼æ–°ã—ã„â€œå¥½ã¿ä¸­å¿ƒâ€24å•ï¼ˆ0=ãœã‚“ãœã‚“ã€œ4=ã¨ã¦ã‚‚ï¼revã¯é€†è»¢ï¼‰
var ITEMS = {
  Q01:{ text:"æ˜ã‚‹ã„ç¬‘é¡”ã‚„ã‚­ãƒ©ãƒƒã¨ã—ãŸè¡¨æƒ…ã«æƒ¹ã‹ã‚Œã‚‹ã€‚" },
  Q02:{ text:"è–„æš—ãé™ã‹ãªç©ºæ°—ã®ã»ã†ãŒè‰²æ°—ã‚’æ„Ÿã˜ã‚‹ã€‚", rev:true },

  Q03:{ text:"ç™½é»’ã®â€œãã£ãã‚ŠåŠ¹ã„ãŸâ€å¯¾æ¯”ã«èƒ¸ãŒé«˜é³´ã‚‹ã€‚" },
  Q04:{ text:"ã‚„ã‚ã‚‰ã‹ãªåŒç³»è‰²ãƒ»ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãŒå¥½ãã€‚", rev:true },

  Q05:{ text:"é«ªãƒ»è‚Œãƒ»ã‚¢ã‚¯ã‚»ã®â€œè‰¶â€ãŒã‚ã‚‹ã¨ä¸€æ°—ã«åˆºã•ã‚‹ã€‚" },
  Q06:{ text:"ãƒãƒƒãƒˆã§è½ã¡ç€ã„ãŸè³ªæ„Ÿã®ã»ã†ãŒå®‰å¿ƒã™ã‚‹ã€‚", rev:true },

  Q07:{ text:"å°ç‰©ã‚„æŸ„ãŒâ€œå°‘ã—å¤šã‚â€ã§ã‚‚ãƒ¯ã‚¯ãƒ¯ã‚¯ã™ã‚‹ã€‚"},
  Q08:{ text:"ç„¡åœ°ï¼†ä½™ç™½ãŸã£ã·ã‚Šã®ãƒŸãƒ‹ãƒãƒ«ã«æƒ¹ã‹ã‚Œã‚‹ã€‚", rev:true },

  Q09:{ text:"ç›´ç·šçš„ã§ç«¯æ­£ãªã‚·ãƒ«ã‚¨ãƒƒãƒˆã«ã‚°ãƒƒã¨ãã‚‹ã€‚"},
  Q10:{ text:"ã‚†ã‚‹ã„è½ã¡æ„Ÿã‚„ä¸¸ã¿ã®ã‚ã‚‹ãƒ©ã‚¤ãƒ³ãŒå¿ƒåœ°ã‚ˆã„ã€‚", rev:true },

  Q11:{ text:"æ˜ã‚‹ããƒ†ãƒ³ãƒã®é€Ÿã„æ‰€ä½œã«æƒ¹ã‹ã‚ŒãŒã¡ã€‚"},
  Q12:{ text:"ã‚†ã£ãã‚Šä¸å¯§ãªæ‰€ä½œã«å®‰å¿ƒã™ã‚‹ã€‚", rev:true },

  Q13:{ text:"é¦™ã‚Šã‚„ãƒ©ãƒ¡ãªã©â€œã‚­ãƒ©ãƒƒâ€ã¨å…‰ã‚‹è¦ç´ ã¯æ­“è¿ã€‚"},
  Q14:{ text:"è‰²æ•°ã¯å°‘ãªãã€ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆã§ã¯ã£ãã‚Šæ±ºã‚ãŸã„ã€‚"},

  Q15:{ text:"ãƒ•ã‚£ãƒ«ãƒ å†™çœŸã‚„ãƒ¬ãƒˆãƒ­å–«èŒ¶ã®é›°å›²æ°—ãŒåˆºã•ã‚‹ã€‚"},
  Q16:{ text:"æ©Ÿèƒ½çš„ãƒ»å®Ÿç”¨çš„ãªãƒ‡ã‚£ãƒ†ãƒ¼ãƒ«ã‚’è¦‹ã‚‹ã¨å¥½å°è±¡ã€‚"},

  Q17:{ text:"å ´ã®ä¸­å¿ƒã§ã‚‚æ§˜ã«ãªã‚‹â€œä¸»å½¹æ„Ÿâ€ã«æƒ¹ã‹ã‚Œã‚‹ã€‚"},
  Q18:{ text:"è£…é£¾ã¯å°‘ãªã‚ã€â€œç´ ã®è‰¯ã•â€ãŒã„ã¡ã°ã‚“ã€‚", rev:true },

  Q19:{ text:"å¤œæ™¯ã‚„ãƒã‚ªãƒ³ã€ã‚¤ãƒ«ãƒŸã®ãã‚‰ã‚ãã«å¼±ã„ã€‚"},
  Q20:{ text:"ã‚­ãƒ£ãƒ³ãƒ‰ãƒ«ã‚„é–“æ¥ç…§æ˜ã®è½ã¡ç€ããŒä¼¼åˆã†äººãŒå¥½ãã€‚", rev:true },

  Q21:{ text:"æ·¡ã„ä¸­é–“è‰²ã‚„ã¼ã‹ã—ã®ç¹Šç´°ã•ãŒâ€œç¶ºéº—â€ã ã¨æ€ã†ã€‚", rev:true },
  Q22:{ text:"ãƒ„ãƒ¤ã‚ˆã‚Šâ€œãƒãƒƒãƒˆã®ä¸Šå“ã•â€ã‚’æ¨ã—ãŸã„ã€‚", rev:true },

  Q23:{ text:"ãƒ­ã‚´ã‚ˆã‚Šç´ æãƒ»å½¢ã®è‰¯ã•ã‚’é‡è¦–ã™ã‚‹ã€‚"},
  Q24:{ text:"å°‘ã—å´©ã—ãŸâ€œæŠœã‘æ„Ÿâ€ã«æƒ¹ã‹ã‚Œã‚‹ã€‚", rev:true }
};
var LABELS = ["ãœã‚“ãœã‚“","ã‚ã¾ã‚Š","ã¨ãã©ã","ã‚ˆã","ã¨ã¦ã‚‚"];

  // ====== ã‚¿ã‚¤ãƒ—å®šç¾©ï¼ˆ18ï¼‹éš ã—19ï¼‰ ======
  var TYPES = [
    { id:1,  key:"t01", name:"çˆ½ã‚„ã‹æ¸…æ½”",         catch:"æ˜ã‚‹ãã‚¯ãƒªãƒ¼ãƒ³ã€‚ä½™ç™½ã¨æ¸…æ½”æ„Ÿã€‚",           taste:"æ¨ã—è‰²ï¼šç™½ãƒ»è–„é’ï¼ã‚­ãƒ¼ï¼šç™½ã‚¹ãƒ‹ãƒ¼ã‚«ãƒ¼" },
    { id:2,  key:"t02", name:"ãƒŸãƒ‹ãƒãƒ«ç„¡åœ°",       catch:"ç„¡åœ°ã¨ã‚µã‚¤ã‚ºæ„Ÿã§é­…ã›ã‚‹ã€‚",                 taste:"æ¨ã—è‰²ï¼šç™½ãƒ»é»’ãƒ»ã‚¨ã‚¯ãƒªãƒ¥ï¼ã‚­ãƒ¼ï¼šç´ æã®è‰¯ã•" },
    { id:3,  key:"t03", name:"æ·¡è‰²ã‚„ã‚ã‚‰ã‹",       catch:"ä½ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆã§ã‚„ã•ã—ã„ç©ºæ°—ã€‚",           taste:"æ¨ã—è‰²ï¼šãã™ã¿ãƒ‘ã‚¹ãƒ†ãƒ«ï¼ã‚­ãƒ¼ï¼šæºã‚Œç´ æ" },
    { id:4,  key:"t04", name:"ã‚ªãƒ¼ãƒ«ãƒ–ãƒ©ãƒƒã‚¯",     catch:"é»’Ã—ç›´ç·šã§ä¸€æ°—ã«ç· ã‚ã‚‹ã€‚",                 taste:"æ¨ã—è‰²ï¼šé»’ï¼ã‚­ãƒ¼ï¼šãƒ¬ã‚¶ãƒ¼" },
    { id:5,  key:"t05", name:"ãƒ¢ãƒãƒˆãƒ¼ãƒ³ãã£ã±ã‚Š", catch:"ç™½é»’ã®å¯¾æ¯”ã§ç«¯æ­£ã«ã€‚",                     taste:"æ¨ã—è‰²ï¼šç™½ãƒ»é»’ï¼ã‚­ãƒ¼ï¼šä½™ç™½" },
    { id:6,  key:"t06", name:"ã‚†ã‚‹ã‚¹ãƒˆãƒªãƒ¼ãƒˆ",     catch:"ãƒªãƒ©ãƒƒã‚¯ã‚¹Ã—ä»Šã£ã½ã•ã€‚",                   taste:"æ¨ã—è‰²ï¼šå·®ã—è‰²è‡ªç”±ï¼ã‚­ãƒ¼ï¼šãƒ¯ã‚¤ãƒ‰" },
    { id:7,  key:"t07", name:"çŸ¥çš„ãã‚Œã„ã‚",       catch:"é™ã‹ãªçŸ¥æ€§ã€ç«¯æ­£ã•ã€‚",                     taste:"æ¨ã—è‰²ï¼šãƒã‚¤ãƒ“ãƒ¼Ã—ç™½ï¼ã‚­ãƒ¼ï¼šç´°ãƒ•ãƒ¬ãƒ¼ãƒ " },
    { id:8,  key:"t08", name:"æ¸…æ¥šã‚¯ãƒ©ã‚·ãƒƒã‚¯",     catch:"ãã¡ã‚“ã¨æ„Ÿã¨æ¸…æ¥šã€‚",                       taste:"æ¨ã—è‰²ï¼šç´ºãƒ»ç”Ÿæˆã‚Šï¼ã‚­ãƒ¼ï¼šè†ä¸‹ãƒ©ã‚¤ãƒ³" },
    { id:9,  key:"t09", name:"ã‚¹ãƒãƒ¼ãƒ†ã‚£æ©Ÿèƒ½",     catch:"æ©Ÿèƒ½ç¾ï¼†ãƒ˜ãƒ«ã‚·ãƒ¼ã€‚",                       taste:"æ¨ã—è‰²ï¼šç™½Ã—ãƒã‚¤ãƒ“ãƒ¼ï¼ã‚­ãƒ¼ï¼šã‚¢ã‚¹ãƒ¬ã‚¸ãƒ£ãƒ¼" },
    { id:10, key:"t10", name:"ãƒŠãƒãƒ¥ãƒ©ãƒ«",         catch:"åŠ›ã®æŠœã‘ãŸå¿ƒåœ°ã‚ˆã•ã€‚",                     taste:"æ¨ã—è‰²ï¼šç”Ÿæˆã‚Šãƒ»ãƒ™ãƒ¼ã‚¸ãƒ¥ï¼ã‚­ãƒ¼ï¼šãƒªãƒãƒ³" },
    { id:11, key:"t11", name:"ã‚¬ãƒ¼ãƒªãƒ¼",           catch:"å¯æ†ã§è¦ªã—ã¿ã€‚",                           taste:"æ¨ã—è‰²ï¼šãƒ‘ã‚¹ãƒ†ãƒ«ï¼ã‚­ãƒ¼ï¼šå°ç²’ã‚¢ã‚¯ã‚»" },
    { id:12, key:"t12", name:"ã‚«ãƒ©ãƒ•ãƒ«",           catch:"é«˜å½©åº¦ã§æ¥½ã—ã„ä¸»å½¹æ„Ÿã€‚",                   taste:"æ¨ã—è‰²ï¼šãƒ“ãƒ“ãƒƒãƒ‰ï¼ã‚­ãƒ¼ï¼šãƒ¬ã‚¤ãƒ¤ãƒ¼" },
    { id:13, key:"t13", name:"å¤ç€ãƒ¬ãƒˆãƒ­",         catch:"ã¬ãã‚‚ã‚Šã‚ã‚‹ãƒ´ã‚£ãƒ³ãƒ†ãƒ¼ã‚¸ã€‚",               taste:"æ¨ã—è‰²ï¼šãƒ‡ãƒ‹ãƒ Ã—ãƒã‚§ãƒƒã‚¯ï¼ã‚­ãƒ¼ï¼šå¤ç€MIX" },
    { id:14, key:"t14", name:"éŸ“å›½ã£ã½",           catch:"ç«¯æ­£Ã—ã„ã¾æ„Ÿã€‚",                           taste:"æ¨ã—è‰²ï¼šç™½é»’ï¼ã‚­ãƒ¼ï¼šãƒ­ãƒ³ã‚°ç›´ç·š" },
    { id:15, key:"t15", name:"ã‚­ãƒ©ã‚­ãƒ©æ´¾æ‰‹",       catch:"å…‰æ²¢ã¨ä¸»å½¹æ„Ÿã§æƒ¹ãã¤ã‘ã‚‹ã€‚",               taste:"æ¨ã—è‰²ï¼šé»’Ã—ã‚·ãƒ«ãƒãƒ¼ï¼ã‚­ãƒ¼ï¼šãƒ“ã‚¸ãƒ¥ãƒ¼" },
    { id:16, key:"t16", name:"åœ°é›·ï¼ˆé»’Ã—ãƒ”ãƒ³ã‚¯ï¼‰",  catch:"é»’ä¸»å½¹ã®ç”˜è¾›ã€‚",                           taste:"æ¨ã—è‰²ï¼šé»’Ã—ãƒ”ãƒ³ã‚¯ï¼ã‚­ãƒ¼ï¼šãƒãƒ§ãƒ¼ã‚«ãƒ¼" },
    { id:17, key:"t17", name:"ç†ç³»ã‚¯ãƒªãƒ¼ãƒ³",       catch:"ç„¡é§„ãªãæ¸…æ½”ãƒ»ç›´ç·šã€‚",                     taste:"æ¨ã—è‰²ï¼šç™½Ã—ãƒã‚¤ãƒ“ãƒ¼ï¼ã‚­ãƒ¼ï¼šæœ€å°å°ç‰©" },
    { id:18, key:"t18", name:"æ–‡ç³»ã‚¯ãƒ©ã‚·ãƒƒã‚¯",     catch:"ã‚„ã‚ã‚‰ã‹ä¸Šå“ãƒ»èª­æ›¸æ„Ÿã€‚",                   taste:"æ¨ã—è‰²ï¼šç”Ÿæˆã‚ŠÃ—ãƒ–ãƒ©ã‚¦ãƒ³ï¼ã‚­ãƒ¼ï¼šé©å°ç‰©" },
    { id:19, key:"t19", name:"ã‚¯ã‚ºãƒãƒ£ãƒ¼ãƒ ï¼ˆå¤œã®ã‚«ãƒªã‚¹ãƒï¼‰", catch:"é»’ã¨è‰¶ã€è¦–ç·šã®é–“åˆã„ã€‚å±ã†ã„ã®ã«ç›®ã‚’é›¢ã›ãªã„ã€‚", taste:"æ¨ã—è‰²ï¼šé»’Ã—ã‚·ãƒ«ãƒãƒ¼ï¼ã‚­ãƒ¼ï¼šç´°ãƒã‚§ãƒ¼ãƒ³", hidden:true }
  ];
  var ALT = {}; TYPES.forEach(function(t){ ALT[t.id] = { male: t.name+"ï¼ˆç”·æ€§ç‰ˆï¼‰", female:t.name+"ï¼ˆå¥³æ€§ç‰ˆï¼‰" }; });

// ====== è¦ç´ å‚ç…§ ======
var qWrap   = document.getElementById("qWrap");
var prog    = document.getElementById("prog");
var resEmpty= document.getElementById("resEmpty");
var resArea = document.getElementById("resArea");
var typeLine= document.getElementById("typeLine");
var heroImg = document.getElementById("heroImg");
var heroTitle= document.getElementById("heroTitle");
var heroCopy = document.getElementById("heroCopy");
var heroTaste= document.getElementById("heroTaste");
var sumAvg  = document.getElementById("sumAvg");
var sumPct  = document.getElementById("sumPct");
var sumNote = document.getElementById("sumNote");
var bars    = document.getElementById("bars");
var longCopy= document.getElementById("longCopy");
var resMemo = document.getElementById("resMemo");
var shareRow= document.getElementById("shareRow");
var shareTw = document.getElementById("shareTw");
var shareLn = document.getElementById("shareLn");
var shareIg = document.getElementById("shareIg");
var btnShot = document.getElementById("btnShot");
var shotCanvas = document.getElementById("shotCanvas");
window.shotCanvas = shotCanvas;

// ç¾åœ¨ã®åˆ¤å®šãŒã‚ã‚‹ã¨ãã€æ€§åˆ¥ã ã‘åæ˜ ã—ã¦ç”»åƒ/altã‚’æ›´æ–°
function renderType(){
  if(!state || !state.type) return;
  var t = state.type;
  heroImg.src = (function(){
  var id = String(t.id).padStart(2,"0");
  var g = (CURRENT_GENDER === "male" ? "female" : "male"); // é€†ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½¿ã†
  return IMG_BASE + g + "/t" + id + ".webp";
})();
  heroImg.alt = (ALT[t.id] && ALT[t.id][CURRENT_GENDER]) || "çµæœã‚¤ãƒ¡ãƒ¼ã‚¸";
}
  // ====== è¨­å•ç”Ÿæˆ ======
  function buildQuestions(){
    var html = "";
    Object.keys(ITEMS).forEach(function(qid, i){
      var q = ITEMS[qid];
      html += '<fieldset class="q" id="fs-'+qid+'">'+
        '<legend>'+String(i+1).padStart(2,"0")+'. '+q.text+'</legend>'+
        '<div class="scale" role="radiogroup" aria-label="'+q.text+'">';
      for(var v=0;v<=4;v++){
        html += '<div style="position:relative">'+
          '<input id="q'+qid+'-'+v+'" type="radio" name="q'+qid+'" value="'+v+'">'+
          '<label for="q'+qid+'-'+v+'" title="'+LABELS[v]+'">'+LABELS[v]+'</label>'+
        '</div>';
      }
      html += '</div></fieldset>';
    });
    qWrap.innerHTML = html;

    qWrap.querySelectorAll('input[type="radio"]').forEach(function(r){
      r.addEventListener('change', function(){ saveAnswers(); updateProgress(); }, false);
    });
    restoreAnswers();
    updateProgress();
  }

  // ====== ä¿å­˜/å¾©å…ƒ ======
  function saveAnswers(){
    try{
      var out = {};
      Object.keys(ITEMS).forEach(function(id){
        var chk = qWrap.querySelector('#fs-'+id+' input[type="radio"]:checked');
        if(chk){ out[id] = parseInt(chk.value,10); }
      });
      localStorage.setItem(ANS_KEY, JSON.stringify({ts:Date.now(), ans:out}));
    }catch(e){}
  }
  function restoreAnswers(){
    try{
      var raw = localStorage.getItem(ANS_KEY);
      if(!raw) return;
      var data = JSON.parse(raw);
      var ans = (data && data.ans) || {};
      Object.keys(ans).forEach(function(id){
        var v = ans[id];
        var input = qWrap.querySelector('#q'+id+'-'+v);
        if(input){ input.checked = true; }
      });
    }catch(e){}
  }
  function wipeAnswers(){ try{ localStorage.removeItem(ANS_KEY); }catch(e){} }

  function updateProgress(){
    var total = Object.keys(ITEMS).length;
    var answered = 0;
    Object.keys(ITEMS).forEach(function(id){
      if(qWrap.querySelector('#fs-'+id+' input[type="radio"]:checked')) answered++;
    });
    var pct = Math.round(100*answered/total);
    prog.style.width = pct + "%";
    var bar = prog.parentElement;
    if(bar){
      bar.setAttribute("aria-valuenow", answered);
      bar.setAttribute("aria-label", "å›ç­”é€²æ—ï¼š"+answered+" / "+total);
    }
  }

  // ====== ã‚¹ã‚³ã‚¢è¨ˆç®— ======
  function valOf(id, raw){ var v=Number(raw); return (ITEMS[id].rev? (4-v):v); }
  function calc(){
    var missing = [];
    var ans = {};
    Object.keys(ITEMS).forEach(function(id){
      var chk = qWrap.querySelector('#fs-'+id+' input[type="radio"]:checked');
      if(!chk){ missing.push(id); return; }
      ans[id] = parseInt(chk.value,10);
    });
    if(missing.length){
      alert("æœªå›ç­”ãŒã‚ã‚Šã¾ã™ã€‚å…¨24å•ã«ãŠç­”ãˆãã ã•ã„ã€‚");
      var fs = document.getElementById('fs-'+missing[0]);
      if(fs){ fs.scrollIntoView({behavior:"smooth", block:"center"}); fs.classList.add("need"); setTimeout(function(){ fs.classList.remove("need"); },1600); }
      return;
    }

    var fScore = {}, fPct = {};
    Object.keys(FACTORS).forEach(function(key){
      var ids = FACTORS[key].items;
      var sum = ids.reduce(function(s,id){ return s + valOf(id, ans[id]); },0);
      var avg = sum / ids.length; // 0-4
      fScore[key] = avg;
      fPct[key] = Math.round((avg/4)*100);
    });

    var keys = Object.keys(FACTORS);
    var totalAvg = keys.reduce(function(s,k){ return s + fScore[k]; },0) / keys.length;
    var totalPct = Math.round((totalAvg/4)*100);

    render({ fScore, fPct, totalAvg, totalPct });
  }

  // ====== ã‚¿ã‚¤ãƒ—åˆ¤å®šï¼ˆéš ã—å„ªå…ˆï¼‰ ======
  function pickType(p){
    // éš ã—19æ¡ä»¶ï¼šCONTRASTâ‰¥70, GLOSSâ‰¥70, TEMPOâ‰¥60, DENSITYâ‰¥55
    if(p["CONTRAST"]>=70 && p["GLOSS"]>=70 && p["TEMPO"]>=60 && p["DENSITY"]>=55){
      return TYPES.find(function(t){ return t.id===19; });
    }
    // ãƒ«ãƒ¼ãƒ«
    var rules = [
      [1,  p.LIGHT>=60 && p.DENSITY<=45],
      [2,  p.DENSITY<=40 && p.GLOSS<=50],
      [3,  p.CONTRAST<=40 && p.STRUCTURE<=55],
      [4,  p.LIGHT<=40 && p.CONTRAST>=70 && p.STRUCTURE>=60],
      [5,  p.CONTRAST>=65 && p.STRUCTURE>=55],
      [6,  p.STRUCTURE<=45 && p.TEMPO>=60],
      [7,  p.STRUCTURE>=65 && p.TEMPO<=55 && p.GLOSS<=60],
      [8,  p.STRUCTURE>=65 && p.CONTRAST<=55 && p.TEMPO<=55],
      [9,  p.STRUCTURE>=60 && p.DENSITY<=50 && p.TEMPO>=55],
      [10, p.STRUCTURE<=50 && p.DENSITY<=55 && p.LIGHT>=50],
      [11, p.LIGHT>=60 && p.CONTRAST<=55 && p.GLOSS>=55],
      [12, p.DENSITY>=65 && p.CONTRAST>=60 && p.TEMPO>=60],
      [13, p.LIGHT<=45 && p.GLOSS<=50 && p.STRUCTURE<=50],
      [14, p.STRUCTURE>=65 && p.CONTRAST>=60],
      [15, p.GLOSS>=70 && p.DENSITY>=60 && p.TEMPO>=60 && p.CONTRAST>=60],
      [16, p.CONTRAST>=70 && p.LIGHT<=45 && p.GLOSS>=60],
      [17, p.STRUCTURE>=65 && p.DENSITY<=50 && p.LIGHT>=55 && p.GLOSS<=55],
      [18, (p.STRUCTURE<=55) && (p.DENSITY>=45 && p.DENSITY<=65) && p.TEMPO<=50],
    ];
    for(var i=0;i<rules.length;i++){
      var id=rules[i][0], cond=rules[i][1];
      if(cond) return TYPES.find(function(t){ return t.id===id; });
    }
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šæœ€ä¸Šä½å› å­ã§ä»£è¡¨ã‚¿ã‚¤ãƒ—
    var top = Object.keys(p).sort(function(a,b){ return p[b]-p[a]; })[0];
    var map = { LIGHT:1, CONTRAST:5, GLOSS:15, DENSITY:2, STRUCTURE:7, TEMPO:6 };
    return TYPES.find(function(t){ return t.id===map[top]; }) || TYPES[0];
  }

// â–¼å ã„é¢¨ã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆ
function buildFortune(pct, type){
  // high/lowã®ã—ãã„å€¤
  var H=60, L=40;

  function pick(txtHigh, txtLow, key){
    var v=pct[key]; return v>=H ? txtHigh : (v<=L ? txtLow : "");
  }

  // ã‚ãªãŸã¯ã“ã‚“ãªäººã«æƒ¹ã‹ã‚Œã‚„ã™ã„
  var likes = [
    pick("æ˜ã‚‹ã„ç¬‘é¡”ã¨é€æ˜æ„Ÿã®ã‚ã‚‹äºº","è½ã¡ç€ã„ãŸç…§åº¦ã§é™ã‹ãªè‰²æ°—ã®äºº","LIGHT"),
    pick("ç™½é»’ã®ãƒ¡ãƒªãƒãƒªãŒä¼¼åˆã†ç«¯æ­£ãªäºº","æ·¡è‰²ã®åŒç³»è‰²ãŒä¼¼åˆã†ã‚„ã•ã—ã„äºº","CONTRAST"),
    pick("è‰¶ã®ã‚ã‚‹é«ªã‚„ã‚¢ã‚¯ã‚»ãŒæ˜ ãˆã‚‹äºº","ãƒãƒƒãƒˆã§ç´ è‚Œæ„Ÿã®ã‚ã‚‹äºº","GLOSS"),
    pick("å°ç‰©ãƒ»æŸ„ã§â€œæƒ…å ±å¤šã‚â€ã®ä¸»å½¹æ„ŸãŒã‚ã‚‹äºº","ç„¡åœ°ï¼†ä½™ç™½ã®ãƒŸãƒ‹ãƒãƒ«ãŒä¼¼åˆã†äºº","DENSITY"),
    pick("ç›´ç·šçš„ã§ç«¯æ­£ãƒ»ãã¡ã‚“ã¨æ„Ÿã®ã‚ã‚‹äºº","è½ã¡æ„Ÿã‚„æ›²ç·šã®â€œæŠœã‘â€ãŒä¸Šæ‰‹ãªäºº","STRUCTURE"),
    pick("ãƒ†ãƒ³ãƒã‚ˆãæ˜ã‚‹ã„æ‰€ä½œã®äºº","ã‚†ã£ãã‚Šä¸å¯§ãªæ‰€ä½œã®äºº","TEMPO")
  ].filter(Boolean);

  // ã‚ã‚‹ã‚ã‚‹ï¼ˆä¸Šä½2å› å­ãƒ™ãƒ¼ã‚¹ï¼‰
  var topKeys = Object.keys(pct).sort(function(a,b){return pct[b]-pct[a];}).slice(0,2);
  var aaDict = {
    LIGHT:["æ˜¼ã®å†™çœŸã‚’ä¿å­˜ã—ãŒã¡","ã‚­ãƒ£ãƒ³ãƒ‰ãƒ«å†™çœŸã«å¼±ã„"],
    CONTRAST:["ç™½é»’ã‚³ãƒ¼ãƒ‡ã®ç”»åƒã«ä¿å­˜ãƒœã‚¿ãƒ³ãŒæš´ç™º","æ·¡è‰²ãƒªãƒ³ã‚¯é›†ã‚ãŒã¡"],
    GLOSS:["â€œè‰¶é«ªâ€ã¨èãã¨ç§’ã§ã‚¿ãƒƒãƒ—","ãƒãƒƒãƒˆãƒªãƒƒãƒ—ç´¹ä»‹ã¯å³ãƒã‚§ãƒƒã‚¯"],
    DENSITY:["ã‚¢ã‚¯ã‚»å¤šã‚ã‚³ãƒ¼ãƒ‡ã«ã€ã‚ã‹ã‚‹â€¦ã€ã¨å‘Ÿã","ç„¡åœ°Ã—ä½™ç™½ã‚³ãƒ¼ãƒ‡ã‚’ãƒ”ãƒ³ç•™ã‚ã—ãŒã¡"],
    STRUCTURE:["ç›´ç·šã‚·ãƒ«ã‚¨ãƒƒãƒˆã§ä¸€ç›®æƒšã‚Œ","è½ã¡æ„Ÿã‚·ãƒ«ã‚¨ãƒƒãƒˆã«ã€æŠœã‘ãŒç¥ã€ã¨è¨€ã„ãŒã¡"],
    TEMPO:["ç¬‘é¡”ã®é€£å†™ã«ã‚„ã‚‰ã‚Œã‚‹","é™ã‹ãªæ¨ªé¡”ã®å‹•ç”»ã‚’ç„¡é™ãƒªãƒ”"]
  };
  var alist=[];
  topKeys.forEach(function(k){
    var arr=aaDict[k]||[];
    // ä¸Šä½å€¤ã§0ç•ªã€ä½ä½ãªã‚‰1ç•ª
    alist.push( pct[k]>=H ? arr[0] : (pct[k]<=L ? arr[1] : (arr[0]||"")) );
  });

  // è·é›¢ã®ç¸®ã‚æ–¹ï¼ˆãƒˆãƒƒãƒ—å› å­ã§ä¸€è¨€ï¼‰
  var tipMap = {
    LIGHT:   {hi:"æ˜¼ã®å†™çœŸï¼†çˆ½ã‚„ã‹ãªæŒ¨æ‹¶ãŒè¿‘é“ã€‚", lo:"è½ã¡ç€ã„ãŸç…§æ˜ã®å ´ã§é™ã‹ã«è©±ã™ã¨åˆºã•ã‚‹ã€‚"},
    CONTRAST:{hi:"è‰²æ•°ã¯çµã£ã¦â€œç™½é»’ã¯ã£ãã‚Šâ€ã§å°è±¡UPã€‚", lo:"åŒç³»è‰²ã§ãƒˆãƒ¼ãƒ³ã‚’åˆã‚ã›ã‚‹ã¨å¥½æ„Ÿåº¦UPã€‚"},
    GLOSS:   {hi:"é«ªã‚„é´ã‚’â€œè‰¶ã®é¢â€ã§æ•´ãˆã‚‹ã¨ä¸€æ°—ã«é›°å›²æ°—ãŒå‡ºã‚‹ã€‚", lo:"ãƒãƒƒãƒˆãªè³ªæ„Ÿã¨æ¸…æ½”æ„Ÿã§ã€ã‚ã‹ã£ã¦ã‚‹ã€ã‚’æ¼”å‡ºã€‚"},
    DENSITY: {hi:"å°ç‰©ã‚„æŸ„ã«ä¸€ã¤â€œç››ã‚Šâ€ã‚’ä¹—ã›ã‚‹ã¨ä¼šè©±ã®ç³¸å£ã«ã€‚", lo:"ç„¡åœ°ï¼‹ä½™ç™½ã§ç´ æã®è‰¯ã•ã‚’è¦‹ã›ã‚‹ã¨åˆºã•ã‚‹ã€‚"},
    STRUCTURE:{hi:"ç›´ç·šçš„ã§ç«¯æ­£ãªã‚·ãƒ«ã‚¨ãƒƒãƒˆã‚’é¸ã¶ã¨ä¿¡é ¼æ„ŸãŒå¢—ã™ã€‚", lo:"åŠ›ã®æŠœã‘ãŸè½ã¡æ„Ÿã§â€œè¦ªã—ã¿ã‚„ã™ã•â€ã‚’ã€‚"},
    TEMPO:   {hi:"ãƒ†ãƒ³ãƒè‰¯ãç¬‘é¡”å¤šã‚ã§è·é›¢ãŒç¸®ã¾ã‚‹ã€‚", lo:"é–“ã‚’å¤§åˆ‡ã«ã€ã‚†ã£ãŸã‚Šç›®ã®ä¼šè©±ãŒåˆã†ã€‚"}
  };
  var tk=topKeys[0], tip=(pct[tk]>=H?tipMap[tk].hi: (pct[tk]<=L?tipMap[tk].lo: tipMap[tk].hi));

  // ã‚¿ã‚¤ãƒ—å›ºæœ‰ã®ä¸€è¨€ï¼ˆè»½ã‚ï¼‰
  var typeNote = (type.hidden)
    ? "â€»ãƒ¬ã‚¢æ ã€éš ã—ã‚¿ã‚¤ãƒ—ã€è§£æ”¾ã€‚é»’Ã—ã‚·ãƒ«ãƒãƒ¼ã¨â€œè‰¶ã®é¢â€ãŒæ±ºã‚æ‰‹ã€‚"
    : "ã“ã®ã‚¿ã‚¤ãƒ—ã¯å†™çœŸã®â€œé¢ã®ä½œã‚Šâ€ã¨è‰²åˆã‚ã›ãŒéµã€‚æ—¥ã«ã‚ˆã£ã¦å¯„ã›æ›¿ãˆã‚‚æ¥½ã—ã‚“ã§ã€‚";

  return {
    likes: (likes.length? likes.join("ï¼") : "çŠ¶æ³ã«åˆã‚ã›ã¦å¥½ã¿ãŒå¤‰ã‚ã‚Šã‚„ã™ã„ã‚¿ã‚¤ãƒ—"),
    alist: alist,
    tip: tip,
    note: typeNote
  };
}
  // ====== è¡¨ç¤º ======
function heroPath(typeNo){
  var id = String(typeNo).padStart(2,"0");
  var g = (CURRENT_GENDER === "male" ? "female" : "male"); // é€†ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½¿ã†
  return IMG_BASE + g + "/t" + id + ".webp";
}
  function drawBars(pct){
    var html = "";
    Object.keys(FACTORS).forEach(function(key){
      var def = FACTORS[key], val = pct[key];
      html += '<article class="bar" aria-label="'+def.name+'">'+
        '<div><strong>'+def.name+'</strong><span class="pill" style="margin-left:6px">'+String(val).padStart(2,"0")+'%</span></div>'+
        '<div class="row" aria-hidden="true"><span style="width:'+val+'%"></span></div>'+
      '</article>';
    });
    bars.innerHTML = html;
  }
  function render(o){
    // åˆ¤å®š
    var t = pickType(o.fPct);
    state.type = t;
    state.pct  = o.fPct;

    // ã‚¿ã‚¤ãƒˆãƒ«è¡Œ
    typeLine.textContent = 'ã‚ãªãŸã®â€œæ¨ã—é¡”â€ã‚¿ã‚¤ãƒ—ï¼š' + t.name;

    // ãƒ’ãƒ¼ãƒ­ãƒ¼
    heroImg.src = heroPath(t.id);
    heroImg.alt = (ALT[t.id] && ALT[t.id][CURRENT_GENDER]) || "çµæœã‚¤ãƒ¡ãƒ¼ã‚¸";
    heroTitle.textContent = t.name + (t.hidden ? "ï¼ˆéš ã—ã‚¿ã‚¤ãƒ—ï¼‰" : "");
    heroCopy.textContent  = t.catch;
    heroTaste.textContent = t.taste;

    // ç·åˆï¼ˆå¹³å‡ã¯å› å­å¹³å‡ï¼‰
    var avg = Object.keys(o.fScore).reduce(function(s,k){return s+o.fScore[k];},0)/Object.keys(o.fScore).length;
    sumAvg.textContent = avg.toFixed(2);
    sumPct.textContent = "= " + o.totalPct + "%";
    // æœ€ä¸Šä½å› å­ã‚’ãƒ¡ãƒ¢
    var topKey = Object.keys(o.fPct).sort(function(a,b){ return o.fPct[b]-o.fPct[a]; })[0];
    sumNote.textContent = "ä¸Šä½å› å­ï¼š"+FACTORS[topKey].name;

    // å› å­ãƒãƒ¼
    drawBars(o.fPct);

// ãƒ©ãƒ³ã‚¯ï¼é•·æ–‡ï¼ˆå ã„é¢¨ï¼‰
var fortune = buildFortune(o.fPct, t);
longCopy.innerHTML =
  '<div class="note"><h4>ã‚ãªãŸã¯ã“ã‚“ãªäººã«æƒ¹ã‹ã‚ŒãŒã¡</h4>'+
  '<p>'+ fortune.likes +'</p>'+
  '<h4 style="margin-top:10px">ã‚ã‚‹ã‚ã‚‹</h4>'+
  '<ul style="margin:6px 0 0 18px;line-height:1.9">'+
    fortune.alist.map(function(s){return '<li>'+s+'</li>';}).join("")+
  '</ul>'+
  '<h4 style="margin-top:10px">è·é›¢ã®ç¸®ã‚æ–¹</h4>'+
  '<p>'+ fortune.tip +'</p>'+
  '<p class="small" style="margin-top:8px">'+ fortune.note +'</p>'+
  (t.hidden?'<p class="small" style="margin-top:6px">â€»æ¡ä»¶ä¸€è‡´ã§ãƒ¬ã‚¢æ ï¼ˆéš ã—ã‚¿ã‚¤ãƒ—ï¼‰ãŒè§£æ”¾ã•ã‚Œã¾ã—ãŸã€‚</p>':'')+
  '</div>';

    // ç ”ç©¶ãƒ¡ãƒ¢ï¼ˆã‚„ã•ã—ã„èªå½™ï¼‰
    var memo = [
      "ã‚ã‚‹ç ”ç©¶ã§ã¯ã€ç¬¬ä¸€å°è±¡ã«ã¯ã€Œæ˜ã‚‹ã•ãƒ»ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆãƒ»è³ªæ„Ÿã€ãŒå¤§ããé–¢ã‚ã‚‹ç¤ºå”†ã€‚",
      "ã‚ã‚‹ç ”ç©¶ã§ã¯ã€è¼ªéƒ­ã®ç›´ç·šï¼æ›²ç·šã¯â€œãã¡ã‚“ã¨æ„Ÿâ€ã‚„â€œã‚„ã‚ã‚‰ã‹ã•â€ã®å°è±¡ã¨çµã³ã¤ãã“ã¨ãŒã‚ã‚‹ã€‚",
      "ã‚ã‚‹ç ”ç©¶ã§ã¯ã€æƒ…å ±é‡ï¼ˆç„¡åœ°ï¼è£…é£¾ï¼‰ã¯æ¸…æ½”æ„Ÿã‚„ä¸»å½¹æ„Ÿã®å—ã‘å–ã‚Šæ–¹ã«å½±éŸ¿ã™ã‚‹å¯èƒ½æ€§ã€‚",
      "ã‚ã‚‹ç ”ç©¶ã§ã¯ã€ãƒ†ãƒ³ãƒï¼ˆæ‰€ä½œã®é€Ÿã•ãƒ»é–“ï¼‰ã®é•ã„ãŒâ€œæ´»ç™ºï¼è½ã¡ç€ãâ€ã®å°è±¡ã«é–¢é€£ã™ã‚‹ã“ã¨ãŒã‚ã‚‹ã€‚",
      "ã‚ã‚‹ç ”ç©¶ã§ã¯ã€å¥½ã¿ã®å‚¾å‘ã¯çŠ¶æ³ã‚„çµ„ã¿åˆã‚ã›ã§å¤‰åŒ–ã—ã€å˜ç‹¬è¦ç´ ã‚ˆã‚Šå…¨ä½“è¨­è¨ˆãŒå¤§åˆ‡ã¨ã„ã†ç¤ºå”†ã€‚"
    ];
    resMemo.innerHTML = memo.map(function(s){ return "<li>"+s+"</li>"; }).join("");

    // å…±æœ‰ãƒªãƒ³ã‚¯
// å…±æœ‰ãƒªãƒ³ã‚¯ï¼ˆbuttonã§ç¢ºå®Ÿã«è¡¨ç¤ºï¼†é–‹ãï¼‰
var shareText = 'ã€æ¨ã—é¡”è¨ºæ–­ã€ã‚¿ã‚¤ãƒ—ï¼š'+t.name+'ï½œå› å­å¹³å‡ '+avg.toFixed(2)+' / 4';
var url = location.href.split('#')[0];

function openBlank(u){ window.open(u, '_blank', 'noopener'); }

// Xï¼ˆæ—§Twitterï¼‰
shareTw.onclick = function(){
  openBlank('https://twitter.com/intent/tweet?text='
    + encodeURIComponent(shareText) + '&url=' + encodeURIComponent(url));
};

// LINE
shareLn.onclick = function(){
  openBlank('https://line.me/R/msg/text/?' + encodeURIComponent(shareText + ' ' + url));
};

// Instagramï¼ˆWebã‚’é–‹ãã€ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã¯è‡ªå‹•ã‚³ãƒ”ãƒ¼ï¼‰
shareIg.onclick = function(){
  var caption = shareText + ' ' + url;
  copyToClipboard(caption).then(function(){
    openBlank('https://www.instagram.com/');
    toast('ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚Instagramã§è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚');
  });
};

// ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼
var shareCp = document.getElementById('shareCp');
if(shareCp){
  shareCp.onclick = function(){
    copyToClipboard(shareText + ' ' + url).then(function(){
      toast('ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
    });
  };
}

// è¡¨ç¤ºï¼ˆhiddenè§£é™¤ï¼‰
shareRow.hidden = false;
shareRow.removeAttribute('hidden');
shareRow.style.display = 'flex';

    // è¡¨ç¤ºåˆ‡æ›¿
    resEmpty.style.display = "none";
    shareRow.hidden = false;

// â–¼ çµæœç”»åƒã‚’ä¿å­˜ï¼ˆã¾ã¨ã‚ã‚¹ã‚¯ã‚·ãƒ§ï¼‰
if (btnShot && shotCanvas){
  btnShot.onclick = async function(e){
    e.preventDefault();
    var original = btnShot.textContent;
    btnShot.textContent = "ç”»åƒã‚’ç”Ÿæˆä¸­â€¦";
    btnShot.disabled = true;

    try{
      var blob = await buildShareImage({
        heroSrc: heroImg.src,
        title: (t.hidden? t.name+"ï¼ˆéš ã—ï¼‰" : t.name),
        catch: t.catch,
        taste: t.taste,
        avg: avg.toFixed(2),
        pct: o.fPct
      });
      saveBlob(blob, "oshi-face_"+t.key+".png");
    }catch(err){
      console.error(err);
      alert("ç”»åƒã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nç”»åƒã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ã§ä¿å­˜ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼ˆfile://ç›´é–‹ãã ã¨å¤–éƒ¨ç”»åƒã¯æã‘ã¾ã›ã‚“ï¼‰ã€‚");
    }finally{
      btnShot.textContent = original;
      btnShot.disabled = false;
    }
  };
}

// è¡¨ç¤ºåˆ‡æ›¿
resEmpty.style.display = "none";
    resArea.style.display  = "block";
    document.getElementById("result").scrollIntoView({behavior:"smooth", block:"start"});

    // æœ€å¾Œã«ä¿å­˜
    try{
      localStorage.setItem("specimens:last", JSON.stringify({ id: SLUG, title: TITLE, href: location.pathname }));
    }catch(e){}
  }

  // ====== å…±æœ‰ãƒ˜ãƒ«ãƒ‘ãƒ¼ ======
  function copyToClipboard(text){
    if(navigator.clipboard && navigator.clipboard.writeText){
      return navigator.clipboard.writeText(text);
    }
    return new Promise(function(res){
      var ta=document.createElement('textarea'); ta.value=text;
      document.body.appendChild(ta); ta.select();
      try{ document.execCommand('copy'); }catch(_){}
      document.body.removeChild(ta); res();
    });
  }
  function toast(msg){
    var t=document.createElement('div');
    t.textContent=msg;
    t.style.position='fixed'; t.style.left='50%'; t.style.bottom='20px';
    t.style.transform='translateX(-50%)'; t.style.background='rgba(31,39,50,.92)';
    t.style.color='#fff'; t.style.padding='8px 12px'; t.style.borderRadius='10px';
    t.style.zIndex=9999; t.style.fontSize='13px';
    document.body.appendChild(t);
    setTimeout(function(){ t.remove(); },1500);
  }

  // ====== ã‚¯ãƒªã‚¢ ======
  function clearAnswers(){
    qWrap.querySelectorAll('input[type="radio"]').forEach(function(r){ r.checked=false; });
    wipeAnswers(); prog.style.width="0%";
    resEmpty.style.display=""; resArea.style.display="none";
    var app=document.getElementById("app"); if(app){ app.scrollIntoView({behavior:"smooth", block:"start"}); }
  }

  // ====== åˆæœŸåŒ– ======
  function init(){
    setGender(CURRENT_GENDER);
    buildQuestions();
    // ç ”ç©¶ãƒ¡ãƒ¢ï¼ˆåˆæœŸãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ï¼‰
    resMemo.innerHTML = ["ã‚ã‚‹ç ”ç©¶ã§ã¯ã€ç¬¬ä¸€å°è±¡ã«ã¯è¤‡æ•°ã®è¦ç´ ãŒé‡ãªã£ã¦åŠ¹ãç¤ºå”†ã€‚"].map(function(s){return "<li>"+s+"</li>";}).join("");
  }

  if(document.readyState === "loading"){ document.addEventListener("DOMContentLoaded", init); } else { init(); }
  document.getElementById("doScore").addEventListener("click", calc, false);
  document.getElementById("doScore2").addEventListener("click", calc, false);
  document.getElementById("clearAns").addEventListener("click", clearAnswers, false);

  var back = document.getElementById("backLink");
  if(back){
    back.addEventListener("click", function(){
      try{ localStorage.setItem("specimens:last", JSON.stringify({ id: SLUG, title: TITLE, href: location.pathname })); }catch(e){}
    }, false);
  }

  // çŠ¶æ…‹
  var state = { type:null, pct:null };
})();

// ====== ã¾ã¨ã‚ç”»åƒç”Ÿæˆï¼ˆ1080x1350ï¼‰ ======
async function buildShareImage(data){
  // ã‚°ãƒ­ãƒ¼ãƒãƒ«ï¼ˆwindowï¼‰ã‹ã‚‰å®‰å…¨ã«å–å¾—
  var cvs = (window.shotCanvas || document.getElementById("shotCanvas"));
  if(!cvs) throw new Error("shotCanvas not found");
  var ctx = cvs.getContext("2d");
  var W = cvs.width, H = cvs.height;
  var FACT = (window.FACTORS || {}); // â†è¿½åŠ 

  // èƒŒæ™¯
  ctx.fillStyle = "#ffffff";
  ctx.fillRect(0,0,W,H);

// ãƒ’ãƒ¼ãƒ­ãƒ¼ç”»åƒï¼ˆä¸Šéƒ¨ 3:4 ã‚’ã ã„ãŸã„ã§ï¼‰
var heroW = W - 120, heroH = Math.round(heroW * 4/3);
if (heroH > 680){ heroH = 680; heroW = Math.round(heroH * 3/4); }
var hx = Math.round((W - heroW)/2), hy = 60;

// è§’ä¸¸èƒŒæ™¯
roundRect(ctx, hx-4, hy-4, heroW+8, heroH+8, 18, "#f7f9ff", "#e6ecf7");

try{
  var img = await loadImage(data.heroSrc);
  ctx.drawImage(img, hx, hy, heroW, heroH);
}catch(_){
  // ç”»åƒãŒå–ã‚Œãªã„ç’°å¢ƒï¼ˆfile:// ç›´é–‹ãç­‰ï¼‰ã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€
  ctx.fillStyle = "#e6ecf7";
  ctx.fillRect(hx, hy, heroW, heroH);
  ctx.fillStyle = "#9aa3b2";
  ctx.font = "600 24px 'Noto Sans JP',system-ui";
  ctx.fillText("ç”»åƒã‚’è¡¨ç¤ºã§ãã¾ã›ã‚“ã§ã—ãŸ", hx + 24, hy + heroH/2);
}

  // ã‚¿ã‚¤ãƒˆãƒ«
  var y = hy + heroH + 40;
  ctx.fillStyle = "#1f2732";
  ctx.font = "800 40px 'Noto Sans JP',system-ui";
  ctx.fillText("æ¨ã—é¡”è¨ºæ–­", 60, y);
  ctx.font = "800 44px 'Noto Sans JP',system-ui";
  drawWrapText(ctx, "ã‚¿ã‚¤ãƒ—ï¼š"+data.title, 60, y+54, W-120, 48);

  // ã‚­ãƒ£ãƒƒãƒï¼†ãƒ†ã‚¤ã‚¹ãƒˆ
  ctx.font = "700 28px 'Noto Sans JP',system-ui";
  drawWrapText(ctx, data.catch, 60, y+120, W-120, 36, "#667087");
  ctx.font = "600 26px 'Noto Sans JP',system-ui";
  drawWrapText(ctx, data.taste, 60, y+176, W-120, 34, "#667087");

  // å› å­ãƒãƒ¼ï¼ˆ6ã¤ï¼‰
  var baseY = y + 230;
  var order = ["LIGHT","CONTRAST","GLOSS","DENSITY","STRUCTURE","TEMPO"];
  for(var i=0;i<order.length;i++){
    var key = order[i], val = data.pct[key]||0;
    drawBar(ctx, 60, baseY + i*70, W-120, 18, val,
      (FACT[key] ? FACT[key].name : key).replace("ï¼ˆ"," ").replace("ï¼‰",""), "#ff7a6b", "#ffba7e");
  }

  // å¹³å‡ã¨ãƒ•ãƒƒã‚¿ãƒ¼
  var ftY = baseY + order.length*70 + 40;
  ctx.font = "700 28px 'Noto Sans JP',system-ui";
  ctx.fillStyle = "#1f2732";
  ctx.fillText("å› å­å¹³å‡ï¼š"+data.avg+" / 4ï¼ˆ= "+Math.round((parseFloat(data.avg)/4)*100)+"%ï¼‰", 60, ftY);

  ctx.font = "600 20px 'Noto Sans JP',system-ui";
  ctx.fillStyle = "#9aa3b2";

  return await canvasToBlob(cvs, "image/png");
}

// ç”»åƒèª­è¾¼ï¼ˆCORSè€ƒæ…®ï¼‰
async function loadImage(src){
  // 1) fetchâ†’blobâ†’blobURL çµŒç”±ï¼ˆåŒä¸€ã‚ªãƒªã‚¸ãƒ³åŒ–ï¼‰
  try{
    const r = await fetch(src, {cache:'no-store'});
    if(!r.ok) throw new Error('fetch failed');
    const b = await r.blob();
    const blobUrl = URL.createObjectURL(b);
    const img = await new Promise((res, rej)=>{
      const im = new Image();
      im.onload = ()=>res(im);
      im.onerror = rej;
      im.src = blobUrl;
    });
    // ä½¿ã„çµ‚ã‚ã£ãŸã‚‰è§£æ”¾
    setTimeout(()=>URL.revokeObjectURL(blobUrl), 1000);
    return img;
  }catch(e){
    // 2) å¾“æ¥ã® anonymous èª­ã¿è¾¼ã¿ï¼ˆCORSé€šã‚Œã°OKï¼‰
    return await new Promise((res, rej)=>{
      const im = new Image();
      im.crossOrigin = "anonymous";
      im.onload = ()=>res(im);
      im.onerror = rej;
      im.src = src + (src.indexOf("?")>-1 ? "&" : "?") + "t=" + Date.now();
    });
  }
}

// è§’ä¸¸çŸ©å½¢
function roundRect(ctx, x, y, w, h, r, fill, stroke){
  ctx.save();
  ctx.beginPath();
  ctx.moveTo(x+r, y);
  ctx.arcTo(x+w, y, x+w, y+h, r);
  ctx.arcTo(x+w, y+h, x, y+h, r);
  ctx.arcTo(x, y+h, x, y, r);
  ctx.arcTo(x, y, x+w, y, r);
  ctx.closePath();
  if(fill){ ctx.fillStyle = fill; ctx.fill(); }
  if(stroke){ ctx.strokeStyle = stroke; ctx.stroke(); }
  ctx.restore();
}

// ãƒ†ã‚­ã‚¹ãƒˆæŠ˜è¿”ã—
function drawWrapText(ctx, text, x, y, maxW, lh, color){
  ctx.fillStyle = color || "#1f2732";
  var words = (text||"").split(/(\s+)/);
  var line = "", cursor = y;
  for(var i=0;i<words.length;i++){
    var test = line + words[i];
    if(ctx.measureText(test).width > maxW && i>0){
      ctx.fillText(line, x, cursor);
      line = words[i].trimStart();
      cursor += lh;
    }else{
      line = test;
    }
  }
  if(line){ ctx.fillText(line, x, cursor); }
}

// ãƒãƒ¼
function drawBar(ctx, x, y, w, h, pct, label, c1, c2){
  ctx.save();
  // ãƒ©ãƒ™ãƒ«
  ctx.fillStyle = "#1f2732";
  ctx.font = "700 22px 'Noto Sans JP',system-ui";
  ctx.fillText(label, x, y-10);

  // ä¸‹åœ°
  var by = y+10;
  roundRect(ctx, x, by, w, h, 10, "#edf2fb", "#e8eef9");

  // å®Ÿãƒãƒ¼
  var ww = Math.max(0, Math.min(w, Math.round(w*pct/100)));
  var grad = ctx.createLinearGradient(x,0,x+w,0);
  grad.addColorStop(0, c1); grad.addColorStop(1, c2);
  roundRect(ctx, x, by, ww, h, 10, grad);

  // æ•°å€¤
  ctx.fillStyle = "#667087";
  ctx.font = "600 18px 'Noto Sans JP',system-ui";
  var txt = String(pct).padStart(2,"0")+"%";
  ctx.fillText(txt, x + w - ctx.measureText(txt).width, by + h + 22);
  ctx.restore();
}

// ä¿å­˜
function saveBlob(blob, filename){
  var a = document.createElement("a");
  var url = URL.createObjectURL(blob);
  a.href = url; a.download = filename || "result.png";
  document.body.appendChild(a); a.click();
  setTimeout(function(){ URL.revokeObjectURL(url); a.remove(); }, 400);
}

// toBlobï¼ˆfallbackï¼‰
function canvasToBlob(cvs, type){
  return new Promise(function(res){
    if(cvs.toBlob){ cvs.toBlob(function(b){ res(b); }, type||"image/png"); }
    else{ res(dataURLtoBlob(cvs.toDataURL(type||"image/png"))); }
  });
}
function dataURLtoBlob(dataUrl){
  var arr = dataUrl.split(','), mime = arr[0].match(/:(.*?);/)[1],
      bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
  while(n--){ u8arr[n] = bstr.charCodeAt(n); }
  return new Blob([u8arr], {type:mime});
}
</script>
</body>
</html>
