<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>姫と城下の恋診断（オリジナル）</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --brand:#7a5e70; --ink:#332b33;
      --bg1:#f8f6f3; --bg2:#efe8e0; --card:#ffffff;
      --muted:#6b6466; --line:#e7ddd7;
      --btn:#7a5e70; --btn2:#8f8f8f;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:22px; color:var(--ink);
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;
      background: linear-gradient(180deg,var(--bg1),var(--bg2));
    }
    .wrap{max-width:820px;margin:0 auto}
    h1{margin:4px 0 12px; text-align:center; color:var(--brand); font-size:clamp(20px,4vw,32px)}
    .sub{color:var(--muted); text-align:center; margin:0 0 18px; font-size:.98em}
    .card{background:var(--card); border:1px solid var(--line); border-radius:14px; padding:16px; box-shadow:0 8px 20px rgba(0,0,0,.06)}
    .meta{display:flex; gap:8px; justify-content:space-between; font-size:12px; color:var(--muted); margin-bottom:8px}
    .section-title{font-weight:600; margin:6px 0 8px; color:#4c404c}
    .preface{font-size:.98em; line-height:1.8; color:#493f46; background:#fbf9f7; border:1px dashed var(--line); border-radius:12px; padding:12px}
    .scene{margin:18px 0 16px; padding:12px; border:1px solid var(--line); border-radius:12px; background:#fff}
    .scene h3{margin:0 0 6px; font-size:1.02em; color:#4b3e49}
    .scene p{margin:4px 0 10px; color:#574a55}
    .choices{display:grid; gap:8px}
    .choice{display:flex; gap:10px; align-items:flex-start; background:#f6f3f1; border-radius:10px; padding:10px; cursor:pointer; border:1px solid transparent}
    .choice:hover{border-color:#e5d9d2}
    .choice input{margin-top:2px; accent-color:var(--brand)}
    .actions{display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:10px}
    .btn{background:var(--btn); color:#fff; border:none; border-radius:12px; padding:12px 18px; font-size:16px; cursor:pointer}
    .btn.secondary{background:var(--btn2)}
    .btn:disabled{opacity:.5; cursor:not-allowed}
    #result{margin-top:18px}
    .result-head{text-align:center; margin:0 0 8px}
    .result-title{font-size:clamp(18px,3.2vw,26px); color:var(--brand); margin:0}
    .result-sub{color:#5a4d56; margin:4px 0 0}
    /* スマホで綺麗に見せる */
    .result-img{
      width:100%;
      height:auto;
      aspect-ratio:3/4;
      object-fit:contain;
      background:#f6f3f1;
      border-radius:12px;
      box-shadow:0 10px 28px rgba(0,0,0,.12);
      margin-top:12px;
      max-height:72svh;
    }
    .result-body{display:grid; gap:10px; margin-top:12px}
    .result-card{background:#fff; border:1px solid var(--line); border-radius:12px; padding:12px}
    .result-card h4{margin:0 0 6px; font-size:1em; color:#4c404c}
    .note{color:var(--muted); text-align:center; margin-top:10px; font-size:.9em}
    .result-ctas{display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:12px}
    .linkbtn{display:inline-block; text-decoration:none; background:#fff; border:1px solid var(--line); color:#533; padding:10px 14px; border-radius:999px}
    .linkbtn.primary{background:var(--brand); color:#fff; border-color:transparent}
    @media (prefers-color-scheme: dark){
      :root{ --card:#181518; --ink:#ede7ee; --bg1:#141014; --bg2:#1a161a; --line:#2b252b; --muted:#b9aeb7; }
      .preface{background:#191619; border-color:#2b252b}
      .scene{background:#171417}
      .choice{background:#1e1a1e}
      .linkbtn{background:#151215; color:#e9dfeb}
      .result-img{background:#1b181b}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>姫と城下の恋診断（オリジナル）</h1>
    <p class="sub">— 禁じられたのは、恋か、手順か。—</p>

    <div class="card">
      <div class="meta"><span id="progress">未回答 4 / 4</span><span>三択 × 4場面</span></div>

      <!-- 前提 -->
      <div class="preface">
        <div class="section-title">前提</div>
        <p>
          お姫様には婚約者がいる。あなたは城下の一般の人。<br>
          二人の間に“規程”と“噂”が横たわる夜、<br>
          その場その場の、小さな選び方が物語を決める。
        </p>
      </div>

      <form id="quizForm">
        <!-- ① 塔の陰の渡り階段 -->
        <div class="scene">
          <h3>① 塔の陰の渡り階段</h3>
          <p>城の外台所と書庫をつなぐ、せまい階段。足音はひびく。</p>
          <div class="choices">
            <label class="choice"><input type="radio" name="q1" value="A"> 小門のほうを指で示し、そっと一段だけ戻る</label>
            <label class="choice"><input type="radio" name="q1" value="B"> 踊り段で止まり、明日の時間だけ決める</label>
            <label class="choice"><input type="radio" name="q1" value="C"> 柱の影でうなずき、ここを「合図の場所」にする</label>
          </div>
        </div>

        <!-- ② 告解格子の前（礼拝堂） -->
        <div class="scene">
          <h3>② 告解格子の前（礼拝堂）</h3>
          <p>蝋のにおい。小さな格子。小声でも祈りに見える。</p>
          <div class="choices">
            <label class="choice"><input type="radio" name="q2" value="A"> 短いリボンを一回だけ結び、格子の根もとに置く</label>
            <label class="choice"><input type="radio" name="q2" value="B"> 書付に「相談 十分」と一行だけ書き、受付印をもらう</label>
            <label class="choice"><input type="radio" name="q2" value="C"> ベンチの板のすき間へ、次の日時の札をすべり込ませる</label>
          </div>
        </div>

        <!-- ③ 大広間の夜会 -->
        <div class="scene">
          <h3>③ 大広間の夜会</h3>
          <p>音楽と人波。婚約者は姫のそばにいる。</p>
          <div class="choices">
            <label class="choice"><input type="radio" name="q3" value="A"> 曲の終わりに、同時に小さく礼をする</label>
            <label class="choice"><input type="radio" name="q3" value="B"> 柱ごしに目を合わせ、息をそろえる</label>
            <label class="choice"><input type="radio" name="q3" value="C"> 執事に頼み、「書庫の確認」として席をひとつもらう</label>
          </div>
        </div>

        <!-- ④ 夜明け前の外門 -->
        <div class="scene">
          <h3>④ 夜明け前の外門</h3>
          <p>空がしろむ。門番は交代前。ここで二人の次が決まる。</p>
          <div class="choices">
            <label class="choice"><input type="radio" name="q4" value="A"> 手を取り、そのまま外へ出る</label>
            <label class="choice"><input type="radio" name="q4" value="B"> 書付を整え、朝の評議に出す</label>
            <label class="choice"><input type="radio" name="q4" value="C"> 合図をふやし、影であたためて続ける</label>
          </div>
        </div>
      </form>

      <div class="actions">
        <button class="btn" type="button" onclick="diagnose()">診断する</button>
        <button class="btn secondary" type="button" onclick="resetAll()">リセット</button>
      </div>

      <div id="result" aria-live="polite"></div>
    </div>
  </div>

  <script>
    // 進捗表示
    const form = document.getElementById('quizForm');
    const progressEl = document.getElementById('progress');
    function updateProgress(){
      const total = 4; let answered = 0;
      for(let i=1;i<=total;i++){
        if(document.querySelector(`input[name="q${i}"]:checked`)) answered++;
      }
      progressEl.textContent = `未回答 ${total-answered} / ${total}`;
    }
    form.addEventListener('change', updateProgress); updateProgress();

    // タグカウンタ
    const countersInit = () => ({ 熱:0, 言葉:0, 手順:0, 合図:0, 守り:0 });

    // 選択肢→タグ加点表
    const TAGS = {
      'q1:A': { 熱:1, 合図:1 },
      'q1:B': { 言葉:1, 手順:1 },
      'q1:C': { 合図:1, 守り:1 },
      'q2:A': { 合図:1, 守り:1 },
      'q2:B': { 言葉:1, 手順:1 },
      'q2:C': { 手順:1, 合図:1 },
      'q3:A': { 熱:1, 合図:1 },
      'q3:B': { 守り:1, 合図:1 },
      'q3:C': { 手順:1, 言葉:1 },
      'q4:A': { 熱:2 },
      'q4:B': { 言葉:1, 手順:1 },
      'q4:C': { 合図:1, 守り:1 },
    };

    // 結果定義
    const ROUTES = {
      moon_sun: { id:"01", title:"自由の月と太陽",
        story:[
          "外門を越えた朝、二人は市はずれの小さな店を始める。",
          "合図はいらない。声で呼び合えるから。",
          "過去は短く、未来は長く――同じ皿を拭きながら決めていく。"
        ],
        trait:[
          "決めるまで慎重だが、決めた後の足は速い。",
          "“守るべき人”が見つかると、自分の疲れより相手の明日を優先しがち。",
          "言葉より行動で示すとき、いちばん誠実さが伝わる。",
          "幸せは派手さよりも、静かな反復で育てられるタイプ。"
        ],
        alt:"夜明け色の店内で、二人が同じ皿を拭いている。窓辺に細い月。"
      },
      good_evil: { id:"02", title:"善と悪の秤",
        story:[
          "群青の帳簿は静かに閉じられ、申請は通らない。",
          "廊下ですれ違えば礼は交わすが、足は止めない。",
          "“正しさ”は守られた。心は、それぞれの側で保存されたまま。"
        ],
        trait:[
          "感情が大きいほど、手順と記録で自分を落ち着かせる。",
          "「損しない選択」を無意識に選び、あとから胸がざわつくことがある。",
          "人に迷惑をかけないことを誇りにしている。",
          "期限とルールがあると、ほんとうの優しさを出しやすい。"
        ],
        alt:"群青の帳簿と小さな秤。窓から冷たい朝光が射す。"
      },
      letter_shadow: { id:"03", title:"折れた手紙と灯の影（露見）",
        story:[
          "夜更け、折り目の同じ手紙を箱に戻す指先を、ひとつの影が見ていた。",
          "朝には帳簿に追記が増え、面会票の写しに赤い印。",
          "合図は言葉になる――二人の間でではなく、他人の口の上で。"
        ],
        trait:[
          "空気を読む精度は高いが、境界の“持久力”を過信しがち。",
          "守るための秘密が増えるほど、自分の線引きが薄くなる。",
          "“二人だけのルール”に温かさを感じる一方、外圧への備えは後回しになりやすい。",
          "早めに出口（撤退線）を決めておくと、優しさを壊さずに終われるタイプ。"
        ],
        alt:"灯に照らされた手紙の箱。扉の隙間に人影がのぞく。"
      },
      bottle_morning: { id:"04", title:"空の瓶と朝の水",
        story:[
          "噴水の水を空の瓶に少しだけ入れて、棚に戻す。",
          "名前は付けない。痛みは薄まり、好意は尊重へ形を変える。",
          "会わない段取りを決め、生活は静かに整っていく。"
        ],
        trait:[
          "感情を“保存”してから片づける、几帳面な優しさがある。",
          "きっぱりよりも、静かに距離を置く方が心に馴染む。",
          "未練をゼロにしないほうが、前に進めるタイプ。",
          "朝のルーティンが整うほど、決断は穏やかになる。"
        ],
        alt:"朝の棚に並ぶガラス瓶。ひとつだけ蓋が開いている。"
      },
      blank_map: { id:"05", title:"白紙の地図",
        story:[
          "地図は畳まれ、季節が変わるまで再会しないと決めた。",
          "敗北ではなく、余地としての白。",
          "次に開くとき、道具から作り直す。"
        ],
        trait:[
          "“いまは決めない”という賢さを持っている。",
          "周囲に合わせるより、時期を合わせるほうが得意。",
          "白紙を見ると不安になるが、開き直ると創造力が出る。",
          "小さな再開の約束があると、毎日が落ち着く。"
        ],
        alt:"紐で閉じられた白い地図。机にやわらかな影が落ちる。"
      }
    };

    // 判定ロジック
    function routeByCounters(c){
      if (c.熱 >= 4 || (c.熱 >= 3 && c.合図 >= 1)) return 'moon_sun';
      if ((c.言葉 + c.手順) >= 5) return 'good_evil';
      if (c.合図 >= 3 && c.守り >= 2) return 'letter_shadow';
      if ((c.守り + c.手順) >= 5 && c.熱 <= 2) return 'bottle_morning';
      return 'blank_map';
    }

    function diagnose(){
      for(let i=1;i<=4;i++){
        const picked = document.querySelector(`input[name="q${i}"]:checked`);
        if(!picked){ alert(`すべての質問に答えてください。\n未回答：Q${i}`); return; }
      }
      let C = countersInit();
      for(let i=1;i<=4;i++){
        const v = document.querySelector(`input[name="q${i}"]:checked`).value;
        const add = TAGS[`q${i}:${v}`] || {};
        Object.keys(add).forEach(k => C[k] += add[k]);
      }
      const key = routeByCounters(C);
      renderResult(ROUTES[key]);
      window.scrollTo({ top: document.body.scrollHeight, behavior:'smooth' });
    }

    function resetAll(){
      form.reset();
      document.getElementById('result').innerHTML = '';
      updateProgress();
      window.scrollTo({ top: 0, behavior:'smooth' });
    }

    function renderResult(route){
      // ここを相対パスに修正（/shindan/ 配下で確実に解決）
      const imgPath = `assets/results/story/${route.id}.png`;
      const storyHtml = route.story.map(line => `<p>${line}</p>`).join('');
      const traitHtml = route.trait.map(t => `<li>${t}</li>`).join('');

      const html = `
        <div class="result-head">
          <h3 class="result-title">${route.title}</h3>
          <p class="result-sub">二人の物語は、こう続いていく。</p>
        </div>

        <img class="result-img"
             src="${imgPath}" alt="${route.alt}"
             loading="lazy" decoding="async">

        <div class="result-body">
          <div class="result-card">
            <h4>END ストーリー</h4>
            ${storyHtml}
          </div>

          <div class="result-card">
            <h4>あなたの気質（やさしい指摘）</h4>
            <ul style="margin:0 0 0 1.2em; padding:0">${traitHtml}</ul>
          </div>
        </div>

        <div class="result-ctas">
          <a class="linkbtn primary" href="#" onclick="resetAll(); return false;">もう一度診断</a>
          <a class="linkbtn" href="/shindan/">診断一覧へ戻る</a>
        </div>
        <p class="note">※ 物語はフィクションです。現実では規程・安全・立場を最優先に。</p>
      `;
      document.getElementById('result').innerHTML = html;
    }
  </script>
</body>
</html>
