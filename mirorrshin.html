<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>é¡ãƒŠãƒ«ã‚·ã‚¹ãƒˆãƒ»ã‚»ãƒ«ãƒ•ãƒã‚§ãƒƒã‚¯ï¼ˆãƒªãƒ‹ãƒ¥ãƒ¼ã‚¢ãƒ«ï¼‰</title>
<meta name="description" content="20å•Ã—5ä»¶æ³•ã€‚Admiration/Rivalry/Vulnerable/Communalã®4å› å­ï¼…ã¨ç·åˆ5æ®µéšãƒãƒ³ãƒ‰ã§â€œè‡ªå·±æ¼”å‡ºã®ã‚¯ã‚»â€ã‚’ã‚„ã•ã—ãå¯è¦–åŒ–ã€‚çµæœç”»åƒä¿å­˜ï¼†å…±æœ‰OKã€‚">
<meta name="theme-color" content="#faf7fb">
<meta property="og:type" content="website">
<meta property="og:title" content="é¡ãƒŠãƒ«ã‚·ã‚¹ãƒˆãƒ»ã‚»ãƒ«ãƒ•ãƒã‚§ãƒƒã‚¯ï¼ˆãƒªãƒ‹ãƒ¥ãƒ¼ã‚¢ãƒ«ï¼‰">
<meta property="og:description" content="4å› å­ï¼…ï¼‹ç·åˆ5æ®µéšã€‚webpç”»åƒä¿å­˜ï¼†å…±æœ‰OKï¼ˆã‚¨ãƒ³ã‚¿ãƒ¡è‡ªå·±ç†è§£ï¼‰ã€‚">
<meta property="og:image" content="/shindan/assets/results/mirror/t01.webp">
<style>
:root{
  --accent:#b86bdf; --accent2:#ffc0e6;
  --ink:#221a28; --muted:#6b6170; --paper:#fff;
  --bg1:#fbf7ff; --bg2:#fef8fb; --line:#efe6f7;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;color:var(--ink);
  background:linear-gradient(180deg,var(--bg1),var(--bg2));
  font-family:"Noto Sans JP",system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN",sans-serif;
}
a{color:inherit}
.wrap{max-width:980px;margin:18px auto;padding:0 14px}
header.hd{display:grid;grid-template-columns:56px 1fr;gap:12px;align-items:center;margin:8px 0}
.logo{width:56px;height:56px;border-radius:14px;background:linear-gradient(135deg,#ffe9ff,#f2f6ff);display:grid;place-items:center;font-size:26px}
h1{margin:0;font-size:clamp(22px,4.6vw,34px);letter-spacing:.02em}
.sub{margin:4px 0 0;color:var(--muted);font-size:.96em}
.card{background:var(--paper);border:1px solid var(--line);border-radius:16px;padding:14px}
.section{margin:14px 0}
.pill{display:inline-block;padding:4px 8px;border:1px solid var(--line);border-radius:999px;background:#fff;color:#6b6a77;font-size:.88em}
.meta{display:flex;gap:8px;flex-wrap:wrap}
.sticky{position:sticky;top:0;z-index:10;margin:-6px -14px 12px;padding:8px 14px;background:rgba(255,255,255,.8);backdrop-filter:blur(6px) saturate(1.05);border-bottom:1px solid #f2e9fb;display:flex;align-items:center;gap:10px}
.progress{height:8px;background:#f7ecff;border-radius:999px;flex:1;overflow:hidden}
.progress>span{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width .25s ease}
.btn{padding:10px 14px;border:1px solid var(--line);border-radius:12px;background:#fff;cursor:pointer}
.btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));border-color:transparent;color:#fff;font-weight:700}
fieldset.q{border:1px solid var(--line);border-radius:12px;padding:10px;margin:10px 0;background:#fff}
legend{font-weight:700}
.scale{display:grid;grid-template-columns:repeat(5,minmax(66px,1fr));gap:8px;margin-top:8px}
.scale input{position:absolute;opacity:0;pointer-events:none}
.scale label{display:grid;place-items:center;border:1px solid #ece3f4;border-radius:10px;padding:8px;cursor:pointer;user-select:none;background:#fff}
.scale input:checked+label{outline:2px solid var(--accent);border-color:transparent}
mark.need{animation:need 1.6s ease}
@keyframes need{0%{box-shadow:0 0 0 0 rgba(184,107,223,.45)}100%{box-shadow:0 0 0 0 rgba(184,107,223,0)}}
.result-head{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;font-weight:700}
.total{font-size:22px;font-weight:800}
.small{color:var(--muted);font-size:.92em}

/* ãƒ’ãƒ¼ãƒ­ãƒ¼ï¼ˆç”»åƒâ†’ãƒ†ã‚­ã‚¹ãƒˆï¼‰ */
.hero-vert{display:grid;place-items:center;border:1px solid var(--line);border-radius:16px;background:#fff;overflow:hidden}
.hero-vert figure{margin:0;width:min(720px,100%);max-width:100%;aspect-ratio:1/1;border-bottom:1px solid var(--line);background:#f7f9ff}
.hero-vert img{width:100%;height:100%;object-fit:cover;display:block}
.hero-vert figcaption{padding:10px;width:100%}
.hero-vert .capline{font-weight:800;line-height:1.55;overflow-wrap:anywhere}
.hero-vert .capmini{font-size:1em;line-height:1.85;color:var(--muted);overflow-wrap:anywhere}

.grid2{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px}
.stat{border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff}
.stat .big{font-size:22px;font-weight:800}
.hr{height:1px;background:var(--line);margin:10px 0}
.factor-mini{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px}
.bar{border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff}
.bar .row{height:10px;background:#f7ecff;border-radius:999px;overflow:hidden;margin-top:6px}
.bar .row>span{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent2))}
.note{border:1px solid var(--line);border-radius:12px;background:#fff;padding:10px}
.note h4{margin:0 0 6px;font-size:16px}

/* å…±æœ‰ãƒœã‚¿ãƒ³ */
.share-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.btn.tw::before{content:"ğ•";margin-right:.25em}
.btn.line::before{content:"ğŸ’¬";margin-right:.25em}
.btn.ig::before{content:"ğŸ“¸";margin-right:.25em}
.btn.save::before{content:"â¬‡ï¸";margin-right:.25em}

@media (max-width:560px){
  .wrap{padding:0 10px}
  .sticky{top:calc(env(safe-area-inset-top) + 0px); padding:8px 10px}
  .scale{grid-template-columns:repeat(2,1fr)}
  .scale label{padding:12px 8px;font-size:14px}
  .hero-vert figure{width:100%}
  .grid2{grid-template-columns:1fr}
  .card{padding:12px}
  .hero-vert .capline{font-size:clamp(16px,5.2vw,20px);line-height:1.65}
  .hero-vert .capmini{font-size:clamp(14px,4.6vw,16px);line-height:1.95}
  .note h4{font-size:15px}
}
</style>
</head>
<body data-id="mirrorshin">
<main class="wrap" id="app">
  <header class="hd">
    <div class="logo">ğŸª</div>
    <div>
      <h1>é¡ãƒŠãƒ«ã‚·ã‚¹ãƒˆãƒ»ã‚»ãƒ«ãƒ•ãƒã‚§ãƒƒã‚¯</h1>
      <p class="sub">20å•ï¼ˆ0ã€œ4ã®5ä»¶æ³•ï¼‰ã€‚4å› å­ã®ï¼…ã¨<b>ç·åˆ5æ®µéšãƒãƒ³ãƒ‰</b>ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚â€»ã‚¨ãƒ³ã‚¿ãƒ¡è‡ªå·±ç†è§£ï¼å› æœã¯æ–­å®šã—ã¾ã›ã‚“ã€‚</p>
    </div>
  </header>

  <div class="sticky" aria-live="polite">
    <div class="progress" aria-label="å›ç­”é€²æ—" role="progressbar" aria-valuemin="0" aria-valuemax="20">
      <span id="prog"></span>
    </div>
    <button class="btn primary" id="doScore">è¨ºæ–­ã™ã‚‹</button>
  </div>

  <section class="card section" id="desc">
    <h2 style="margin:4px 0 8px">èª¬æ˜</h2>
    <div class="meta" style="margin-bottom:8px">
      <span class="pill">è³ªå•æ•°ï¼š20</span>
      <span class="pill">å½¢å¼ï¼š0â€“4ï¼ˆ0=ãœã‚“ãœã‚“ / 4=ã¨ã¦ã‚‚ï¼‰</span>
      <span class="pill">å‡ºåŠ›ï¼š4å› å­ï¼…ï¼‹ç·åˆ5æ®µéšï¼ˆç”»åƒwebpï¼‰</span>
    </div>
    <p class="small">æ³¨ç›®ã®æµ´ã³æ–¹ã‚„ç«¶äº‰å¿ƒã€å‚·ã¤ãã‚„ã™ã•ã€å–„è¡Œã‚¢ãƒ”ãƒ¼ãƒ«ãªã©ã®â€œè‡ªå·±æ¼”å‡ºã®ã‚¯ã‚»â€ã‚’4å› å­ã§ã‚„ã•ã—ãè¦‹ãˆã‚‹åŒ–ã€‚æ—¥å¸¸ã§ä½¿ãˆã‚‹<b>ä¸€è¨€ã‚±ã‚¢</b>ã‚‚è¡¨ç¤ºã—ã¾ã™ã€‚</p>
  </section>

  <!-- è¨­å• -->
  <section class="card section" id="questions">
    <h2 style="margin:4px 0 8px">è¨­å•ï¼ˆãœã‚“ãœã‚“ï¼ã‚ã¾ã‚Šï¼ã¨ãã©ãï¼ã‚ˆãï¼ã¨ã¦ã‚‚ï¼‰</h2>
    <div id="qWrap"></div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
      <button class="btn" id="clearAns">å›ç­”ã‚’ã‚¯ãƒªã‚¢</button>
      <button class="btn primary" id="doScore2">è¨ºæ–­ã™ã‚‹</button>
    </div>
  </section>

  <!-- çµæœ -->
  <section class="card section" id="result" aria-live="polite">
    <div id="resEmpty">
      <span class="badge">ã¾ã çµæœã¯ã‚ã‚Šã¾ã›ã‚“</span>
      <p class="small">å…¨20å•ã«å›ç­”ã—ã¦ã€Œè¨ºæ–­ã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>
    </div>

    <div id="resArea" style="display:none">
      <div class="result-head">
        <span class="badge">çµæœ</span>
        <div class="total" id="typeLine">â€”</div>
      </div>

      <!-- ç”»åƒï¼‹ãƒŸãƒ‹æƒ…å ±ï¼ˆæ­£æ–¹å½¢webpï¼‰ -->
      <div class="hero-vert section" role="region" aria-label="ã‚¿ã‚¤ãƒ—ã‚¤ãƒ¡ãƒ¼ã‚¸">
        <figure>
          <img id="heroImg" src="/shindan/assets/results/mirror/t01.webp" alt="çµæœã‚¤ãƒ¡ãƒ¼ã‚¸" loading="lazy" width="1080" height="1080">
        </figure>
        <figcaption>
          <div class="capline" id="heroTitle">â€”</div>
          <div class="capmini" id="heroCopy">â€”</div>
          <div class="capmini" id="heroHint" style="margin-top:4px">â€”</div>

          <div class="share-row" id="shareRow" hidden>
            <button id="btnShot"  class="btn save" type="button">çµæœç”»åƒã‚’ä¿å­˜</button>
            <button id="shareTw"  class="btn tw"   type="button">Xã§å…±æœ‰</button>
            <button id="shareLn"  class="btn line" type="button">LINEã§é€ã‚‹</button>
            <button id="shareIg"  class="btn ig"   type="button" aria-label="Instagramï¼ˆWebï¼‰">Instagram</button>
            <button id="shareCp"  class="btn"      type="button">ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼</button>
          </div>
          <canvas id="shotCanvas" width="1080" height="1350" style="display:none"></canvas>
        </figcaption>
      </div>

      <div class="grid2">
        <article class="stat" aria-label="ç·åˆã‚¹ã‚³ã‚¢">
          <div><strong>å› å­å¹³å‡ï¼ˆ0â€“4ï¼‰</strong></div>
          <div class="big"><span id="sumAvg">0.00</span> / 4.00 <span class="small" id="sumPct">= 0%</span></div>
          <div class="small" id="sumNote">â€”</div>
        </article>
        <article class="stat" aria-label="ã²ã¨ã“ã¨">
          <div><strong>ä»Šæ—¥ã®ã²ã¨ã“ã¨</strong></div>
          <div class="small" id="allyNote">â€”</div>
        </article>
      </div>

      <div class="hr"></div>
      <!-- å› å­ãƒãƒ¼ï¼ˆ4ï¼‰ -->
      <div class="section">
        <h3 style="margin:8px 0">4å› å­ï¼ˆï¼…ï¼‰</h3>
        <div id="bars" class="factor-mini"></div>
      </div>

      <div class="hr"></div>
      <!-- é•·æ–‡ï¼ˆãƒãƒ³ãƒ‰åˆ¥ï¼‰ -->
      <div id="longCopy" class="small"></div>

      <div class="hr"></div>
      <!-- ä»Šæ—¥ã®ã‚±ã‚¢ï¼ˆä¸Šä½å› å­ã«å¿œã˜ãŸ3è¡Œï¼‰ -->
      <details class="section" open id="careSec">
        <summary><strong>ä»Šæ—¥ã®ã‚±ã‚¢</strong></summary>
        <ul class="small" id="careList" style="margin:6px 0 0 18px;line-height:1.8"></ul>
      </details>

      <div class="hr"></div>
      <!-- ç ”ç©¶ãƒ¡ãƒ¢ï¼ˆã“ã®ãƒ†ãƒ¼ãƒç”¨ï¼‰ -->
      <details class="section" open>
        <summary><strong>ç ”ç©¶ãƒ¡ãƒ¢</strong></summary>
        <ul class="small" id="resMemo" style="margin:6px 0 0 18px;line-height:1.8"></ul>
        <p class="small" style="margin-top:6px">â€»ç›¸é–¢ä¸­å¿ƒã§å› æœã¯æ–­å®šã§ãã¾ã›ã‚“ã€‚å€‹äººå·®ãŒã‚ã‚Šã¾ã™ã€‚åŒ»ç™‚ãƒ»æ¡ç”¨ãªã©ã®ç”¨é€”ã«ã¯ä½¿ãˆã¾ã›ã‚“ã€‚</p>
      </details>

      <div class="back-area" style="display:flex;justify-content:center;margin-top:12px">
        <a class="back" href="/shindan/" id="backLink" aria-label="è¨ºæ–­ä¸€è¦§ã«æˆ»ã‚‹">è¨ºæ–­ä¸€è¦§ã«æˆ»ã‚‹</a>
      </div>
    </div>
  </section>

  <section class="footer card">
    <h2 style="margin:4px 0 8px">ã”åˆ©ç”¨ã«ã‚ãŸã£ã¦</h2>
    <p class="small">ã“ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯<b>ã‚¨ãƒ³ã‚¿ãƒ¡ç”¨ã®è‡ªå·±ç†è§£</b>ã§ã™ã€‚ç¾å®Ÿã®åˆ¤æ–­ã‚„åŒ»ç™‚ãƒ»æ¡ç”¨ã«ã¯ä½¿ãˆã¾ã›ã‚“ã€‚å¿…è¦ãªå ´åˆã¯é–¢ä¿‚æ©Ÿé–¢ãƒ»å°‚é–€å®¶ã«ã”ç›¸è«‡ãã ã•ã„ã€‚<br>
    ãƒ‡ãƒ¼ã‚¿ã¯ç«¯æœ«å†…ã§å‡¦ç†ã•ã‚Œã€å€‹äººã‚’ç‰¹å®šã™ã‚‹æƒ…å ±ã®é€ä¿¡ãƒ»åé›†ã¯è¡Œã„ã¾ã›ã‚“ï¼ˆã”åˆ©ç”¨ç’°å¢ƒã«ã‚ˆã‚Šã‚¢ã‚¯ã‚»ã‚¹è§£æç­‰ãŒå‹•ä½œã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼‰ã€‚</p>
  </section>
</main>

<script>
(function(){
  // ====== ãƒšãƒ¼ã‚¸æƒ…å ± ======
  var SLUG = "mirrorshin";
  var TITLE = "é¡ãƒŠãƒ«ã‚·ã‚¹ãƒˆãƒ»ã‚»ãƒ«ãƒ•ãƒã‚§ãƒƒã‚¯";
  var ANS_KEY = "specimens:"+SLUG+":answers";
  var IMG_BASE = "/shindan/assets/results/mirror/"; // t01.webp..t05.webp

  // ====== å› å­ãƒ»è¨­å• ======
  // 4å› å­ï¼šAdmiration / Rivalry / Vulnerable / Communal
  var FACTORS = {
    ADM:{ name:"è‡ªå·±è³›ç¾ï¼ˆAdmirationï¼‰", items:["Q01","Q02","Q03","Q04","Q05"] },
    RIV:{ name:"ç«¶äº‰/å„ªè¶Šï¼ˆRivalryï¼‰",   items:["Q06","Q07","Q08","Q09","Q10"] },
    VUL:{ name:"ç¹Šç´°/å‚·ã¤ãã‚„ã™ã•ï¼ˆVulnerableï¼‰", items:["Q11","Q12","Q13","Q14","Q15"] },
    COM:{ name:"å–„è¡Œã‚¢ãƒ”ãƒ¼ãƒ«ï¼ˆCommunalï¼‰", items:["Q16","Q17","Q18","Q19","Q20"] }
  };
  window.FACTORS = FACTORS;

  // 20å•ï¼ˆrev: é€†è»¢ãƒ»ã‚„ã‚ã‚‰ã‹è¡¨ç¾ï¼‰
  var ITEMS = {
    // Admirationï¼ˆè‡ªå·±æ¼”å‡ºãƒ»æ³¨ç›®ï¼‰
    Q01:{ text:"äººå‰ã§é­…åŠ›çš„ã«è¦‹ã›ã‚‹å·¥å¤«ã¯å¾—æ„ãªã»ã†ã ã€‚" },
    Q02:{ text:"ç›®ç«‹ã¤å ´é¢ã«ç«‹ã¤ã¨æ°—åˆ†ãŒä¸ŠãŒã‚‹ã€‚" },
    Q03:{ text:"åˆå¯¾é¢ã®äººã«å¥½å°è±¡ã‚’æ®‹ã›ã‚‹è‡ªä¿¡ãŒã‚ã‚‹ã€‚" },
    Q04:{ text:"æˆåŠŸã¯è‡ªåˆ†ã«ãµã•ã‚ã—ã„ã¨æ„Ÿã˜ã‚„ã™ã„ã€‚" },
    Q05:{ text:"å†™çœŸã‚„æ˜ åƒã§ã®è¦‹ãˆæ–¹ã‚’ã‚ˆãæ°—ã«ã™ã‚‹ã€‚" },
    // Rivalryï¼ˆç«¶äº‰ãƒ»åç™ºï¼‰
    Q06:{ text:"æ‰¹åˆ¤ã•ã‚Œã‚‹ã¨åè«–ã—ãŸããªã‚Šã‚„ã™ã„ã€‚" },
    Q07:{ text:"è‡ªåˆ†ã‚ˆã‚Šç›®ç«‹ã¤äººãŒã„ã‚‹ã¨æ„è­˜ã—ã¦ã—ã¾ã†ã€‚" },
    Q08:{ text:"è² ã‘ã‚’èªã‚ã‚‹ã®ã¯å°‘ã—è‹¦æ‰‹ã ã€‚" },
    Q09:{ text:"å½¹ç«‹ãŸãªã„ã¨æ„Ÿã˜ã‚‹äººã¨ã¯è·é›¢ã‚’ç½®ããŸã„ã€‚" },
    Q10:{ text:"ãƒ«ãƒ¼ãƒ«ãŒè‡ªåˆ†ã®åŠ›ã‚’åˆ¶é™ã™ã‚‹ã¨æ„Ÿã˜ã‚‹ã“ã¨ãŒã‚ã‚‹ã€‚" },
    // Vulnerableï¼ˆç¹Šç´°ãƒ»ä¸å®‰ãƒ™ãƒ¼ã‚¹ï¼‰
    Q11:{ text:"è©•ä¾¡ãŒä¸‹ãŒã‚‹ã®ãŒæ€–ãã€è½ã¡è¾¼ã¿ã‚„ã™ã„ã€‚" },
    Q12:{ text:"å¤±æ•—ã®ã‚ã¨ã€è‡ªåˆ†ã‚’å¼·ãè²¬ã‚ã¦ã—ã¾ã†ã“ã¨ãŒã‚ã‚‹ã€‚" },
    Q13:{ text:"æ³¨ç›®ãŒãªã„ã¨ä¾¡å€¤ãŒä¸‹ãŒã‚‹æ°—ãŒã—ã¦ä¸å®‰ã«ãªã‚‹ã€‚" },
    Q14:{ text:"äººã‹ã‚‰ã®åå¿œã‚’æ·±èª­ã¿ã—ã¦å‚·ã¤ãã“ã¨ãŒã‚ã‚‹ã€‚" },
    Q15:{ text:"ã†ã¾ãã„ã£ã¦ã‚‚ã€ŒãŸã¾ãŸã¾ã€ã¨æ€ã„ã‚„ã™ã„ã€‚", rev:true },
    // Communalï¼ˆå–„è¡Œã‚¢ãƒ”ãƒ¼ãƒ«ãƒ»å½¹ç«‹ã¡ã‚¢ãƒ”ãƒ¼ãƒ«ï¼‰
    Q16:{ text:"äººã®å½¹ã«ç«‹ã¦ãŸã¨ãã€åºƒãçŸ¥ã£ã¦ã»ã—ã„ã¨æ€ã†ã€‚" },
    Q17:{ text:"åŠ©ã‘ãŸè©±ã‚„è²¢çŒ®ã‚’SNSã§ä¼ãˆã‚‹ã“ã¨ãŒã‚ã‚‹ã€‚" },
    Q18:{ text:"è‡ªåˆ†ã¯è‰¯ã„å½±éŸ¿ã‚’ä¸ãˆã‚‹å´ã ã¨æ€ã†ã€‚"},
    Q19:{ text:"å‘¨ã‚Šã‚ˆã‚Šâ€œæ°—ã¥ã/é…æ…®ã§ãã‚‹â€è‡ªè² ãŒã‚ã‚‹ã€‚"},
    Q20:{ text:"è¦‹è¿”ã‚Šã‚’æœŸå¾…ã›ãšè¡Œå‹•ã—ã¦ã„ã‚‹ã€‚", rev:true }
  };
  var LABELS = ["ãœã‚“ãœã‚“","ã‚ã¾ã‚Š","ã¨ãã©ã","ã‚ˆã","ã¨ã¦ã‚‚"];

  // 5ãƒãƒ³ãƒ‰ï¼ˆç·åˆï¼…ã§æ±ºå®šï¼‰
  var BANDS = [
    { id:1, key:"t01", name:"ãƒŸãƒ‹ãƒãƒ«",   one:"æ§ãˆã‚ã§è‡ªç„¶ä½“ã€‚",               hint:"è‡ªå·±ã‚¢ãƒ”ãƒ¼ãƒ«ã¯â€œå¿…è¦ãªå ´é¢ã ã‘â€ã§ååˆ†ã€‚å¿«é©åœã‚’å®ˆã‚ã†ã€‚"},
    { id:2, key:"t02", name:"ãƒŠãƒãƒ¥ãƒ©ãƒ«", one:"è½ã¡ç€ã„ãŸè‚¯å®šæ„Ÿã€‚",             hint:"çŠ¶æ³ã«å¿œã˜ã¦è»½ãé­…ã›ã‚‹ã€‚ç„¡ç†ã«ç››ã‚‰ãªã„ã®ãŒé­…åŠ›ã€‚"},
    { id:3, key:"t03", name:"ãƒãƒ©ãƒ³ã‚¹",   one:"ON/OFFã®åˆ‡æ›¿ãŒä¸Šæ‰‹ã€‚",           hint:"å¤§äº‹ãªå ´é¢ã§ã ã‘ã‚¹ã‚¤ãƒƒãƒONã€‚çµ‚ã‚ã£ãŸã‚‰OFFã®å„€å¼ã‚’ã€‚"},
    { id:4, key:"t04", name:"ã‚¨ãƒƒã‚¸",     one:"è‡ªå·±ä¸»å¼µãƒ»ç«¶äº‰å¿ƒãŒã‚„ã‚„å¼·ã‚ã€‚",   hint:"ä¼‘ã‚€äºˆå®šã‚‚â€œä»•äº‹â€ã¨ã—ã¦å…¥ã‚Œã‚‹ã€‚æ¯”ã¹ã™ãã‚’1å›ãƒ‘ã‚¹ã€‚"},
    { id:5, key:"t05", name:"ã‚¹ã‚¿ãƒ¼",     one:"æ¼”å‡ºï¼†å¯¾æŠ—å¿ƒãŒå¼·ã„ã‚¹ã‚¿ãƒ¼æ°—è³ªã€‚", hint:"ã‚±ã‚¢æ‹…å½“ã‚’æ±ºã‚ã‚‹ï¼ˆç¡çœ ãƒ»æ „é¤Šãƒ»è¦ªã—ã„äººï¼‰ã€‚å‹è² ã¯é¸ã¼ã†ã€‚"}
  ];
  var BAND_LONG = {
    t01:"è‡ªå·±ä¸»å¼µã¯æ§ãˆã‚ã§ã€è‡ªç„¶ä½“ã®ã¾ã¾è©•ä¾¡ã•ã‚ŒãŸã„ã‚¹ã‚¿ã‚¤ãƒ«ã€‚é™ã‹ãªé›†ä¸­ãŒå¼·ã¿ã§ã™ã€‚å¿…è¦ãªå ´é¢ã ã‘ãƒ©ã‚¤ãƒˆã‚’å½“ã¦ã‚‹ã¨ã€ç–²ã‚Œã«ããâ€œã‚‰ã—ã•â€ã‚’ä¿ã¦ã¾ã™ã€‚ã‚¢ãƒ”ãƒ¼ãƒ«ã‚ˆã‚Šã‚‚ã€æ—¥ã€…ã®å°ã•ãªç¶™ç¶šãŒã‚ãªãŸã®ä¿¡é ¼ã‚’ä½œã‚Šã¾ã™ã€‚",
    t02:"ç©ã‚„ã‹ãªè‡ªå·±è‚¯å®šã¨è¬™è™šã•ã®ãƒãƒ©ãƒ³ã‚¹ã€‚ç›®ç«‹ã¤/æ”¯ãˆã‚‹ã‚’çŠ¶æ³ã§åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã¾ã™ã€‚è¦‹ã›æ–¹ã¯â€œè¶³ã—ç®—ã‚ˆã‚Šå¼•ãç®—â€ã€‚ç››ã‚‰ãšã«è‰¯ã•ãŒæ®‹ã‚‹é…ç½®ã‚’é¸ã¶ã¨ã€è‡ªç„¶ãªé­…åŠ›ãŒé•·æŒã¡ã—ã¾ã™ã€‚",
    t03:"ON/OFFã®åˆ‡æ›¿ãŒä¸Šæ‰‹ã§ã€å¿…è¦ãªã¨ãã«é›†ä¸­ã¨æ¼”å‡ºã‚’ä½¿ãˆã¾ã™ã€‚å‹è² æ‰€ã‚’æ±ºã‚ã¦ã‚¨ãƒãƒ«ã‚®ãƒ¼é…åˆ†ã‚’ã€‚çµ‚äº†ã®åˆå›³ï¼ˆæ•£æ­©ãƒ»ã‚¹ãƒˆãƒ¬ãƒƒãƒãƒ»éŸ³æ¥½ï¼‰ã‚’æ±ºã‚ã‚‹ã¨OFFãŒã‚¹ãƒ ãƒ¼ã‚ºã«ãªã‚Šã€ç¿Œæ—¥ã®å›å¾©ãŒé€Ÿããªã‚Šã¾ã™ã€‚",
    t04:"è‡ªå·±ä¸»å¼µã¨ç«¶äº‰å¿ƒãŒã‚„ã‚„å¼·ã‚ã€‚æ¨é€²åŠ›ã«ãªã‚‹ä¸€æ–¹ã§ã€æ¯”ã¹ã™ãã‚‹ã¨æ¶ˆè€—ã—ã¾ã™ã€‚â€œæˆ¦ã‚ãªã„æ—¥â€ã‚’é€±ã«1å›ä½œã‚Šã€ã‚±ã‚¢ã®å„€å¼ï¼ˆç¡çœ ãƒ»é£Ÿäº‹ãƒ»æ°´åˆ†ãƒ»æ·±å‘¼å¸ï¼‰ã§åœŸå°ã‚’æ•´ãˆã‚‹ã¨ã€å°–ã‚Šã¯æ­¦å™¨ã¨ã—ã¦åƒãã¾ã™ã€‚",
    t05:"æ¼”å‡ºã¨å¯¾æŠ—å¿ƒãŒå¼·ã„ã‚¹ã‚¿ãƒ¼æ°—è³ªã€‚é«˜ã„ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ã¯å‘¨å›²ã‚’å¼•ã£å¼µã‚‹åŠ›ã«ãªã‚Šã¾ã™ã€‚å‹è² ã®æ•°ã‚’çµã‚Šã€è² ã‘ã®æ‰±ã„æ–¹ï¼ˆæŒ¯è¿”ã‚Šâ†’æ¬¡ã®ä¸€æ‰‹ï¼‰ã‚’ãƒ†ãƒ³ãƒ—ãƒ¬åŒ–ã€‚ä¿¡é ¼ã§ãã‚‹äººã«â€œãƒ–ãƒ¬ãƒ¼ã‚­å½¹â€ã‚’é ¼ã‚€ã¨æŒç¶šå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚"
  };

  // è¦ç´ å‚ç…§
  var qWrap   = document.getElementById("qWrap");
  var prog    = document.getElementById("prog");
  var resEmpty= document.getElementById("resEmpty");
  var resArea = document.getElementById("resArea");
  var typeLine= document.getElementById("typeLine");
  var heroImg = document.getElementById("heroImg");
  var heroTitle= document.getElementById("heroTitle");
  var heroCopy = document.getElementById("heroCopy");
  var heroHint = document.getElementById("heroHint");
  var sumAvg  = document.getElementById("sumAvg");
  var sumPct  = document.getElementById("sumPct");
  var sumNote = document.getElementById("sumNote");
  var bars    = document.getElementById("bars");
  var longCopy= document.getElementById("longCopy");
  var resMemo = document.getElementById("resMemo");
  var shareRow= document.getElementById("shareRow");
  var shareTw = document.getElementById("shareTw");
  var shareLn = document.getElementById("shareLn");
  var shareIg = document.getElementById("shareIg");
  var shareCp = document.getElementById("shareCp");
  var careList= document.getElementById("careList");
  var shotCanvas = document.getElementById("shotCanvas");
  var allyNote= document.getElementById("allyNote");
  window.shotCanvas = shotCanvas;

  // è¨­å•ç”Ÿæˆ
  function buildQuestions(){
    var html = "";
    Object.keys(ITEMS).forEach(function(qid, i){
      var q = ITEMS[qid];
      html += '<fieldset class="q" id="fs-'+qid+'">'+
        '<legend>'+String(i+1).padStart(2,"0")+'. '+q.text+'</legend>'+
        '<div class="scale" role="radiogroup" aria-label="'+q.text+'">';
      for(var v=0;v<=4;v++){
        html += '<div style="position:relative">'+
          '<input id="q'+qid+'-'+v+'" type="radio" name="q'+qid+'" value="'+v+'">'+
          '<label for="q'+qid+'-'+v+'" title="'+LABELS[v]+'">'+LABELS[v]+'</label>'+
        '</div>';
      }
      html += '</div></fieldset>';
    });
    qWrap.innerHTML = html;

    qWrap.querySelectorAll('input[type="radio"]').forEach(function(r){
      r.addEventListener('change', function(){ saveAnswers(); updateProgress(); }, false);
    });
    restoreAnswers();
    updateProgress();
  }

  // ä¿å­˜/å¾©å…ƒ
  function saveAnswers(){
    try{
      var out = {};
      Object.keys(ITEMS).forEach(function(id){
        var chk = qWrap.querySelector('#fs-'+id+' input[type="radio"]:checked');
        if(chk){ out[id] = parseInt(chk.value,10); }
      });
      localStorage.setItem(ANS_KEY, JSON.stringify({ts:Date.now(), ans:out}));
    }catch(e){}
  }
  function restoreAnswers(){
    try{
      var raw = localStorage.getItem(ANS_KEY);
      if(!raw) return;
      var data = JSON.parse(raw);
      var ans = (data && data.ans) || {};
      Object.keys(ans).forEach(function(id){
        var v = ans[id];
        var input = qWrap.querySelector('#q'+id+'-'+v);
        if(input){ input.checked = true; }
      });
    }catch(e){}
  }
  function wipeAnswers(){ try{ localStorage.removeItem(ANS_KEY); }catch(e){} }

  function updateProgress(){
    var total = Object.keys(ITEMS).length; // 20
    var answered = 0;
    Object.keys(ITEMS).forEach(function(id){
      if(qWrap.querySelector('#fs-'+id+' input[type="radio"]:checked')) answered++;
    });
    var pct = Math.round(100*answered/total);
    prog.style.width = pct + "%";
    var bar = prog.parentElement;
    if(bar){
      bar.setAttribute("aria-valuenow", answered);
      bar.setAttribute("aria-label", "å›ç­”é€²æ—ï¼š"+answered+" / "+total);
    }
  }

  // ã‚¹ã‚³ã‚¢è¨ˆç®—
  function valOf(id, raw){ var v=Number(raw); return (ITEMS[id].rev? (4-v):v); }
  function calc(){
    var missing = [];
    var ans = {};
    Object.keys(ITEMS).forEach(function(id){
      var chk = qWrap.querySelector('#fs-'+id+' input[type="radio"]:checked');
      if(!chk){ missing.push(id); return; }
      ans[id] = parseInt(chk.value,10);
    });
    if(missing.length){
      alert("æœªå›ç­”ãŒã‚ã‚Šã¾ã™ã€‚å…¨20å•ã«ãŠç­”ãˆãã ã•ã„ã€‚");
      var fs = document.getElementById('fs-'+missing[0]);
      if(fs){ fs.scrollIntoView({behavior:"smooth", block:"center"}); fs.classList.add("need"); setTimeout(function(){ fs.classList.remove("need"); },1600); }
      return;
    }

    var fScore = {}, fPct = {};
    Object.keys(FACTORS).forEach(function(key){
      var ids = FACTORS[key].items;
      var sum = ids.reduce(function(s,id){ return s + valOf(id, ans[id]); },0);
      var avg = sum / ids.length; // 0-4
      fScore[key] = avg;
      fPct[key] = Math.round((avg/4)*100);
    });

    var keys = Object.keys(FACTORS);
    var totalAvg = keys.reduce(function(s,k){ return s + fScore[k]; },0) / keys.length;
    var totalPct = Math.round((totalAvg/4)*100);

    render({ fScore, fPct, totalAvg, totalPct });
  }

  // ç”»åƒãƒ‘ã‚¹
  function heroPath(bandKey){ return IMG_BASE + bandKey + ".webp"; }

  function drawBars(pct){
    var order = ["ADM","RIV","VUL","COM"];
    var html = "";
    order.forEach(function(key){
      var def = FACTORS[key], val = pct[key]||0;
      html += '<article class="bar" aria-label="'+def.name+'">'+
        '<div><strong>'+def.name+'</strong><span class="pill" style="margin-left:6px">'+String(val).padStart(2,"0")+'%</span></div>'+
        '<div class="row" aria-hidden="true"><span style="width:'+val+'%"></span></div>'+
      '</article>';
    });
    bars.innerHTML = html;
  }

  // ã‚±ã‚¢ï¼ˆä¸Šä½å› å­ï¼‰
  var CARE = {
    ADM: [
      "â€œé­…ã›ã‚‹æ—¥â€ã¨â€œç´ ã§éã”ã™æ—¥â€ã‚’åˆ†ã‘ã‚‹ï¼ˆäºˆå®šè¡¨ã«ON/OFFï¼‰ã€‚",
      "ã‚¢ãƒ”ãƒ¼ãƒ«ã¯â€œ1ç‚¹ã ã‘â€ã€‚ç››ã‚Šã™ããªã„ã¨å¥½å°è±¡ãŒé•·æŒã¡ã€‚",
      "çµ‚ã‚ã‚Šã®åˆå›³ã‚’ä½œã‚‹ï¼ˆæ­©ã/é¡”ã‚’æ´—ã†/æ·±å‘¼å¸ï¼‰ã€‚"
    ],
    RIV: [
      "æ¯”ã¹ã‚°ã‚»ã«æ°—ã¥ã„ãŸã‚‰â€œä»Šã®ä¸€æ‰‹â€ã‚’3åˆ†ã ã‘ã‚„ã‚‹ã€‚",
      "æˆ¦ã‚ãªã„æ—¥ã‚’é€±1ã€‚ç¡çœ ãƒ»æ „é¤Šãƒ»æ°´åˆ†ã‚’å…ˆã«ç¢ºä¿ã€‚",
      "è² ã‘ã®æ‰±ã„æ–¹ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆè¦å› â†’å­¦ã³â†’æ¬¡ã®ä¸€æ‰‹ï¼‰ã€‚"
    ],
    VUL: [
      "â€œæ°—åˆ†â€ã¨â€œäº‹å®Ÿâ€ã‚’åˆ¥è¡Œã§1è¡Œãƒ¡ãƒ¢ã€‚è‡ªè²¬ã‚’è–„ã‚ã‚‹ã€‚",
      "ã»ã‚ã¯å¼•ç”¨ä¿å­˜â†’ç¿Œæ—¥ã«èª­ã‚€ï¼ˆå¦å®šã¯ãã®å¾Œï¼‰ã€‚",
      "å®‰å¿ƒã§ãã‚‹äººã«å°ã•ãç›¸è«‡ï¼ˆ1å¾€å¾©ã§OKï¼‰ã€‚"
    ],
    COM: [
      "è²¢çŒ®ã®æŠ•ç¨¿ã¯â€œé€±1å›ã¾ã¨ã‚ã¦â€ã€‚æ—¥ã€…ã¯é™ã‹ã«ç¶™ç¶šã€‚",
      "åŠ©ã‘ã‚’â€œãƒãƒ¼ãƒ ã®æˆæœâ€ã¨ã—ã¦è¡¨ç¾ï¼ˆç§â†’ç§ãŸã¡ï¼‰ã€‚",
      "è¦‹è¿”ã‚Šãªã—ã®ãƒŸãƒ‹è¡Œå‹•ã‚’1ã¤ï¼ˆå¸­ã‚†ãšã‚Š/ã­ãã‚‰ã„ï¼‰ã€‚"
    ]
  };

  function pickBand(totalPct){
    if (totalPct<=20) return BANDS[0];
    if (totalPct<=40) return BANDS[1];
    if (totalPct<=60) return BANDS[2];
    if (totalPct<=80) return BANDS[3];
    return BANDS[4];
  }

  function render(o){
    // ç·åˆãƒãƒ³ãƒ‰
    var band = pickBand(o.totalPct);

    // ä¸Šä½å› å­
    var topKey = Object.keys(o.fPct).sort(function(a,b){ return o.fPct[b]-o.fPct[a]; })[0];

    // ã‚¿ã‚¤ãƒˆãƒ«è¡Œ
    typeLine.textContent = 'é¡ã®çŠ¶æ…‹ï¼š' + band.name + 'ï¼ˆ'+o.totalPct+'%ï¼‰';

    // ãƒ’ãƒ¼ãƒ­ãƒ¼
    heroImg.src = heroPath(band.key);
    heroImg.alt = band.name + " ã®ã‚¤ãƒ¡ãƒ¼ã‚¸";
    heroTitle.textContent = band.name + "ï½œ" + band.one;
    heroCopy.textContent  = BAND_LONG[band.key] || "";
    heroHint.textContent  = "ãƒ’ãƒ³ãƒˆï¼š" + band.hint;

    // ç·åˆ
    var avg = Object.keys(o.fScore).reduce(function(s,k){return s+o.fScore[k];},0)/Object.keys(o.fScore).length;
    sumAvg.textContent = avg.toFixed(2);
    sumPct.textContent = "= " + o.totalPct + "%";
    sumNote.textContent = "ä¸Šä½å› å­ï¼š"+FACTORS[topKey].name;
    allyNote.textContent = "ä»Šæ—¥ã®ãƒã‚¤ãƒ³ãƒˆï¼šä¸Šä½å› å­ï¼ˆ"+FACTORS[topKey].name+"ï¼‰ã®æ‰±ã„ã‚’1ã¤ã ã‘æ•´ãˆã‚‹ã€‚";

    // å› å­ãƒãƒ¼
    drawBars(o.fPct);

    // é•·æ–‡
    longCopy.innerHTML = '';

    // ã‚±ã‚¢ï¼ˆä¸Šä½å› å­3è¡Œï¼‰
    if (careList && CARE[topKey]) {
      careList.innerHTML = CARE[topKey].map(function(s){ return "<li>"+s+"</li>"; }).join("");
    }

    // ç ”ç©¶ãƒ¡ãƒ¢ï¼ˆã“ã®ãƒ†ãƒ¼ãƒç”¨ï¼‰
    var memo = [
      "è‡ªå·±è³›ç¾ã¨ç«¶äº‰å¿ƒã¯æ¨é€²åŠ›ã«ãªã‚‹ä¸€æ–¹ã€éåº¦ã ã¨äººé–“é–¢ä¿‚ã®æ‘©æ“¦ã‚„æ¶ˆè€—ã«ã¤ãªãŒã‚Šã‚„ã™ã„ã€‚æ‰±ã„ã‚’æ•´ãˆã‚‹ã¨â€œæˆæœã¯ãã®ã¾ã¾ã€ç–²åŠ´ã¯æ§ãˆã‚â€ã«ãªã‚Šã‚„ã™ã„ã€‚",
      "ç¹Šç´°ã•ã¯æ„Ÿå—æ€§ã®å¼·ã•ã§ã‚‚ã‚ã‚‹ã€‚æ°—åˆ†ã¨äº‹å®Ÿã‚’åˆ†ã‘ã¦ãƒ¡ãƒ¢ã™ã‚‹ç¿’æ…£ã¯ã€è¡å‹•çš„ãªåˆ¤æ–­ã‚’æ¸›ã‚‰ã—ç¿Œæ—¥ã®è»Œé“ä¿®æ­£ã‚’åŠ©ã‘ã‚‹ã€‚",
      "å–„è¡Œã‚¢ãƒ”ãƒ¼ãƒ«ã¯å…±æ„Ÿã‚’åºƒã’ã‚‹é¢ã‚‚ã‚ã‚‹ãŒã€é »åº¦ãŒé«˜ã„ã¨åç™ºã‚’æ‹›ãã“ã¨ãŒã‚ã‚‹ã€‚ã¾ã¨ã‚ã¦ç™ºä¿¡ã—ã€æ—¥ã€…ã¯é™ã‹ã«ç¶™ç¶šã™ã‚‹ã¨ä¿¡é ¼ãŒç©ã¿ä¸ŠãŒã‚‹ã€‚"
    ];
    resMemo.innerHTML = memo.map(function(s){ return "<li>"+s+"</li>"; }).join("");

    // å…±æœ‰
    var shareText = 'ã€é¡ãƒŠãƒ«ã‚·ã‚¹ãƒˆãƒ»ã‚»ãƒ«ãƒ•ãƒã‚§ãƒƒã‚¯ã€é¡ã®çŠ¶æ…‹ï¼š'+band.name+'ï½œå› å­å¹³å‡ '+avg.toFixed(2)+' / 4';
    var url = location.href.split('#')[0];
    function openBlank(u){ window.open(u, '_blank', 'noopener'); }
    if(shareTw) shareTw.onclick = function(){ openBlank('https://twitter.com/intent/tweet?text='+encodeURIComponent(shareText)+'&url='+encodeURIComponent(url)); };
    if(shareLn) shareLn.onclick = function(){ openBlank('https://line.me/R/msg/text/?'+encodeURIComponent(shareText+' '+url)); };
    if(shareIg) shareIg.onclick = function(){
      var cap = shareText+' '+url;
      copyToClipboard(cap).then(function(){
        openBlank('https://www.instagram.com/');
        toast('ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚Instagramã§è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚');
      });
    };
    if(shareCp){
      shareCp.onclick = function(){
        copyToClipboard(shareText+' '+url).then(function(){ toast('ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'); });
      };
    }
    shareRow.hidden = false;
    shareRow.style.display = 'flex';

    // è¡¨ç¤ºåˆ‡æ›¿
    resEmpty.style.display = "none";
    resArea.style.display  = "block";
    document.getElementById("result").scrollIntoView({behavior:"smooth", block:"start"});

    // ä¿å­˜ï¼ˆç›´è¿‘ï¼‰
    try{
      localStorage.setItem("specimens:last", JSON.stringify({ id: SLUG, title: TITLE, href: location.pathname }));
    }catch(e){}

    // æ¸ˆè¨ˆä¸Šã®åˆå›³ï¼ˆå…±é€šã‚¹ãƒ‹ãƒšãƒƒãƒˆç”¨ï¼‰
    try{ document.dispatchEvent(new Event('result:ready')); }catch(_){}
  }

  // å…±æœ‰ãƒ˜ãƒ«ãƒ‘
  function copyToClipboard(text){
    if(navigator.clipboard && navigator.clipboard.writeText){ return navigator.clipboard.writeText(text); }
    return new Promise(function(res){
      var ta=document.createElement('textarea'); ta.value=text;
      document.body.appendChild(ta); ta.select();
      try{ document.execCommand('copy'); }catch(_){}
      document.body.removeChild(ta); res();
    });
  }
  function toast(msg){
    var t=document.createElement('div');
    t.textContent=msg;
    t.style.position='fixed'; t.style.left='50%'; t.style.bottom='20px';
    t.style.transform='translateX(-50%)'; t.style.background='rgba(34,26,40,.92)';
    t.style.color='#fff'; t.style.padding='8px 12px'; t.style.borderRadius='10px';
    t.style.zIndex=9999; t.style.fontSize='13px';
    document.body.appendChild(t);
    setTimeout(function(){ t.remove(); },1500);
  }

  // ã‚¹ã‚¯ã‚·ãƒ§ä¿å­˜
  var btnShot = document.getElementById('btnShot');
  if(btnShot){ btnShot.addEventListener('click', async function(){
    var avg = parseFloat(sumAvg.textContent)||0;
    var band = pickBand(Math.round((avg/4)*100));
    var blob = await buildShareImage({
      heroSrc: heroImg.src,
      title: document.getElementById('heroTitle').textContent,
      one: document.getElementById('heroCopy').textContent,
      hint: document.getElementById('heroHint').textContent.replace(/^ãƒ’ãƒ³ãƒˆï¼š/,''),
      pct: (function(){
        var m={}; ["ADM","RIV","VUL","COM"].forEach(function(k){
          var el = bars.querySelector('article:nth-child('+({ADM:1,RIV:2,VUL:3,COM:4}[k])+') .pill');
          m[k]= el? parseInt(el.textContent,10):0;
        }); return m;
      })(),
      avg: sumAvg.textContent
    });
    saveBlob(blob, "mirror-result.png");
  }, false); }

  // ã‚¯ãƒªã‚¢
  function clearAnswers(){
    qWrap.querySelectorAll('input[type="radio"]').forEach(function(r){ r.checked=false; });
    wipeAnswers(); prog.style.width="0%";
    resEmpty.style.display=""; resArea.style.display="none";
    var app=document.getElementById("app"); if(app){ app.scrollIntoView({behavior:"smooth", block:"start"}); }
  }

  function init(){
    buildQuestions();
    resMemo.innerHTML = ["æœ¬ãƒã‚§ãƒƒã‚¯ã¯ã‚¨ãƒ³ã‚¿ãƒ¡è‡ªå·±ç†è§£ã§ã™ã€‚"].map(function(s){return "<li>"+s+"</li>";}).join("");
  }
  if(document.readyState === "loading"){ document.addEventListener("DOMContentLoaded", init); } else { init(); }
  document.getElementById("doScore").addEventListener("click", calc, false);
  document.getElementById("doScore2").addEventListener("click", calc, false);
  document.getElementById("clearAns").addEventListener("click", clearAnswers, false);

  var back = document.getElementById("backLink");
  if(back){
    back.addEventListener("click", function(){
      try{ localStorage.setItem("specimens:last", JSON.stringify({ id: SLUG, title: TITLE, href: location.pathname })); }catch(e){}
    }, false);
  }
})(); // IIFE

// ====== çµæœç”»åƒï¼ˆ1080x1350ï¼‰ ======
async function buildShareImage(data){
  var cvs = (window.shotCanvas || document.getElementById("shotCanvas"));
  if(!cvs) throw new Error("shotCanvas not found");
  var ctx = cvs.getContext("2d");
  var W = cvs.width, H = cvs.height;
  var FACT = (window.FACTORS || {});

  // èƒŒæ™¯
  ctx.fillStyle = "#ffffff"; ctx.fillRect(0,0,W,H);

  // ãƒ’ãƒ¼ãƒ­ãƒ¼ç”»åƒï¼ˆæ­£æ–¹å½¢ï¼‰
  var heroW = W - 120, heroH = heroW;
  var hx = Math.round((W - heroW)/2), hy = 60;
  roundRect(ctx, hx-4, hy-4, heroW+8, heroH+8, 18, "#fbf7ff", "#efe6f7");
  try{
    var img = await loadImage(data.heroSrc);
    ctx.drawImage(img, hx, hy, heroW, heroH);
  }catch(_){
    ctx.fillStyle = "#efe6f7"; ctx.fillRect(hx, hy, heroW, heroH);
    ctx.fillStyle = "#9a88a6"; ctx.font = "600 24px 'Noto Sans JP',system-ui";
    ctx.fillText("ç”»åƒã‚’è¡¨ç¤ºã§ãã¾ã›ã‚“ã§ã—ãŸ", hx + 24, hy + heroH/2);
  }

  // ã‚¿ã‚¤ãƒˆãƒ«
  var y = hy + heroH + 40;
  ctx.fillStyle = "#221a28";
  ctx.font = "800 40px 'Noto Sans JP',system-ui";
  ctx.fillText("é¡ãƒŠãƒ«ã‚·ã‚¹ãƒˆãƒ»ã‚»ãƒ«ãƒ•ãƒã‚§ãƒƒã‚¯", 60, y);
  ctx.font = "800 44px 'Noto Sans JP',system-ui";
  drawWrapText(ctx, data.title, 60, y+54, W-120, 48);

  // ä¸€è¨€ãƒ»ãƒ’ãƒ³ãƒˆ
  ctx.font = "700 28px 'Noto Sans JP',system-ui";
  drawWrapText(ctx, data.one, 60, y+120, W-120, 36, "#6b6170");
  ctx.font = "600 26px 'Noto Sans JP',system-ui";
  drawWrapText(ctx, "ãƒ’ãƒ³ãƒˆï¼š"+data.hint, 60, y+176, W-120, 34, "#6b6170");

  // å› å­ãƒãƒ¼ï¼ˆ4ï¼‰
  var baseY = y + 230;
  var order = ["ADM","RIV","VUL","COM"];
  for(var i=0;i<order.length;i++){
    var key = order[i], val = data.pct[key]||0;
    drawBar(ctx, 60, baseY + i*60, W-120, 16, val,
      (FACT[key] ? FACT[key].name : key), "#b86bdf", "#ffc0e6");
  }

  // å¹³å‡
  var ftY = baseY + order.length*60 + 36;
  ctx.font = "700 28px 'Noto Sans JP',system-ui";
  ctx.fillStyle = "#221a28";
  ctx.fillText("å› å­å¹³å‡ï¼š"+data.avg+" / 4ï¼ˆ= "+Math.round((parseFloat(data.avg)/4)*100)+"%ï¼‰", 60, ftY);

  return await canvasToBlob(cvs, "image/png");
}
async function loadImage(src){
  try{
    const r = await fetch(src, {cache:'no-store'});
    if(!r.ok) throw new Error('fetch failed');
    const b = await r.blob();
    const blobUrl = URL.createObjectURL(b);
    const img = await new Promise((res, rej)=>{
      const im = new Image();
      im.onload = ()=>res(im);
      im.onerror = rej;
      im.src = blobUrl;
    });
    setTimeout(()=>URL.revokeObjectURL(blobUrl), 1000);
    return img;
  }catch(e){
    return await new Promise((res, rej)=>{
      const im = new Image();
      im.crossOrigin = "anonymous";
      im.onload = ()=>res(im);
      im.onerror = rej;
      im.src = src + (src.indexOf("?")>-1 ? "&" : "?") + "t=" + Date.now();
    });
  }
}
function roundRect(ctx, x, y, w, h, r, fill, stroke){
  ctx.save(); ctx.beginPath();
  ctx.moveTo(x+r, y);
  ctx.arcTo(x+w, y, x+w, y+h, r);
  ctx.arcTo(x+w, y+h, x, y+h, r);
  ctx.arcTo(x, y+h, x, y, r);
  ctx.arcTo(x, y, x+w, y, r);
  ctx.closePath();
  if(fill){ ctx.fillStyle = fill; ctx.fill(); }
  if(stroke){ ctx.strokeStyle = stroke; ctx.stroke(); }
  ctx.restore();
}
function drawWrapText(ctx, text, x, y, maxW, lh, color){
  ctx.fillStyle = color || "#221a28";
  var words = (text||"").split(/(\s+)/);
  var line = "", cursor = y;
  for(var i=0;i<words.length;i++){
    var test = line + words[i];
    if(ctx.measureText(test).width > maxW && i>0){
      ctx.fillText(line, x, cursor);
      line = words[i].trimStart();
      cursor += lh;
    }else{ line = test; }
  }
  if(line){ ctx.fillText(line, x, cursor); }
}
function drawBar(ctx, x, y, w, h, pct, label, c1, c2){
  ctx.save();
  ctx.fillStyle = "#221a28";
  ctx.font = "700 20px 'Noto Sans JP',system-ui";
  ctx.fillText(label, x, y-8);
  var by = y+8;
  roundRect(ctx, x, by, w, h, 10, "#f7ecff", "#efe6f7");
  var ww = Math.max(0, Math.min(w, Math.round(w*pct/100)));
  var grad = ctx.createLinearGradient(x,0,x+w,0);
  grad.addColorStop(0, c1); grad.addColorStop(1, c2);
  roundRect(ctx, x, by, ww, h, 10, grad);
  ctx.fillStyle = "#6b6170";
  ctx.font = "600 16px 'Noto Sans JP',system-ui";
  var txt = String(pct).padStart(2,"0")+"%";
  ctx.fillText(txt, x + w - ctx.measureText(txt).width, by + h + 18);
  ctx.restore();
}
function saveBlob(blob, filename){
  var a = document.createElement("a");
  var url = URL.createObjectURL(blob);
  a.href = url; a.download = filename || "result.png";
  document.body.appendChild(a); a.click();
  setTimeout(function(){ URL.revokeObjectURL(url); a.remove(); }, 400);
}
function canvasToBlob(cvs, type){
  return new Promise(function(res){
    if(cvs.toBlob){ cvs.toBlob(function(b){ res(b); }, type||"image/png"); }
    else{ res(dataURLtoBlob(cvs.toDataURL(type||"image/png"))); }
  });
}
function dataURLtoBlob(dataUrl){
  var arr = dataUrl.split(','), mime = arr[0].match(/:(.*?);/)[1],
      bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
  while(n--){ u8arr[n] = bstr.charCodeAt(n); }
  return new Blob([u8arr], {type:mime});
}
</script>

<!-- ===== å…±é€šã‚¹ãƒ‹ãƒšãƒƒãƒˆï¼šæ¸ˆï¼‹ã‚ãªãŸLvï¼‹ã¿ã‚“ãªã®Lvï¼ˆCountAPIï¼‰ =====
     å„è¨ºæ–­HTMLã® </body> ç›´å‰ã«è²¼ã‚‹æƒ³å®šã€‚data-id ã¯ <body data-id="..."> -->
<script>
(function(){
  'use strict';
  var DONE_KEY   = 'specimens:open:byid';
  var TOTAL_KEY  = 'specimens:open:total';
  var GLOBAL_LAST= 'specimens:open:global:last';
  var MY_ID = (document.body && document.body.getAttribute('data-id')) || 'unknown';

  // ã¿ã‚“ãªã®Lvï¼ˆCountAPIï¼‰
  var COUNTAPI_NS  = 'haisuikounozarigani_shindan';
  var COUNTAPI_KEY = 'specimens_open_total';
  function countapiHit(){
    var url = 'https://api.countapi.xyz/hit/'+COUNTAPI_NS+'/'+COUNTAPI_KEY;
    if(navigator.sendBeacon){
      try{ navigator.sendBeacon(url); }catch(_){}
    }else{
      fetch(url, {mode:'cors', cache:'no-store', keepalive:true}).catch(function(){});
    }
  }

  var marked = false;
  function markOnce(){
    if(marked) return; marked = true;
    try{
      // ã‚ãªãŸã®ã“ã“ã‚Lv +1
      var total = (+localStorage.getItem(TOTAL_KEY) || 0) + 1;
      localStorage.setItem(TOTAL_KEY, String(total));
      // æ¸ˆãƒãƒƒãƒ— +1ï¼ˆtimestampæ··ãœï¼‰
      var map={}; try{ map = JSON.parse(localStorage.getItem(DONE_KEY) || '{}'); }catch(_){}
      map[MY_ID] = (map[MY_ID] || 0) + 1;
      localStorage.setItem(DONE_KEY, JSON.stringify(Object.assign({}, map, {_ts: Date.now()})));
      // ã¿ã‚“ãªã®Lv +1
      countapiHit();
      try{
        var last = (+localStorage.getItem(GLOBAL_LAST) || 0) + 1;
        localStorage.setItem(GLOBAL_LAST, String(last));
      }catch(_){}
    }catch(_){}
  }
  document.addEventListener('result:ready', markOnce);
  setTimeout(markOnce, 2000); // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
})();
</script>
</body>
</html>