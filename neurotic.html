<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>神経症的傾向・クトゥルフ神話診断</title>
<meta name="description" content="6下位因子×各3問=18問を0〜4の5件法で回答。総合ランク（ノーデンス〜アザトース）と因子別バー、守護バッジ、研究メモを表示します（エンタメ用／独自項目）。">
<meta name="theme-color" content="#f7f9ff">
<!-- OG -->
<meta property="og:type" content="website">
<meta property="og:title" content="神経症的傾向・クトゥルフ神話診断">
<meta property="og:description" content="18問で神経症的傾向をチェック。総合ランク（神）と因子バー、守護バッジ、研究メモを表示。">
<meta property="og:url" content="https://haisuikounozarigani.github.io/shindan/neurotic.html">
<meta property="og:image" content="/shindan/assets/results/neurotic/03.png">
<style>
:root{
  --accent:#4aa8ff; --accent2:#a48bff;
  --ink:#1f2732; --muted:#667087; --paper:#fff;
  --bg1:#f7f9ff; --bg2:#f6f3ff; --line:#e6ecf7;
  --good:#40c057; --mid:#fab005; --low:#ff6b6b;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--ink);
  background:linear-gradient(180deg,var(--bg1),var(--bg2));
  font-family:"Noto Sans JP",system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN",sans-serif;
}
a{color:inherit}
.wrap{max-width:980px;margin:18px auto;padding:0 14px}
header.hd{display:grid;grid-template-columns:56px 1fr;gap:12px;align-items:center;margin:8px 0}
.logo{width:56px;height:56px;border-radius:14px;background:linear-gradient(135deg,#e1f2ff,#ece6ff);display:grid;place-items:center;font-size:28px}
h1{margin:0;font-size:clamp(22px,4.6vw,34px);letter-spacing:.02em}
.sub{margin:4px 0 0;color:var(--muted);font-size:.96em}
.card{background:var(--paper);border:1px solid var(--line);border-radius:16px;padding:14px}
.section{margin:14px 0}
.pill{display:inline-block;padding:4px 8px;border:1px solid var(--line);border-radius:999px;background:#fff;color:#6b6a77;font-size:.88em}
.meta{display:flex;gap:8px;flex-wrap:wrap}
.sticky{position:sticky;top:0;z-index:10;margin:-6px -14px 12px;padding:8px 14px;background:rgba(255,255,255,.8);backdrop-filter:blur(6px) saturate(1.05);border-bottom:1px solid #e9edf7;display:flex;align-items:center;gap:10px}
.progress{height:8px;background:#edf2fb;border-radius:999px;flex:1;overflow:hidden}
.progress>span{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent2))}
.btn{padding:10px 14px;border:1px solid var(--line);border-radius:12px;background:#fff;cursor:pointer}
.btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));border-color:transparent;color:#fff;font-weight:700}
fieldset.q{border:1px solid var(--line);border-radius:12px;padding:10px;margin:10px 0;background:#fff}
legend{font-weight:700}
.scale{display:grid;grid-template-columns:repeat(5,minmax(66px,1fr));gap:8px;margin-top:8px}
.scale input{position:absolute;opacity:0;pointer-events:none}
.scale label{display:grid;place-items:center;border:1px solid #e5e9f3;border-radius:10px;padding:8px;cursor:pointer;user-select:none;background:#fff}
.scale input:checked+label{outline:2px solid var(--accent);border-color:transparent}
mark.need{animation:need 1.6s ease}
@keyframes need{0%{box-shadow:0 0 0 0 rgba(74,168,255,.45)}100%{box-shadow:0 0 0 0 rgba(74,168,255,0)}}
.result-head{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;font-weight:700}
.total{font-size:26px;font-weight:800}
.small{color:var(--muted);font-size:.92em}
.hero-vert{display:grid;place-items:center;border:1px solid var(--line);border-radius:16px;background:#fff;overflow:hidden}
.hero-vert figure{margin:0;width:min(600px,100%);max-width:100%;aspect-ratio:3/4;border-bottom:1px solid var(--line);background:#f7f9ff}
.hero-vert img{width:100%;height:100%;object-fit:cover;display:block}
.hero-vert figcaption{padding:10px;width:100%}
.hero-vert .capline{font-weight:800;line-height:1.55;overflow-wrap:anywhere;word-break:break-word;white-space:normal}
.hero-vert .poem{font-style:italic;letter-spacing:.02em;margin-top:4px;color:#445;opacity:.9}
.hero-vert .capmini{font-size:1em;line-height:1.85;color:var(--muted);overflow-wrap:anywhere;word-break:break-word;white-space:normal}
.grid2{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px}
.stat{border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff}
.stat .big{font-size:22px;font-weight:800}
.hr{height:1px;background:var(--line);margin:10px 0}
.klist{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
.kpill{border:1px solid var(--line);border-radius:999px;padding:6px 10px;background:#fff;font-size:.9em}
.bar{border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff}
.bar .row{height:10px;background:#edf2fb;border-radius:999px;overflow:hidden;margin-top:6px}
.bar .row>span{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent2))}
.footer{color:var(--muted);font-size:.92em}
.warn{background:#f8fbff;border:1px solid #e1ebf7;border-radius:12px;padding:10px;margin:12px 0}
.back-area{display:flex;justify-content:center;margin-top:10px}
a.back{display:inline-flex;align-items:center;gap:6px;padding:10px 14px;border:1px solid var(--line);border-radius:12px;background:#fff;text-decoration:none}
.badge-size{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;background:#fff;border:1px solid var(--line);font-size:.85em;margin-left:6px}
.title-row{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.tags{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
.tag{padding:3px 8px;border:1px solid var(--line);border-radius:999px;background:#fff;font-size:.84em}
.title-emoji{font-size:22px}
.factor-mini{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px}
.guard{display:flex;align-items:center;gap:8px;border:1px solid var(--line);border-radius:12px;background:#fff;padding:8px 10px}
.guard .g-emo{font-size:18px}
@media (max-width: 560px){
  .wrap{padding:0 10px}
  .sticky{top:calc(env(safe-area-inset-top) + 0px); padding:8px 10px}
  .scale{grid-template-columns:repeat(2,1fr)}
  .scale label{padding:12px 8px;font-size:14px}
  .hero-vert figure{width:100%}
  .grid2{grid-template-columns:1fr}
  .badge-size{font-size:.8em}
  .card{padding:12px}
  .hero-vert .capline{font-size:clamp(16px,5.2vw,20px);line-height:1.65}
  .hero-vert .capmini{font-size:clamp(14px,4.6vw,16px);line-height:1.95}
}
.note{border:1px solid var(--line);border-radius:12px;background:#fff;padding:10px}
.note h4{margin:0 0 6px;font-size:16px}
.note .mini{display:inline-block;margin-left:6px;font-size:.82em;color:#6b6a77}
.note p{margin:6px 0;line-height:1.75}
@media (max-width:560px){
  .note h4{font-size:15px}
}
</style>
</head>
<body data-id="neurotic">
<main class="wrap" id="app">
  <header class="hd">
    <div class="logo">🌊</div>
    <div>
      <h1>神経症的傾向・クトゥルフ神話診断</h1>
      <p class="sub">6下位因子×各3問＝18問（0〜4の5件法）。総合ランク（神）と因子別バー、守護バッジ、研究メモを表示します。※独自項目のエンタメ自己理解用。</p>
    </div>
  </header>

  <div class="sticky" aria-live="polite">
    <span>📊</span>
    <div class="progress" aria-label="回答進捗"><span id="prog"></span></div>
    <button class="btn primary" id="doScore">診断する</button>
  </div>

  <section class="card section" id="desc">
    <h2 style="margin:4px 0 8px">説明</h2>
    <div class="meta" style="margin-bottom:8px">
      <span class="pill">質問数：18</span>
      <span class="pill">形式：0–4（0=まったくない / 4=とても）</span>
      <span class="pill">総合：0–4（6因子平均）</span>
    </div>
    <p class="small">ここでの「神経症的傾向」は、<strong>日常の揺れやすさ</strong>の平均的な傾向をそっと可視化するものです。医療目的ではありません。</p>
  </section>

  <!-- 設問 -->
  <section class="card section" id="questions">
    <h2 style="margin:4px 0 8px">設問（0=まったくない／1=あまりない／2=半々／3=だいたい／4=とても）</h2>
    <div id="qWrap"></div>
    <div class="tags">
      <span class="tag">下位因子：不安／易怒／ふさぎ込み／自意識／衝動／脆さ</span>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
      <button class="btn" id="clearAns">回答をクリア</button>
      <button class="btn primary" id="doScore2">診断する</button>
    </div>
  </section>

  <!-- 結果 -->
  <section class="card section" id="result" aria-live="polite">
    <div id="resEmpty">
      <span class="badge">まだ結果はありません</span>
      <p class="small">全18問に回答して「診断する」を押してください。</p>
    </div>

    <div id="resArea" style="display:none">
      <div class="result-head">
        <span class="badge">結果</span>
        <div class="total" id="typeLine">—</div>
      </div>

      <!-- ヒーロー（3:4大きく） -->
      <div class="hero-vert section" role="region" aria-label="ランクのイメージ">
        <figure>
          <img id="heroImg" src="/shindan/assets/results/neurotic/01.png" alt="月光の入り江に浮かぶ小舟" loading="lazy" width="600" height="800">
        </figure>
        <figcaption>
          <div class="title-row">
            <div class="capline" id="heroTitle">—</div>
            <span class="badge-size" id="sizeBadge" aria-label="総合平均">—</span>
          </div>
          <div class="poem" id="heroPoem">—</div>
          <div class="capmini" id="heroCopy">—</div>
        </figcaption>
      </div>

      <!-- 数値 -->
      <div class="grid2">
        <article class="stat" aria-label="総合スコア">
          <div><strong>総合N（0–4）</strong></div>
          <div class="big"><span id="sumAvg">0.00</span> / 4.00</div>
          <div class="small" id="sumNote">—</div>
        </article>
        <article class="stat" aria-label="守護バッジ">
          <div><strong>守護（下位因子の相棒）</strong></div>
          <div class="factor-mini" id="guardArea"><!-- JS --></div>
        </article>
      </div>

      <div class="hr"></div>
      <!-- 因子バー -->
      <div class="section">
        <h3 style="margin:8px 0">因子別スコア</h3>
        <div id="bars" class="factor-mini"><!-- JS --></div>
      </div>

      <div class="hr"></div>
      <section class="section" id="factorNotesSec">
        <h3 style="margin:8px 0">因子ごとの説明</h3>
        <div id="factorNotes" class="factor-mini"><!-- JS --></div>
      </section>

      <div class="hr"></div>
      <div id="longCopy" class="small"><!-- JS 長文コメント --></div>

      <div class="hr"></div>
      <!-- 研究メモ（外向性と同じスタイル：常に開いたdetails） -->
      <details class="section" open>
        <summary><strong>研究メモ</strong></summary>
        <ul class="small" id="resMemo" style="margin:6px 0 0 18px;line-height:1.8"><!-- JS --></ul>
        <p class="small" style="margin-top:6px">※ここでの数値は<strong>平均的な傾向</strong>の目安です。相関が中心で、因果は断定できません。個人差が大きい点をご理解ください。</p>
      </details>

      <div class="hr"></div>
      <!-- 独自設問の明記 -->
      <p class="small"><strong>独自設問について：</strong>本診断は<strong>ビッグファイブ理論を参考にした独自の設問</strong>で構成されています。<strong>NEO-PI(-R)、BFI/BFI-2、TIPI</strong>等の標準化検査とは同一でも互換でもありません。研究・臨床評価を目的とせず、<strong>エンタメ／自己理解</strong>の補助を意図しています。</p>

      <div class="back-area" style="margin-top:12px">
        <a class="back" href="/shindan/" id="backLink" aria-label="診断一覧に戻る">診断一覧に戻る</a>
      </div>
    </div>
  </section>

  <section class="footer card">
    <h2 style="margin:4px 0 8px">ご利用にあたって</h2>
    <p class="warn"><strong>注意：</strong>このコンテンツは<b>エンタメ用のセルフチェック</b>です。医療・診断・治療・カウンセリング等の目的ではありません。結果の解釈・利用はご自身の判断と責任にてお願いいたします。<br>
回答は端末内で処理・保存され、回答内容や個人を特定できる情報はサーバーに送信されません。結果表示時に匿名の件数カウントのみ送信する場合があります。<br>
神名・比喩は<b>文学的モチーフ</b>です（宗教的意図はありません）。</p>
  </section>
</main>

<script>
(function(){
  // ====== ページ情報 ======
  var SLUG = "neurotic";
  var TITLE = "神経症的傾向・クトゥルフ神話診断";
  var IMG_BASE = "/shindan/assets/results/neurotic/"; // 末尾/
  var ANS_KEY = "specimens:"+SLUG+":answers"; // 回答保存キー

  // ====== ランク定義（総合平均0–4） ======
  var LV = [
    {id:1, name:"ノーデンス",       label:"Lv1", min:0.00, max:0.79, img:"01.png", alt:"月光の入り江に浮かぶ小舟",
     poem:"潮は静まり、星は揺れを映さない。", 
     copy:"落ち着きが強い帯。揺れても整える手順で戻せます。朝に「今日の3手」、夜は良かったことを1行書くと道筋がはっきりします。"},
    {id:2, name:"ヨグ＝ソトース",   label:"Lv2", min:0.80, max:1.59, img:"02.png", alt:"星々が輪になった門",
     poem:"門は開きつつあり、境界はまだ守られている。", 
     copy:"境界の管理が上手。負荷が上がると崩れやすいので、通知・音・人混みなど刺激を時間でON/OFFすると安定しやすくなります。"},
    {id:3, name:"ニャルラトテップ", label:"Lv3", min:1.60, max:2.39, img:"03.png", alt:"仮面と遠い街灯り",
     poem:"仮面の内側に波が立ち、運転次第で行き先が変わる。", 
     copy:"波はあるが回せる帯。「不安→対処を1行」で区切りをつけるクセが効きます。まず1つ小タスクを完了させて流れを作りましょう。"},
    {id:4, name:"クトゥルフ",       label:"Lv4", min:2.40, max:3.19, img:"04.png", alt:"波間に沈む古い都市の影",
     poem:"海はざわめき、夢は予定を侵食する。", 
     copy:"揺れが強く、予定に食い込みやすい帯。3分だけ動く→終わりを区切る小タスクが助走になります。人に頼る一言を用意しておくのも鍵。"},
    {id:5, name:"アザトース",       label:"Lv5", min:3.20, max:4.00, img:"05.png", alt:"渦巻く星雲と散る譜面",
     poem:"渦の中心では、まず足場を固めよ。", 
     copy:"まず足場（睡眠・食事・歩く）を固定。寝る90分前の光・カフェインOFF、10分だけ歩く、無理な所は早めに頼る——小さな安定を積み上げましょう。"}
  ];

  // ====== 下位因子と守護 ======
  // key: {name, guard, catch, icon, items:[q indices 1..18]}
  var FACTORS = {
    ANX: {name:"不安",       guard:"ナイトゴーント",  catch:"兆しから最悪を想像",        icon:"🌫️", items:[1,2,3]},
    ANG: {name:"易怒",       guard:"狂信者",          catch:"怒りが言葉に出やすい",      icon:"🔥", items:[4,5,6]},
    DEP: {name:"ふさぎ込み", guard:"廃都の探索者",    catch:"失敗を長く背負いがち",      icon:"🏚️", items:[7,8,9]},
    SCS: {name:"自意識",     guard:"仮面の演者",      catch:"視線が気になりやすい",      icon:"🎭", items:[10,11,12]},
    IMP: {name:"衝動",       guard:"禁書蒐集家",      catch:"勢いで動きやすい",          icon:"📚", items:[13,14,15]},
    VUL: {name:"脆さ",       guard:"極地探検隊",      catch:"予想外に弱くなる",          icon:"🧭", items:[16,17,18]}
  };

  // ====== 因子説明テキスト（やさしい語彙） ======
  var FACTOR_DESC = {
    ANX: {
      title:"不安（守護：ナイトゴーント）",
      body:"小さな兆しから“最悪パターン”を早めに想像する力。危険検知の鋭さは安全運転に役立ちます。",
      use :"不安→対処を名詞で1行（例：『騒音→耳栓』）。チェックリスト化すると安心。",
      care:"想像と現実を分けるために、深呼吸3回＋現状確認のルーティンを。"
    },
    ANG: {
      title:"易怒（守護：狂信者）",
      body:"正しさへの感度が高く、ズレに反応しやすい面。熱量は推進力にもなります。",
      use :"一言クッション（『まず受け取ったよ』）→要点2つだけ伝える。",
      care:"眠気・空腹・騒音の三点を先に整えると棘が減りやすい。"
    },
    DEP: {
      title:"ふさぎ込み（守護：廃都の探索者）",
      body:"うまくいかなかった点に長く目が向く傾向。だからこそ改善の芽も拾えます。",
      use :"よかった点→改善点の順で2行だけ記録。翌日に回す。",
      care:"朝の光・散歩5分・人に一言頼る、のどれか一つから。"
    },
    SCS: {
      title:"自意識（守護：仮面の演者）",
      body:"他者の視線を細かく察知する力。空気読みやリスク回避に効きます。",
      use :"“失敗してもOK”の合図を先に置く（例：『途中で止めて』）。",
      care:"手の震えなど体感が強い日は、話す前に深い呼吸でペースづくり。"
    },
    IMP: {
      title:"衝動（守護：禁書蒐集家）",
      body:"勢いで動けるスタートダッシュ。創造や突破に役立ちます。",
      use :"買い物・返信・発言は『一晩寝かす』ボタンを作る。",
      care:"通知オフ・間食の置き換えなど、先回りの仕組みで守る。"
    },
    VUL: {
      title:"脆さ（守護：極地探検隊）",
      body:"複数ストレスで一気に疲れやすい面。助けを呼ぶセンサーを先に用意すると強くなれます。",
      use :"『困ったら合図』をチームで決める／優先度3つに並べ替え。",
      care:"睡眠・水分・休憩を“固定タスク”に。助けを求めるのはOK。"
    }
  };

  // ====== 設問（18問・正採点） ======
  var ITEMS = [
    // 不安
    {id:1,  text:"小さな兆しから最悪パターンを想像してしまう。"},
    {id:2,  text:"予定の変更で動揺が長く残る。"},
    {id:3,  text:"体の違和感があると病気を強く心配する。"},
    // 易怒
    {id:4,  text:"待たされるとイラッとして態度に出る。"},
    {id:5,  text:"反論されるとトゲのある言い方になりやすい。"},
    {id:6,  text:"怒りが収まるまでが長い。"},
    // ふさぎ込み
    {id:7,  text:"褒められても心から受け取りづらい。"},
    {id:8,  text:"失敗を長く引きずる。"},
    {id:9,  text:"朝、起きる前から気が重い日が多い。"},
    // 自意識
    {id:10, text:"人前で話すとき、顔や手の震えが気になる。"},
    {id:11, text:"その場の空気に“浮いてないか”を過剰に気にする。"},
    {id:12, text:"失言がないか何度も思い返す。"},
    // 衝動
    {id:13, text:"感情の勢いで買い物／返信／発言をして後悔する。"},
    {id:14, text:"ストレス時に食べ過ぎ・夜更かしが増える。"},
    {id:15, text:"一旦ムッとすると止めにくい。"},
    // 脆さ
    {id:16, text:"予想外が続くと頭が真っ白になりやすい。"},
    {id:17, text:"締切や騒音など複数ストレスでパンクしやすい。"},
    {id:18, text:"困ったら助けを求めるのが遅れがち。"}
  ];

  var LABELS = ["まったくない","あまりない","半々","だいたい","とても"];

  // ====== 要素参照 ======
  var qWrap   = document.getElementById("qWrap");
  var prog    = document.getElementById("prog");
  var resEmpty= document.getElementById("resEmpty");
  var resArea = document.getElementById("resArea");
  var typeLine= document.getElementById("typeLine");
  var heroImg = document.getElementById("heroImg");
  var heroTitle= document.getElementById("heroTitle");
  var heroPoem = document.getElementById("heroPoem");
  var heroCopy = document.getElementById("heroCopy");
  var sizeBadgeEl= document.getElementById("sizeBadge");
  var sumAvg  = document.getElementById("sumAvg");
  var sumNote = document.getElementById("sumNote");
  var guardArea = document.getElementById("guardArea");
  var bars    = document.getElementById("bars");
  var longCopy= document.getElementById("longCopy");
  var resMemo = document.getElementById("resMemo");

  // ====== ユーティリティ＋保存 ======
  function band(pct){ return pct>=70?"good":(pct>=40?"mid":"low"); }
  function bandLabel(pct){ return pct>=70?"高":(pct>=40?"中":"低"); }

  function saveAnswers(){
    try{
      var out = {};
      for(var i=0;i<ITEMS.length;i++){
        var id = ITEMS[i].id;
        var chk = qWrap.querySelector('#fs-'+id+' input[type="radio"]:checked');
        if(chk){ out[id] = parseInt(chk.value,10); }
      }
      localStorage.setItem(ANS_KEY, JSON.stringify({ts:Date.now(), ans:out}));
    }catch(e){}
  }
  function restoreAnswers(){
    try{
      var raw = localStorage.getItem(ANS_KEY);
      if(!raw) return;
      var data = JSON.parse(raw);
      var ans = (data && data.ans) || {};
      Object.keys(ans).forEach(function(id){
        var v = ans[id];
        var input = qWrap.querySelector('#q'+id+'-'+v);
        if(input){ input.checked = true; }
      });
      if (typeof updateProgress === "function") updateProgress();
    }catch(e){}
  }
  function wipeAnswers(){
    try{ localStorage.removeItem(ANS_KEY); }catch(e){}
  }

  // ====== 設問生成（番号はUIに出さない） ======
  function buildQuestions(){
    var html = "";
    for(var i=0;i<ITEMS.length;i++){
      var q = ITEMS[i];
      html += '<fieldset class="q" id="fs-'+q.id+'">'+
        '<legend>'+q.text+'</legend>'+
        '<div class="scale" role="radiogroup" aria-label="'+q.text+'">';
      for(var v=0;v<=4;v++){
        html += '<div style="position:relative">'+
          '<input id="q'+q.id+'-'+v+'" type="radio" name="q'+q.id+'" value="'+v+'">'+
          '<label for="q'+q.id+'-'+v+'" title="'+LABELS[v]+'">'+LABELS[v]+'</label>'+
        '</div>';
      }
      html += '</div></fieldset>';
    }
    qWrap.innerHTML = html;

    var radios = qWrap.querySelectorAll('input[type="radio"]');
    for(var r=0;r<radios.length;r++){
      radios[r].addEventListener('change', function(){
        saveAnswers();
        updateProgress();
      }, false);
    }
    restoreAnswers();
  }

  function updateProgress(){
    var total = ITEMS.length;
    var answered = qWrap.querySelectorAll('input[type="radio"]:checked').length;
    prog.style.width = Math.round(100*answered/total) + "%";
  }

  // ====== スコア計算 ======
  function score(){
    var missing = [];
    var ans = {};
    for(var i=0;i<ITEMS.length;i++){
      var id = ITEMS[i].id;
      var chk = qWrap.querySelector('#fs-'+id+' input[type="radio"]:checked');
      if(!chk){ missing.push(id); continue; }
      ans[id] = parseInt(chk.value,10);
    }
    if(missing.length){
      alert("未回答があります。全18問にお答えください。");
      var fs = document.getElementById('fs-'+missing[0]);
      if(fs){ fs.scrollIntoView({behavior:"smooth", block:"center"}); fs.classList.add("need"); setTimeout(function(){ fs.classList.remove("need"); },1600); }
      return;
    }

    // 因子ごとの平均(0-4)と%に換算
    var fScore = {};
    Object.keys(FACTORS).forEach(function(key){
      var ids = FACTORS[key].items;
      var sum = ids.reduce(function(s,id){ return s + (ans[id]||0); },0);
      var avg = sum / ids.length; // 0-4
      var pct = Math.round((avg/4)*100);
      fScore[key] = {sum:sum, avg:avg, pct:pct};
    });
    // 総合平均（6因子平均）
    var avgTotal = Object.values(fScore).reduce(function(s,o){ return s+o.avg; },0) / 6;
    avgTotal = Math.round(avgTotal*100)/100; // 小数2桁

    render({avg:avgTotal, fScore:fScore, ans:ans});
  }

  function rankOf(avg){
    for(var i=0;i<LV.length;i++){
      var d = LV[i];
      if(avg>=d.min && avg<=d.max) return d;
    }
    return LV[2];
  }

  function render(o){
    var rank = rankOf(o.avg);

    // ヒーロー
    heroImg.src = IMG_BASE + rank.img;
    heroImg.alt = rank.alt;
    heroTitle.textContent = "あなたのランク："+rank.name+"（"+rank.label+"）";
    heroPoem.textContent  = rank.poem;
    heroCopy.textContent  = rank.copy;
    sizeBadgeEl.textContent = "総合平均 " + o.avg.toFixed(2) + " / 4.00";

    // 合計
    sumAvg.textContent = o.avg.toFixed(2);
    var note = "";
    if(o.avg<0.8) note="安定が強いレンジ。今の手順を続ければOK。";
    else if(o.avg<1.6) note="小さな揺れは管理可。刺激のON/OFFを時間で切替。";
    else if(o.avg<2.4) note="波はある帯。区切りの言葉と小タスクで回せます。";
    else if(o.avg<3.2) note="揺れが強め。3分だけ動く→保存、の手順が効きます。";
    else note="まず足場（睡眠・食事・歩く）を固定。無理な所は頼ってOK。";
    sumNote.textContent = note;

    // 守護バッジ
    var gHtml = "";
    Object.keys(FACTORS).forEach(function(key){
      var def = FACTORS[key];
      gHtml += '<div class="guard">'+
        '<div class="g-emo" aria-hidden="true">'+def.icon+'</div>'+
        '<div><div><strong>'+def.name+'</strong> <span class="small">（'+def.guard+'）</span></div>'+
        '<div class="small" style="opacity:.9">'+def.catch+'</div></div>'+
      '</div>';
    });
    guardArea.innerHTML = gHtml;

    // 因子バー
    var bHtml = "";
    Object.keys(FACTORS).forEach(function(key){
      var def = FACTORS[key], sc = o.fScore[key];
      bHtml += '<article class="bar" aria-label="'+def.name+'">'+
        '<div><strong>'+def.name+'</strong><span class="pill" style="margin-left:6px">'+sc.avg.toFixed(2)+' / 4</span>'+
        '<span class="band '+band(sc.pct)+'" style="margin-left:6px">'+bandLabel(sc.pct)+'</span></div>'+
        '<div class="row" aria-hidden="true"><span style="width:'+sc.pct+'%"></span></div>'+
        '<div class="small" style="margin-top:4px">'+sc.pct+' / 100</div>'+
        '</article>';
    });
    bars.innerHTML = bHtml;

    // 因子ごとの説明
    var notes = "";
    Object.keys(FACTORS).forEach(function(key){
      var def = FACTORS[key], sc = o.fScore[key], d = FACTOR_DESC[key];
      if(!d){ return; }
      notes += '<article class="note" aria-label="'+def.name+'の説明">'+
        '<h4>'+d.title+'<span class="mini">平均 '+sc.avg.toFixed(2)+' / 4｜'+sc.pct+'%</span></h4>'+
        '<p>'+d.body+'</p>'+
        '<p><strong>活かし方：</strong>'+d.use+'</p>'+
        '<p><strong>ケア：</strong>'+d.care+'</p>'+
      '</article>';
    });
    var fn = document.getElementById("factorNotes");
    if(fn){ fn.innerHTML = notes; }

    // 長文コメント（ランク本文そのまま）
    longCopy.textContent = rank.copy;

// 研究メモ（拡張・“ぼかし”で誠実に）
var memo = [
  "▼高めで報告されやすい関連（相関中心／平均差は小さめ）",
  "・ネガティブ感情（不安・怒り・落ち込み）が起こりやすい関連がいくつか。",
  "・ストレス反応や反すう（考え続ける）が増えやすいという観察がある。",
  "・睡眠の質のゆらぎや体調不良の自覚がやや増える関連が見られることがある。",
  "・対人場面での評価懸念（自意識の高まり）と結びつく報告がある（状況依存）。",
  "・危険検知／リスク回避の感度が高いという指摘もある（扱い方次第）。",

  "▼低めの強みとして語られること",
  "・情緒の安定・回復の早さと関連する報告がいくつか。",
  "・プレッシャー下でもパフォーマンスの波が小さめに保ちやすい、という示唆。",
  "・困難や計画変更の際に柔軟に戻れる“リセット力”が語られることがある。",

  "▼トレードオフ（起こりうる傾向）",
  "・高め：最悪ケースの想像で行動が遅れやすい／自己批判が強く疲れやすい。",
  "・高め：怒りや焦りが言葉に乗りやすい（睡眠・空腹・雑音の影響大）。",
  "・低め：危険サインの見落としや楽観バイアスに注意（確認の仕組みで補う）。",

  "▼運用ヒント（実装アイデア）",
  "・刺激のON/OFF：通知・音・人混みを時間で切替（深い作業はサイレント枠）。",
  "・区切り語：『不安→対処を一行』『今日はここまで』で切り替えを可視化。",
  "・小さな助走：3分だけ動く→小タスク完了→勢いで次へ、の手順を固定。",
  "・体調の土台：睡眠・食事・歩く10分を“固定タスク”化（週2で点検）。",
  "・頼る一言：『ここは助けて』の定型文を準備／合図をチームで決める。",

  "▼測定・解釈の注意",
  "・自己申告ゆえにムードや自己呈示の影響を受けます。体調の良い時に受検を。",
  "・文化・言語差で項目の解釈が揺れます。国際比較は厳密にはできません。",
  "・ここでの記述は一般論。相関中心で因果は断定できず、個人差は大きいです。",
  "・気分の不調が長引く／日常に支障がある場合は、専門家への相談を検討。"
];
    resMemo.innerHTML = memo.map(function(s){ return "<li>"+s+"</li>"; }).join("");

    // 表示切替
    resEmpty.style.display = "none";
    resArea.style.display = "block";
    document.getElementById("result").scrollIntoView({behavior:"smooth", block:"start"});

    // 保存（一覧の「つづきから再開」）
    try{
      document.dispatchEvent(new Event('result:ready'));
      localStorage.setItem("specimens:last", JSON.stringify({ id: SLUG, title: TITLE, href: location.pathname }));
    }catch(e){}
  }

  function clearAnswers(){
    var radios = qWrap.querySelectorAll('input[type="radio"]');
    for(var i=0;i<radios.length;i++){ radios[i].checked=false; }
    wipeAnswers();
    prog.style.width = "0%";
    resEmpty.style.display = "";
    resArea.style.display = "none";
    var app = document.getElementById("app");
    if(app){ app.scrollIntoView({behavior:"smooth", block:"start"}); }
  }

  // ====== 初期化 ======
  if(document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", function(){ buildQuestions(); });
  }else{
    buildQuestions();
  }
  document.getElementById("doScore").addEventListener("click", score, false);
  document.getElementById("doScore2").addEventListener("click", score, false);
  document.getElementById("clearAns").addEventListener("click", clearAnswers, false);
  var back = document.getElementById("backLink");
  if(back){
    back.addEventListener("click", function(){
      try{
        document.dispatchEvent(new Event('result:ready'));
      localStorage.setItem("specimens:last", JSON.stringify({ id: SLUG, title: TITLE, href: location.pathname }));
      }catch(e){}
    }, false);
  }
})();
</script>
<script>
/* こころLv/済カウント（結果描画の合図で一度だけ） */
(function(){
  'use strict';
  var DONE_KEY    = 'specimens:open:byid';         // 済マップ
  var TOTAL_KEY   = 'specimens:open:total';        // あなたのこころLv（合計）
  var GLOBAL_LAST = 'specimens:open:global:last';  // 一覧の初期表示キャッシュ
  var MY_ID = (document.body && document.body.getAttribute('data-id')) || 'unknown';

  // みんなのLv（CountAPI）
  var COUNTAPI_NS  = 'haisuikounozarigani_shindan';
  var COUNTAPI_KEY = 'specimens_open_total';
  function hitEveryone(){
    var url = 'https://api.countapi.xyz/hit/'+COUNTAPI_NS+'/'+COUNTAPI_KEY;
    if(navigator.sendBeacon){ try{ navigator.sendBeacon(url); }catch(_){ } }
    else{ fetch(url, {mode:'cors', cache:'no-store', keepalive:true}).catch(function(){}); }
  }

  var marked = false;
  function markOnce(){
    if(marked) return; marked = true;
    try{
      // あなたのこころLv +1
      localStorage.setItem(TOTAL_KEY, String((+localStorage.getItem(TOTAL_KEY) || 0) + 1));
      // 済 +1（他タブ即時反映用_ts）
      var map={}; try{ map = JSON.parse(localStorage.getItem(DONE_KEY) || '{}'); }catch(_){}
      map[MY_ID] = (map[MY_ID] || 0) + 1;
      localStorage.setItem(DONE_KEY, JSON.stringify(Object.assign({}, map, {_ts: Date.now()})));
      // みんなのLv +1 と見栄えキャッシュ +1
      hitEveryone();
      try{ localStorage.setItem(GLOBAL_LAST, String((+localStorage.getItem(GLOBAL_LAST) || 0) + 1)); }catch(_){}
    }catch(_){}
  }

  document.addEventListener('result:ready', markOnce);
  setTimeout(markOnce, 2000); // フォールバック
})();
</script>
</body>
</html>