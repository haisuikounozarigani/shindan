<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>認知プロフィール診断（画像なし・サイト完結）</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
:root{--brand:#b86b77;--bg:#fffaf6;--card:#fff;--muted:#666;--bar:#f5e8eb;--fill:#b86b77}
*{box-sizing:border-box}
body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;background:var(--bg);color:#333;margin:0;padding:20px}
h1{text-align:center;color:var(--brand);margin:0 0 8px}
.lead{text-align:center;margin:0 0 16px;color:#777}
.wrap{max-width:980px;margin:0 auto}
.card{background:var(--card);border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.06);padding:16px;margin:12px 0}
.sec-title{display:flex;gap:8px;align-items:center;margin:0 0 10px}
.badge{display:inline-block;background:#fde9ee;color:var(--brand);padding:4px 10px;border-radius:999px;font-size:12px}
.q{margin:12px 0}
.q p{margin:0 0 8px;font-weight:600}
.opt{display:block;background:#f4f4f4;border:1px solid transparent;border-radius:10px;padding:10px;margin:6px 0;cursor:pointer}
.opt input{margin-right:8px}
.opt.on{background:#fff6f8;border-color:#e6c6ce}
.row{display:flex;gap:10px;flex-wrap:wrap}
.btn{background:var(--brand);color:#fff;border:none;border-radius:10px;padding:10px 14px;font-size:16px;cursor:pointer}
.btn.ghost{background:#eee;color:#333}
.small{font-size:12px;color:#777}
.grid{display:grid;gap:8px}
.kbd{display:inline-block;border:1px solid #ddd;border-bottom-width:2px;border-radius:6px;padding:4px 8px;background:#fff}
.center{text-align:center}
.bar{height:12px;background:var(--bar);border-radius:999px;overflow:hidden}
.fill{height:100%;width:0;background:var(--fill);transition:width .5s ease}
.result-head{display:flex;justify-content:space-between;align-items:center;margin:0 0 10px}
.pill{background:#fdf1f3;color:#7b3f4a;border:1px solid #e3c5cc;border-radius:999px;padding:6px 10px}
.score-row{display:grid;grid-template-columns:130px 1fr 56px;gap:10px;align-items:center;margin:8px 0}
.note{font-size:13px;color:#555;background:#fff7e6;border-left:6px solid #ffbf66;border-radius:8px;padding:10px;margin-top:12px}
.links{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:10px}
@media (max-width:640px){
  .score-row{grid-template-columns:1fr}
}
</style>
</head>
<body>
<div class="wrap">
  <h1>🧠 認知プロフィール診断（ミニ）</h1>
  <p class="lead">画像なし・サイト完結。5領域（推理/言語/空間/作動記憶/処理速度）をサクッと推定します。</p>

  <!-- 1. パターン推理 -->
  <section class="card" id="sec-pattern">
    <div class="sec-title"><span class="badge">1｜パターン推理</span><strong>数列や法則性を見抜く</strong></div>
    <div id="patternQs" class="grid"></div>
  </section>

  <!-- 2. 言語 -->
  <section class="card" id="sec-verbal">
    <div class="sec-title"><span class="badge">2｜言語</span><strong>語彙・論理・類比</strong></div>
    <div id="verbalQs" class="grid"></div>
  </section>

  <!-- 3. 空間（矢印回転・向き） -->
  <section class="card" id="sec-spatial">
    <div class="sec-title"><span class="badge">3｜空間</span><strong>向き/回転の頭内操作（矢印）</strong></div>
    <div id="spatialQs" class="grid"></div>
  </section>

  <!-- 4. 作動記憶（短時間の保持と操作） -->
  <section class="card" id="sec-memory">
    <div class="sec-title"><span class="badge">4｜作動記憶</span><strong>短時間の保持と並べ替え</strong></div>
    <div class="q">
      <p>4-1. <strong>数字の順唱</strong>（3秒ずつ表示 → そのまま入力）</p>
      <div class="row">
        <button class="btn" type="button" id="memShowDigits">表示開始</button>
        <div id="memDigitsNow" class="kbd" aria-live="polite">——</div>
      </div>
      <div class="row" style="margin-top:8px">
        <input id="memDigitsAns" class="kbd" inputmode="numeric" placeholder="表示順に入力" />
        <button class="btn ghost" type="button" id="memDigitsCheck">チェック</button>
        <span class="small" id="memDigitsMsg"></span>
      </div>
    </div>
    <div class="q">
      <p>4-2. <strong>文字の逆唱</strong>（一度だけ表示 → 逆順で入力）</p>
      <div class="row">
        <button class="btn" type="button" id="memShowLetters">表示</button>
        <div id="memLettersNow" class="kbd" aria-live="polite">——</div>
      </div>
      <div class="row" style="margin-top:8px">
        <input id="memLettersAns" class="kbd" placeholder="逆順で入力（例 ABC → CBA）" />
        <button class="btn ghost" type="button" id="memLettersCheck">チェック</button>
        <span class="small" id="memLettersMsg"></span>
      </div>
    </div>
  </section>

  <!-- 5. 処理速度（記号探索：反応時間を測定） -->
  <section class="card" id="sec-speed">
    <div class="sec-title"><span class="badge">5｜処理速度</span><strong>ターゲットが含まれる？（Yes/No 反応）</strong></div>
    <div class="q">
      <p>5-1. 文字列に <span class="kbd" id="spdT1">??</span> は <strong>含まれる？</strong></p>
      <div class="kbd" id="spdS1" style="display:inline-block;min-width:260px">（開始で表示）</div>
      <div class="row" style="margin-top:8px">
        <button class="btn" type="button" id="spdStart1">開始</button>
        <button class="btn ghost" type="button" id="spdYes1" disabled>Yes</button>
        <button class="btn ghost" type="button" id="spdNo1"  disabled>No</button>
        <span class="small" id="spdMsg1"></span>
      </div>
    </div>
    <div class="q">
      <p>5-2. 文字列に <span class="kbd" id="spdT2">??</span> は <strong>含まれる？</strong></p>
      <div class="kbd" id="spdS2" style="display:inline-block;min-width:260px">（開始で表示）</div>
      <div class="row" style="margin-top:8px">
        <button class="btn" type="button" id="spdStart2">開始</button>
        <button class="btn ghost" type="button" id="spdYes2" disabled>Yes</button>
        <button class="btn ghost" type="button" id="spdNo2"  disabled>No</button>
        <span class="small" id="spdMsg2"></span>
      </div>
    </div>
    <p class="small">※ 反応が速く正確なほどスコアが上がります（300〜3000msでスケール）。</p>
  </section>

  <!-- 実行＆結果 -->
  <section class="card">
    <div class="row" style="justify-content:center">
      <button class="btn" id="calcBtn" type="button">集計する</button>
      <a class="btn ghost" href="/shindan/">診断一覧へ戻る</a>
    </div>
  </section>

  <section id="result" class="card" style="display:none">
    <div class="result-head">
      <h2 style="margin:0;color:#7b3f4a">結果｜認知プロファイル</h2>
      <span id="topType" class="pill">—</span>
    </div>
    <div id="scores"></div>
    <div class="note">この診断は自己理解/娯楽向けの簡易推定です。医療・選抜目的では使用しないでください。</div>
  </section>

</div>

<script>
/* ---------- 1) パターン推理（3問） ---------- */
const patternQs = [
  {q:"2, 4, 7, 11, ？", opts:["15","16","17","18"], a:1}, // +2 +3 +4 +5 → 16
  {q:"3, 6, 12, 24, ？", opts:["36","48","54","60"], a:1}, // ×2 → 48
  {q:"1, 1, 2, 3, 5, ？", opts:["6","7","8","9"], a:2},    // Fibonacci → 8
];

/* ---------- 2) 言語（3問） ---------- */
const verbalQs = [
  {q:"「迅速」に最も近いもの", opts:["おだやか","すばやい","堅実","詳細"], a:1},
  {q:"「抽象的」の反対語",     opts:["複雑","具体的","精巧","特殊"], a:1},
  {q:"猫：子猫 ＝ 犬：？",      opts:["子犬","猟犬","番犬","子鹿"], a:0},
];

/* ---------- 3) 空間（矢印の回転/向き 3問） ---------- */
const spatialQs = [
  {q:"→ を90°反時計回りに回すと？", opts:["↑","↓","←","→"], a:0},
  {q:"↑ を180°回転すると？",        opts:["↑","→","↓","←"], a:2},
  {q:"↖ を90°時計回りに回すと？",   opts:["↙","↗","↘","↑"], a:1},
];

/* 生成（共通） */
function renderRadioBlock(containerId, list, namePrefix){
  const box = document.getElementById(containerId);
  list.forEach((it, i)=>{
    const wrap = document.createElement('div');
    wrap.className = 'q';
    const qname = `${namePrefix}${i}`;
    const opts = it.opts.map((txt, n)=>(
      `<label class="opt"><input type="radio" name="${qname}" value="${n}"> ${txt}</label>`
    )).join("");
    wrap.innerHTML = `<p>${i+1}. ${it.q}</p>${opts}`;
    box.appendChild(wrap);
  });
  // 選択の見た目ハイライト
  box.addEventListener('change', (e)=>{
    if(!e.target.name?.startsWith(namePrefix)) return;
    document.querySelectorAll(`input[name="${e.target.name}"]`).forEach(inp=>{
      inp.closest('.opt').classList.toggle('on', inp.checked);
    });
  });
}
renderRadioBlock('patternQs', patternQs, 'p');
renderRadioBlock('verbalQs',  verbalQs,  'v');
renderRadioBlock('spatialQs', spatialQs, 's');

/* ---------- 4) 作動記憶 ---------- */
const memDigitsSeq = (()=>{ // 5桁のランダム数字（重複あり）
  return Array.from({length:5},()=>Math.floor(Math.random()*10)).join('');
})();
const memLettersSeq = (()=>{ // 4文字ランダム（A～Z）
  const A=65; return Array.from({length:4},()=>String.fromCharCode(A+Math.floor(Math.random()*26))).join('');
})();
const memDigitsNow = document.getElementById('memDigitsNow');
const memLettersNow= document.getElementById('memLettersNow');
const memDigitsMsg = document.getElementById('memDigitsMsg');
const memLettersMsg= document.getElementById('memLettersMsg');

document.getElementById('memShowDigits').onclick = async()=>{
  memDigitsMsg.textContent="";
  memDigitsNow.textContent="準備…";
  await wait(300);
  memDigitsNow.textContent = memDigitsSeq[0]; await wait(700);
  memDigitsNow.textContent = memDigitsSeq[1]; await wait(700);
  memDigitsNow.textContent = memDigitsSeq[2]; await wait(700);
  memDigitsNow.textContent = memDigitsSeq[3]; await wait(700);
  memDigitsNow.textContent = memDigitsSeq[4]; await wait(700);
  memDigitsNow.textContent="— 隠しました —";
};
document.getElementById('memDigitsCheck').onclick = ()=>{
  const ans = (document.getElementById('memDigitsAns').value||"").replace(/\s/g,'');
  const correct = memDigitsSeq;
  const hit = scorePositional(ans, correct);
  memDigitsMsg.textContent = `一致：${hit}/${correct.length}`;
  memDigitsMsg.dataset.score = hit/correct.length; // 0..1
};

document.getElementById('memShowLetters').onclick = ()=>{
  memLettersMsg.textContent="";
  memLettersNow.textContent = memLettersSeq + "（3秒後に隠れます）";
  setTimeout(()=>{memLettersNow.textContent="— 隠しました —"}, 3000);
};
document.getElementById('memLettersCheck').onclick = ()=>{
  const ans = (document.getElementById('memLettersAns').value||"").replace(/\s/g,'').toUpperCase();
  const correct = [...memLettersSeq].reverse().join('');
  const hit = scorePositional(ans, correct);
  memLettersMsg.textContent = `一致：${hit}/${correct.length}`;
  memLettersMsg.dataset.score = hit/correct.length; // 0..1
};

function scorePositional(ans, correct){
  const L = Math.min(ans.length, correct.length);
  let c=0; for(let i=0;i<L;i++){ if(ans[i]===correct[i]) c++; }
  return c;
}
function wait(ms){ return new Promise(r=>setTimeout(r,ms)); }

/* ---------- 5) 処理速度（2トライアル） ---------- */
function makeSearchTrial(){
  const letters = "ABCDEFGHJKLMNPQRSTUVWXYZ"; // 見分けやすい
  const target = randPair(letters);
  const present = Math.random()<0.5;
  let line = "";
  for(let i=0;i<26;i++){
     const p = Math.random();
     if(present && i===Math.floor(Math.random()*26)) line += target;
     else line += randPair(letters);
     line += " ";
  }
  if(!present){ // 念のためターゲットを含まないように
    line = line.replaceAll(target, "ZZ");
  }
  return {target, line: line.trim(), present};
}
function randPair(pool){
  const a = pool[Math.floor(Math.random()*pool.length)];
  const b = pool[Math.floor(Math.random()*pool.length)];
  return a+b;
}
const speed = {
  t1: makeSearchTrial(), t2: makeSearchTrial(),
  startTime1:0, startTime2:0, rt1:null, rt2:null, ok1:null, ok2:null
};
document.getElementById('spdT1').textContent = speed.t1.target;
document.getElementById('spdT2').textContent = speed.t2.target;

function setupSpeedTrial(idx){
  const T = speed[`t${idx}`];
  const sEl = document.getElementById(`spdS${idx}`);
  const yes = document.getElementById(`spdYes${idx}`);
  const no  = document.getElementById(`spdNo${idx}`);
  const msg = document.getElementById(`spdMsg${idx}`);
  document.getElementById(`spdStart${idx}`).onclick = ()=>{
    msg.textContent=""; sEl.textContent=T.line;
    yes.disabled = no.disabled = false;
    speed[`startTime${idx}`] = performance.now();
  };
  yes.onclick = ()=> finish(true);
  no.onclick  = ()=> finish(false);
  function finish(ans){
    if(yes.disabled) return;
    const rt = performance.now() - speed[`startTime${idx}`];
    const ok = (ans===T.present);
    speed[`rt${idx}`] = rt; speed[`ok${idx}`] = ok;
    yes.disabled = no.disabled = true;
    msg.textContent = `${ok?"正解":"不正解"}｜${Math.round(rt)}ms`;
  }
}
setupSpeedTrial(1);
setupSpeedTrial(2);

/* ---------- 集計 ---------- */
document.getElementById('calcBtn').onclick = ()=>{
  // 1) pattern/verbal/spatial（正答率）
  const pctPattern = radioScore('p', patternQs);
  const pctVerbal  = radioScore('v', verbalQs);
  const pctSpatial = radioScore('s', spatialQs);

  // 2) memory（順唱・逆唱の平均 0..1 → 0..100）
  const mem1 = parseFloat(document.getElementById('memDigitsMsg').dataset.score||"0");
  const mem2 = parseFloat(document.getElementById('memLettersMsg').dataset.score||"0");
  const pctMemory = Math.round(((mem1+mem2)/2)*100);

  // 3) speed（正確さ×速度でスコア化）
  const pctSpeed = speedScore(speed.rt1, speed.ok1, speed.rt2, speed.ok2);

  const scores = {
    pattern:pctPattern, verbal:pctVerbal, spatial:pctSpatial,
    memory:pctMemory, speed:pctSpeed
  };
  showResults(scores);
};

function radioScore(prefix, list){
  let correct=0, answered=0;
  list.forEach((it,i)=>{
    const v = document.querySelector(`input[name="${prefix}${i}"]:checked`)?.value;
    if(v!==undefined){ answered++; if(parseInt(v,10)===it.a) correct++; }
  });
  if(answered<list.length){
    alert(`未回答の設問があります（${prefix==="p"?"パターン":prefix==="v"?"言語":"空間"}）。`);
    // 途中でも計算は継続しない
    throw new Error("unanswered");
  }
  return Math.round(correct/list.length*100);
}
function speedScore(rt1,ok1,rt2,ok2){
  // 未実施なら注意
  if(rt1==null || rt2==null){
    alert("処理速度の試行が未実施です（開始→Yes/No まで実行してください）。");
    throw new Error("speed not done");
  }
  // 300〜3000msを0〜100にスケール（遅いほど低得点）。誤答はその試行0点。
  const S = (rt,ok)=>{
    if(!ok) return 0;
    const min=300, max=3000, clamped=Math.min(Math.max(rt,min),max);
    return Math.round(100*(max-clamped)/(max-min));
  };
  return Math.round((S(rt1,ok1)+S(rt2,ok2))/2);
}

/* ---------- 結果描画 ---------- */
function showResults(scores){
  const labels = {
    pattern:"パターン推理", verbal:"言語", spatial:"空間",
    memory:"作動記憶", speed:"処理速度"
  };
  const tips = {
    pattern:"法則発見・抽象化が得意。道筋の言語化を加えると鉄壁に。",
    verbal:"語彙・説明・比喩理解が強み。要点→結論の順でさらに伝わる。",
    spatial:"回転・向き・配置の整理が速い。俯瞰→部分→再俯瞰でミス減。",
    memory:"保持しながらの更新が効く。短い塊に区切るとバテにくい。",
    speed:"初動の速さが武器。最後に“10秒停止→一括見直し”で精度UP。"
  };
  // トップ領域
  const topKey = Object.entries(scores).sort((a,b)=>b[1]-a[1])[0][0];
  document.getElementById('topType').textContent = `最も高い領域：${labels[topKey]}`;

  // バー
  const box = document.getElementById('scores');
  box.innerHTML = "";
  Object.keys(labels).forEach(k=>{
    const row = document.createElement('div');
    row.className = 'score-row';
    row.innerHTML = `
      <div><strong>${labels[k]}</strong></div>
      <div class="bar"><div class="fill" style="width:${scores[k]}%"></div></div>
      <div style="text-align:right">${scores[k]}%</div>
      <div class="small" style="grid-column:1 / -1">${tips[k]}</div>
    `;
    box.appendChild(row);
  });

  document.getElementById('result').style.display = 'block';
  window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'});
}
</script>
</body>
</html>
