<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>æ°´æ™¶ã®ãŠå‘Šã’è¨ºæ–­ï½œH/A/R/Mï¼ˆå¥åº·ãƒ»é‡å¿ƒ/ä»•äº‹ãƒ»é–¢ä¿‚ãƒ»ãŠé‡‘ï¼‰ã‚’ã‚„ã•ã—ãå½“ã¦ã‚‹</title>
<meta name="description" content="24å•Ã—5ä»¶æ³•ã€‚ä½“ã®ã‚µã‚¤ãƒ³/æœªæ¥ã¨ç· åˆ‡/ä»–äººã®ç›®ç·š/ãŠé‡‘ã¸ã®æ•æ„Ÿã•/è‡ªå·±æ‰¹è©•ã®å£°/å‹•ãå‡ºã—æŠµæŠ—ã®6å› å­ã‹ã‚‰ã€ã„ã¾ä¸€ç•ªå¼·ã„æ‚©ã¿ãŒHï¼ˆå¥åº·ï¼‰/Aï¼ˆé‡å¿ƒãƒ»ä»•äº‹ï¼‰/Rï¼ˆé–¢ä¿‚ï¼‰/Mï¼ˆãŠé‡‘ï¼‰ã®ã©ã‚Œã‹ã‚’ã‚„ã•ã—ãæ¨å®šã€‚åº¦åˆã„ãƒãƒ¼ï¼‹æ ¹æ‹ ãƒ¯ãƒ¼ãƒ‰ï¼‹ãƒŸãƒ‹ä¸€æ­©ã¤ãã€‚">
<meta name="theme-color" content="#2a1840">
<!-- OG -->
<meta property="og:type" content="website">
<meta property="og:title" content="æ°´æ™¶ã®ãŠå‘Šã’è¨ºæ–­">
<meta property="og:description" content="24å•Ã—5ä»¶æ³•ã§ã€H/A/R/Mï¼ˆå¥åº·ãƒ»é‡å¿ƒ/ä»•äº‹ãƒ»é–¢ä¿‚ãƒ»ãŠé‡‘ï¼‰ã®â€œä»Šã„ã¡ã°ã‚“é‡ã„â€ã‚’æ¨å®šã€‚">
<meta property="og:url" content="https://haisuikounozarigani.github.io/shindan/crystal-guess.html">
<meta property="og:image" content="https://haisuikounozarigani.github.io/shindan/assets/results/crystal-guess/t00.webp">
<style>
  :root{
    --bg:#f7f5fb; --paper:#fff; --ink:#221a2a; --muted:#6d6280; --line:#ece7f4;
    --accent:#8c6bff; --accent2:#ff8fc7; --witch:#2a1840;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Sans","Hiragino Kaku Gothic ProN","Yu Gothic",Meiryo,sans-serif}
  a{color:var(--witch);text-decoration:none}
  .wrap{max-width:980px;margin:0 auto;padding:16px}
  header.hd{position:relative;background:linear-gradient(160deg,#f5f0ff,#f0f4ff);border-bottom:1px solid var(--line)}
  header.hd .wrap{padding:20px 16px 10px}
  .ttl{font-weight:800;font-size:1.35rem;letter-spacing:.02em}
  .sub{color:var(--muted);font-size:.95rem}

  /* å›ºå®šé€²æ—ãƒãƒ¼ï¼ˆnohæº–æ‹ ï¼‰ */
  .progress-fixed{position:sticky;top:0;z-index:20;height:8px;background:var(--line)}
  .progress-bar{height:100%;border-radius:6px;background:var(--accent);transition:width .2s ease}

  figure.hero{margin:12px 0;border:1px solid var(--line);border-radius:16px;overflow:hidden;background:#fff}
  figure.hero img{display:block;width:100%;height:auto}

  .paper{background:var(--paper);border:1px solid var(--line);border-radius:16px;padding:16px;margin:14px 0}
  .qnum{font-weight:700;color:#3b2b54}
  .qtext{margin:.4rem 0 1rem}
  .opts{display:grid;grid-template-columns:1fr;gap:8px}
  .btn{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 14px;border:1px solid var(--line);border-radius:12px;background:#fff;cursor:pointer;transition:.12s}
  .btn[aria-pressed="true"]{outline:2px solid #ffdff2;background:#fff8fe}
  .btn:hover{transform:translateY(-1px)}
  .opt-note{color:#7f7196;font-size:.9rem}
  .ctrls{display:flex;gap:8px;margin-top:12px}
  .ctrls button{padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#faf7ff;cursor:pointer}
  .ctrls button.primary{background:var(--witch);color:#fff;border-color:#1c0f2d}
  .hint{font-size:.9rem;color:#7b6f8d}

  .result{display:none}
  .rank{display:inline-block;padding:.2em .6em;border-radius:999px;background:#efe8ff;color:#4b3a7f;font-weight:700;margin-left:.4em}
  .flex{display:flex;gap:16px;flex-wrap:wrap}
  .result .imgbox{flex:1 1 280px;min-width:260px}
  .result .imgbox img{width:100%;height:auto;border-radius:14px;border:1px solid var(--line);display:block}
  .result .text{flex:2 1 360px;min-width:300px}
  .bars{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
  .bar{background:#f5f2ff;border:1px solid var(--line);border-radius:10px;overflow:hidden}
  .bar .h{display:flex;justify-content:space-between;align-items:center;padding:6px 10px;font-size:.92rem}
  .bar .b{height:10px;background:linear-gradient(90deg,var(--accent),var(--accent2));width:0%}
  .meta{color:#6f6584;font-size:.92rem}
  .footer-note{font-size:.88rem;color:#6f6584}
  .back{display:inline-block;margin:10px 0 20px;padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#faf7ff}

  .mini-toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%) translateY(20px);opacity:0;background:#2a1840;color:#fff;padding:8px 12px;border-radius:999px;font-size:.9rem;transition:.25s;z-index:40}
  .mini-toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

  [role="progressbar"]{width:100%}
  
  /* â”€â”€ å‰å›ã®å›ç­”ï¼šã‚¹ãƒãƒ›è¦–èªæ€§UP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .prev-list{list-style:none;padding-left:0;margin:.4rem 0 .2rem .9rem}
  .prev-item{display:flex;gap:8px;align-items:flex-start;padding:6px 0;border-bottom:1px solid var(--line)}
  /* è³ªå•æ–‡ã¯2è¡Œã§çœç•¥ï¼ˆè‡ªç„¶ãªä½ç½®ã§æŠ˜ã‚Šï¼‰ */
  .prev-q{flex:1;min-width:0;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2;overflow:hidden;overflow-wrap:anywhere}
  /* å›ç­”ãƒ©ãƒ™ãƒ«ã¯1è¡Œå›ºå®šã®ãƒãƒƒãƒ—åŒ–ï¼ˆæŠ˜ã‚Šè¿”ã•ãªã„ï¼‰ */
  .prev-a{flex:0 0 auto;white-space:nowrap;border:1px solid var(--line);border-radius:999px;padding:2px 8px;font-size:.9rem;background:#faf7ff}
</style>
</head>

<body data-id="crystal-guess">
<header class="hd" role="banner">
  <div class="wrap">
    <div class="ttl">æ°´æ™¶ã®ãŠå‘Šã’è¨ºæ–­ <span class="rank" aria-label="æœ¬å‘½ã‚«ãƒ†ã‚´ãƒª">H/A/R/M</span></div>
    <div class="sub">é­”å¥³ã®æ°´æ™¶çƒãŒã€Œã„ã¾ä¸€ç•ªé‡ã„ãŠæ‚©ã¿ã€ã‚’ã‚„ã•ã—ãæ¨å®šã€‚åº¦åˆã„ãƒãƒ¼ï¼‹æ ¹æ‹ ãƒ¯ãƒ¼ãƒ‰ï¼‹ãƒŸãƒ‹ä¸€æ­©ã¤ãã€‚</div>
  </div>
</header>

<!-- å›ºå®šé€²æ—ãƒãƒ¼ -->
<div class="progress-fixed"><div class="progress-bar" style="width:0%"></div></div>

<main class="wrap" id="app" role="main" aria-live="polite">
  <!-- ãƒ’ãƒ¼ãƒ­ãƒ¼ -->
  <figure class="hero">
    <img src="/shindan/assets/results/crystal-guess/t00.webp" alt="é­”å¥³ã¨æ°´æ™¶çƒ" loading="lazy">
  </figure>

  <!-- è³ªå•ã‚«ãƒ¼ãƒ‰ -->
  <section id="quiz" class="paper" aria-label="è³ªå•ã‚»ã‚¯ã‚·ãƒ§ãƒ³">
    <div class="qnum" id="qnum">Q1/24</div>
    <div class="qtext" id="qtext">â€¦</div>
    <div class="opts" id="opts" role="group" aria-label="å›ç­”ã‚’é¸æŠ"></div>
    <div class="ctrls">
      <button type="button" id="prevBtn">ã‚‚ã©ã‚‹</button>
      <button type="button" id="nextBtn" class="primary">æ¬¡ã¸</button>
    </div>
    <div class="hint" id="hint">æŠ¼ã—ãŸç¬é–“ã«ä¿å­˜ã•ã‚Œã¾ã™ğŸ”®</div>
  </section>

  <!-- çµæœ -->
  <section id="result" class="paper result" aria-label="çµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³">
    <h2 style="margin-top:0">ãŠå‘Šã’</h2>
    <div class="flex">
      <div class="imgbox">
        <img id="resultImg" src="" alt="" loading="lazy">
      </div>
      <div class="text">
        <h3 id="resultTitle" style="margin:.2rem 0 0;"></h3>
        <p id="resultLines" style="white-space:pre-line;margin:.4rem 0 1rem"></p>
        <div class="meta" id="resultMeta"></div>

     
        <!-- â–¼ ç½®ãæ›ãˆï¼šã‚«ãƒ†ã‚´ãƒªï¼†å› å­ã®ãƒãƒ¼è¡¨ç¤ºï¼ˆ2æ®µï¼‰ -->
<h4 class="minihead" style="margin:.6rem 0 .4rem;color:#6f6584;font-size:.95rem">H/A/R/M ã®å‚¾ã</h4>
<div class="bars" id="barsCat"></div>

<h4 class="minihead" style="margin:1rem 0 .4rem;color:#6f6584;font-size:.95rem">å› å­ã®å†…è¨³</h4>
<div class="bars" id="barsFac"></div>
        </div>
      </div>
    </div>

    <details style="margin-top:14px">
     <summary>ç ”ç©¶ãƒ¡ãƒ¢</summary>
      <ul style="margin:.4rem 0 .2rem .9rem" id="reasons">
        <!-- ä¸Šä½3å› å­ã‚’è‡ªå‹•æŒ¿å…¥ -->
      </ul>
    </details>
    
    <!-- å‰å›ã®å›ç­”ï¼ˆãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰ -->
<details id="prevBlock" style="margin-top:10px">
  <summary>å‰å›ã®å›ç­”ï¼ˆä¸€è¦§ï¼‰</summary>
  <ul id="prevList" class="prev-list"></ul>
</details>

    <p class="footer-note" style="margin-top:12px">â€»æœ¬ãƒšãƒ¼ã‚¸ã¯å¨¯æ¥½ï¼‹è‡ªå·±ç†è§£ã®è£œåŠ©ã‚’ç›®çš„ã¨ã—ãŸç°¡æ˜“ãƒ†ã‚¹ãƒˆã§ã™ã€‚ã¤ã‚‰ã•ãŒç¶šãæ™‚ã¯ã€èº«è¿‘ãªäººã‚„å°‚é–€ã®ç›¸è«‡å…ˆã¸æ—©ã‚ã«ç›¸è«‡ã—ã¦ãã ã•ã„ã€‚</p>

    <button type="button" class="back" id="restartBtn" aria-label="æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™">æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™</button>
    <a class="back" href="https://haisuikounozarigani.github.io/shindan/">è¨ºæ–­ä¸€è¦§ã«æˆ»ã‚‹</a>
  </section>
</main>

<div class="mini-toast" id="toast" role="status" aria-live="polite">è¨˜éŒ²ã—ãŸã‚ˆ âœ…</div>

<script>
/* ===== å›ºå®šé€²æ—ãƒãƒ¼æ›´æ–°ï¼ˆè¦å®šï¼‰ ===== */
function updateProgress(p){
  document.querySelector('.progress-bar').style.width = Math.max(0,Math.min(100,p)) + '%';
}

/* ===== å®šç¾© ===== */
const SLUG='crystal-guess';
const LS_ANS=`shindan:${SLUG}:answers`;
const LS_IDX=`shindan:${SLUG}:index`;
const LS_DONE=`shindan:${SLUG}:done`;
const LS_LASTANS = `shindan:${SLUG}:lastAnswers`; // å‰å›å®Œäº†æ™‚ã®å›ç­”ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ
const FACT = {BODY:'ä½“ã®ã‚µã‚¤ãƒ³', FUT:'æœªæ¥ã¨ç· åˆ‡', GAZE:'ä»–äººã®ç›®ç·š', MONEY:'ãŠé‡‘ã¸ã®æ•æ„Ÿã•', SELF:'è‡ªå·±æ‰¹è©•ã®å£°', START:'å‹•ãå‡ºã—æŠµæŠ—'};
const LABELS = ['ãœã‚“ãœã‚“','ã‚ã¾ã‚Š','åŠã€…','ã‘ã£ã“ã†','ã™ã”ã']; // æ•°å­—ç¦æ­¢

// 24å•ï¼ˆå„å› å­4å•ï¼‰â€” rev=true ã¯â€œè»½ãã§ãã¦ã„ã‚‹/ç·©å’Œã§ãã‚‹â€å†…å®¹ã§é€†è»¢
const Q = [
  // â‘ ä½“ã®ã‚µã‚¤ãƒ³
  {t:'å¯é€”ä¸­ã§ç›®ãŒè¦šã‚ã‚‹ã“ã¨ãŒå¤šã„ã€‚', k:'BODY'},
  {t:'ä½“ã®ã“ã‚ã°ã‚Šã‚’æ„è­˜ã™ã‚‹ã€‚', k:'BODY'},
  {t:'ç–²ã‚Œã§è€ƒãˆãŒç‹­ããªã‚‹ã€‚', k:'BODY'},
  {t:'æ¸©ã‹ã„é£²ã¿ç‰©ã‚„å…¥æµ´ã§ã»ã©ã‘ã‚‹ã€‚', k:'BODY', rev:true},

  // â‘¡æœªæ¥ã¨ç· åˆ‡
  {t:'ç· åˆ‡ãŒé ã„ã»ã©æ‰‹ãŒã¤ã‹ãªã„ã€‚', k:'FUT'},
  {t:'ã€Œæœ€åˆã®5åˆ†ã€ãŒé‡ã„ã€‚', k:'FUT'},
  {t:'æ¬¡ã®ä¸€æ‰‹ãŒæ±ºã¾ã‚‰ãªã„ã“ã¨ãŒå¤šã„ã€‚', k:'FUT'},
  {t:'é€²æ—ãŒè¦‹ãˆãšç„¦ã‚‹ã€‚', k:'FUT'},

  // â‘¢ä»–äººã®ç›®ç·š
  {t:'ç›¸æ‰‹ã®è¿”äº‹ãŒé…ã„ã¨ä¸å®‰ãŒå¼·ã¾ã‚‹ã€‚', k:'GAZE'},
  {t:'ç›¸æ‰‹ã®åå¿œã‚’ä½•åº¦ã‚‚åã™ã†ã—ã¦ã—ã¾ã†ã€‚', k:'GAZE'},
  {t:'æ–­ã‚Šã®ç†ç”±ã‚’é•·æ–‡ã§æ›¸ããŒã¡ã€‚', k:'GAZE'},
  {t:'äººå‰ã®å°ã•ãªãƒŸã‚¹ã‚’ä½•åº¦ã‚‚æ€ã„å‡ºã™ã€‚', k:'GAZE'},

  // â‘£ãŠé‡‘ã¸ã®æ•æ„Ÿã•
  {t:'å›ºå®šè²»ã®å¢—æ¸›ã«æ•æ„Ÿã ã€‚', k:'MONEY'},
  {t:'æœˆæœ«ã¯å°ã•ãªæ”¯å‡ºãŒç‰¹ã«æ°—ã«ãªã‚‹ã€‚', k:'MONEY'},
  {t:'ä»Šè²·ã†ã‹æ¥æœˆã‹ã§æ‚©ã‚€ã“ã¨ãŒå¤šã„ã€‚', k:'MONEY'},
  {t:'ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ¬ã‚¹ã®è¦‹ãˆãªã„å‡ºè²»ãŒä¸å®‰ã ã€‚', k:'MONEY'},

  // â‘¤è‡ªå·±æ‰¹è©•ã®å£°
  {t:'å…¨éƒ¨ã®ã‚„ã‚Šæ–¹ã‚’ç–‘ã£ã¦ã—ã¾ã†ã€‚', k:'SELF'},
  {t:'æ³¨æ„ã•ã‚ŒãŸä¸€ç‚¹ãŒå¼·ãæ®‹ã‚‹ã€‚', k:'SELF'},
  {t:'ã¤ã„å‘¨ã‚Šã¨æ¯”ã¹ãŒã¡ã€‚', k:'SELF'},
  {t:'å°ã•ãªãƒŸã‚¹ã‚’æ€§æ ¼ã«çµã³ã¤ã‘ã¦ã—ã¾ã†ã€‚', k:'SELF'},

  // â‘¥å‹•ãå‡ºã—æŠµæŠ—
  {t:'é€£çµ¡ã ã‘ãªã‚‰å‹•ã‘ã‚‹ã“ã¨ãŒå¤šã„ã€‚', k:'START', rev:true},
  {t:'æœºã‚’ã€Œ10cmã ã‘ã€ç‰‡ã¥ã‘ã‚‹ã¨å§‹ã¾ã‚Œã‚‹ã€‚', k:'START', rev:true},
  {t:'ã‚¿ã‚¤ãƒãƒ¼ã€Œ3åˆ†ã€ã§ç€æ‰‹ã§ãã‚‹ã€‚', k:'START', rev:true},
  {t:'ä½“èª¿ãŒå¾®å¦™ã ã¨å¾Œå›ã—ãŒå¢—ãˆã‚‹ã€‚', k:'START'}
];

// H/A/R/M é‡ã¿ï¼ˆå› å­â†’ã‚«ãƒ†ã‚´ãƒªï¼‰ã€‚ã‚ã¨ã§å„ã‚«ãƒ†ã‚´ãƒªç·å’Œã§æ­£è¦åŒ–ã—ã¦0â€“100ã«ã—ã¾ã™ã€‚
const W = {
  H:{BODY:.70, FUT:.10, GAZE:.10, MONEY:0.00, SELF:.10, START:.30},
  A:{BODY:.10, FUT:.70, GAZE:.10, MONEY:.20, SELF:.40, START:.40},
  R:{BODY:.10, FUT:.10, GAZE:.70, MONEY:.10, SELF:.40, START:.20},
  M:{BODY:.10, FUT:.10, GAZE:.10, MONEY:.70, SELF:.10, START:.10}
};
const CAT_NAME = {H:'Hï¼ˆå¥åº·ï¼‰', A:'Aï¼ˆé‡å¿ƒ/ä»•äº‹ï¼‰', R:'Rï¼ˆé–¢ä¿‚ï¼‰', M:'Mï¼ˆãŠé‡‘ï¼‰'};
const CAT_IMG  = {H:'t01.webp', A:'t02.webp', R:'t03.webp', M:'t04.webp'};
const CAT_ALT  = {H:'æ°´æ™¶ã¨å¥åº·', A:'æ°´æ™¶ã¨é‡å¿ƒ', R:'æ°´æ™¶ã¨é–¢ä¿‚', M:'æ°´æ™¶ã¨ãŠé‡‘'};
const MINI_STEP = {
  H:['å°±å¯90åˆ†å‰ã¬ã‚‹ã‚å…¥æµ´10åˆ†','æœã„ã¡æ°´ä¸€æ¯ï¼‹å§¿å‹¢30ç§’'],
  A:['æœ€åˆã®5åˆ†ã ã‘ç€æ‰‹','é€£çµ¡ã ã‘å…ˆã«é€ã‚‹'],
  R:['ã€Œã‚ã‚ŠãŒã¨ã†1è¡Œã€ã ã‘é€ã‚‹','çŸ­æ–‡ï¼‹ä»£æ¡ˆæ—¥æ™‚ã§æ–­ã‚‹'],
  M:['å›ºå®šè²»ã‚’1é …ç›®ã ã‘è¦‹ç›´ã™','æ˜ç´°ã‚’1ã‚«æ‰€ã«é›†ç´„']
};

/* ===== çŠ¶æ…‹ã¨è¦ç´  ===== */
let idx=0, ans = new Array(Q.length).fill(null);
const $qnum = document.getElementById('qnum');
const $qtext= document.getElementById('qtext');
const $opts = document.getElementById('opts');
const $prev = document.getElementById('prevBtn');
const $next = document.getElementById('nextBtn');
const $quiz = document.getElementById('quiz');
const $result = document.getElementById('result');
const $img = document.getElementById('resultImg');
const $ttl = document.getElementById('resultTitle');
const $lines = document.getElementById('resultLines');
const $meta = document.getElementById('resultMeta');
const $barsCat = document.getElementById('barsCat');
const $barsFac = document.getElementById('barsFac');
const $degBar = document.getElementById('degBar');
const $degPct = document.getElementById('degPct');
const $degLabel = document.getElementById('degLabel');
const $reasons = document.getElementById('reasons');
const $toast = document.getElementById('toast');
const $restart = document.getElementById('restartBtn');

/* ===== å¾©å…ƒ ===== */
(function restore(){
  try{
    const a = JSON.parse(localStorage.getItem(LS_ANS)||'null');
    const i = JSON.parse(localStorage.getItem(LS_IDX)||'0');
    if(Array.isArray(a) && a.length===Q.length){ ans=a; idx=Math.min(Math.max(0,+i||0),Q.length-1);
      if(ans.every(v=>v!==null)){ showResult(); return; }
    }
  }catch(_){}
  renderQ();
})();

/* ===== é€²è¡Œæç”» ===== */
function renderQ(){
  const q=Q[idx];
  $qnum.textContent = `Q${idx+1}/${Q.length}`;
  $qtext.textContent = q.t;
  $opts.innerHTML='';
  LABELS.forEach((lab,i)=>{
    const b=document.createElement('button');
    b.type='button'; b.className='btn';
    b.setAttribute('aria-pressed', ans[idx]===i?'true':'false');
    b.innerHTML = `<span>${lab}</span><span class="opt-note">${note(i)}</span>`;
    b.addEventListener('click',()=> select(i));
    $opts.appendChild(b);
  });
  $prev.disabled = (idx===0);
  $next.textContent = (idx===Q.length-1)? 'ãŠå‘Šã’ã‚’è¦‹ã‚‹':'æ¬¡ã¸';
  const done = ans.filter(v=>v!==null).length;
  updateProgress(Math.round(done/Q.length*100));
}
function note(i){
  return ['ã¾ã£ãŸããªã„','ã™ã“ã—','åŠåˆ†ãã‚‰ã„','ã‚ã‚Šã¨ã‚ã‚‹','ã¨ã¦ã‚‚ã‚ã‚‹'][i];
}

/* ===== å›ç­”å‡¦ç† ===== */
function select(v){
  ans[idx]=v; persist();
  showToast('è¨˜éŒ²ã—ãŸã‚ˆ ğŸ”®');
  mark(v);
  setTimeout(()=>{ if(idx<Q.length-1){idx++; renderQ();} else {showResult();} },140);
}
function mark(v){[...$opts.children].forEach((el,i)=> el.setAttribute('aria-pressed', i===v?'true':'false'));}
$prev.addEventListener('click',()=>{ if(idx>0){ idx--; persist(); renderQ(); }});
$next.addEventListener('click',()=>{ if(idx<Q.length-1){ idx++; persist(); renderQ(); } else { showResult(); }});
function persist(){ try{localStorage.setItem(LS_ANS,JSON.stringify(ans)); localStorage.setItem(LS_IDX,JSON.stringify(idx));}catch(_){} }

/* ===== ã‚¹ã‚³ã‚¢è¨ˆç®— ===== */
// å› å­ã”ã¨ã« avg(0â€“4) â†’ pct(0â€“100) ã«æ›ç®—ï¼ˆrevã¯ 4-vï¼‰
function compute(){
  const sums={BODY:0,FUT:0,GAZE:0,MONEY:0,SELF:0,START:0};
  const cnt={BODY:0,FUT:0,GAZE:0,MONEY:0,SELF:0,START:0};
  Q.forEach((q,i)=>{
    let v = ans[i]; if(v==null) v=0;
    if(q.rev) v = 4 - v;
    sums[q.k]+=v; cnt[q.k]++;
  });
  const pct={}; Object.keys(sums).forEach(k=>{
    const avg = sums[k]/(cnt[k]*4); // 0â€“1
    pct[k] = Math.round(avg*100);   // 0â€“100
  });
  // H/A/R/Mè¨ˆç®—ï¼šé‡ã¿ä»˜ãâ†’ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«ç·å’Œã§å‰²ã£ã¦0â€“100æ­£è¦åŒ–
  function scoreCat(cat){
    const w=W[cat], keys=Object.keys(w);
    const raw = keys.reduce((a,k)=>a + (pct[k]*w[k]), 0);
    const wsum = keys.reduce((a,k)=>a + w[k], 0);
    return raw/wsum; // 0â€“100ç›¸å½“
  }
  const S = {H:scoreCat('H'), A:scoreCat('A'), R:scoreCat('R'), M:scoreCat('M')};
  // æ ¹æ‹ ï¼šæœ¬å‘½ã«å¯„ä¸ã—ãŸå› å­ã®ä¸Šä½3ã¤ï¼ˆpctÃ—wï¼‰
  function reasonsFor(cat){
    const w=W[cat];
    return Object.keys(w)
      .map(k=>({k, v:pct[k]*w[k]}))
      .sort((a,b)=>b.v-a.v)
      .slice(0,3)
      .map(o=>({key:o.k, name:FACT[o.k]}));
  }
  return {pct, S, reasonsFor};
}

/* ===== ç”»åƒ & ãƒ†ã‚­ã‚¹ãƒˆ ===== */
function showResult(){
  const {pct,S,reasonsFor} = compute();
  // â¬‡ å‰å›ã®å›ç­”ã‚’èª­ã¿å‡ºã—ã€ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æç”»
  try{
    const prev = JSON.parse(localStorage.getItem(LS_LASTANS) || 'null');
    const $block = document.getElementById('prevBlock');
    const $list  = document.getElementById('prevList');
    if(prev && Array.isArray(prev.answers) && $block && $list){
      $list.innerHTML = '';
      prev.answers.forEach((v,i)=>{
        const li = document.createElement('li');
        li.className = 'prev-item';
        const lab = (typeof v === 'number' && v>=0 && v<LABELS.length) ? LABELS[v] : 'â€”';
        li.innerHTML = `<span class="prev-q">Q${i+1}ï¼š${Q[i].t}</span><span class="prev-a">ã€Œ${lab}ã€</span>`;
        $list.appendChild(li);
      });
      $block.open = false; // æ—¢å®šã¯é–‰ã˜ã¦è¡¨ç¤º
    }
  }catch(_){}

  // æœ¬å‘½ & æ¬¡ç‚¹
  const entries = Object.entries(S).sort((a,b)=>b[1]-a[1]);
  const [topCat, topVal] = entries[0];
  const [secCat, secVal] = entries[1];
  const diff = Math.round(topVal - secVal);
  const degPct = Math.round(topVal); // 0â€“100
  const degBand = degPct<=39?'å¼±':(degPct<=69?'ä¸­':'å¼·');

  // ç”»åƒ
  const IMG_BASE='/shindan/assets/results/crystal-guess/';
  const file = CAT_IMG[topCat];
  $img.src = IMG_BASE + file;
  $img.alt = CAT_ALT[topCat] || 'æ°´æ™¶';

  // ã‚¿ã‚¤ãƒˆãƒ«
  document.querySelector('.rank').textContent = CAT_NAME[topCat];
  $ttl.textContent = `æœ¬å‘½ï¼š${CAT_NAME[topCat]}ï¼ˆåº¦åˆã„ï¼š${degPct}/100ï½œ${degBand}ï¼‰`;

  // ç”¨èªå¤‰æ›´ï¼šã€ŒãŠå‘Šã’ç¢ºåº¦ã€â†’ã€Œèª­ã¿ã®ã¯ã£ãã‚Šåº¦ã€
  const clarity = diff<=6?'å¼±ã‚':(diff<=14?'ãµã¤ã†':'ã¯ã£ãã‚Š');
  const clarityLine = `èª­ã¿ã®ã¯ã£ãã‚Šåº¦ï¼š${clarity}ï¼ˆæœ¬å‘½ã¨æ¬¡ç‚¹ã®å·® ${diff}ï¼‰`;
  const secLine = `æ¬¡ç‚¹ï¼š${CAT_NAME[secCat]}`;

  // ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆ2ã€œ3æ–‡ï¼‹ãƒŸãƒ‹ä¸€æ­©ï¼‰
  const baseLine = (()=> {
    switch(topCat){
      case 'H': return 'ä½“ã®ã‚µã‚¤ãƒ³ãŒå…ˆã«é³´ã‚‹ã¨ã€æ€è€ƒã‚‚ç‹­ã¾ã‚Šã‚„ã™ã„æ™‚æœŸã€‚ä¼‘æ¯ã®ã€Œè³ªã€ã‚’1ã¤ã ã‘ä¸Šã’ã‚‹ã¨å…¨ä½“ãŒè»½ããªã‚Šã¾ã™ã€‚';
      case 'A': return 'æœªæ¥ã¨ç· åˆ‡ã®è² è·ãŒä¸»å½¹ã€‚æœ€åˆã®5åˆ†ã‚’åˆ‡ã‚Šå‡ºã™ã¨ã€è¿·ã„ã¯ã€Œå…·ä½“ã€ã«å¤‰ã‚ã‚Šã‚„ã™ã„ã€‚';
      case 'R': return 'ä»–äººã®ç›®ç·šãŒå¼·ãå…¥ã‚‹é…ç½®ã€‚é–¢ä¿‚ã‚’ä¿ã¤æœ€å°å˜ä½ã‚’æ±ºã‚ã‚‹ã¨ã€å¿ƒã®æºã‚ŒãŒæ¸›ã‚Šã¾ã™ã€‚';
      case 'M': return 'ãŠé‡‘ã¸ã®æ³¨æ„ãŒé›†ä¸­ã€‚æ”¯å‡ºã®è¦‹ãˆã‚‹åŒ–ã¯ã€ãã‚Œã ã‘ã§ä¸å®‰ã®èŠ¯ã‚’ã»ã©ãã¾ã™ã€‚';
    }
  })();
  const mini = MINI_STEP[topCat][Math.floor(Math.random()*MINI_STEP[topCat].length)];
  $lines.textContent = [baseLine, `${clarityLine}ï¼${secLine}`, 'ãƒŸãƒ‹ä¸€æ­©ï¼š' + mini].join('\n');

  // ãƒ¡ã‚¿ï¼ˆå› å­ã®ç”Ÿpctï¼‰
  $meta.textContent = `å› å­ï¼ˆ0â€“100ï¼‰ï¼šä½“${pct.BODY}ï¼æœªæ¥${pct.FUT}ï¼ç›®ç·š${pct.GAZE}ï¼ãŠé‡‘${pct.MONEY}ï¼è‡ªå·±æ‰¹è©•${pct.SELF}ï¼å‹•ãå‡ºã—${pct.START}`;

  // â”€â”€ H/A/R/Mï¼ˆ4æœ¬ãƒãƒ¼ï¼‰
  $barsCat.innerHTML = '';
  [['H','å¥åº·'],['A','é‡å¿ƒ/ä»•äº‹'],['R','é–¢ä¿‚'],['M','ãŠé‡‘']].forEach(([k])=>{
    const v = Math.round(S[k]);
    const div = document.createElement('div');
    div.className = 'bar';
    div.innerHTML = `
      <div class="h"><span>${CAT_NAME[k]}</span><span>${v}%</span></div>
      <div class="b" style="width:${v}%"></div>
    `;
    $barsCat.appendChild(div);
  });

  // â”€â”€ å› å­ï¼ˆ6æœ¬ãƒãƒ¼ï¼‰
  $barsFac.innerHTML = '';
  [['BODY','ä½“ã®ã‚µã‚¤ãƒ³'],['FUT','æœªæ¥ã¨ç· åˆ‡'],['GAZE','ä»–äººã®ç›®ç·š'],['MONEY','ãŠé‡‘ã¸ã®æ•æ„Ÿã•'],['SELF','è‡ªå·±æ‰¹è©•ã®å£°'],['START','å‹•ãå‡ºã—æŠµæŠ—']]
    .forEach(([k,jp])=>{
      const v = pct[k];
      const div = document.createElement('div');
      div.className = 'bar';
      div.innerHTML = `
        <div class="h"><span>${jp}</span><span>${v}%</span></div>
        <div class="b" style="width:${v}%"></div>
      `;
      $barsFac.appendChild(div);
    });

  // â”€â”€ ç ”ç©¶ãƒ¡ãƒ¢ã®ã¿è¡¨ç¤ºï¼ˆH/A/R/M å…¨éƒ¨ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$reasons.innerHTML='';

// ã‚«ãƒ†ã‚´ãƒªåˆ¥ ç ”ç©¶ãƒ¡ãƒ¢è¾æ›¸ï¼ˆãã®ã¾ã¾æµç”¨ï¼å¿…è¦ãªã‚‰ç·¨é›†OKï¼‰
const RESEARCH_HINT = {
  H: [
    'çŸ­ã„å…¥æµ´ã‚„æ¸©ã‹ã„é£²ã¿ç‰©ãªã©ã®ã€Œæ¸©ç†±åˆºæ¿€ã€ã¯ã€ã‹ã‚‰ã ã®ç·Šå¼µã‚’ã‚†ã‚‹ã‚æ°—åˆ†ã‚’å’Œã‚‰ã’ã‚‹å‚¾å‘ãŒã‚ã‚‹ã¨è¨€ã‚ã‚Œã¾ã™ã€‚',
    'ç¡çœ ã®ä¸€è²«æ€§ï¼ˆå°±å¯èµ·åºŠã®å›ºå®šï¼‰ã¯ã€æ—¥ä¸­ã®é›†ä¸­ã‚„æ°—åˆ†ã®å®‰å®šã¨é–¢é€£ã—ã‚„ã™ã„ã¨å ±å‘Šã•ã‚Œã¾ã™ã€‚'
  ],
  A: [
    'ç€æ‰‹ã‚’ã€Œæœ€åˆã®æ•°åˆ†ã€ã«åˆ†è§£ã™ã‚‹æ‰‹æ³•ã¯ã€å…ˆå»¶ã°ã—ã®è»½æ¸›ã¨é–¢é€£ã™ã‚‹ã“ã¨ãŒå¤šã„ã¨ã•ã‚Œã¦ã„ã¾ã™ã€‚',
    'å°ã•ãªé€²æ—ã®è¦‹ãˆã‚‹åŒ–ï¼ˆãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚„ã‚¿ã‚¤ãƒãƒ¼ï¼‰ã¯ã€è‡ªå·±åŠ¹åŠ›æ„Ÿã®å›å¾©ã«å½¹ç«‹ã¤ã¨ç¤ºå”†ã•ã‚Œã¾ã™ã€‚'
  ],
  R: [
    'ã”ãçŸ­ã„äº¤æµï¼ˆæŒ¨æ‹¶ãƒ»1åˆ†é€šè©±ï¼‰ã§ã‚‚ã€ã¤ãªãŒã‚Šæ„Ÿã‚„æ°—åˆ†ã®åº•ä¸Šã’ã«å¯„ä¸ã™ã‚‹å‚¾å‘ãŒã‚ã‚‹ã¨ã•ã‚Œã¾ã™ã€‚',
    'ãƒã‚¸ãƒ†ã‚£ãƒ–ãªä¸€è¨€ï¼ˆä¾‹ï¼šã€Œã‚ã‚ŠãŒã¨ã†1è¡Œã€ï¼‰ã¯ã€é–¢ä¿‚æº€è¶³æ„Ÿã®ç¶­æŒã«å°ã•ãªè¿½ã„é¢¨ã«ãªã‚‹ã¨å ±å‘ŠãŒã‚ã‚Šã¾ã™ã€‚'
  ],
  M: [
    'æ”¯å‡ºã®å¯è¦–åŒ–ï¼ˆå›ºå®šè²»ã®æ£šå¸ã—ã‚„å®¶è¨ˆã‚¢ãƒ—ãƒªï¼‰ã¯ã€é‡‘éŠ­ä¸å®‰ã®ä¸»è¦³çš„è² æ‹…ã‚’ä¸‹ã’ã‚‹ã¨ã•ã‚Œã¾ã™ã€‚',
    'ãƒ«ãƒ¼ãƒ«åŒ–ï¼ˆè³¼å…¥å‰ã®å¾…æ©Ÿæ™‚é–“ã‚„ä¸Šé™è¨­å®šï¼‰ã¯ã€è¡å‹•çš„ãªå‡ºè²»ã®æŠ‘åˆ¶ã¨é–¢é€£ã™ã‚‹ã¨è¨€ã‚ã‚Œã¾ã™ã€‚'
  ]
};

// H/A/R/M å…¨ã‚«ãƒ†ã‚´ãƒªã‚’é †ã«å‡ºã™ï¼ˆè¦‹å‡ºã—é¢¨â†’å„ãƒ¡ãƒ¢ï¼‰
['H','A','R','M'].forEach(cat=>{
  const head = document.createElement('li');
  head.textContent = `â€” ${CAT_NAME[cat]} â€”`;
  head.style.listStyle = 'none';
  head.style.margin = '8px 0 2px';
  head.style.color = '#6f6584';
  $reasons.appendChild(head);

  (RESEARCH_HINT[cat] || []).forEach(t=>{
    const li = document.createElement('li');
    li.textContent = '' + t;
    $reasons.appendChild(li);
  });
});

  // ç”»é¢åˆ‡æ›¿ï¼†ä¿å­˜ï¼†é›†è¨ˆãƒ•ãƒƒã‚¯
  $quiz.style.display='none';
  $result.style.display='block';
  try{ localStorage.setItem(LS_DONE, String(Date.now())); }catch(_){}
  
  document.dispatchEvent(new Event('result:ready'));
}
// â¬‡ ä»Šå›ã®å›ç­”ã‚’ã€Œå‰å›å›ç­”ã€ã¨ã—ã¦ä¿å­˜ï¼ˆæ¬¡å›ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ï¼‰
  try{
    localStorage.setItem(LS_LASTANS, JSON.stringify({answers: ans.slice(), ts: Date.now()}));
  }catch(_){}
/* ===== ã‚„ã‚Šç›´ã— ===== */
function restartQuiz(){
  ans = new Array(Q.length).fill(null); idx = 0;
  try{ localStorage.removeItem(LS_ANS); localStorage.removeItem(LS_IDX);}catch(_){}
  $result.style.display='none'; $quiz.style.display='block';
  updateProgress(0); renderQ();
  window.scrollTo({top:0,behavior:'smooth'}); showToast('æœ€åˆã‹ã‚‰ã¯ã˜ã‚ã‚‹ã‚ˆ');
}
if($restart){ $restart.addEventListener('click', restartQuiz); }

/* ===== ãƒˆãƒ¼ã‚¹ãƒˆ ===== */
let toastTimer=null;
function showToast(msg){
  $toast.textContent = msg || 'OK';
  $toast.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=> $toast.classList.remove('show'), 850);
}

/* ===== åˆæœŸæç”» ===== */
renderQ();
</script>

<!-- ã¿ã‚“ãªã®ã“ã“ã‚ï¼ˆå…±é€šIIFEï¼šä¿å­˜ï¼‹CountAPIï¼‰ -->
<script>(function(){
  var DONE_KEY='specimens:open:byid', TOTAL_KEY='specimens:open:total';
  var MY_ID=document.body.getAttribute('data-id')||'crystal-guess';
  var NS='haisuikounozarigani_shindan', KEY='specimens_open_total';
  var marked=false;
  function mark(){ if(marked) return; marked=true;
    try{
      var t=(+localStorage.getItem(TOTAL_KEY)||0)+1;
      localStorage.setItem(TOTAL_KEY,String(t));
      var map={}; try{ map=JSON.parse(localStorage.getItem(DONE_KEY)||'{}'); }catch(_){}
      map[MY_ID]=(map[MY_ID]||0)+1;
      localStorage.setItem(DONE_KEY, JSON.stringify(Object.assign({},map,{_ts:Date.now()})));
      var url='https://api.countapi.xyz/hit/'+NS+'/'+KEY;
      if(navigator.sendBeacon){ try{ navigator.sendBeacon(url); }catch(_){ } }
      else{ fetch(url,{mode:'cors',cache:'no-store',keepalive:true}).catch(function(){}); }
    }catch(_){}
  }
  document.addEventListener('result:ready', mark);
  setTimeout(mark, 2000); // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
}());</script>

</body>
</html>