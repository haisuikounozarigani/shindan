<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>転生先どこ？診断｜白亜紀〜令和〜星暦XX年</title>
<meta name="description" content="24問×5件法で、生活の速さ・人との距離など8軸から、白亜紀〜令和〜星暦XX年の“暮らし相性”を判定。因子バーとミニ一歩つき。">
<meta name="theme-color" content="#0f2a1f">
<!-- OG -->
<meta property="og:type" content="website">
<meta property="og:title" content="転生先どこ？診断">
<meta property="og:description" content="8因子からあなたの“暮らし相性”を時代で可視化。白亜紀〜令和〜星暦XX年。">
<meta property="og:url" content="https://haisuikounozarigani.github.io/shindan/reincarnation-era-fit.html">
<meta property="og:image" content="https://haisuikounozarigani.github.io/shindan/assets/results/reincarnation-era-fit/t00.webp">
<style>
  :root{
    --bg:#f3f6f4; --paper:#fff; --ink:#0e1914; --muted:#57665d; --line:#e1ebe6;
    --accent:#4aa8ff; /* cold */ --accent2:#a48bff; /* duo */
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);
    font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Sans","Hiragino Kaku Gothic ProN","Yu Gothic",Meiryo,sans-serif}
  a{color:#1e4b38;text-decoration:none}
  .wrap{max-width:980px;margin:0 auto;padding:16px}
  header.hd{background:linear-gradient(160deg,#eef6f1,#e9f2ed);border-bottom:1px solid var(--line)}
  header.hd .wrap{padding:20px 16px 10px}
  .ttl{font-weight:800;font-size:1.35rem;letter-spacing:.02em}
  .sub{color:var(--muted);font-size:.95rem}

  /* 固定進捗（noh準拠） */
  .progress-fixed{position:sticky;top:0;z-index:20;height:8px;background:var(--line)}
  .progress-bar{height:100%;border-radius:6px;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width .2s ease}
  [role="progressbar"]{width:100%}

  figure.hero{margin:12px 0;border:1px solid var(--line);border-radius:16px;overflow:hidden;background:#fff}
  figure.hero img{display:block;width:100%;height:auto}

  .paper{background:var(--paper);border:1px solid var(--line);border-radius:16px;padding:16px;margin:14px 0}
  .qnum{font-weight:700;color:#123126}
  .qtext{margin:.4rem 0 1rem}
  .opts{display:grid;grid-template-columns:1fr;gap:8px}
  .btn{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 14px;border:1px solid var(--line);border-radius:12px;background:#fff;cursor:pointer;transition:.12s}
  .btn[aria-pressed="true"]{outline:2px solid var(--accent2);background:#f3f0ff}
  .btn:hover{transform:translateY(-1px)}
  .opt-note{color:#6b7a6e;font-size:.9rem}
  .ctrls{display:flex;gap:8px;margin-top:12px}
  .ctrls button{padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#f6fbf8;cursor:pointer}
  .ctrls button.primary{background:#0f2a1f;color:#fff;border-color:#0b2219}

  .result{display:none}
  .rank{display:inline-block;padding:.2em .6em;border-radius:999px;background:#e9f2ff;color:#1a3a6b;font-weight:700;margin-left:.4em}
  .flex{display:flex;gap:16px;flex-wrap:wrap}
  .result .imgbox{flex:1 1 280px;min-width:260px}
  .result .imgbox img{width:100%;height:auto;border-radius:14px;border:1px solid var(--line);display:block}
  .result .text{flex:2 1 360px;min-width:300px}
  .bars{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
  .bar{background:#eef6fb;border:1px solid var(--line);border-radius:10px;overflow:hidden}
  .bar .h{display:flex;justify-content:space-between;align-items:center;padding:6px 10px;font-size:.92rem}
  .bar .b{height:10px;background:linear-gradient(90deg,var(--accent),var(--accent2));width:0%}
  .meta{color:#6b7a75;font-size:.92rem}
  .back{display:inline-block;margin:10px 0 20px;padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#f6fbf8}

  .mini-toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%) translateY(20px);opacity:0;background:#0f2a1f;color:#fff;padding:8px 12px;border-radius:999px;font-size:.9rem;transition:.25s;z-index:40}
  .mini-toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

  /* 前回回答：スマホ視認性UP */
  .prev-list{list-style:none;padding-left:0;margin:.4rem 0 .2rem .9rem}
  .prev-item{display:flex;gap:8px;align-items:flex-start;padding:6px 0;border-bottom:1px solid var(--line)}
  .prev-q{flex:1;min-width:0;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2;overflow:hidden;overflow-wrap:anywhere}
  .prev-a{flex:0 0 auto;white-space:nowrap;border:1px solid var(--line);border-radius:999px;padding:2px 8px;font-size:.9rem;background:#f6fbf8}
</style>
</head>

<body data-id="reincarnation-era-fit">
<header class="hd" role="banner">
  <div class="wrap">
    <div class="ttl">転生先どこ？診断 <span class="rank" aria-label="時代候補">—</span></div>
    <div class="sub">8因子（速さ/距離/手しごと/自然/きまり-自由/物語/音と言葉/情報）で“暮らし相性”を時代にマッピング。</div>
  </div>
</header>

<!-- 固定進捗バー -->
<div class="progress-fixed"><div class="progress-bar" style="width:0%"></div></div>

<main class="wrap" id="app" role="main" aria-live="polite">
  <!-- ヒーロー -->
  <figure class="hero">
    <img src="/shindan/assets/results/reincarnation-era-fit/t00.webp" alt="時代が重なる街" loading="lazy">
  </figure>

  <!-- 質問カード -->
  <section id="quiz" class="paper" aria-label="質問セクション">
    <div class="qnum" id="qnum">Q1/24</div>
    <div class="qtext" id="qtext">…</div>
    <div class="opts" id="opts" role="group" aria-label="回答を選択"></div>
    <div class="ctrls">
      <button type="button" id="prevBtn">もどる</button>
      <button type="button" id="nextBtn" class="primary">次へ</button>
    </div>
  </section>

  <!-- 結果 -->
  <section id="result" class="paper result" aria-label="結果セクション">
    <h2 style="margin-top:0">結果</h2>
    <div class="flex">
      <div class="imgbox">
        <img id="resultImg" src="" alt="" loading="lazy">
      </div>
      <div class="text">
        <h3 id="resultTitle" style="margin:.2rem 0 0;"></h3>
        <p id="resultLines" style="white-space:pre-line;margin:.4rem 0 1rem"></p>

        <!-- 因子バー（8本） -->
        <div class="bars" id="bars"></div>

        <!-- メタ -->
        <div class="meta" id="meta" style="margin-top:.6rem"></div>
      </div>
    </div>

    <!-- 前回の回答（レビュー） -->
    <details id="prevBlock" style="margin-top:10px">
      <summary>前回の回答（一覧）</summary>
      <ul id="prevList" class="prev-list"></ul>
    </details>

    <p class="meta" style="margin:.8rem 0 0">※本ページは娯楽＋自己理解の補助を目的とした簡易テストです。体調や不調が続く場合は専門機関へご相談ください。</p>
    <button type="button" class="back" id="restartBtn" aria-label="最初からやり直す">最初からやり直す</button>
    <a class="back" href="https://haisuikounozarigani.github.io/shindan/">診断一覧に戻る</a>
  </section>
</main>

<div class="mini-toast" id="toast" role="status" aria-live="polite"> ✅</div>

<script>
/* ===== 固定進捗バー ===== */
function updateProgress(p){
  document.querySelector('.progress-bar').style.width = Math.max(0,Math.min(100,p)) + '%';
}

/* ===== 定義 ===== */
const SLUG = 'reincarnation-era-fit';
const LS_ANS = `shindan:${SLUG}:answers`;
const LS_IDX = `shindan:${SLUG}:index`;
const LS_DONE = `shindan:${SLUG}:done`;
const LS_LASTANS = `shindan:${SLUG}:lastAnswers`;

/* 因子（8） */
const FACTS = ['SPEED','DIST','HAND','NATURE','RULE','STORY','LANG','INFO'];
const FACT_LABEL = {
  SPEED:'生活の速さ',
  DIST:'人との距離',
  HAND:'手しごと度',
  NATURE:'自然となじむ',
  RULE:'きまりと自由',
  STORY:'物語が好きさ',
  LANG:'音と言葉のなじみ',
  INFO:'情報の強さ'
};

/* 時代（t01〜t08） */
const ERA = ['CRET','JOMON','HEIAN','EDO','TAISHO','HEISEI','REIWA','STAR'];
const ERA_NAME = {
  CRET:'白亜紀', JOMON:'縄文', HEIAN:'平安', EDO:'江戸',
  TAISHO:'大正', HEISEI:'平成', REIWA:'令和', STAR:'星暦XX年'
};
const ERA_IMG = {
  CRET:'t01.webp', JOMON:'t02.webp', HEIAN:'t03.webp', EDO:'t04.webp',
  TAISHO:'t05.webp', HEISEI:'t06.webp', REIWA:'t07.webp', STAR:'t08.webp'
};
const ERA_ALT = {
  CRET:'白亜の海と恐竜', JOMON:'土器と焚き火', HEIAN:'御簾と和歌紙', EDO:'提灯の路地',
  TAISHO:'路面電車の街角', HEISEI:'CD店とガラケー', REIWA:'静かなカフェ', STAR:'軌道都市と星図'
};

/* 24問（8因子×3、5件法 0–4 / ★は逆転） */
const QUESTIONS = [
  // 生活の速さ（SPEED）
  {t:'ゆっくりよりサッと進むほうが落ち着く。', key:'SPEED'},
  {t:'予定はミッチリより余白多めが好き。', key:'SPEED', rev:true}, // ★
  {t:'締切は近いほうが火がつく。', key:'SPEED'},

  // 人との距離（DIST）
  {t:'雑談は“短く・ほどほど”がちょうどいい。', key:'DIST'},
  {t:'長い集まりの後はしばらく一人で回復したい。', key:'DIST'},
  {t:'毎日ずっと誰かと一緒でも平気だ。', key:'DIST', rev:true}, // ★

  // 手しごと度（HAND）
  {t:'手を動かす単純作業はけっこう好き。', key:'HAND'},
  {t:'自分の道具を手入れするのが楽しい。', key:'HAND'},
  {t:'画面だけの作業だと満足感が足りない。', key:'HAND'},

  // 自然となじむ（NATURE）
  {t:'外の空気や木の匂いで落ち着く。', key:'NATURE'},
  {t:'季節の変化に気分が左右されやすい。', key:'NATURE'},
  {t:'都会の人工的な景色が好きだ。', key:'NATURE', rev:true}, // ★

  // きまりと自由（RULE）
  {t:'決まりがあると動きやすい。', key:'RULE'},
  {t:'細かいルールは息苦しく感じる。', key:'RULE', rev:true}, // ★
  {t:'自分で決めたマイルールなら続けられる。', key:'RULE'},

  // 物語が好きさ（STORY）
  {t:'昔話や歴史のエピソードにワクワクする。', key:'STORY'},
  {t:'日常にも小さな“物語”を見つけがち。', key:'STORY'},
  {t:'実用オンリーで、物語はあまり気にしない。', key:'STORY', rev:true}, // ★

  // 音と言葉（LANG）
  {t:'静けさや自然音だと考えがはかどる。', key:'LANG'},
  {t:'人の声や歌詞があると気が散りやすい。', key:'LANG'},
  {t:'にぎやかな音でも気にならない。', key:'LANG', rev:true}, // ★

  // 情報の強さ（INFO）
  {t:'情報は早く・多く欲しいタイプだ。', key:'INFO'},
  {t:'新しい技術やガジェットにすぐ触れてみたい。', key:'INFO'},
  {t:'情報は最小限でよく、変化はゆっくりがいい。', key:'INFO', rev:true} // ★
];

const LABELS = ['ぜんぜん','あまり','どちらとも','わりと','とても'];

/* ===== 状態 ===== */
let idx = 0;
let answers = new Array(QUESTIONS.length).fill(null);

/* ===== 要素 ===== */
const $qnum = document.getElementById('qnum');
const $qtext = document.getElementById('qtext');
const $opts = document.getElementById('opts');
const $prev = document.getElementById('prevBtn');
const $next = document.getElementById('nextBtn');
const $quiz = document.getElementById('quiz');
const $result = document.getElementById('result');
const $resultImg = document.getElementById('resultImg');
const $resultTitle = document.getElementById('resultTitle');
const $resultLines = document.getElementById('resultLines');
const $bars = document.getElementById('bars');
const $meta = document.getElementById('meta');
const $restart = document.getElementById('restartBtn');
const $toast = document.getElementById('toast');

/* ===== 復元 ===== */
(function restore(){
  try{
    const savedAns = JSON.parse(localStorage.getItem(LS_ANS) || 'null');
    const savedIdx = JSON.parse(localStorage.getItem(LS_IDX) || '0');
    if(Array.isArray(savedAns) && savedAns.length === QUESTIONS.length){
      answers = savedAns;
      idx = Math.min(Math.max(0, +savedIdx || 0), QUESTIONS.length-1);
      if(answers.every(v => v !== null)){ showResult(); return; }
    }
  }catch(_){}
  renderQuestion();
})();

/* ===== 画面描画 ===== */
function renderQuestion(){
  const q = QUESTIONS[idx];
  $qnum.textContent = `Q${idx+1}/${QUESTIONS.length}`;
  $qtext.textContent = q.t;
  $opts.innerHTML = '';
  LABELS.forEach((lab,i)=>{
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'btn';
    btn.setAttribute('aria-pressed', answers[idx]===i ? 'true':'false');
    btn.innerHTML = `<span>${lab}</span><span class="opt-note">${descFor(i)}</span>`;
    btn.addEventListener('click',()=> selectAnswer(i));
    $opts.appendChild(btn);
  });
  $prev.disabled = (idx===0);
  $next.textContent = (idx===QUESTIONS.length-1)? '結果を見る':'次へ';
  const done = answers.filter(v=>v!==null).length;
  updateProgress(Math.round(done/QUESTIONS.length*100));
  document.querySelector('.rank').textContent = '—';
}
function descFor(i){
  return ['ほぼない','すこし','半々','よくある','とてもある'][i] || '';
}

/* ===== 回答処理 ===== */
function selectAnswer(v){
  answers[idx] = v; // 0–4
  persist();
  showToast(' ✅');
  markPressed(v);
  setTimeout(()=>{ // 自動で次へ
    if(idx < QUESTIONS.length-1){ idx++; renderQuestion(); }
    else { showResult(); }
  }, 140);
}
function markPressed(v){
  [...$opts.children].forEach((el,i)=> el.setAttribute('aria-pressed', i===v ? 'true' : 'false'));
}
$prev.addEventListener('click', ()=>{ if(idx>0){ idx--; persist(); renderQuestion(); }});
$next.addEventListener('click', ()=>{ if(idx<QUESTIONS.length-1){ idx++; persist(); renderQuestion(); } else { showResult(); }});

/* ===== 保存 ===== */
function persist(){
  try{
    localStorage.setItem(LS_ANS, JSON.stringify(answers));
    localStorage.setItem(LS_IDX, JSON.stringify(idx));
  }catch(_){}
}

/* ===== スコア（avg→pct, z） ===== */
function compute(){
  const sums = {SPEED:0,DIST:0,HAND:0,NATURE:0,RULE:0,STORY:0,LANG:0,INFO:0};
  const counts = {SPEED:0,DIST:0,HAND:0,NATURE:0,RULE:0,STORY:0,LANG:0,INFO:0};
  QUESTIONS.forEach((q,i)=>{
    let v = answers[i]; if(v==null) v = 0;       // 0–4
    if(q.rev) v = 4 - v;                         // 逆転
    sums[q.key] += v; counts[q.key] += 1;
  });
  const avg = {}; const pct = {}; const z = {};
  FACTS.forEach(k=>{
    const a = (sums[k]/(counts[k]||1));              // 0–4
    const a15 = (a+1);                               // 1–5 へシフト（作問が0–4なので）
    avg[k] = a15;                                    // 1–5
    pct[k] = Math.round((a15-1)/4*100);              // 0–100
    z[k] = (a15 - 3)/2;                              // −1〜+1
  });
  return {avg,pct,z};
}

/* ===== 時代プロファイル（−2〜+2） ===== */
const PROFILE = {
  CRET:{SPEED:-2, DIST:-1, HAND:+2, NATURE:+2, RULE:+1, STORY:-2, LANG:-2, INFO:-2},
  JOMON:{SPEED:-2, DIST:-1, HAND:+2, NATURE:+2, RULE: 0, STORY:+1, LANG:-1, INFO:-2},
  HEIAN:{SPEED:-2, DIST: 0, HAND:+1, NATURE:+1, RULE:-2, STORY:+2, LANG:-1, INFO:-2},
  EDO  :{SPEED:-1, DIST:-1, HAND:+2, NATURE: 0, RULE:-1, STORY:+1, LANG: 0, INFO:-1},
  TAISHO:{SPEED: 0, DIST: 0, HAND:+1, NATURE:-1, RULE: 0, STORY:+1, LANG:+1, INFO: 0},
  HEISEI:{SPEED:+1, DIST:+1, HAND:-1, NATURE:-1, RULE:+1, STORY:+1, LANG:+1, INFO:+1},
  REIWA:{SPEED:+2, DIST:+1, HAND:-2, NATURE:-1, RULE:+1, STORY: 0, LANG:+2, INFO:+2},
  STAR :{SPEED:+2, DIST:+2, HAND:-2, NATURE:-2, RULE:+1, STORY: 0, LANG:+2, INFO:+2}
};

/* ===== 結果テキスト・ミニ一歩 ===== */
function eraPack(key){
  switch(key){
    case 'CRET': return {
      one:'野性と手ざわりが主役。道具を自分で作る悦び。',
      fun:'あなたは「静かだけど芯が強い」タイプ。朝の空気でスイッチが入るあるある。',
      step:'化石図鑑を1枚眺める'
    };
    case 'JOMON': return {
      one:'自然と暮らしが地続き。火と土の落ち着き。',
      fun:'お気に入りは長く使う派。手をかけた物ほど可愛く見える…わかる。',
      step:'外で3分深呼吸'
    };
    case 'HEIAN': return {
      one:'静けさとことば。余白に情緒が宿る時代。',
      fun:'言葉選びにこだわる「静かに燃える」タイプ。丁寧な一文で伝えるのが得意。',
      step:'短歌を一首まねる'
    };
    case 'EDO': return {
      one:'手しごとと規律。道具を育てる日々。',
      fun:'段取り決まると一気に強い。置き場所が決まると心も落ち着く…あるある。',
      step:'道具を10分手入れ'
    };
    case 'TAISHO': return {
      one:'古い新しいが交わる街角。浪漫と実用の同居。',
      fun:'クラシックも新奇も“いいとこ取り”したい欲。つい混ぜて試したくなる。',
      step:'古写真を1枚眺める'
    };
    case 'HEISEI': return {
      one:'カタログ文化と手堅さ。情報は“必要十分”。',
      fun:'安定重視だけど便利はちゃんと使う現実派。「結局これが楽」って言いがち。',
      step:'昔のCDを1曲聴く'
    };
    case 'REIWA': return {
      one:'速さとつながりの最適化。静かな個室と高密度情報。',
      fun:'効率大好き。タスクは静かな個室＋高速回線で爆速…それが正義。',
      step:'通知を30分止める'
    };
    case 'STAR': return {
      one:'高密度の知とショートカットが基本作法。',
      fun:'未来のショートカットを作りたくなる最適化沼タイプ。設定画面を開きがち。',
      step:'ショートカットを1本整える'
    };
  }
  return {one:'', fun:'', step:''};
}

/* ===== 画像alt辞書 ===== */
const ALT = {
  't01.webp':'白亜の海と恐竜','t02.webp':'土器と焚き火','t03.webp':'御簾と和歌紙','t04.webp':'提灯の路地',
  't05.webp':'路面電車の街角','t06.webp':'CD店とガラケー','t07.webp':'静かなカフェ','t08.webp':'軌道都市と星図'
};

/* ===== 結果表示 ===== */
function showResult(){

  function restartQuiz(){
    answers = new Array(QUESTIONS.length).fill(null);
    idx = 0;
    try{ localStorage.removeItem(LS_ANS); localStorage.removeItem(LS_IDX); }catch(_){}
    $result.style.display = 'none';
    $quiz.style.display = 'block';
    updateProgress(0);
    renderQuestion();
    window.scrollTo({top:0, behavior:'smooth'});
    showToast('最初からはじめるよ');
  }
  if($restart){ $restart.addEventListener('click', restartQuiz); }

  const {pct,z} = compute();

  // 時代スコア（内積）
  const scores = {};
  ERA.forEach(k=>{
    const w = PROFILE[k];
    let s = 0;
    FACTS.forEach(f=>{ s += (z[f]||0) * (w[f]||0); });
    scores[k] = s; // 実数
  });

  // ランキング
  const entries = Object.entries(scores).sort((a,b)=>b[1]-a[1]);
  let [topKey, topVal] = entries[0];
  const [secKey, secVal] = entries[1];
  const diff = topVal - secVal;

  // 接戦処理：差が0.25未満なら INFO→SPEED→DIST の寄与が大きい方を採択
  if(diff < 0.25){
    const order = ['INFO','SPEED','DIST'];
    let picked = topKey;
    for(const f of order){
      const cTop = (z[f]||0) * (PROFILE[topKey][f]||0);
      const cSec = (z[f]||0) * (PROFILE[secKey][f]||0);
      if(Math.abs(cTop - cSec) > 0.001){
        picked = (cTop > cSec)? topKey : secKey;
        break;
      }
    }
    topKey = picked;
    topVal = scores[picked];
  }

  // 画像・タイトル
  const IMG_BASE = '/shindan/assets/results/reincarnation-era-fit/';
  const file = ERA_IMG[topKey];
  $resultImg.src = IMG_BASE + file;
  $resultImg.alt = ALT[file] || ERA_ALT[topKey] || '時代イメージ';

  const topName = ERA_NAME[topKey];
  const pack = eraPack(topKey);

  // ヘッダのランクバッジと見出し
  document.querySelector('.rank').textContent = topName;
  const nextLine = (Math.abs(topVal - secVal) < 0.25) ? `（次点：${ERA_NAME[secKey]}）` : '';
  $resultTitle.textContent = `転生先：${topName}${nextLine}`;

  // 本文（MBTI的短文＋ミニ一歩）
  const line = `${pack.one}\n${pack.fun}\nミニ一歩：${pack.step}`;
  $resultLines.textContent = line;

  // 因子バー（8本） 0–100%
  $bars.innerHTML = '';
  FACTS.forEach(k=>{
    const v = pct[k];
    const wrap = document.createElement('div');
    wrap.className = 'bar';
    wrap.innerHTML = `
      <div class="h"><span>${FACT_LABEL[k]}</span><span>${v}%</span></div>
      <div class="b" style="width:${v}%"></div>
    `;
    $bars.appendChild(wrap);
  });

  // メタ行（簡易表示）
  $meta.textContent = `因子（0–100）：${FACT_LABEL.SPEED}${pct.SPEED}／${FACT_LABEL.DIST}${pct.DIST}／${FACT_LABEL.HAND}${pct.HAND}／${FACT_LABEL.NATURE}${pct.NATURE}／${FACT_LABEL.RULE}${pct.RULE}／${FACT_LABEL.STORY}${pct.STORY}／${FACT_LABEL.LANG}${pct.LANG}／${FACT_LABEL.INFO}${pct.INFO}`;

  // 画面切替
  $quiz.style.display = 'block'; // safety
  $quiz.style.display = 'none';
  $result.style.display = 'block';

  // 完了・前回回答保存・みんなのこころ発火
  try{ localStorage.setItem(LS_DONE, String(Date.now())); }catch(_){}
  try{
    localStorage.setItem(LS_LASTANS, JSON.stringify({answers: answers.slice(), ts: Date.now()}));
  }catch(_){}
  document.dispatchEvent(new Event('result:ready'));
}

/* ===== トースト ===== */
let toastTimer = null;
function showToast(msg){
  $toast.textContent = msg || 'OK';
  $toast.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=> $toast.classList.remove('show'), 850);
}

/* ===== 初回描画 ===== */
renderQuestion();

/* ===== 前回回答一覧を結果表示時に構築 ===== */
(function hookPrev(){
  const obs = new MutationObserver(()=>{
    if($result.style.display==='block'){
      try{
        const prev = JSON.parse(localStorage.getItem(LS_LASTANS) || 'null');
        const $block = document.getElementById('prevBlock');
        const $list  = document.getElementById('prevList');
        if(prev && Array.isArray(prev.answers) && $block && $list){
          $list.innerHTML = '';
          prev.answers.forEach((v,i)=>{
            const li = document.createElement('li');
            li.className = 'prev-item';
            const lab = (typeof v === 'number' && v>=0 && v<LABELS.length) ? LABELS[v] : '—';
            li.innerHTML = `<span class="prev-q">Q${i+1}：${QUESTIONS[i].t}</span><span class="prev-a">「${lab}」</span>`;
            $list.appendChild(li);
          });
          $block.open = false;
        }
      }catch(_){}
      obs.disconnect();
    }
  });
  obs.observe($result, {attributes:true, attributeFilter:['style']});
})();

/* ===== みんなのこころ（共通IIFE：あなたのLv＋CountAPI） ===== */
</script>

<script>(function(){
  var DONE_KEY='specimens:open:byid', TOTAL_KEY='specimens:open:total';
  var MY_ID=document.body.getAttribute('data-id')||'reincarnation-era-fit';
  var NS='haisuikounozarigani_shindan', KEY='specimens_open_total';
  var marked=false;
  function mark(){ if(marked) return; marked=true;
    try{
      var t=(+localStorage.getItem(TOTAL_KEY)||0)+1;
      localStorage.setItem(TOTAL_KEY,String(t));
      var map={}; try{ map=JSON.parse(localStorage.getItem(DONE_KEY)||'{}'); }catch(_){}
      map[MY_ID]=(map[MY_ID]||0)+1;
      localStorage.setItem(DONE_KEY, JSON.stringify(Object.assign({},map,{_ts:Date.now()})));
      var url='https://api.countapi.xyz/hit/'+NS+'/'+KEY;
      if(navigator.sendBeacon){ try{ navigator.sendBeacon(url); }catch(_){ } }
      else{ fetch(url,{mode:'cors',cache:'no-store',keepalive:true}).catch(function(){}); }
    }catch(_){}
  }
  document.addEventListener('result:ready', mark);
  setTimeout(mark, 2000); // フォールバック
}());</script>

</body>
</html>